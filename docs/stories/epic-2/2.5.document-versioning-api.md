# Story 2.5: Document Versioning API

## Status

Complete

## Story

**As a** utilisateur,
**I want** uploader une nouvelle version d'un document existant,
**so that** je puisse maintenir un historique des modifications.

## Acceptance Criteria

1. Schéma Prisma `DocumentVersion` : id, documentId, versionNumber, storagePath, size, uploadedById, createdAt
2. Champ `currentVersionId` ajouté à `Document`
3. Endpoint `POST /api/documents/:id/versions` uploadant une nouvelle version
4. Version number auto-incrémenté (v1, v2, v3...)
5. Endpoint `GET /api/documents/:id/versions` listant toutes les versions
6. Endpoint `GET /api/documents/:id/versions/:versionId/download` téléchargeant une version spécifique
7. Possibilité de restaurer une ancienne version comme version courante
8. Conservation de toutes les versions (pas de suppression automatique pour MVP)
9. Affichage de la version courante par défaut
10. Tests couvrant upload version, listing, restauration

## Tasks / Subtasks

- [x] **Task 1: Créer le schéma Prisma DocumentVersion** (AC: 1, 2)
  - [x] Ajouter modèle `DocumentVersion` dans `prisma/schema.prisma`
  - [x] Ajouter champ `currentVersionId` nullable sur `Document`
  - [x] Définir relation Document → DocumentVersion
  - [x] Créer et exécuter la migration

- [x] **Task 2: Créer les types partagés** (AC: 1-7)
  - [x] Créer `packages/shared/src/types/version.types.ts`
  - [x] Définir `DocumentVersionResponse`, `VersionListResponse`
  - [x] Créer validateurs Zod

- [x] **Task 3: Créer le service versions** (AC: 3-9)
  - [x] Créer `apps/api/src/modules/documents/versions.service.ts`
  - [x] Implémenter `uploadNewVersion(documentId, file, userId)`
  - [x] Implémenter `getVersions(documentId)` - liste toutes les versions
  - [x] Implémenter `getVersionDownloadUrl(versionId)` - URL signée
  - [x] Implémenter `restoreVersion(documentId, versionId)` - restaurer ancienne version
  - [x] Implémenter `getNextVersionNumber(documentId)` - auto-incrément

- [x] **Task 4: Ajouter les routes versions** (AC: 3, 5, 6, 7)
  - [x] `POST /api/documents/:id/versions` → `uploadNewVersion` + `canAccessFolder(WRITE)`
  - [x] `GET /api/documents/:id/versions` → `getVersions` + `canAccessFolder(READ)`
  - [x] `GET /api/documents/:id/versions/:versionId/download` → `getVersionDownloadUrl` + `canAccessFolder(READ)`
  - [x] `POST /api/documents/:id/versions/:versionId/restore` → `restoreVersion` + `canAccessFolder(WRITE)`

- [x] **Task 5: Mettre à jour le service documents** (AC: 9)
  - [x] Modifier `getDocumentById` pour inclure la version courante
  - [x] Modifier `getDownloadUrl` pour retourner l'URL de la version courante

- [x] **Task 6: Écrire les tests** (AC: 10)
  - [x] Tester upload nouvelle version
  - [x] Vérifier auto-incrément du numéro de version
  - [x] Tester listing des versions
  - [x] Tester téléchargement version spécifique
  - [x] Tester restauration d'une ancienne version
  - [x] Vérifier que toutes les versions sont conservées

## Dev Notes

### Structure des fichiers à créer/modifier

```
prisma/
  schema.prisma              # Ajouter DocumentVersion, modifier Document

packages/shared/src/
  types/version.types.ts     # Nouveau

apps/api/src/
  modules/documents/
    versions.service.ts      # Nouveau
    documents.routes.ts      # Ajouter routes versions
```

### Schéma Prisma suggéré

```prisma
model Document {
  id               String            @id @default(cuid())
  name             String
  mimeType         String
  size             Int
  storagePath      String            @unique
  folderId         String
  folder           Folder            @relation(fields: [folderId], references: [id])
  uploadedById     String
  uploadedBy       User              @relation(fields: [uploadedById], references: [id])
  currentVersionId String?           @unique
  currentVersion   DocumentVersion?  @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  versions         DocumentVersion[] @relation("DocumentVersions")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@map("documents")
}

model DocumentVersion {
  id              String    @id @default(cuid())
  documentId      String
  document        Document  @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  versionNumber   Int
  storagePath     String    @unique
  size            Int
  uploadedById    String
  uploadedBy      User      @relation(fields: [uploadedById], references: [id])
  createdAt       DateTime  @default(now())

  currentFor      Document? @relation("CurrentVersion")

  @@unique([documentId, versionNumber])
  @@map("document_versions")
}
```

### Logique d'upload nouvelle version

```typescript
async function uploadNewVersion(documentId: string, file: Express.Multer.File, userId: string) {
  const document = await prisma.document.findUnique({ where: { id: documentId } });
  if (!document) throw new NotFoundError('Document');

  // 1. Calculer le prochain numéro de version
  const lastVersion = await prisma.documentVersion.findFirst({
    where: { documentId },
    orderBy: { versionNumber: 'desc' },
  });
  const nextVersionNumber = (lastVersion?.versionNumber ?? 0) + 1;

  // 2. Uploader le fichier
  const storagePath = await storageService.uploadFile(file, document.folderId, `v${nextVersionNumber}`);

  // 3. Créer la version en DB
  const version = await prisma.documentVersion.create({
    data: {
      documentId,
      versionNumber: nextVersionNumber,
      storagePath,
      size: file.size,
      uploadedById: userId,
    },
  });

  // 4. Mettre à jour le document avec la nouvelle version courante
  await prisma.document.update({
    where: { id: documentId },
    data: {
      currentVersionId: version.id,
      size: file.size,
      updatedAt: new Date(),
    },
  });

  return version;
}
```

### Logique de restauration

```typescript
async function restoreVersion(documentId: string, versionId: string) {
  const version = await prisma.documentVersion.findFirst({
    where: { id: versionId, documentId },
  });
  if (!version) throw new NotFoundError('Version');

  // Simplement mettre à jour currentVersionId
  // La restauration ne crée pas de nouvelle version
  await prisma.document.update({
    where: { id: documentId },
    data: {
      currentVersionId: versionId,
      size: version.size,
      updatedAt: new Date(),
    },
  });

  return version;
}
```

### Storage Path pour les versions

```
/org/{folderId}/{uuid}_{filename}           # Document original (v1)
/org/{folderId}/{uuid}_v2_{filename}        # Version 2
/org/{folderId}/{uuid}_v3_{filename}        # Version 3
```

### Coding Standards

- Conserver TOUTES les versions (pas de purge automatique pour le MVP)
- Le téléchargement par défaut retourne toujours la version courante
- La restauration ne supprime pas la version actuelle (elle devient juste une version historique)

## Testing

### Cas de test requis

1. **Upload version**
   - Upload v2 sur document existant → versionNumber = 2
   - Upload v3 → versionNumber = 3
   - currentVersionId mis à jour

2. **Listing**
   - GET versions → liste ordonnée par versionNumber desc
   - Inclut toutes les versions (v1, v2, v3...)

3. **Téléchargement**
   - GET download version spécifique → URL signée correcte
   - GET download document → URL de la version courante

4. **Restauration**
   - POST restore v1 quand v3 est courante → currentVersionId = v1.id
   - v3 reste dans la liste des versions
   - Taille du document mise à jour

5. **Permissions**
   - Upload version requiert WRITE
   - Listing/téléchargement requiert READ

## Dependencies

- **Requires**: Story 2.3 (Document Upload), Story 2.4 (Document Operations)
- **Blocks**: Story 2.9 (UI Document Details)

## QA Results

**Gate Decision: PASS**

### Acceptance Criteria Validation

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | DocumentVersion schema | ✅ PASS | prisma/schema.prisma |
| 2 | currentVersionId on Document | ✅ PASS | prisma/schema.prisma |
| 3 | POST /:id/versions | ✅ PASS | documents.routes.ts |
| 4 | Auto-increment version | ✅ PASS | getNextVersionNumber() |
| 5 | GET /:id/versions | ✅ PASS | getVersions endpoint |
| 6 | GET /:id/versions/:vId/download | ✅ PASS | getVersionDownloadUrl |
| 7 | Restore version | ✅ PASS | restoreVersion endpoint |
| 8 | Keep all versions | ✅ PASS | No auto-delete logic |
| 9 | Current version default | ✅ PASS | currentVersionId tracking |
| 10 | Tests | ✅ PASS | 192 tests passing |

### Test Results
- **Total Tests**: 192 passed
- **Test Suites**: 15 passed
- **Lint**: Pass (1 expected warning)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes
- Created DocumentVersion Prisma model with relations to Document and User
- Added currentVersionId field to Document for tracking current version
- Implemented versions.service.ts with all versioning operations
- Implemented versions.controller.ts for HTTP handlers
- Added 4 version routes to documents.routes.ts
- Created shared types and validators for versions
- All 192 tests passing
- Lint passes with only expected console warning

### File List
**New Files:**
- `apps/api/src/modules/documents/versions.service.ts` - Version business logic
- `apps/api/src/modules/documents/versions.controller.ts` - HTTP handlers
- `packages/shared/src/types/version.types.ts` - Version types
- `packages/shared/src/validators/version.validators.ts` - Zod schemas

**Modified Files:**
- `prisma/schema.prisma` - Added DocumentVersion model, updated Document
- `apps/api/src/modules/documents/documents.routes.ts` - Added version routes
- `apps/api/src/modules/documents/index.ts` - Exported versions module
- `packages/shared/src/types/index.ts` - Exported version types
- `packages/shared/src/validators/index.ts` - Exported version validators

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
| 2026-01-24 | 1.1 | Implémentation complète - tous les tests passent | Dev Agent (James) |
