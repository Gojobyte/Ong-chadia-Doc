# Story 2.2: Folder Permissions API

## Status

Draft

## Story

**As a** Super-Admin ou Staff,
**I want** définir les permissions d'accès sur chaque dossier,
**so that** je puisse contrôler qui peut voir ou modifier les documents sensibles.

## Acceptance Criteria

1. Schéma Prisma `FolderPermission` : id, folderId, role (enum), permission (READ/WRITE/ADMIN)
2. Permissions héritées : un sous-dossier hérite des permissions du parent par défaut
3. Override possible : permissions spécifiques sur un sous-dossier remplacent l'héritage
4. Endpoint `GET /api/folders/:id/permissions` listant les permissions du dossier
5. Endpoint `POST /api/folders/:id/permissions` ajoutant une permission (Super-Admin/Staff only)
6. Endpoint `DELETE /api/folders/:id/permissions/:permId` supprimant une permission
7. Logique d'accès : Super-Admin a accès à tout, Staff selon permissions, Contributor/Guest restreints
8. Middleware `canAccessFolder(permission)` vérifiant l'accès avant toute opération
9. Tests couvrant tous les cas d'héritage et d'override
10. Documentation des règles de permissions

## Tasks / Subtasks

- [ ] **Task 1: Créer les enums et types partagés** (AC: 1)
  - [ ] Ajouter enum `Permission` (READ, WRITE, ADMIN) dans `packages/shared/src/types/permission.types.ts`
  - [ ] Ajouter enum `Role` (SUPER_ADMIN, STAFF, CONTRIBUTOR, GUEST) si non existant
  - [ ] Créer `FolderPermissionDto`, `CreatePermissionDto`
  - [ ] Créer validateurs Zod correspondants

- [ ] **Task 2: Créer le schéma Prisma FolderPermission** (AC: 1)
  - [ ] Ajouter le modèle `FolderPermission` dans `prisma/schema.prisma`
  - [ ] Définir les champs : id, folderId (relation), role (enum), permission (enum)
  - [ ] Ajouter contrainte unique sur (folderId, role)
  - [ ] Créer et exécuter la migration

- [ ] **Task 3: Créer le service permissions** (AC: 2-7)
  - [ ] Créer `apps/api/src/modules/folders/permissions.service.ts`
  - [ ] Implémenter `getFolderPermissions(folderId)` - permissions du dossier
  - [ ] Implémenter `getEffectivePermissions(folderId)` - avec héritage
  - [ ] Implémenter `addPermission(folderId, role, permission)`
  - [ ] Implémenter `removePermission(permissionId)`
  - [ ] Implémenter `canAccessFolder(userId, folderId, requiredPermission)` - logique complète

- [ ] **Task 4: Créer le middleware canAccessFolder** (AC: 8)
  - [ ] Créer `apps/api/src/middleware/folder-access.middleware.ts`
  - [ ] Middleware factory: `canAccessFolder(permission: Permission)`
  - [ ] Vérifier le rôle de l'utilisateur
  - [ ] Super-Admin: accès total
  - [ ] Autres rôles: vérifier permissions effectives (avec héritage)
  - [ ] Retourner 403 Forbidden si accès refusé

- [ ] **Task 5: Créer le contrôleur et routes permissions** (AC: 4-6)
  - [ ] Ajouter routes dans `apps/api/src/modules/folders/folders.routes.ts`
  - [ ] `GET /api/folders/:id/permissions` - requires ADMIN ou Super-Admin
  - [ ] `POST /api/folders/:id/permissions` - requires ADMIN ou Super-Admin
  - [ ] `DELETE /api/folders/:id/permissions/:permId` - requires ADMIN ou Super-Admin

- [ ] **Task 6: Écrire les tests** (AC: 9)
  - [ ] Créer `apps/api/tests/permissions.service.test.ts`
  - [ ] Tester l'héritage des permissions (dossier enfant hérite du parent)
  - [ ] Tester l'override (permission spécifique sur enfant remplace l'héritage)
  - [ ] Tester les accès par rôle (Super-Admin, Staff, Contributor, Guest)
  - [ ] Tester le middleware canAccessFolder

- [ ] **Task 7: Documenter les règles de permissions** (AC: 10)
  - [ ] Ajouter section dans le README ou docs/api.md
  - [ ] Diagramme de la logique d'héritage

## Dev Notes

### Structure des fichiers à créer/modifier

```
prisma/
  schema.prisma              # Ajouter FolderPermission, enums

packages/shared/src/
  types/permission.types.ts  # Nouveau
  validators/permission.validators.ts  # Nouveau

apps/api/src/
  modules/folders/
    permissions.service.ts   # Nouveau
    folders.routes.ts        # Modifier - ajouter routes permissions
  middleware/
    folder-access.middleware.ts  # Nouveau
```

### Schéma Prisma suggéré

```prisma
enum Permission {
  READ
  WRITE
  ADMIN
}

enum Role {
  SUPER_ADMIN
  STAFF
  CONTRIBUTOR
  GUEST
}

model FolderPermission {
  id         String     @id @default(cuid())
  folderId   String
  folder     Folder     @relation(fields: [folderId], references: [id], onDelete: Cascade)
  role       Role
  permission Permission
  createdAt  DateTime   @default(now())

  @@unique([folderId, role])
  @@map("folder_permissions")
}
```

### Logique d'héritage des permissions

```typescript
async function getEffectivePermissions(folderId: string, userRole: Role): Promise<Permission | null> {
  // 1. Super-Admin a toujours accès ADMIN
  if (userRole === 'SUPER_ADMIN') return Permission.ADMIN;

  // 2. Chercher permission spécifique sur ce dossier
  const directPerm = await prisma.folderPermission.findUnique({
    where: { folderId_role: { folderId, role: userRole } }
  });
  if (directPerm) return directPerm.permission;

  // 3. Remonter la hiérarchie (héritage)
  const folder = await prisma.folder.findUnique({
    where: { id: folderId },
    select: { parentId: true }
  });
  if (folder?.parentId) {
    return getEffectivePermissions(folder.parentId, userRole);
  }

  // 4. Pas de permission trouvée
  return null;
}
```

### Hiérarchie des permissions

- `ADMIN` > `WRITE` > `READ`
- ADMIN permet tout (lecture, écriture, gestion des permissions)
- WRITE permet lecture et modification des documents
- READ permet uniquement la lecture

### Coding Standards

- Middleware doit être réutilisable sur toutes les routes liées aux dossiers/documents
- Toujours vérifier les permissions AVANT toute opération

## Testing

### Cas de test requis

1. **Héritage**
   - Dossier parent avec READ pour Staff → sous-dossier hérite READ
   - Dossier parent avec WRITE → tous les descendants héritent WRITE

2. **Override**
   - Parent avec READ, enfant avec WRITE → enfant a WRITE
   - Parent avec WRITE, enfant avec READ → enfant a READ (restriction)

3. **Accès par rôle**
   - Super-Admin accède à tout sans permission explicite
   - Staff sans permission → accès refusé
   - Staff avec READ → peut lire, pas écrire
   - Staff avec WRITE → peut lire et écrire

4. **Middleware**
   - 403 si pas de permission
   - 403 si permission insuffisante (READ quand WRITE requis)
   - 200 si permission suffisante

## Dependencies

- **Requires**: Story 2.1 (Folder Management API)
- **Blocks**: Story 2.3 (Document Upload), Story 2.4 (Document Operations)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
