# Story 2.2: Folder Permissions API

## Status

Ready for Review

## Story

**As a** Super-Admin ou Staff,
**I want** définir les permissions d'accès sur chaque dossier,
**so that** je puisse contrôler qui peut voir ou modifier les documents sensibles.

## Acceptance Criteria

1. Schéma Prisma `FolderPermission` : id, folderId, role (enum), permission (READ/WRITE/ADMIN)
2. Permissions héritées : un sous-dossier hérite des permissions du parent par défaut
3. Override possible : permissions spécifiques sur un sous-dossier remplacent l'héritage
4. Endpoint `GET /api/folders/:id/permissions` listant les permissions du dossier
5. Endpoint `POST /api/folders/:id/permissions` ajoutant une permission (Super-Admin/Staff only)
6. Endpoint `DELETE /api/folders/:id/permissions/:permId` supprimant une permission
7. Logique d'accès : Super-Admin a accès à tout, Staff selon permissions, Contributor/Guest restreints
8. Middleware `canAccessFolder(permission)` vérifiant l'accès avant toute opération
9. Tests couvrant tous les cas d'héritage et d'override
10. Documentation des règles de permissions

## Tasks / Subtasks

- [x] **Task 1: Créer les enums et types partagés** (AC: 1)
  - [x] Ajouter enum `Permission` (READ, WRITE, ADMIN) dans `packages/shared/src/types/permission.types.ts`
  - [x] Ajouter enum `Role` (SUPER_ADMIN, STAFF, CONTRIBUTOR, GUEST) - already existed in Prisma
  - [x] Créer `FolderPermissionDto`, `CreatePermissionDto`, `EffectivePermission`
  - [x] Créer validateurs Zod correspondants

- [x] **Task 2: Créer le schéma Prisma FolderPermission** (AC: 1)
  - [x] Ajouter le modèle `FolderPermission` dans `prisma/schema.prisma`
  - [x] Définir les champs : id, folderId (relation), role (enum), permission (enum)
  - [x] Ajouter contrainte unique sur (folderId, role)
  - [x] Créer et exécuter la migration avec `pnpm db:push`

- [x] **Task 3: Créer le service permissions** (AC: 2-7)
  - [x] Créer `apps/api/src/modules/folders/permissions.service.ts`
  - [x] Implémenter `getFolderPermissions(folderId)` - permissions du dossier
  - [x] Implémenter `getEffectivePermission(folderId, role)` - avec héritage récursif
  - [x] Implémenter `addPermission(folderId, data)` - avec upsert
  - [x] Implémenter `removePermission(permissionId)`
  - [x] Implémenter `canAccessFolder(userId, folderId, requiredPermission)` - logique complète
  - [x] Implémenter `checkFolderAccess()` - throws ForbiddenError if denied

- [x] **Task 4: Créer le middleware canAccessFolder** (AC: 8)
  - [x] Créer `apps/api/src/middleware/folder-access.middleware.ts`
  - [x] Middleware factory: `canAccessFolder(permission: Permission)`
  - [x] Vérifier le rôle de l'utilisateur
  - [x] Super-Admin: accès total (ADMIN permission)
  - [x] Autres rôles: vérifier permissions effectives (avec héritage)
  - [x] Retourner 403 Forbidden si accès refusé
  - [x] Pre-configured middlewares: requireRead, requireWrite, requireAdmin

- [x] **Task 5: Créer le contrôleur et routes permissions** (AC: 4-6)
  - [x] Créer `apps/api/src/modules/folders/permissions.controller.ts`
  - [x] Ajouter routes dans `apps/api/src/modules/folders/folders.routes.ts`
  - [x] `GET /api/folders/:id/permissions` - requires Staff+ role
  - [x] `POST /api/folders/:id/permissions` - requires Staff+ role
  - [x] `DELETE /api/folders/:id/permissions/:permId` - requires Staff+ role

- [x] **Task 6: Écrire les tests** (AC: 9)
  - [x] Créer `apps/api/tests/unit/permissions.service.test.ts` (21 tests)
  - [x] Créer `apps/api/tests/integration/permissions.api.test.ts` (7 tests)
  - [x] Tester l'héritage des permissions (dossier enfant hérite du parent)
  - [x] Tester l'override (permission spécifique sur enfant remplace l'héritage)
  - [x] Tester les accès par rôle (Super-Admin, Staff, Contributor, Guest)
  - [x] Tester la hiérarchie des permissions (ADMIN > WRITE > READ)

- [x] **Task 7: Documenter les règles de permissions** (AC: 10)
  - [x] Documentation dans le service avec JSDoc comments
  - [x] Permission hierarchy documented in code: ADMIN > WRITE > READ

## Dev Notes

### Structure des fichiers à créer/modifier

```
prisma/
  schema.prisma              # Ajouter FolderPermission, enums

packages/shared/src/
  types/permission.types.ts  # Nouveau
  validators/permission.validators.ts  # Nouveau

apps/api/src/
  modules/folders/
    permissions.service.ts   # Nouveau
    folders.routes.ts        # Modifier - ajouter routes permissions
  middleware/
    folder-access.middleware.ts  # Nouveau
```

### Schéma Prisma suggéré

```prisma
enum Permission {
  READ
  WRITE
  ADMIN
}

enum Role {
  SUPER_ADMIN
  STAFF
  CONTRIBUTOR
  GUEST
}

model FolderPermission {
  id         String     @id @default(cuid())
  folderId   String
  folder     Folder     @relation(fields: [folderId], references: [id], onDelete: Cascade)
  role       Role
  permission Permission
  createdAt  DateTime   @default(now())

  @@unique([folderId, role])
  @@map("folder_permissions")
}
```

### Logique d'héritage des permissions

```typescript
async function getEffectivePermissions(folderId: string, userRole: Role): Promise<Permission | null> {
  // 1. Super-Admin a toujours accès ADMIN
  if (userRole === 'SUPER_ADMIN') return Permission.ADMIN;

  // 2. Chercher permission spécifique sur ce dossier
  const directPerm = await prisma.folderPermission.findUnique({
    where: { folderId_role: { folderId, role: userRole } }
  });
  if (directPerm) return directPerm.permission;

  // 3. Remonter la hiérarchie (héritage)
  const folder = await prisma.folder.findUnique({
    where: { id: folderId },
    select: { parentId: true }
  });
  if (folder?.parentId) {
    return getEffectivePermissions(folder.parentId, userRole);
  }

  // 4. Pas de permission trouvée
  return null;
}
```

### Hiérarchie des permissions

- `ADMIN` > `WRITE` > `READ`
- ADMIN permet tout (lecture, écriture, gestion des permissions)
- WRITE permet lecture et modification des documents
- READ permet uniquement la lecture

### Coding Standards

- Middleware doit être réutilisable sur toutes les routes liées aux dossiers/documents
- Toujours vérifier les permissions AVANT toute opération

## Testing

### Cas de test requis

1. **Héritage**
   - Dossier parent avec READ pour Staff → sous-dossier hérite READ
   - Dossier parent avec WRITE → tous les descendants héritent WRITE

2. **Override**
   - Parent avec READ, enfant avec WRITE → enfant a WRITE
   - Parent avec WRITE, enfant avec READ → enfant a READ (restriction)

3. **Accès par rôle**
   - Super-Admin accède à tout sans permission explicite
   - Staff sans permission → accès refusé
   - Staff avec READ → peut lire, pas écrire
   - Staff avec WRITE → peut lire et écrire

4. **Middleware**
   - 403 si pas de permission
   - 403 si permission insuffisante (READ quand WRITE requis)
   - 200 si permission suffisante

## Dependencies

- **Requires**: Story 2.1 (Folder Management API)
- **Blocks**: Story 2.3 (Document Upload), Story 2.4 (Document Operations)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
| 2026-01-24 | 1.1 | Implémentation complète des 7 tâches | Dev Agent (James) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**New Files Created:**

- `apps/api/src/modules/folders/permissions.service.ts` - Permission service with inheritance logic
- `apps/api/src/modules/folders/permissions.controller.ts` - Permission route handlers
- `apps/api/src/modules/folders/permissions.validators.ts` - Zod validators for permissions
- `apps/api/src/middleware/folder-access.middleware.ts` - Folder access control middleware
- `apps/api/tests/unit/permissions.service.test.ts` - Unit tests (21 test cases)
- `apps/api/tests/integration/permissions.api.test.ts` - Integration tests (7 test cases)
- `packages/shared/src/types/permission.types.ts` - Shared permission types
- `packages/shared/src/validators/permission.validators.ts` - Shared Zod schemas

**Modified Files:**

- `prisma/schema.prisma` - Added Permission enum and FolderPermission model
- `apps/api/src/modules/folders/folders.routes.ts` - Added permission routes
- `apps/api/src/modules/folders/index.ts` - Added permission exports
- `packages/shared/src/types/index.ts` - Added permission types export
- `packages/shared/src/validators/index.ts` - Added permission validators export

### Debug Log References

None - implementation was straightforward.

### Completion Notes

- All 7 tasks completed successfully
- 164 tests passing (28 permission-specific tests added)
- Permission system features:
  - Recursive inheritance from parent folders
  - Override capability (child permission replaces inherited)
  - Permission hierarchy: ADMIN > WRITE > READ
  - Super Admin bypass (always has ADMIN)
  - Middleware for route protection (requireRead, requireWrite, requireAdmin)
- Routes restricted to Staff+ role for permission management

---

## QA Results

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is excellent with clean architecture:

- Recursive permission inheritance works correctly
- Permission hierarchy (ADMIN > WRITE > READ) properly enforced
- Middleware factory pattern allows flexible route protection
- Upsert used for safe permission updates (create or update)

### Refactoring Performed

None required. Code meets all quality standards.

### Compliance Check

- Coding Standards: ✓ Proper typing, error handling, naming conventions
- Project Structure: ✓ Files in correct locations
- Testing Strategy: ✓ 28 tests covering all acceptance criteria
- All ACs Met: ✓ All 10 acceptance criteria fully implemented

### Improvements Checklist

- [x] Permission inheritance from parent folders
- [x] Override capability for child folders
- [x] Permission hierarchy (ADMIN > WRITE > READ)
- [x] Super Admin bypass (always ADMIN)
- [x] Middleware for route protection
- [x] Staff+ role required for permission management
- [x] Comprehensive unit and integration tests
- [ ] Consider caching effective permissions (future optimization)
- [ ] Add audit logging for permission changes (future story)

### Security Review

✓ **PASS** - Permission system properly implemented:

- All permission routes require Staff+ role
- Super Admin has full access
- Permission checks prevent unauthorized access
- Recursive inheritance prevents permission escalation

### Performance Considerations

✓ **PASS** - Acceptable performance:

- Recursive queries for inheritance (acceptable for typical folder depths)
- Could optimize with PostgreSQL CTE for deep hierarchies if needed

### Files Modified During Review

None.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.2-folder-permissions-api.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, 164 total tests passing.
