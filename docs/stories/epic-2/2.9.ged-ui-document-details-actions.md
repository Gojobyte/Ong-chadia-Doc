# Story 2.9: GED UI - Document Details & Actions

## Status

Complete

## Story

**As a** utilisateur,
**I want** voir les détails d'un document et effectuer des actions,
**so that** je puisse télécharger, renommer, ou gérer les versions.

## Acceptance Criteria

1. Clic sur un document ouvre un panneau de détails (drawer ou modal)
2. Affichage : nom, type, taille, date création, uploadé par, dossier parent
3. Prévisualisation inline pour PDF et images (si possible)
4. Bouton "Télécharger" récupérant le fichier
5. Bouton "Renommer" avec formulaire inline
6. Bouton "Déplacer" ouvrant un sélecteur de dossier destination
7. Bouton "Supprimer" avec confirmation
8. Section "Versions" listant l'historique des versions
9. Bouton "Uploader nouvelle version"
10. Lien de chaque version pour télécharger une version spécifique

## Tasks / Subtasks

- [x] **Task 1: Créer le hook useDocument** (AC: 1-2, 8)
  - [x] Hooks ajoutés dans `apps/web/src/hooks/useDocuments.ts`
  - [x] Implémenter `useDocument(documentId)` - détails avec versions
  - [x] Implémenter mutations : rename, move, delete, uploadVersion

- [x] **Task 2: Étendre le service documents** (AC: 4-7, 9-10)
  - [x] Ajouter `getDocument(id)` - avec versions
  - [x] Ajouter `getDownloadUrl(id)` - URL signée
  - [x] Ajouter `getVersionDownloadUrl(documentId, versionId)`
  - [x] Ajouter `update(id, data)` - pour rename/move
  - [x] Ajouter `delete(id)`
  - [x] Ajouter `uploadVersion(documentId, file)` et version methods

- [x] **Task 3: Créer le composant DocumentDrawer** (AC: 1-2)
  - [x] Créer `apps/web/src/components/documents/DocumentDrawer.tsx`
  - [x] Utiliser Sheet component (drawer latéral)
  - [x] Afficher toutes les métadonnées
  - [x] Gérer l'état open/close

- [x] **Task 4: Créer la section DocumentInfo** (AC: 2)
  - [x] Info intégrée dans DocumentDrawer.tsx
  - [x] Liste des propriétés avec labels et icônes
  - [x] Formatage des valeurs (taille, date)

- [x] **Task 5: Implémenter la prévisualisation** (AC: 3)
  - [x] Créer `apps/web/src/components/documents/DocumentPreview.tsx`
  - [x] Pour images : `<img>` avec URL signée
  - [x] Pour PDF : `<iframe>` avec URL signée
  - [x] Fallback : icône du type de fichier

- [x] **Task 6: Créer les boutons d'action** (AC: 4-7)
  - [x] Actions intégrées dans DocumentDrawer.tsx
  - [x] Bouton Télécharger → `window.open(signedUrl)`
  - [x] Bouton Renommer → ouvre RenameDocumentModal
  - [x] Bouton Déplacer → ouvre MoveDocumentModal
  - [x] Bouton Supprimer → ouvre DeleteDocumentModal

- [x] **Task 7: Créer le formulaire de renommage** (AC: 5)
  - [x] Réutilisé `RenameDocumentModal.tsx` existant
  - [x] Input avec validation React Hook Form + Zod

- [x] **Task 8: Créer le modal de déplacement** (AC: 6)
  - [x] Créer `apps/web/src/components/documents/MoveDocumentModal.tsx`
  - [x] Afficher l'arbre des dossiers avec expansion récursive
  - [x] Griser le dossier actuel
  - [x] Bouton confirmer

- [x] **Task 9: Créer la section versions** (AC: 8-10)
  - [x] Créer `apps/web/src/components/documents/VersionHistory.tsx`
  - [x] Liste des versions avec : numéro, date, taille
  - [x] Badge "Courante" sur la version active
  - [x] Bouton télécharger pour chaque version
  - [x] Bouton "Restaurer" pour les anciennes versions

- [x] **Task 10: Créer l'upload de nouvelle version** (AC: 9)
  - [x] Ajouter bouton "Nouvelle version" dans VersionHistory
  - [x] Input file avec upload XHR
  - [x] Rafraîchir la liste après succès via query invalidation

## Dev Notes

### Structure des fichiers à créer

```
apps/web/src/
  components/documents/
    DocumentDrawer.tsx         # Nouveau
    DocumentInfo.tsx           # Nouveau
    DocumentPreview.tsx        # Nouveau
    DocumentActions.tsx        # Nouveau
    RenameForm.tsx             # Nouveau
    MoveDocumentModal.tsx      # Nouveau
    VersionHistory.tsx         # Nouveau
  hooks/
    useDocument.ts             # Nouveau
```

### Composant DocumentDrawer

```tsx
// DocumentDrawer.tsx
interface DocumentDrawerProps {
  documentId: string | null;
  open: boolean;
  onClose: () => void;
}

export function DocumentDrawer({ documentId, open, onClose }: DocumentDrawerProps) {
  const { data: document, isLoading } = useDocument(documentId);

  return (
    <Sheet open={open} onOpenChange={onClose}>
      <SheetContent className="w-[400px] sm:w-[540px]">
        <SheetHeader>
          <SheetTitle>{document?.name}</SheetTitle>
        </SheetHeader>

        {isLoading ? (
          <DocumentDrawerSkeleton />
        ) : document ? (
          <div className="space-y-6 mt-4">
            <DocumentPreview document={document} />
            <DocumentInfo document={document} />
            <DocumentActions document={document} onClose={onClose} />
            <Separator />
            <VersionHistory document={document} />
          </div>
        ) : null}
      </SheetContent>
    </Sheet>
  );
}
```

### Hook useDocument

```typescript
// hooks/useDocument.ts
export function useDocument(documentId: string | null) {
  return useQuery({
    queryKey: ['document', documentId],
    queryFn: () => documentsService.getDocument(documentId!),
    enabled: !!documentId,
  });
}

export function useRenameDocument() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, name }: { id: string; name: string }) =>
      documentsService.renameDocument(id, name),
    onSuccess: (_, { id }) => {
      queryClient.invalidateQueries({ queryKey: ['document', id] });
      queryClient.invalidateQueries({ queryKey: ['documents'] });
      toast.success('Document renommé');
    },
  });
}

export function useDeleteDocument() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: documentsService.deleteDocument,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['documents'] });
      toast.success('Document supprimé');
    },
  });
}
```

### Prévisualisation des fichiers

```tsx
// DocumentPreview.tsx
export function DocumentPreview({ document }: { document: Document }) {
  const { data: url } = useQuery({
    queryKey: ['document', document.id, 'preview-url'],
    queryFn: () => documentsService.getDownloadUrl(document.id),
  });

  if (!url) return <Skeleton className="h-48" />;

  // Images
  if (document.mimeType.startsWith('image/')) {
    return (
      <div className="border rounded-lg overflow-hidden">
        <img src={url} alt={document.name} className="max-h-48 mx-auto" />
      </div>
    );
  }

  // PDF
  if (document.mimeType === 'application/pdf') {
    return (
      <div className="border rounded-lg overflow-hidden h-48">
        <iframe src={url} className="w-full h-full" title={document.name} />
      </div>
    );
  }

  // Fallback
  return (
    <div className="border rounded-lg p-8 flex flex-col items-center justify-center">
      <FileIcon mimeType={document.mimeType} className="w-16 h-16 text-muted-foreground" />
      <span className="mt-2 text-sm text-muted-foreground">Aperçu non disponible</span>
    </div>
  );
}
```

### Section Versions

```tsx
// VersionHistory.tsx
export function VersionHistory({ document }: { document: DocumentWithVersions }) {
  const uploadVersion = useUploadVersion();

  return (
    <div className="space-y-3">
      <div className="flex justify-between items-center">
        <h3 className="font-medium">Historique des versions</h3>
        <UploadVersionButton documentId={document.id} />
      </div>

      <div className="space-y-2">
        {document.versions.map((version) => (
          <div
            key={version.id}
            className="flex items-center justify-between p-2 border rounded"
          >
            <div className="flex items-center gap-2">
              <span className="font-mono text-sm">v{version.versionNumber}</span>
              {version.id === document.currentVersionId && (
                <Badge variant="secondary">Courante</Badge>
              )}
            </div>
            <div className="text-sm text-muted-foreground">
              {formatDate(version.createdAt)}
            </div>
            <div className="flex gap-2">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => downloadVersion(document.id, version.id)}
              >
                <DownloadIcon className="w-4 h-4" />
              </Button>
              {version.id !== document.currentVersionId && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => restoreVersion(document.id, version.id)}
                >
                  Restaurer
                </Button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### Intégration avec DocumentList

```tsx
// Dans DocumentList.tsx ou DocumentRow.tsx
const [selectedDocId, setSelectedDocId] = useState<string | null>(null);

// ...
<DocumentRow
  document={doc}
  onClick={() => setSelectedDocId(doc.id)}
/>

<DocumentDrawer
  documentId={selectedDocId}
  open={!!selectedDocId}
  onClose={() => setSelectedDocId(null)}
/>
```

## Testing

### Tests recommandés

1. **DocumentDrawer**
   - S'ouvre avec les bonnes données
   - Se ferme au clic extérieur

2. **Actions**
   - Télécharger ouvre l'URL
   - Renommer met à jour le nom
   - Supprimer avec confirmation

3. **Versions**
   - Liste toutes les versions
   - Badge "Courante" correctement placé
   - Restauration change la version courante

## Dependencies

- **Requires**: Story 2.4 (Operations API), Story 2.5 (Versioning API), Story 2.8 (Document List)
- **Blocks**: Story 2.10 (Sharing)

## Dev Agent Record

### File List

| File | Action |
|------|--------|
| `apps/web/src/services/documents.service.ts` | Modified - Added version methods (getVersions, uploadVersion, getVersionDownloadUrl, restoreVersion) |
| `apps/web/src/hooks/useDocuments.ts` | Modified - Added version hooks (useDocumentVersions, useUploadVersion, useRestoreVersion) |
| `apps/web/src/components/ui/sheet.tsx` | Created - Sheet component for drawer |
| `apps/web/src/components/ui/separator.tsx` | Created - Separator component |
| `apps/web/src/components/documents/DocumentDrawer.tsx` | Created - Main detail drawer with info, actions, versions |
| `apps/web/src/components/documents/DocumentPreview.tsx` | Created - Image/PDF preview with fallback |
| `apps/web/src/components/documents/VersionHistory.tsx` | Created - Version list with upload/restore |
| `apps/web/src/components/documents/MoveDocumentModal.tsx` | Created - Folder selector for moving documents |
| `apps/web/src/components/documents/DocumentList.tsx` | Modified - Added drawer integration with onClick |
| `apps/web/src/components/documents/DocumentRow.tsx` | Modified - Added onClick support |
| `apps/web/src/components/documents/index.ts` | Modified - Added exports |

### Completion Notes

- Implemented DocumentDrawer with full detail view including preview, info, and actions
- DocumentPreview supports image and PDF inline preview with fallback for other types
- VersionHistory displays version list with download, restore, and upload new version
- MoveDocumentModal shows recursive folder tree for destination selection
- All actions (download, rename, move, delete) integrated via existing modals
- Drawer opens on document row click in DocumentList

### Agent Model Used

Claude Opus 4.5

## PO Review

### Review Date: 2026-01-24

### Reviewed By: Sarah (Product Owner)

### Business Value Assessment

| Critère | Status | Commentaire |
|---------|--------|-------------|
| Valeur métier livrée | ✅ | Vue détaillée des documents avec toutes les actions |
| Besoins utilisateur satisfaits | ✅ | Prévisualisation, téléchargement, versioning |
| Cohérence avec objectifs Epic | ✅ | Interface complète de gestion documentaire |

### Acceptance Criteria - Business Validation

- ✅ AC1-2: Drawer avec métadonnées complètes
- ✅ AC3: Prévisualisation inline (images, PDF)
- ✅ AC4-7: Actions complètes (télécharger, renommer, déplacer, supprimer)
- ✅ AC8-10: Gestion des versions avec historique et restauration

### UX Value for ONG

- ✅ Drawer latéral pour garder le contexte
- ✅ Prévisualisation sans téléchargement
- ✅ Historique des versions accessible
- ✅ Actions groupées dans une interface cohérente

### PO Gate Decision

**APPROVED** - Le drawer de détails offre une vue complète des documents avec toutes les actions nécessaires à la gestion quotidienne.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
| 2026-01-24 | 1.1 | Implementation complete | Dev Agent (James) |
