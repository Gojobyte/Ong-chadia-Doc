# Story 2.9: GED UI - Document Details & Actions

## Status

Approved

## Story

**As a** utilisateur,
**I want** voir les détails d'un document et effectuer des actions,
**so that** je puisse télécharger, renommer, ou gérer les versions.

## Acceptance Criteria

1. Clic sur un document ouvre un panneau de détails (drawer ou modal)
2. Affichage : nom, type, taille, date création, uploadé par, dossier parent
3. Prévisualisation inline pour PDF et images (si possible)
4. Bouton "Télécharger" récupérant le fichier
5. Bouton "Renommer" avec formulaire inline
6. Bouton "Déplacer" ouvrant un sélecteur de dossier destination
7. Bouton "Supprimer" avec confirmation
8. Section "Versions" listant l'historique des versions
9. Bouton "Uploader nouvelle version"
10. Lien de chaque version pour télécharger une version spécifique

## Tasks / Subtasks

- [ ] **Task 1: Créer le hook useDocument** (AC: 1-2, 8)
  - [ ] Créer `apps/web/src/hooks/useDocument.ts`
  - [ ] Implémenter `useDocument(documentId)` - détails avec versions
  - [ ] Implémenter mutations : rename, move, delete, uploadVersion

- [ ] **Task 2: Étendre le service documents** (AC: 4-7, 9-10)
  - [ ] Ajouter `getDocument(id)` - avec versions
  - [ ] Ajouter `downloadDocument(id)` - URL signée
  - [ ] Ajouter `downloadVersion(documentId, versionId)`
  - [ ] Ajouter `renameDocument(id, name)`
  - [ ] Ajouter `moveDocument(id, targetFolderId)`
  - [ ] Ajouter `deleteDocument(id)`
  - [ ] Ajouter `uploadVersion(documentId, file)`

- [ ] **Task 3: Créer le composant DocumentDrawer** (AC: 1-2)
  - [ ] Créer `apps/web/src/components/documents/DocumentDrawer.tsx`
  - [ ] Utiliser Sheet de shadcn/ui (drawer latéral)
  - [ ] Afficher toutes les métadonnées
  - [ ] Gérer l'état open/close

- [ ] **Task 4: Créer la section DocumentInfo** (AC: 2)
  - [ ] Créer `apps/web/src/components/documents/DocumentInfo.tsx`
  - [ ] Liste des propriétés avec labels
  - [ ] Icône du type de fichier
  - [ ] Formatage des valeurs (taille, date)

- [ ] **Task 5: Implémenter la prévisualisation** (AC: 3)
  - [ ] Créer `apps/web/src/components/documents/DocumentPreview.tsx`
  - [ ] Pour images : `<img>` avec URL signée
  - [ ] Pour PDF : `<iframe>` ou lib comme `react-pdf`
  - [ ] Fallback : icône du type de fichier

- [ ] **Task 6: Créer les boutons d'action** (AC: 4-7)
  - [ ] Créer `apps/web/src/components/documents/DocumentActions.tsx`
  - [ ] Bouton Télécharger → `window.open(signedUrl)`
  - [ ] Bouton Renommer → ouvre formulaire inline
  - [ ] Bouton Déplacer → ouvre modal sélecteur de dossier
  - [ ] Bouton Supprimer → ouvre modal de confirmation

- [ ] **Task 7: Créer le formulaire de renommage** (AC: 5)
  - [ ] Créer `apps/web/src/components/documents/RenameForm.tsx`
  - [ ] Input inline avec boutons Save/Cancel
  - [ ] Validation Zod

- [ ] **Task 8: Créer le modal de déplacement** (AC: 6)
  - [ ] Créer `apps/web/src/components/documents/MoveDocumentModal.tsx`
  - [ ] Afficher l'arbre des dossiers pour sélection
  - [ ] Griser le dossier actuel
  - [ ] Bouton confirmer

- [ ] **Task 9: Créer la section versions** (AC: 8-10)
  - [ ] Créer `apps/web/src/components/documents/VersionHistory.tsx`
  - [ ] Liste des versions avec : numéro, date, uploadé par, taille
  - [ ] Badge "Courante" sur la version active
  - [ ] Lien télécharger pour chaque version
  - [ ] Bouton "Restaurer" pour les anciennes versions

- [ ] **Task 10: Créer l'upload de nouvelle version** (AC: 9)
  - [ ] Ajouter bouton "Nouvelle version" dans VersionHistory
  - [ ] Réutiliser logique d'upload avec progression
  - [ ] Rafraîchir la liste après succès

## Dev Notes

### Structure des fichiers à créer

```
apps/web/src/
  components/documents/
    DocumentDrawer.tsx         # Nouveau
    DocumentInfo.tsx           # Nouveau
    DocumentPreview.tsx        # Nouveau
    DocumentActions.tsx        # Nouveau
    RenameForm.tsx             # Nouveau
    MoveDocumentModal.tsx      # Nouveau
    VersionHistory.tsx         # Nouveau
  hooks/
    useDocument.ts             # Nouveau
```

### Composant DocumentDrawer

```tsx
// DocumentDrawer.tsx
interface DocumentDrawerProps {
  documentId: string | null;
  open: boolean;
  onClose: () => void;
}

export function DocumentDrawer({ documentId, open, onClose }: DocumentDrawerProps) {
  const { data: document, isLoading } = useDocument(documentId);

  return (
    <Sheet open={open} onOpenChange={onClose}>
      <SheetContent className="w-[400px] sm:w-[540px]">
        <SheetHeader>
          <SheetTitle>{document?.name}</SheetTitle>
        </SheetHeader>

        {isLoading ? (
          <DocumentDrawerSkeleton />
        ) : document ? (
          <div className="space-y-6 mt-4">
            <DocumentPreview document={document} />
            <DocumentInfo document={document} />
            <DocumentActions document={document} onClose={onClose} />
            <Separator />
            <VersionHistory document={document} />
          </div>
        ) : null}
      </SheetContent>
    </Sheet>
  );
}
```

### Hook useDocument

```typescript
// hooks/useDocument.ts
export function useDocument(documentId: string | null) {
  return useQuery({
    queryKey: ['document', documentId],
    queryFn: () => documentsService.getDocument(documentId!),
    enabled: !!documentId,
  });
}

export function useRenameDocument() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: ({ id, name }: { id: string; name: string }) =>
      documentsService.renameDocument(id, name),
    onSuccess: (_, { id }) => {
      queryClient.invalidateQueries({ queryKey: ['document', id] });
      queryClient.invalidateQueries({ queryKey: ['documents'] });
      toast.success('Document renommé');
    },
  });
}

export function useDeleteDocument() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: documentsService.deleteDocument,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['documents'] });
      toast.success('Document supprimé');
    },
  });
}
```

### Prévisualisation des fichiers

```tsx
// DocumentPreview.tsx
export function DocumentPreview({ document }: { document: Document }) {
  const { data: url } = useQuery({
    queryKey: ['document', document.id, 'preview-url'],
    queryFn: () => documentsService.getDownloadUrl(document.id),
  });

  if (!url) return <Skeleton className="h-48" />;

  // Images
  if (document.mimeType.startsWith('image/')) {
    return (
      <div className="border rounded-lg overflow-hidden">
        <img src={url} alt={document.name} className="max-h-48 mx-auto" />
      </div>
    );
  }

  // PDF
  if (document.mimeType === 'application/pdf') {
    return (
      <div className="border rounded-lg overflow-hidden h-48">
        <iframe src={url} className="w-full h-full" title={document.name} />
      </div>
    );
  }

  // Fallback
  return (
    <div className="border rounded-lg p-8 flex flex-col items-center justify-center">
      <FileIcon mimeType={document.mimeType} className="w-16 h-16 text-muted-foreground" />
      <span className="mt-2 text-sm text-muted-foreground">Aperçu non disponible</span>
    </div>
  );
}
```

### Section Versions

```tsx
// VersionHistory.tsx
export function VersionHistory({ document }: { document: DocumentWithVersions }) {
  const uploadVersion = useUploadVersion();

  return (
    <div className="space-y-3">
      <div className="flex justify-between items-center">
        <h3 className="font-medium">Historique des versions</h3>
        <UploadVersionButton documentId={document.id} />
      </div>

      <div className="space-y-2">
        {document.versions.map((version) => (
          <div
            key={version.id}
            className="flex items-center justify-between p-2 border rounded"
          >
            <div className="flex items-center gap-2">
              <span className="font-mono text-sm">v{version.versionNumber}</span>
              {version.id === document.currentVersionId && (
                <Badge variant="secondary">Courante</Badge>
              )}
            </div>
            <div className="text-sm text-muted-foreground">
              {formatDate(version.createdAt)}
            </div>
            <div className="flex gap-2">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => downloadVersion(document.id, version.id)}
              >
                <DownloadIcon className="w-4 h-4" />
              </Button>
              {version.id !== document.currentVersionId && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => restoreVersion(document.id, version.id)}
                >
                  Restaurer
                </Button>
              )}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### Intégration avec DocumentList

```tsx
// Dans DocumentList.tsx ou DocumentRow.tsx
const [selectedDocId, setSelectedDocId] = useState<string | null>(null);

// ...
<DocumentRow
  document={doc}
  onClick={() => setSelectedDocId(doc.id)}
/>

<DocumentDrawer
  documentId={selectedDocId}
  open={!!selectedDocId}
  onClose={() => setSelectedDocId(null)}
/>
```

## Testing

### Tests recommandés

1. **DocumentDrawer**
   - S'ouvre avec les bonnes données
   - Se ferme au clic extérieur

2. **Actions**
   - Télécharger ouvre l'URL
   - Renommer met à jour le nom
   - Supprimer avec confirmation

3. **Versions**
   - Liste toutes les versions
   - Badge "Courante" correctement placé
   - Restauration change la version courante

## Dependencies

- **Requires**: Story 2.4 (Operations API), Story 2.5 (Versioning API), Story 2.8 (Document List)
- **Blocks**: Story 2.10 (Sharing)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
