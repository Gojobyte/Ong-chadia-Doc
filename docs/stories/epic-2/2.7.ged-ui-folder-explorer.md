# Story 2.7: GED UI - Folder Explorer

## Status

Complete

## Story

**As a** utilisateur,
**I want** naviguer dans l'arborescence des dossiers via une interface graphique,
**so that** je puisse explorer et organiser ma structure documentaire.

## Acceptance Criteria

1. Page `/documents` avec panneau latéral d'arborescence de dossiers
2. Affichage hiérarchique des dossiers (tree view) avec expand/collapse
3. Breadcrumb montrant le chemin actuel
4. Clic sur un dossier affiche son contenu dans la zone principale
5. Menu contextuel (clic droit ou bouton "...") : Nouveau sous-dossier, Renommer, Déplacer, Supprimer
6. Modal de création de dossier avec validation du nom
7. Modal de confirmation avant suppression
8. Icônes différenciées pour dossiers selon permissions (cadenas pour restreint)
9. Drag & drop pour déplacer dossiers (optionnel, bonus)
10. État de chargement pendant les opérations

## Tasks / Subtasks

- [x] **Task 1: Créer la page /documents** (AC: 1)
  - [x] Mettre à jour `apps/web/src/pages/DocumentsPage.tsx`
  - [x] Layout avec sidebar (tree) + zone principale (contenu)
  - [x] Route déjà existante dans React Router

- [x] **Task 2: Créer le hook useFolders** (AC: 2, 4)
  - [x] Créer `apps/web/src/hooks/useFolders.ts`
  - [x] Utiliser TanStack Query pour fetch les dossiers
  - [x] Implémenter `useRootFolders()` - dossiers racine
  - [x] Implémenter `useFolderChildren(folderId)` - sous-dossiers
  - [x] Implémenter mutations : create, update, delete

- [x] **Task 3: Créer le service folders frontend** (AC: 2-7)
  - [x] Créer `apps/web/src/services/folders.service.ts`
  - [x] Implémenter appels API : getRootFolders, getFolderChildren, createFolder, updateFolder, deleteFolder
  - [x] Typage avec types partagés de `@ong-chadia/shared`

- [x] **Task 4: Créer le composant FolderTree** (AC: 2, 8)
  - [x] Créer `apps/web/src/components/documents/FolderTree.tsx`
  - [x] Affichage récursif des dossiers
  - [x] Icône folder + nom
  - [x] Bouton expand/collapse pour dossiers avec enfants
  - [x] Highlight du dossier sélectionné
  - Note: Icône cadenas pour permissions restreintes deferred (requires permission data from API)

- [x] **Task 5: Créer le composant FolderTreeItem** (AC: 2, 5, 8)
  - [x] Créer `apps/web/src/components/documents/FolderTreeItem.tsx`
  - [x] Gestion de l'état expanded/collapsed
  - [x] Bouton "..." pour menu contextuel
  - [x] Lazy loading des enfants au expand

- [x] **Task 6: Créer le composant Breadcrumb** (AC: 3)
  - [x] Créer `apps/web/src/components/documents/FolderBreadcrumb.tsx`
  - [x] Afficher le chemin : Home > Dossier Parent > Dossier Actuel
  - [x] Chaque élément cliquable pour navigation

- [x] **Task 7: Créer le menu contextuel** (AC: 5)
  - [x] Utiliser DropdownMenu de shadcn/ui
  - [x] Options : Nouveau sous-dossier, Renommer, Déplacer, Supprimer
  - Note: Permission-based disabling deferred (requires permission data from API)

- [x] **Task 8: Créer les modals** (AC: 6, 7)
  - [x] Créer `apps/web/src/components/documents/CreateFolderModal.tsx`
  - [x] Créer `apps/web/src/components/documents/RenameFolderModal.tsx`
  - [x] Créer `apps/web/src/components/documents/DeleteFolderModal.tsx`
  - [x] Créer `apps/web/src/components/documents/MoveFolderModal.tsx`
  - [x] Utiliser Dialog de shadcn/ui
  - [x] Validation du nom avec React Hook Form + Zod

- [x] **Task 9: Implémenter les états de chargement** (AC: 10)
  - [x] Loader spinner pour l'arbre initial
  - [x] Spinner inline pour expand
  - [x] Toast de succès/erreur pour les opérations (via useFolders hooks)

- [ ] **Task 10: (Bonus) Drag & drop** (AC: 9) - DEFERRED
  - Note: Drag & drop deferred to future enhancement

## Dev Notes

### Structure des fichiers à créer

```
apps/web/src/
  pages/
    DocumentsPage.tsx              # Nouveau
  components/documents/
    FolderTree.tsx                 # Nouveau
    FolderTreeItem.tsx             # Nouveau
    FolderBreadcrumb.tsx           # Nouveau
    FolderContextMenu.tsx          # Nouveau
    CreateFolderModal.tsx          # Nouveau
    RenameFolderModal.tsx          # Nouveau
    DeleteFolderModal.tsx          # Nouveau
    MoveFolderModal.tsx            # Nouveau
  hooks/
    useFolders.ts                  # Nouveau
  services/
    folders.service.ts             # Nouveau
```

### Layout de la page Documents

```tsx
// DocumentsPage.tsx
export function DocumentsPage() {
  const [selectedFolderId, setSelectedFolderId] = useState<string | null>(null);

  return (
    <div className="flex h-full">
      {/* Sidebar - Arbre des dossiers */}
      <aside className="w-64 border-r overflow-y-auto">
        <FolderTree
          selectedId={selectedFolderId}
          onSelect={setSelectedFolderId}
        />
      </aside>

      {/* Zone principale */}
      <main className="flex-1 p-4">
        <FolderBreadcrumb folderId={selectedFolderId} />
        {/* DocumentList sera ajouté en Story 2.8 */}
        <DocumentList folderId={selectedFolderId} />
      </main>
    </div>
  );
}
```

### Hook useFolders avec TanStack Query

```typescript
// hooks/useFolders.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { foldersService } from '@/services/folders.service';

export function useRootFolders() {
  return useQuery({
    queryKey: ['folders', 'root'],
    queryFn: foldersService.getRootFolders,
  });
}

export function useFolderChildren(folderId: string | null) {
  return useQuery({
    queryKey: ['folders', folderId, 'children'],
    queryFn: () => foldersService.getFolderChildren(folderId!),
    enabled: !!folderId,
  });
}

export function useCreateFolder() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: foldersService.createFolder,
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['folders'] });
    },
  });
}
```

### Composant FolderTreeItem

```tsx
// FolderTreeItem.tsx
interface FolderTreeItemProps {
  folder: Folder;
  level: number;
  selectedId: string | null;
  onSelect: (id: string) => void;
}

export function FolderTreeItem({ folder, level, selectedId, onSelect }: FolderTreeItemProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const { data: children, isLoading } = useFolderChildren(isExpanded ? folder.id : null);

  return (
    <div>
      <div
        className={cn(
          "flex items-center gap-2 px-2 py-1 hover:bg-muted cursor-pointer",
          selectedId === folder.id && "bg-muted"
        )}
        style={{ paddingLeft: `${level * 16 + 8}px` }}
        onClick={() => onSelect(folder.id)}
      >
        <button onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }}>
          {isLoading ? <Spinner /> : <ChevronIcon expanded={isExpanded} />}
        </button>
        <FolderIcon />
        {folder.isRestricted && <LockIcon className="w-3 h-3" />}
        <span>{folder.name}</span>
        <FolderContextMenu folder={folder} />
      </div>

      {isExpanded && children?.map(child => (
        <FolderTreeItem
          key={child.id}
          folder={child}
          level={level + 1}
          selectedId={selectedId}
          onSelect={onSelect}
        />
      ))}
    </div>
  );
}
```

### Utilisation de shadcn/ui

- `Dialog` pour les modals
- `DropdownMenu` pour le menu contextuel
- `Button`, `Input` pour les formulaires
- `Skeleton` pour les états de chargement
- `toast` (sonner) pour les notifications

### Coding Standards Frontend

- **State Management**: TanStack Query pour server state, useState local pour UI state
- **Services**: Jamais `fetch` direct dans les composants
- **Components**: PascalCase, un composant par fichier
- **Hooks**: camelCase avec préfixe `use`

## Testing

### Tests recommandés (Vitest + Testing Library)

1. **FolderTree**
   - Affiche les dossiers racine
   - Expand affiche les enfants
   - Clic sélectionne le dossier

2. **Modals**
   - CreateFolderModal: validation du nom, submit crée le dossier
   - DeleteFolderModal: confirmation requise

3. **Breadcrumb**
   - Affiche le chemin correct
   - Clic navigue vers le dossier parent

## Dependencies

- **Requires**: Story 2.1 (Folder API), Story 2.2 (Permissions API)
- **Blocks**: Story 2.8 (Document List UI)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**Created:**
- `apps/web/src/services/folders.service.ts` - API service for folder operations
- `apps/web/src/hooks/useFolders.ts` - TanStack Query hooks for folders
- `apps/web/src/components/documents/index.ts` - Component exports
- `apps/web/src/components/documents/FolderTree.tsx` - Main tree component
- `apps/web/src/components/documents/FolderTreeItem.tsx` - Recursive tree item
- `apps/web/src/components/documents/FolderBreadcrumb.tsx` - Navigation breadcrumb
- `apps/web/src/components/documents/FolderContextMenu.tsx` - Dropdown menu
- `apps/web/src/components/documents/CreateFolderModal.tsx` - Create folder dialog
- `apps/web/src/components/documents/RenameFolderModal.tsx` - Rename folder dialog
- `apps/web/src/components/documents/MoveFolderModal.tsx` - Move folder dialog
- `apps/web/src/components/documents/DeleteFolderModal.tsx` - Delete confirmation

**Modified:**
- `apps/web/src/pages/DocumentsPage.tsx` - Added folder sidebar and breadcrumb

### Completion Notes

1. Implemented folder explorer UI with:
   - Collapsible folder tree sidebar with expand/collapse animations
   - Lazy loading of folder children on expand
   - Breadcrumb navigation showing full path
   - Context menu with CRUD operations
   - Modal dialogs for create, rename, move, delete operations
   - Form validation with React Hook Form + Zod
   - Toast notifications for success/error feedback

2. Technical decisions:
   - Used TanStack Query for server state management
   - Recursive component pattern for tree rendering
   - Framer Motion for sidebar animations
   - Followed existing code patterns from users module

3. Deferred features:
   - Permission-based icon (lock) for restricted folders
   - Permission-based menu option disabling
   - Drag & drop folder reordering (Task 10)

## PO Review

### Review Date: 2026-01-24

### Reviewed By: Sarah (Product Owner)

### Business Value Assessment

| Critère | Status | Commentaire |
|---------|--------|-------------|
| Valeur métier livrée | ✅ | Navigation intuitive dans l'arborescence documentaire |
| Besoins utilisateur satisfaits | ✅ | Explorateur de dossiers complet avec CRUD |
| Cohérence avec objectifs Epic | ✅ | Interface utilisateur essentielle pour la GED |

### Acceptance Criteria - Business Validation

- ✅ AC1: Page /documents avec layout deux colonnes
- ✅ AC2: Arborescence hiérarchique avec expand/collapse
- ✅ AC3: Breadcrumb de navigation
- ✅ AC4-5: Sélection et menu contextuel
- ✅ AC6-7: Modals de création/suppression
- ⏳ AC8: Icônes cadenas (deferred - nécessite données permissions API)
- ⏳ AC9: Drag & drop (deferred - future enhancement)
- ✅ AC10: États de chargement

### UX Value for ONG

- ✅ Interface familière (style explorateur de fichiers)
- ✅ Lazy loading des sous-dossiers
- ✅ Feedback visuel pour toutes les opérations

### PO Gate Decision

**APPROVED** - L'explorateur de dossiers offre une expérience utilisateur intuitive pour la gestion documentaire. Les fonctionnalités différées (drag & drop, icônes permissions) seront ajoutées dans une future itération.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
