# Story 2.7: GED UI - Folder Explorer

## Status

Approved

## Story

**As a** utilisateur,
**I want** naviguer dans l'arborescence des dossiers via une interface graphique,
**so that** je puisse explorer et organiser ma structure documentaire.

## Acceptance Criteria

1. Page `/documents` avec panneau latéral d'arborescence de dossiers
2. Affichage hiérarchique des dossiers (tree view) avec expand/collapse
3. Breadcrumb montrant le chemin actuel
4. Clic sur un dossier affiche son contenu dans la zone principale
5. Menu contextuel (clic droit ou bouton "...") : Nouveau sous-dossier, Renommer, Déplacer, Supprimer
6. Modal de création de dossier avec validation du nom
7. Modal de confirmation avant suppression
8. Icônes différenciées pour dossiers selon permissions (cadenas pour restreint)
9. Drag & drop pour déplacer dossiers (optionnel, bonus)
10. État de chargement pendant les opérations

## Tasks / Subtasks

- [ ] **Task 1: Créer la page /documents** (AC: 1)
  - [ ] Créer `apps/web/src/pages/DocumentsPage.tsx`
  - [ ] Layout avec sidebar (tree) + zone principale (contenu)
  - [ ] Ajouter la route dans React Router

- [ ] **Task 2: Créer le hook useFolders** (AC: 2, 4)
  - [ ] Créer `apps/web/src/hooks/useFolders.ts`
  - [ ] Utiliser TanStack Query pour fetch les dossiers
  - [ ] Implémenter `useRootFolders()` - dossiers racine
  - [ ] Implémenter `useFolderChildren(folderId)` - sous-dossiers
  - [ ] Implémenter mutations : create, update, delete

- [ ] **Task 3: Créer le service folders frontend** (AC: 2-7)
  - [ ] Créer `apps/web/src/services/folders.service.ts`
  - [ ] Implémenter appels API : getRootFolders, getFolderChildren, createFolder, updateFolder, deleteFolder
  - [ ] Typage avec types partagés de `@shared/types`

- [ ] **Task 4: Créer le composant FolderTree** (AC: 2, 8)
  - [ ] Créer `apps/web/src/components/documents/FolderTree.tsx`
  - [ ] Affichage récursif des dossiers
  - [ ] Icône folder + nom
  - [ ] Bouton expand/collapse pour dossiers avec enfants
  - [ ] Highlight du dossier sélectionné
  - [ ] Icône cadenas pour dossiers avec permissions restreintes

- [ ] **Task 5: Créer le composant FolderTreeItem** (AC: 2, 5, 8)
  - [ ] Créer `apps/web/src/components/documents/FolderTreeItem.tsx`
  - [ ] Gestion de l'état expanded/collapsed
  - [ ] Bouton "..." pour menu contextuel
  - [ ] Lazy loading des enfants au expand

- [ ] **Task 6: Créer le composant Breadcrumb** (AC: 3)
  - [ ] Créer `apps/web/src/components/documents/FolderBreadcrumb.tsx`
  - [ ] Afficher le chemin : Home > Dossier Parent > Dossier Actuel
  - [ ] Chaque élément cliquable pour navigation

- [ ] **Task 7: Créer le menu contextuel** (AC: 5)
  - [ ] Utiliser DropdownMenu de shadcn/ui
  - [ ] Options : Nouveau sous-dossier, Renommer, Déplacer, Supprimer
  - [ ] Désactiver options selon permissions utilisateur

- [ ] **Task 8: Créer les modals** (AC: 6, 7)
  - [ ] Créer `apps/web/src/components/documents/CreateFolderModal.tsx`
  - [ ] Créer `apps/web/src/components/documents/RenameFolderModal.tsx`
  - [ ] Créer `apps/web/src/components/documents/DeleteFolderModal.tsx`
  - [ ] Créer `apps/web/src/components/documents/MoveFolderModal.tsx`
  - [ ] Utiliser Dialog de shadcn/ui
  - [ ] Validation du nom avec React Hook Form + Zod

- [ ] **Task 9: Implémenter les états de chargement** (AC: 10)
  - [ ] Skeleton loading pour l'arbre initial
  - [ ] Spinner inline pour expand
  - [ ] Toast de succès/erreur pour les opérations

- [ ] **Task 10: (Bonus) Drag & drop** (AC: 9)
  - [ ] Utiliser `@dnd-kit/core` ou `react-beautiful-dnd`
  - [ ] Permettre de déplacer un dossier vers un autre parent
  - [ ] Feedback visuel pendant le drag

## Dev Notes

### Structure des fichiers à créer

```
apps/web/src/
  pages/
    DocumentsPage.tsx              # Nouveau
  components/documents/
    FolderTree.tsx                 # Nouveau
    FolderTreeItem.tsx             # Nouveau
    FolderBreadcrumb.tsx           # Nouveau
    FolderContextMenu.tsx          # Nouveau
    CreateFolderModal.tsx          # Nouveau
    RenameFolderModal.tsx          # Nouveau
    DeleteFolderModal.tsx          # Nouveau
    MoveFolderModal.tsx            # Nouveau
  hooks/
    useFolders.ts                  # Nouveau
  services/
    folders.service.ts             # Nouveau
```

### Layout de la page Documents

```tsx
// DocumentsPage.tsx
export function DocumentsPage() {
  const [selectedFolderId, setSelectedFolderId] = useState<string | null>(null);

  return (
    <div className="flex h-full">
      {/* Sidebar - Arbre des dossiers */}
      <aside className="w-64 border-r overflow-y-auto">
        <FolderTree
          selectedId={selectedFolderId}
          onSelect={setSelectedFolderId}
        />
      </aside>

      {/* Zone principale */}
      <main className="flex-1 p-4">
        <FolderBreadcrumb folderId={selectedFolderId} />
        {/* DocumentList sera ajouté en Story 2.8 */}
        <DocumentList folderId={selectedFolderId} />
      </main>
    </div>
  );
}
```

### Hook useFolders avec TanStack Query

```typescript
// hooks/useFolders.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { foldersService } from '@/services/folders.service';

export function useRootFolders() {
  return useQuery({
    queryKey: ['folders', 'root'],
    queryFn: foldersService.getRootFolders,
  });
}

export function useFolderChildren(folderId: string | null) {
  return useQuery({
    queryKey: ['folders', folderId, 'children'],
    queryFn: () => foldersService.getFolderChildren(folderId!),
    enabled: !!folderId,
  });
}

export function useCreateFolder() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: foldersService.createFolder,
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['folders'] });
    },
  });
}
```

### Composant FolderTreeItem

```tsx
// FolderTreeItem.tsx
interface FolderTreeItemProps {
  folder: Folder;
  level: number;
  selectedId: string | null;
  onSelect: (id: string) => void;
}

export function FolderTreeItem({ folder, level, selectedId, onSelect }: FolderTreeItemProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const { data: children, isLoading } = useFolderChildren(isExpanded ? folder.id : null);

  return (
    <div>
      <div
        className={cn(
          "flex items-center gap-2 px-2 py-1 hover:bg-muted cursor-pointer",
          selectedId === folder.id && "bg-muted"
        )}
        style={{ paddingLeft: `${level * 16 + 8}px` }}
        onClick={() => onSelect(folder.id)}
      >
        <button onClick={(e) => { e.stopPropagation(); setIsExpanded(!isExpanded); }}>
          {isLoading ? <Spinner /> : <ChevronIcon expanded={isExpanded} />}
        </button>
        <FolderIcon />
        {folder.isRestricted && <LockIcon className="w-3 h-3" />}
        <span>{folder.name}</span>
        <FolderContextMenu folder={folder} />
      </div>

      {isExpanded && children?.map(child => (
        <FolderTreeItem
          key={child.id}
          folder={child}
          level={level + 1}
          selectedId={selectedId}
          onSelect={onSelect}
        />
      ))}
    </div>
  );
}
```

### Utilisation de shadcn/ui

- `Dialog` pour les modals
- `DropdownMenu` pour le menu contextuel
- `Button`, `Input` pour les formulaires
- `Skeleton` pour les états de chargement
- `toast` (sonner) pour les notifications

### Coding Standards Frontend

- **State Management**: TanStack Query pour server state, useState local pour UI state
- **Services**: Jamais `fetch` direct dans les composants
- **Components**: PascalCase, un composant par fichier
- **Hooks**: camelCase avec préfixe `use`

## Testing

### Tests recommandés (Vitest + Testing Library)

1. **FolderTree**
   - Affiche les dossiers racine
   - Expand affiche les enfants
   - Clic sélectionne le dossier

2. **Modals**
   - CreateFolderModal: validation du nom, submit crée le dossier
   - DeleteFolderModal: confirmation requise

3. **Breadcrumb**
   - Affiche le chemin correct
   - Clic navigue vers le dossier parent

## Dependencies

- **Requires**: Story 2.1 (Folder API), Story 2.2 (Permissions API)
- **Blocks**: Story 2.8 (Document List UI)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
