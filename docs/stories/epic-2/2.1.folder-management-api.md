# Story 2.1: Folder Management API

## Status

Draft

## Story

**As a** utilisateur authentifié,
**I want** créer et organiser des dossiers hiérarchiques,
**so that** je puisse structurer mes documents de manière logique.

## Acceptance Criteria

1. Schéma Prisma `Folder` : id, name, parentId (nullable), createdById, createdAt, updatedAt
2. Endpoint `GET /api/folders` listant les dossiers racine de l'utilisateur
3. Endpoint `GET /api/folders/:id` récupérant un dossier avec ses sous-dossiers
4. Endpoint `GET /api/folders/:id/children` listant les sous-dossiers directs
5. Endpoint `POST /api/folders` créant un dossier (name, parentId optionnel)
6. Endpoint `PATCH /api/folders/:id` modifiant un dossier (name, parentId pour déplacer)
7. Endpoint `DELETE /api/folders/:id` supprimant un dossier vide uniquement
8. Validation : nom unique au sein du même parent
9. Validation : empêcher les cycles (un dossier ne peut être son propre descendant)
10. Tests unitaires et d'intégration

## Tasks / Subtasks

- [ ] **Task 1: Créer le schéma Prisma Folder** (AC: 1)
  - [ ] Ajouter le modèle `Folder` dans `prisma/schema.prisma`
  - [ ] Définir les champs : id (cuid), name (String), parentId (String? relation), createdById (String relation User), createdAt, updatedAt
  - [ ] Ajouter la relation self-referencing pour la hiérarchie parent/children
  - [ ] Créer et exécuter la migration : `pnpm db:migrate`

- [ ] **Task 2: Créer les types partagés** (AC: 1-7)
  - [ ] Créer `packages/shared/src/types/folder.types.ts`
  - [ ] Définir `CreateFolderDto`, `UpdateFolderDto`, `FolderResponse`
  - [ ] Définir les validateurs Zod correspondants dans `packages/shared/src/validators/folder.validators.ts`
  - [ ] Exporter depuis `packages/shared/src/index.ts`

- [ ] **Task 3: Créer le service folders** (AC: 2-9)
  - [ ] Créer `apps/api/src/modules/folders/folders.service.ts`
  - [ ] Implémenter `getRootFolders(userId)` - retourne les dossiers sans parent
  - [ ] Implémenter `getFolderById(id)` - avec sous-dossiers inclus
  - [ ] Implémenter `getFolderChildren(folderId)` - sous-dossiers directs
  - [ ] Implémenter `createFolder(data, userId)` - avec validation nom unique
  - [ ] Implémenter `updateFolder(id, data)` - avec détection de cycles
  - [ ] Implémenter `deleteFolder(id)` - vérifie que le dossier est vide
  - [ ] Implémenter `checkCycleDetection(folderId, newParentId)` - empêche les cycles

- [ ] **Task 4: Créer le contrôleur folders** (AC: 2-7)
  - [ ] Créer `apps/api/src/modules/folders/folders.controller.ts`
  - [ ] Route `GET /api/folders` → `getRootFolders`
  - [ ] Route `GET /api/folders/:id` → `getFolderById`
  - [ ] Route `GET /api/folders/:id/children` → `getFolderChildren`
  - [ ] Route `POST /api/folders` → `createFolder`
  - [ ] Route `PATCH /api/folders/:id` → `updateFolder`
  - [ ] Route `DELETE /api/folders/:id` → `deleteFolder`

- [ ] **Task 5: Créer les routes folders** (AC: 2-7)
  - [ ] Créer `apps/api/src/modules/folders/folders.routes.ts`
  - [ ] Appliquer middleware `authenticate` sur toutes les routes
  - [ ] Appliquer validation Zod sur POST et PATCH
  - [ ] Enregistrer les routes dans `apps/api/src/app.ts`

- [ ] **Task 6: Écrire les tests** (AC: 10)
  - [ ] Créer `apps/api/tests/folders.service.test.ts` - tests unitaires
  - [ ] Créer `apps/api/tests/folders.integration.test.ts` - tests d'intégration
  - [ ] Tester la création de dossier racine et sous-dossier
  - [ ] Tester la validation du nom unique par parent
  - [ ] Tester la détection de cycles
  - [ ] Tester la suppression (dossier vide vs non-vide)

## Dev Notes

### Structure des fichiers à créer/modifier

```
prisma/
  schema.prisma              # Ajouter modèle Folder

packages/shared/src/
  types/folder.types.ts      # Nouveau
  validators/folder.validators.ts  # Nouveau
  index.ts                   # Exporter les nouveaux types

apps/api/src/
  modules/folders/
    folders.service.ts       # Nouveau
    folders.controller.ts    # Nouveau
    folders.routes.ts        # Nouveau
    index.ts                 # Nouveau
  app.ts                     # Enregistrer routes

apps/api/tests/
  folders.service.test.ts    # Nouveau
  folders.integration.test.ts # Nouveau
```

### Schéma Prisma suggéré

```prisma
model Folder {
  id          String   @id @default(cuid())
  name        String
  parentId    String?
  parent      Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    Folder[] @relation("FolderHierarchy")
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, parentId])
  @@map("folders")
}
```

### Coding Standards à respecter

- **Types dans `packages/shared`** - Jamais dupliquer entre frontend/backend
- **Toujours paginer** les listes (sauf pour les sous-dossiers directs qui sont généralement peu nombreux)
- **Naming**: Service en `camelCase.service.ts`, routes en kebab-case `/api/folders`
- **API Response format**: `res.json({ data: folders, pagination: { page, limit, total, totalPages } })`

### Algorithme de détection de cycles

```typescript
async function hasCycle(folderId: string, newParentId: string): Promise<boolean> {
  let current = newParentId;
  while (current) {
    if (current === folderId) return true;
    const parent = await prisma.folder.findUnique({ where: { id: current }, select: { parentId: true } });
    current = parent?.parentId;
  }
  return false;
}
```

## Testing

### Standards de test (Jest + Supertest)

- **Emplacement**: `apps/api/tests/`
- **Framework**: Jest 29.x + Supertest 6.x
- **Pattern**: Describe blocks par fonctionnalité, arrange-act-assert

### Cas de test requis

1. **Création**
   - Créer un dossier racine (parentId = null)
   - Créer un sous-dossier avec parentId valide
   - Échec si parentId inexistant
   - Échec si nom dupliqué dans le même parent

2. **Lecture**
   - Récupérer les dossiers racine
   - Récupérer un dossier avec ses enfants
   - 404 si dossier inexistant

3. **Mise à jour**
   - Renommer un dossier
   - Déplacer un dossier vers un autre parent
   - Échec si création de cycle

4. **Suppression**
   - Supprimer un dossier vide
   - Échec si dossier contient des sous-dossiers
   - Échec si dossier contient des documents (préparation Story 2.3)

## Dependencies

- **Requires**: Story 1.x (Authentication API) - pour le middleware authenticate
- **Blocks**: Story 2.2 (Folder Permissions), Story 2.3 (Document Upload)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
