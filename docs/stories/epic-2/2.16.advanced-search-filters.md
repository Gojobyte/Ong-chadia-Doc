# Story 2.16: Recherche Avancée & Filtres

## Status

Complete

## Story

**As a** utilisateur,
**I want** avoir des options de recherche avancées et des filtres puissants,
**so that** je puisse retrouver rapidement n'importe quel document même dans une grande collection.

> **Inspiré de** : Google Drive (advanced search), Dropbox (filters), M-Files (metadata search)

## Acceptance Criteria

1. Barre de recherche globale accessible depuis n'importe quelle page (header)
2. Recherche instantanée avec résultats en temps réel (debounce 300ms)
3. Recherche dans le nom, tags, métadonnées, et contenu texte (si indexé)
4. Panneau de filtres avancés déployable
5. Filtres : Type de fichier, Date de création, Taille, Dossier, Tags, Uploadé par
6. Sauvegarde des recherches fréquentes
7. Historique des recherches récentes (5 dernières)
8. Mise en surbrillance des termes trouvés dans les résultats
9. Tri des résultats : Pertinence, Date, Nom, Taille
10. Résultats groupés par dossier (optionnel)

## Tasks / Subtasks

- [x] **Task 1: Améliorer l'endpoint de recherche**
  - [x] Modifier `GET /api/documents/search`
  - [x] Ajouter filtre `uploadedBy` (userId)
  - [x] Ajouter filtre `sizeMin`, `sizeMax`
  - [x] Ajouter filtre `tags[]`
  - [x] Ajouter paramètre `highlight=true` pour retourner les extraits

- [ ] **Task 2: Implémenter la recherche full-text (optionnel)** - DEFERRED
  - [ ] Configurer PostgreSQL full-text search sur Document.name
  - [ ] Index GIN sur le nom et tags
  - [ ] Ranking par pertinence
  - [x] Fallback sur ILIKE si FTS non disponible (implemented via contains/insensitive)

- [x] **Task 3: Créer la barre de recherche globale**
  - [x] Composant `GlobalSearch.tsx` dans TopNav
  - [x] Input avec icône de recherche
  - [x] Raccourci clavier : Cmd/Ctrl + K
  - [x] Command palette style (comme VS Code)

- [x] **Task 4: Créer le dropdown de résultats instantanés**
  - [x] Composant intégré dans `GlobalSearch.tsx`
  - [x] Affiche les 5 premiers résultats en temps réel
  - [x] Section "Récents" quand vide
  - [x] Lien "Voir tous les résultats"

- [x] **Task 5: Créer la page de résultats de recherche**
  - [x] Page `/search?q=terme`
  - [x] Liste de résultats avec détails
  - [x] Compteur de résultats
  - [x] Message si aucun résultat

- [x] **Task 6: Créer le panneau de filtres avancés**
  - [x] Composant `SearchFilters.tsx`
  - [x] Déployable via bouton "Filtres"
  - [x] Filtres avec checkboxes et selects
  - [x] Bouton "Réinitialiser les filtres"
  - [x] Badge indiquant le nombre de filtres actifs

- [x] **Task 7: Implémenter les filtres UI**
  - [x] Type de fichier : checkboxes (PDF, Word, Excel, Image)
  - [x] Date : DateRangePicker (de - à)
  - [x] Taille : presets (< 1Mo, 1-10Mo, 10-50Mo, > 50Mo)
  - [x] Dossier : TreeSelect (arbre dossiers avec lazy loading)
  - [x] Tags : Multi-select avec couleurs
  - [x] Uploadé par : UserSelect

- [ ] **Task 8: Implémenter les recherches sauvegardées** - DEFERRED
  - [ ] Table `SavedSearch` : id, userId, name, query, filters (JSON)
  - [ ] Bouton "Sauvegarder cette recherche"
  - [ ] Liste des recherches sauvegardées dans dropdown
  - [ ] Clic applique la recherche

- [x] **Task 9: Implémenter l'historique de recherche**
  - [x] Stocker les 10 dernières recherches en localStorage
  - [x] Afficher dans le dropdown quand input vide
  - [x] Bouton effacer l'historique

- [x] **Task 10: Implémenter la mise en surbrillance**
  - [x] Composant `Highlight.tsx`
  - [x] Wrap les termes trouvés dans `<mark>`
  - [x] Style : fond jaune
  - [x] Appliquer sur nom et tags

## Dev Notes

### Endpoint de recherche amélioré

```typescript
// GET /api/documents/search
// Query params:
// - q: string (terme de recherche)
// - type: string[] (pdf,docx,xlsx,image)
// - folderId: string (avec recursive=true par défaut)
// - from: string (date ISO)
// - to: string (date ISO)
// - sizeMin: number (bytes)
// - sizeMax: number (bytes)
// - tags: string[] (tag IDs)
// - uploadedBy: string (user ID)
// - sort: 'relevance' | 'date' | 'name' | 'size'
// - order: 'asc' | 'desc'
// - highlight: boolean

{
  data: [
    {
      id,
      name,
      mimeType,
      size,
      createdAt,
      folder: { id, name, path },
      uploadedBy: { id, firstName, lastName },
      tags: [...],
      highlight: {
        name: 'Budget <mark>2026</mark> final.pdf',
        excerpt: '...le budget <mark>2026</mark> prévoit...'
      }
    }
  ],
  pagination: { ... },
  totalCount: 42,
  searchTime: 0.045 // seconds
}
```

### PostgreSQL Full-Text Search

```sql
-- Migration: Add full-text search
ALTER TABLE "Document" ADD COLUMN search_vector tsvector;

CREATE INDEX document_search_idx ON "Document" USING GIN (search_vector);

CREATE OR REPLACE FUNCTION update_document_search_vector()
RETURNS trigger AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('french', coalesce(NEW.name, '')), 'A');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER document_search_update
BEFORE INSERT OR UPDATE ON "Document"
FOR EACH ROW EXECUTE FUNCTION update_document_search_vector();
```

### Composant GlobalSearch

```tsx
export function GlobalSearch() {
  const [open, setOpen] = useState(false);
  const [query, setQuery] = useState('');
  const debouncedQuery = useDebounce(query, 300);

  const { data: results, isLoading } = useSearch(debouncedQuery);
  const { data: recentSearches } = useRecentSearches();

  useHotkeys('mod+k', () => setOpen(true));

  return (
    <>
      <button
        onClick={() => setOpen(true)}
        className="flex items-center gap-2 px-3 py-1.5 text-sm text-slate-500 bg-slate-100 rounded-lg hover:bg-slate-200"
      >
        <Search className="w-4 h-4" />
        <span>Rechercher...</span>
        <kbd className="text-xs bg-white px-1.5 py-0.5 rounded border">⌘K</kbd>
      </button>

      <CommandDialog open={open} onOpenChange={setOpen}>
        <CommandInput
          placeholder="Rechercher des documents..."
          value={query}
          onValueChange={setQuery}
        />

        <CommandList>
          {isLoading && <CommandLoading>Recherche...</CommandLoading>}

          {!query && recentSearches?.length > 0 && (
            <CommandGroup heading="Recherches récentes">
              {recentSearches.map((search) => (
                <CommandItem
                  key={search}
                  onSelect={() => {
                    setQuery(search);
                    navigate(`/search?q=${encodeURIComponent(search)}`);
                  }}
                >
                  <Clock className="w-4 h-4 mr-2" />
                  {search}
                </CommandItem>
              ))}
            </CommandGroup>
          )}

          {results?.data?.length > 0 && (
            <CommandGroup heading="Documents">
              {results.data.slice(0, 5).map((doc) => (
                <CommandItem
                  key={doc.id}
                  onSelect={() => navigate(`/documents/${doc.id}`)}
                >
                  <FileIcon mimeType={doc.mimeType} className="w-4 h-4 mr-2" />
                  <div>
                    <Highlight text={doc.name} query={query} />
                    <span className="text-xs text-muted-foreground ml-2">
                      {doc.folder.path}
                    </span>
                  </div>
                </CommandItem>
              ))}
            </CommandGroup>
          )}

          {query && results?.totalCount > 5 && (
            <CommandItem onSelect={() => navigate(`/search?q=${encodeURIComponent(query)}`)}>
              <span>Voir les {results.totalCount} résultats →</span>
            </CommandItem>
          )}
        </CommandList>
      </CommandDialog>
    </>
  );
}
```

### Composant Highlight

```tsx
interface HighlightProps {
  text: string;
  query: string;
}

export function Highlight({ text, query }: HighlightProps) {
  if (!query) return <span>{text}</span>;

  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  const parts = text.split(regex);

  return (
    <span>
      {parts.map((part, i) =>
        regex.test(part) ? (
          <mark key={i} className="bg-yellow-200 px-0.5 rounded">
            {part}
          </mark>
        ) : (
          <span key={i}>{part}</span>
        )
      )}
    </span>
  );
}
```

### Sources d'inspiration

- [Google Drive - Advanced Search](https://support.google.com/drive/answer/2375114)
- [Dropbox - Search filters](https://help.dropbox.com/organize/search)
- [Notion - Quick Find](https://www.notion.so/help/keyboard-shortcuts)

## Testing

### Tests recommandés

1. **Recherche API**
   - Retourne les bons résultats
   - Filtres fonctionnent en combinaison
   - Performance < 500ms pour 10k documents

2. **UI Recherche**
   - Cmd+K ouvre la recherche
   - Debounce fonctionne
   - Navigation clavier dans les résultats

3. **Filtres**
   - Chaque filtre réduit les résultats
   - Reset remet tout à zéro
   - URL reflète les filtres actifs

## Dependencies

- **Requires**: Story 2.6 (Search API), Story 2.13 (Tags)
- **Blocks**: None

## Dev Agent Record

### File List

| File | Action |
|------|--------|
| `apps/api/src/modules/documents/search.service.ts` | Existing - All filters already implemented (type, folderId, from, to, sizeMin, sizeMax, tags, uploadedBy, sort, order) |
| `apps/api/src/modules/documents/search.controller.ts` | Existing - Controller with query param parsing |
| `apps/web/src/components/search/GlobalSearch.tsx` | Existing - Command palette with Cmd+K shortcut |
| `apps/web/src/components/search/Highlight.tsx` | Existing - Text highlighting component |
| `apps/web/src/components/search/SearchFilters.tsx` | Created - Advanced filters panel with all filter types |
| `apps/web/src/components/search/index.ts` | Modified - Added SearchFilters export |
| `apps/web/src/pages/SearchResultsPage.tsx` | Modified - Integrated SearchFilters, added all filter params |
| `apps/web/src/hooks/useDebounce.ts` | Existing - 300ms debounce hook |

### Completion Notes

- Most of the story was already implemented in a previous session
- Task 6 & 7 were the main implementation work (SearchFilters component)
- SearchFilters includes: type checkboxes, date range, size presets, folder tree, tags multi-select, user select
- Folder filter uses lazy loading with useFolderChildren hook
- All filters are reflected in URL query params for shareable search URLs
- Task 2 (PostgreSQL FTS) deferred - current ILIKE search is sufficient for typical document volumes
- Task 8 (Saved Searches) deferred - requires database schema changes
- Search history uses localStorage with max 10 entries (as per PO recommendation)

### Agent Model Used

Claude Opus 4.5

---

## PO Review

### Review Date: 2026-01-26

### Reviewer: Sarah (Product Owner)

### Review Summary

| Critère | Score | Commentaire |
|---------|-------|-------------|
| Complétude Template | ✅ 10/10 | Structure complète |
| Acceptance Criteria | ✅ 10/10 | 10 AC exhaustifs |
| Tasks/Subtasks | ✅ 10/10 | 10 tâches séquentielles |
| Dev Notes | ✅ 10/10 | FTS + CommandDialog |
| Testing | ⚠️ 7/10 | Performance mentionnée |
| UX | ✅ 10/10 | Cmd+K, historique, highlights |

### Verdict: **GO** ✅

### Implementation Readiness Score: 9.4/10

### Confidence Level: High

### Recommendations
1. Préciser comportement si FTS non disponible (fallback ILIKE documenté)
2. Ajouter limite de caractères pour recherche (min 2, max 100)
3. Limiter historique localStorage (10 entrées max)
4. Ajouter debounce côté serveur en plus du client

### Notes
- Command palette style (Cmd+K) - UX moderne et efficace
- Full-text search PostgreSQL - performance optimale
- Highlight des termes - aide visuelle importante
- Recherches sauvegardées - gain de productivité
- Filtres combinables - puissance de recherche

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | Dev Agent (James) |
| 2026-01-26 | 1.1 | PO Review - Approuvé | Sarah (PO) |
| 2026-01-27 | 1.2 | Implémentation complète - SearchFilters ajouté, 8/10 tâches terminées | James (Dev) |
| 2026-01-27 | 1.3 | PO Implementation Review - APPROVED → Complete (2 tasks deferred) | Sarah (PO) |
