# Story 2.8: GED UI - Document List & Upload

## Status

Ready for Review

## Story

**As a** utilisateur,
**I want** voir les documents d'un dossier et en uploader de nouveaux,
**so that** je puisse gérer mes fichiers depuis l'interface.

## Acceptance Criteria

1. Zone principale affichant la liste des documents du dossier sélectionné
2. Vue liste avec colonnes : Nom, Type (icône), Taille, Date upload, Uploadé par
3. Tri cliquable sur chaque colonne
4. Bouton "Upload" ouvrant un sélecteur de fichiers
5. Zone de drag & drop pour upload (drop zone visuelle)
6. Barre de progression pendant l'upload
7. Support upload multiple (plusieurs fichiers à la fois)
8. Validation côté client : taille max, types acceptés
9. Message d'erreur si upload échoue
10. Rafraîchissement automatique de la liste après upload réussi

## Tasks / Subtasks

- [x] **Task 1: Créer le hook useDocuments** (AC: 1, 10)
  - [x] Créer `apps/web/src/hooks/useDocuments.ts`
  - [x] Implémenter `useDocumentsByFolder(folderId, params)`
  - [x] Implémenter `useUploadDocument()` mutation
  - [x] Invalidation automatique après upload

- [x] **Task 2: Créer le service documents frontend** (AC: 1-3)
  - [x] Créer `apps/web/src/services/documents.service.ts`
  - [x] Implémenter `getByFolder(folderId, params)`
  - [x] Implémenter `upload(file, folderId, onProgress)`

- [x] **Task 3: Créer le composant DocumentList** (AC: 1-3)
  - [x] Créer `apps/web/src/components/documents/DocumentList.tsx`
  - [x] Table avec colonnes : Nom, Type (icône), Taille, Date
  - [x] Headers cliquables pour tri
  - [x] État vide avec call-to-action upload

- [x] **Task 4: Créer le composant DocumentRow** (AC: 2)
  - [x] Créer `apps/web/src/components/documents/DocumentRow.tsx`
  - [x] Icône selon le type de fichier (PDF, Word, Excel, Image, etc.)
  - [x] Formatage de la taille (Ko, Mo)
  - [x] Formatage de la date (relative)
  - [x] Menu contextuel avec actions (télécharger, renommer, supprimer)

- [x] **Task 5: Implémenter le tri** (AC: 3)
  - [x] État local pour sort field et order
  - [x] Icône flèche sur la colonne active
  - [x] Re-fetch avec nouveaux params de tri

- [x] **Task 6: Créer le composant UploadButton** (AC: 4, 7)
  - [x] Créer `apps/web/src/components/documents/UploadButton.tsx`
  - [x] Input file hidden avec ref
  - [x] Support `multiple` pour plusieurs fichiers
  - [x] Validation client avant ouverture dialog

- [x] **Task 7: Créer le composant DropZone** (AC: 5)
  - [x] Créer `apps/web/src/components/documents/DropZone.tsx`
  - [x] Implémentation native avec drag events
  - [x] Feedback visuel au drag over (overlay avec icône)
  - [x] Intégré avec la zone de liste

- [x] **Task 8: Implémenter la progression d'upload** (AC: 6)
  - [x] Utiliser `XMLHttpRequest` pour progress events
  - [x] Créer `apps/web/src/components/documents/UploadProgress.tsx`
  - [x] Barre de progression pour chaque fichier
  - [x] Afficher nom du fichier + pourcentage + statut

- [x] **Task 9: Implémenter la validation client** (AC: 8)
  - [x] Vérifier taille max (50 MB) avant upload
  - [x] Vérifier type de fichier autorisé
  - [x] Afficher toast d'erreur si invalide
  - [x] Utiliser constantes partagées de `@ong-chadia/shared`

- [x] **Task 10: Gestion des erreurs** (AC: 9)
  - [x] Toast d'erreur si upload échoue
  - [x] Message spécifique selon le type d'erreur
  - [x] Statut error affiché dans UploadProgress

## Dev Notes

### Structure des fichiers à créer

```
apps/web/src/
  components/documents/
    DocumentList.tsx           # Nouveau
    DocumentRow.tsx            # Nouveau
    UploadButton.tsx           # Nouveau
    DropZone.tsx               # Nouveau
    UploadProgress.tsx         # Nouveau
  hooks/
    useDocuments.ts            # Nouveau
  services/
    documents.service.ts       # Nouveau
```

### Composant DocumentList

```tsx
// DocumentList.tsx
interface DocumentListProps {
  folderId: string | null;
}

export function DocumentList({ folderId }: DocumentListProps) {
  const [sort, setSort] = useState<{ field: string; order: 'asc' | 'desc' }>({
    field: 'createdAt',
    order: 'desc',
  });

  const { data, isLoading } = useDocumentsByFolder(folderId, { sort });

  if (!folderId) {
    return <EmptyState message="Sélectionnez un dossier" />;
  }

  if (isLoading) {
    return <DocumentListSkeleton />;
  }

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h2 className="text-lg font-semibold">Documents</h2>
        <UploadButton folderId={folderId} />
      </div>

      <DropZone folderId={folderId}>
        <Table>
          <TableHeader>
            <TableRow>
              <SortableHeader field="name" current={sort} onSort={setSort}>Nom</SortableHeader>
              <TableHead>Type</TableHead>
              <SortableHeader field="size" current={sort} onSort={setSort}>Taille</SortableHeader>
              <SortableHeader field="createdAt" current={sort} onSort={setSort}>Date</SortableHeader>
              <TableHead>Uploadé par</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {data?.data.map(doc => (
              <DocumentRow key={doc.id} document={doc} />
            ))}
          </TableBody>
        </Table>
      </DropZone>

      {data?.data.length === 0 && (
        <EmptyState message="Aucun document dans ce dossier" />
      )}
    </div>
  );
}
```

### Hook useDocuments

```typescript
// hooks/useDocuments.ts
export function useDocumentsByFolder(
  folderId: string | null,
  options?: { sort?: { field: string; order: 'asc' | 'desc' } }
) {
  return useQuery({
    queryKey: ['documents', folderId, options],
    queryFn: () => documentsService.getByFolder(folderId!, options),
    enabled: !!folderId,
  });
}

export function useUploadDocument() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ file, folderId }: { file: File; folderId: string }) =>
      documentsService.upload(file, folderId),
    onSuccess: (_, { folderId }) => {
      queryClient.invalidateQueries({ queryKey: ['documents', folderId] });
      toast.success('Document uploadé avec succès');
    },
    onError: (error) => {
      toast.error(error.message || 'Erreur lors de l\'upload');
    },
  });
}
```

### Upload avec progression

```typescript
// services/documents.service.ts
async upload(
  file: File,
  folderId: string,
  onProgress?: (percent: number) => void
): Promise<Document> {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('folderId', folderId);

  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable && onProgress) {
        onProgress(Math.round((e.loaded / e.total) * 100));
      }
    });

    xhr.addEventListener('load', () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve(JSON.parse(xhr.responseText).data);
      } else {
        reject(new Error(JSON.parse(xhr.responseText).error));
      }
    });

    xhr.addEventListener('error', () => reject(new Error('Upload failed')));

    xhr.open('POST', `${API_URL}/documents/upload`);
    xhr.setRequestHeader('Authorization', `Bearer ${getToken()}`);
    xhr.send(formData);
  });
}
```

### Icônes par type de fichier

```typescript
const FILE_TYPE_ICONS: Record<string, React.ComponentType> = {
  'application/pdf': FileTextIcon,
  'application/msword': FileIcon,
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': FileIcon,
  'application/vnd.ms-excel': TableIcon,
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': TableIcon,
  'image/jpeg': ImageIcon,
  'image/png': ImageIcon,
  'image/gif': ImageIcon,
  'text/plain': FileTextIcon,
};

function getFileIcon(mimeType: string) {
  return FILE_TYPE_ICONS[mimeType] || FileIcon;
}
```

### Formatage utilitaires

```typescript
// utils/format.ts
export function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

export function formatDate(date: string | Date): string {
  return new Intl.DateTimeFormat('fr-FR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date));
}
```

## Testing

### Tests recommandés

1. **DocumentList**
   - Affiche la liste des documents
   - État vide si pas de documents
   - Tri change l'ordre

2. **UploadButton**
   - Ouvre le sélecteur de fichiers
   - Appelle la mutation avec le fichier

3. **DropZone**
   - Feedback visuel au drag over
   - Déclenche l'upload au drop

4. **Validation**
   - Rejette fichier > 50 MB
   - Rejette type non supporté

## Dependencies

- **Requires**: Story 2.3 (Upload API), Story 2.4 (Operations API), Story 2.7 (Folder Explorer)
- **Blocks**: Story 2.9 (Document Details)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**Created:**
- `apps/web/src/services/documents.service.ts` - API service for documents
- `apps/web/src/hooks/useDocuments.ts` - TanStack Query hooks
- `apps/web/src/components/documents/DocumentList.tsx` - Main list component
- `apps/web/src/components/documents/DocumentRow.tsx` - Row with file icons
- `apps/web/src/components/documents/UploadButton.tsx` - File picker button
- `apps/web/src/components/documents/DropZone.tsx` - Drag & drop area
- `apps/web/src/components/documents/UploadProgress.tsx` - Upload progress tracker
- `apps/web/src/components/documents/RenameDocumentModal.tsx` - Rename dialog
- `apps/web/src/components/documents/DeleteDocumentModal.tsx` - Delete confirmation

**Modified:**
- `apps/web/src/lib/utils.ts` - Added formatFileSize, formatDate, formatRelativeDate
- `apps/web/src/components/documents/index.ts` - Export new components
- `apps/web/src/pages/DocumentsPage.tsx` - Integrated DocumentList

### Completion Notes

1. Implemented document list with:
   - Table view with sortable columns (name, size, date)
   - File type icons (PDF=red, Word=blue, Excel=green, Image=purple)
   - Relative date formatting (e.g., "Il y a 2 jours")
   - Context menu with download, rename, delete actions

2. Implemented file upload with:
   - UploadButton with file picker (multiple files)
   - DropZone with visual drag-over feedback
   - UploadProgress showing each file's status
   - Client-side validation (size, type)
   - XHR-based upload with progress events
   - Auto-refresh after successful upload

3. Technical decisions:
   - Native drag events instead of react-dropzone (simpler)
   - XHR for upload progress (axios doesn't support it well)
   - French locale for file sizes (Ko, Mo) and dates

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
