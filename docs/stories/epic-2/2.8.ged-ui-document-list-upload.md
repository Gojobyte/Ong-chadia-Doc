# Story 2.8: GED UI - Document List & Upload

## Status

Approved

## Story

**As a** utilisateur,
**I want** voir les documents d'un dossier et en uploader de nouveaux,
**so that** je puisse gérer mes fichiers depuis l'interface.

## Acceptance Criteria

1. Zone principale affichant la liste des documents du dossier sélectionné
2. Vue liste avec colonnes : Nom, Type (icône), Taille, Date upload, Uploadé par
3. Tri cliquable sur chaque colonne
4. Bouton "Upload" ouvrant un sélecteur de fichiers
5. Zone de drag & drop pour upload (drop zone visuelle)
6. Barre de progression pendant l'upload
7. Support upload multiple (plusieurs fichiers à la fois)
8. Validation côté client : taille max, types acceptés
9. Message d'erreur si upload échoue
10. Rafraîchissement automatique de la liste après upload réussi

## Tasks / Subtasks

- [ ] **Task 1: Créer le hook useDocuments** (AC: 1, 10)
  - [ ] Créer `apps/web/src/hooks/useDocuments.ts`
  - [ ] Implémenter `useDocumentsByFolder(folderId, pagination, sort)`
  - [ ] Implémenter `useUploadDocument()` mutation
  - [ ] Invalidation automatique après upload

- [ ] **Task 2: Créer le service documents frontend** (AC: 1-3)
  - [ ] Créer `apps/web/src/services/documents.service.ts`
  - [ ] Implémenter `getDocumentsByFolder(folderId, params)`
  - [ ] Implémenter `uploadDocument(file, folderId)`

- [ ] **Task 3: Créer le composant DocumentList** (AC: 1-3)
  - [ ] Créer `apps/web/src/components/documents/DocumentList.tsx`
  - [ ] Utiliser Table de shadcn/ui
  - [ ] Colonnes : Nom, Type (icône), Taille, Date, Uploadé par
  - [ ] Headers cliquables pour tri
  - [ ] État vide : "Aucun document dans ce dossier"

- [ ] **Task 4: Créer le composant DocumentRow** (AC: 2)
  - [ ] Créer `apps/web/src/components/documents/DocumentRow.tsx`
  - [ ] Icône selon le type de fichier (PDF, Word, Excel, Image, etc.)
  - [ ] Formatage de la taille (KB, MB)
  - [ ] Formatage de la date (relative ou absolue)
  - [ ] Clic ouvre les détails (Story 2.9)

- [ ] **Task 5: Implémenter le tri** (AC: 3)
  - [ ] État local pour sort field et order
  - [ ] Icône flèche sur la colonne active
  - [ ] Re-fetch avec nouveaux params de tri

- [ ] **Task 6: Créer le composant UploadButton** (AC: 4, 7)
  - [ ] Créer `apps/web/src/components/documents/UploadButton.tsx`
  - [ ] Input file hidden avec ref
  - [ ] Support `multiple` pour plusieurs fichiers
  - [ ] Bouton styled avec shadcn/ui

- [ ] **Task 7: Créer le composant DropZone** (AC: 5)
  - [ ] Créer `apps/web/src/components/documents/DropZone.tsx`
  - [ ] Utiliser `react-dropzone` ou implémentation native
  - [ ] Feedback visuel au drag over (border, background)
  - [ ] Intégrer avec la zone de liste

- [ ] **Task 8: Implémenter la progression d'upload** (AC: 6)
  - [ ] Utiliser `XMLHttpRequest` ou `axios` pour progress events
  - [ ] Créer `apps/web/src/components/documents/UploadProgress.tsx`
  - [ ] Barre de progression pour chaque fichier
  - [ ] Afficher nom du fichier + pourcentage

- [ ] **Task 9: Implémenter la validation client** (AC: 8)
  - [ ] Vérifier taille max (50 MB) avant upload
  - [ ] Vérifier type de fichier autorisé
  - [ ] Afficher erreur immédiate si invalide
  - [ ] Utiliser constantes partagées de `@shared/constants`

- [ ] **Task 10: Gestion des erreurs** (AC: 9)
  - [ ] Toast d'erreur si upload échoue
  - [ ] Message spécifique selon le type d'erreur
  - [ ] Retry possible

## Dev Notes

### Structure des fichiers à créer

```
apps/web/src/
  components/documents/
    DocumentList.tsx           # Nouveau
    DocumentRow.tsx            # Nouveau
    UploadButton.tsx           # Nouveau
    DropZone.tsx               # Nouveau
    UploadProgress.tsx         # Nouveau
  hooks/
    useDocuments.ts            # Nouveau
  services/
    documents.service.ts       # Nouveau
```

### Composant DocumentList

```tsx
// DocumentList.tsx
interface DocumentListProps {
  folderId: string | null;
}

export function DocumentList({ folderId }: DocumentListProps) {
  const [sort, setSort] = useState<{ field: string; order: 'asc' | 'desc' }>({
    field: 'createdAt',
    order: 'desc',
  });

  const { data, isLoading } = useDocumentsByFolder(folderId, { sort });

  if (!folderId) {
    return <EmptyState message="Sélectionnez un dossier" />;
  }

  if (isLoading) {
    return <DocumentListSkeleton />;
  }

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h2 className="text-lg font-semibold">Documents</h2>
        <UploadButton folderId={folderId} />
      </div>

      <DropZone folderId={folderId}>
        <Table>
          <TableHeader>
            <TableRow>
              <SortableHeader field="name" current={sort} onSort={setSort}>Nom</SortableHeader>
              <TableHead>Type</TableHead>
              <SortableHeader field="size" current={sort} onSort={setSort}>Taille</SortableHeader>
              <SortableHeader field="createdAt" current={sort} onSort={setSort}>Date</SortableHeader>
              <TableHead>Uploadé par</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {data?.data.map(doc => (
              <DocumentRow key={doc.id} document={doc} />
            ))}
          </TableBody>
        </Table>
      </DropZone>

      {data?.data.length === 0 && (
        <EmptyState message="Aucun document dans ce dossier" />
      )}
    </div>
  );
}
```

### Hook useDocuments

```typescript
// hooks/useDocuments.ts
export function useDocumentsByFolder(
  folderId: string | null,
  options?: { sort?: { field: string; order: 'asc' | 'desc' } }
) {
  return useQuery({
    queryKey: ['documents', folderId, options],
    queryFn: () => documentsService.getByFolder(folderId!, options),
    enabled: !!folderId,
  });
}

export function useUploadDocument() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ file, folderId }: { file: File; folderId: string }) =>
      documentsService.upload(file, folderId),
    onSuccess: (_, { folderId }) => {
      queryClient.invalidateQueries({ queryKey: ['documents', folderId] });
      toast.success('Document uploadé avec succès');
    },
    onError: (error) => {
      toast.error(error.message || 'Erreur lors de l\'upload');
    },
  });
}
```

### Upload avec progression

```typescript
// services/documents.service.ts
async upload(
  file: File,
  folderId: string,
  onProgress?: (percent: number) => void
): Promise<Document> {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('folderId', folderId);

  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();

    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable && onProgress) {
        onProgress(Math.round((e.loaded / e.total) * 100));
      }
    });

    xhr.addEventListener('load', () => {
      if (xhr.status >= 200 && xhr.status < 300) {
        resolve(JSON.parse(xhr.responseText).data);
      } else {
        reject(new Error(JSON.parse(xhr.responseText).error));
      }
    });

    xhr.addEventListener('error', () => reject(new Error('Upload failed')));

    xhr.open('POST', `${API_URL}/documents/upload`);
    xhr.setRequestHeader('Authorization', `Bearer ${getToken()}`);
    xhr.send(formData);
  });
}
```

### Icônes par type de fichier

```typescript
const FILE_TYPE_ICONS: Record<string, React.ComponentType> = {
  'application/pdf': FileTextIcon,
  'application/msword': FileIcon,
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': FileIcon,
  'application/vnd.ms-excel': TableIcon,
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': TableIcon,
  'image/jpeg': ImageIcon,
  'image/png': ImageIcon,
  'image/gif': ImageIcon,
  'text/plain': FileTextIcon,
};

function getFileIcon(mimeType: string) {
  return FILE_TYPE_ICONS[mimeType] || FileIcon;
}
```

### Formatage utilitaires

```typescript
// utils/format.ts
export function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

export function formatDate(date: string | Date): string {
  return new Intl.DateTimeFormat('fr-FR', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date));
}
```

## Testing

### Tests recommandés

1. **DocumentList**
   - Affiche la liste des documents
   - État vide si pas de documents
   - Tri change l'ordre

2. **UploadButton**
   - Ouvre le sélecteur de fichiers
   - Appelle la mutation avec le fichier

3. **DropZone**
   - Feedback visuel au drag over
   - Déclenche l'upload au drop

4. **Validation**
   - Rejette fichier > 50 MB
   - Rejette type non supporté

## Dependencies

- **Requires**: Story 2.3 (Upload API), Story 2.4 (Operations API), Story 2.7 (Folder Explorer)
- **Blocks**: Story 2.9 (Document Details)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
