# Story 2.10: Document Sharing & Access Logs

## Status

Complete

## Story

**As a** Staff ou Super-Admin,
**I want** partager un document via lien sécurisé et voir qui y a accédé,
**so that** je puisse collaborer avec des partenaires externes et auditer les accès.

## Acceptance Criteria

1. Schéma Prisma `ShareLink` : id, documentId, token (unique), expiresAt, maxAccessCount (nullable), createdById, accessCount, revokedAt (nullable)
2. Schéma Prisma `AccessLog` : id, documentId, userId (nullable pour liens), action, ipAddress, createdAt
3. Endpoint `POST /api/documents/:id/share` créant un lien de partage avec expiration
4. Endpoint `GET /api/share/:token` permettant téléchargement sans auth (lien public temporaire)
5. Bouton "Partager" dans l'UI générant et affichant le lien
6. Option de durée d'expiration (1h, 24h, 7 jours, 30 jours)
7. Option de nombre d'accès maximum (optionnel : 1, 5, 10, illimité)
8. Endpoint `DELETE /api/documents/:id/share/:linkId` pour révoquer manuellement un lien
9. Logging automatique de tous les accès aux documents sensibles
10. Endpoint `GET /api/documents/:id/access-logs` listant les accès (Super-Admin)
11. Endpoint `GET /api/documents/:id/share-links` listant les liens actifs (Staff/Super-Admin)
12. UI affichant les logs d'accès dans les détails du document (si autorisé)
13. UI listant les liens de partage actifs avec possibilité de révoquer
14. Tests de sécurité : lien expiré retourne 403, token invalide retourne 404, lien révoqué retourne 403, max accès atteint retourne 403

## Tasks / Subtasks

- [x] **Task 1: Créer les schémas Prisma** (AC: 1, 2)
  - [x] Ajouter modèle `ShareLink` dans `prisma/schema.prisma` (avec maxAccessCount et revokedAt)
  - [x] Ajouter modèle `AccessLog` dans `prisma/schema.prisma`
  - [x] Ajouter enum `AccessAction` dans `prisma/schema.prisma`

- [x] **Task 2: Créer les types partagés** (AC: 1-4, 6, 7)
  - [x] Créer `packages/shared/src/types/share.types.ts`
  - [x] Définir `CreateShareLinkDto`, `ShareLinkResponse`
  - [x] Définir enum `ExpirationDuration` (1h, 24h, 7d, 30d)
  - [x] Définir `MAX_ACCESS_OPTIONS` (1, 5, 10, null=illimité)
  - [x] Créer `packages/shared/src/types/access-log.types.ts`
  - [x] Définir `AccessLogResponse`, enum `AccessAction`

- [x] **Task 3: Créer le service sharing** (AC: 3, 4, 7, 8, 11)
  - [x] Créer `apps/api/src/modules/documents/sharing.service.ts`
  - [x] Implémenter `createShareLink(documentId, expiresIn, maxAccessCount, userId)`
  - [x] Générer token sécurisé avec `crypto.randomBytes`
  - [x] Implémenter `getDocumentByShareToken(token)` - vérifie expiration, révocation et max accès
  - [x] Implémenter access count increment dans getDocumentByShareToken
  - [x] Implémenter `revokeShareLink(documentId, linkId, userId)` - met à jour revokedAt
  - [x] Implémenter `getShareLinks(documentId)` - liste les liens actifs

- [x] **Task 4: Créer le service access-logs** (AC: 7, 8)
  - [x] Créer `apps/api/src/modules/documents/access-logs.service.ts`
  - [x] Implémenter `logAccess(documentId, userId, action, ipAddress, metadata)`
  - [x] Implémenter `getAccessLogs(documentId, page, pageSize)`
  - [x] Actions : VIEW, DOWNLOAD, SHARE, SHARE_REVOKE, EDIT, DELETE, SHARE_DOWNLOAD

- [x] **Task 5: Logging intégré** (AC: 7)
  - [x] Logging automatique dans sharing.service (SHARE, SHARE_REVOKE)
  - [x] Logging dans sharing.controller (SHARE_DOWNLOAD)
  - [x] Extraction IP depuis `req.ip` ou `X-Forwarded-For`

- [x] **Task 6: Créer les routes sharing** (AC: 3, 4, 8, 11)
  - [x] `POST /api/documents/:id/share` → `createShareLink` (Staff/Super-Admin)
  - [x] `GET /api/share/:token` → `downloadByShareToken` (public, pas d'auth)
  - [x] `GET /api/documents/:id/share-links` → `getShareLinks` (Staff/Super-Admin)
  - [x] `DELETE /api/documents/:id/share/:linkId` → `revokeShareLink` (Staff/Super-Admin)
  - [x] Vérifier permission WRITE sur le document pour créer/révoquer un lien

- [x] **Task 7: Créer la route access-logs** (AC: 8)
  - [x] `GET /api/documents/:id/access-logs` → `getAccessLogs` (Super-Admin only)
  - [x] Pagination supportée

- [x] **Task 8: Créer le composant ShareButton UI** (AC: 5, 6, 7)
  - [x] Créer `apps/web/src/components/documents/ShareButton.tsx`
  - [x] Dialog avec options de durée d'expiration
  - [x] Dialog avec options de nombre d'accès max (1, 5, 10, illimité)
  - [x] Affiche le lien généré avec bouton copier

- [x] **Task 8b: Créer le composant ShareLinksManager UI** (AC: 11, 13)
  - [x] Créer `apps/web/src/components/documents/ShareLinksManager.tsx`
  - [x] Liste des liens actifs : token (tronqué), expire le, accès restants, créé par
  - [x] Bouton "Révoquer" pour chaque lien avec confirmation AlertDialog
  - [x] Intégré dans DocumentDrawer (visible Staff/Super-Admin)

- [x] **Task 9: Créer la section AccessLogs UI** (AC: 9)
  - [x] Créer `apps/web/src/components/documents/AccessLogs.tsx`
  - [x] Liste avec : Date, Utilisateur/Externe, Action, IP
  - [x] Visible uniquement pour Super-Admin
  - [x] Intégré dans DocumentDrawer

- [ ] **Task 10: Écrire les tests de sécurité** (AC: 10)
  - [ ] Test lien expiré → 403 Forbidden
  - [ ] Test token invalide → 404 Not Found
  - [ ] Test token valide → 302 redirect
  - [ ] Test création lien sans permission → 403
  - [ ] Test max accès atteint → 403
  - [ ] Test lien révoqué → 403

## Dev Notes

### Structure des fichiers à créer/modifier

```
prisma/
  schema.prisma              # Ajouter ShareLink, AccessLog

packages/shared/src/
  types/share.types.ts       # Nouveau
  types/access-log.types.ts  # Nouveau

apps/api/src/
  modules/documents/
    sharing.service.ts       # Nouveau
    access-logs.service.ts   # Nouveau
    documents.routes.ts      # Ajouter routes
  middleware/
    access-logger.middleware.ts  # Nouveau
  routes/
    share.routes.ts          # Nouveau (route publique)

apps/web/src/
  components/documents/
    ShareButton.tsx          # Nouveau
    ShareLinksManager.tsx    # Nouveau
    AccessLogs.tsx           # Nouveau
  hooks/
    useShareLinks.ts         # Nouveau
```

### Schémas Prisma

```prisma
model ShareLink {
  id             String    @id @default(cuid())
  documentId     String
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  token          String    @unique
  expiresAt      DateTime
  maxAccessCount Int?      // null = illimité
  createdById    String
  createdBy      User      @relation(fields: [createdById], references: [id])
  accessCount    Int       @default(0)
  revokedAt      DateTime? // null = actif, date = révoqué
  createdAt      DateTime  @default(now())

  @@map("share_links")
}

model AccessLog {
  id         String       @id @default(cuid())
  documentId String
  document   Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String?      // null pour accès via share link
  user       User?        @relation(fields: [userId], references: [id])
  action     AccessAction
  ipAddress  String?
  metadata   Json?        // Infos supplémentaires (share token utilisé, etc.)
  createdAt  DateTime     @default(now())

  @@index([documentId, createdAt])
  @@map("access_logs")
}

enum AccessAction {
  VIEW
  DOWNLOAD
  SHARE
  SHARE_REVOKE    // Révocation d'un lien de partage
  EDIT
  DELETE
  SHARE_DOWNLOAD  // Téléchargement via lien partagé
}
```

### Génération de token sécurisé

```typescript
import crypto from 'crypto';

function generateShareToken(): string {
  return crypto.randomBytes(32).toString('hex');
  // Exemple: "a1b2c3d4e5f6..."  (64 caractères)
}
```

### Durées d'expiration et options d'accès

```typescript
export enum ExpirationDuration {
  ONE_HOUR = '1h',
  ONE_DAY = '24h',
  ONE_WEEK = '7d',
  ONE_MONTH = '30d',
}

const EXPIRATION_MS: Record<ExpirationDuration, number> = {
  '1h': 60 * 60 * 1000,
  '24h': 24 * 60 * 60 * 1000,
  '7d': 7 * 24 * 60 * 60 * 1000,
  '30d': 30 * 24 * 60 * 60 * 1000,
};

function calculateExpiresAt(duration: ExpirationDuration): Date {
  return new Date(Date.now() + EXPIRATION_MS[duration]);
}

// Options pour le nombre d'accès max
export const MAX_ACCESS_OPTIONS = [
  { value: 1, label: '1 accès' },
  { value: 5, label: '5 accès' },
  { value: 10, label: '10 accès' },
  { value: null, label: 'Illimité' },
] as const;
```

### Service Sharing

```typescript
// sharing.service.ts
async function createShareLink(
  documentId: string,
  expiresIn: ExpirationDuration,
  maxAccessCount: number | null,
  userId: string
): Promise<ShareLink> {
  const token = generateShareToken();
  const expiresAt = calculateExpiresAt(expiresIn);

  const shareLink = await prisma.shareLink.create({
    data: {
      documentId,
      token,
      expiresAt,
      maxAccessCount, // null = illimité
      createdById: userId,
    },
  });

  // Logger la création du lien
  await accessLogsService.logAccess(documentId, userId, 'SHARE', null);

  return shareLink;
}

async function getDocumentByShareToken(token: string): Promise<Document | null> {
  const shareLink = await prisma.shareLink.findUnique({
    where: { token },
    include: { document: true },
  });

  if (!shareLink) return null;

  // Vérifier si révoqué
  if (shareLink.revokedAt) {
    throw new ForbiddenError('Share link has been revoked');
  }

  // Vérifier expiration
  if (new Date() > shareLink.expiresAt) {
    throw new ForbiddenError('Share link expired');
  }

  // Vérifier nombre d'accès max
  if (shareLink.maxAccessCount !== null && shareLink.accessCount >= shareLink.maxAccessCount) {
    throw new ForbiddenError('Share link max access count reached');
  }

  // Incrémenter le compteur
  await prisma.shareLink.update({
    where: { id: shareLink.id },
    data: { accessCount: { increment: 1 } },
  });

  return shareLink.document;
}

async function revokeShareLink(linkId: string, userId: string): Promise<void> {
  const shareLink = await prisma.shareLink.findUnique({ where: { id: linkId } });

  if (!shareLink) {
    throw new NotFoundError('Share link not found');
  }

  await prisma.shareLink.update({
    where: { id: linkId },
    data: { revokedAt: new Date() },
  });

  // Logger la révocation
  await accessLogsService.logAccess(shareLink.documentId, userId, 'SHARE_REVOKE', null);
}

async function getShareLinks(documentId: string): Promise<ShareLink[]> {
  return prisma.shareLink.findMany({
    where: {
      documentId,
      revokedAt: null,
      expiresAt: { gt: new Date() },
    },
    orderBy: { createdAt: 'desc' },
    include: { createdBy: { select: { firstName: true, lastName: true } } },
  });
}
```

### Route publique pour téléchargement

```typescript
// share.routes.ts (pas de middleware authenticate)
router.get('/share/:token', async (req, res) => {
  const { token } = req.params;

  try {
    const document = await sharingService.getDocumentByShareToken(token);

    if (!document) {
      return res.status(404).json({ error: 'Share link not found' });
    }

    // Logger l'accès
    await accessLogsService.logAccess(
      document.id,
      null, // pas d'userId
      'SHARE_DOWNLOAD',
      req.ip,
      { shareToken: token }
    );

    // Retourner l'URL signée
    const signedUrl = await storageService.getSignedUrl(document.storagePath, 300);
    res.redirect(signedUrl);

  } catch (error) {
    if (error instanceof ForbiddenError) {
      return res.status(403).json({ error: error.message });
    }
    throw error;
  }
});
```

### Composant ShareButton

```tsx
// ShareButton.tsx
export function ShareButton({ document }: { document: Document }) {
  const [duration, setDuration] = useState<ExpirationDuration>('24h');
  const [maxAccess, setMaxAccess] = useState<number | null>(null); // null = illimité
  const [shareUrl, setShareUrl] = useState<string | null>(null);
  const createShare = useCreateShareLink();

  const handleShare = async () => {
    const result = await createShare.mutateAsync({
      documentId: document.id,
      expiresIn: duration,
      maxAccessCount: maxAccess,
    });
    setShareUrl(`${window.location.origin}/share/${result.token}`);
  };

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button variant="outline">
          <ShareIcon className="w-4 h-4 mr-2" />
          Partager
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80">
        {!shareUrl ? (
          <div className="space-y-4">
            <h4 className="font-medium">Créer un lien de partage</h4>

            {/* Durée d'expiration */}
            <div className="space-y-2">
              <Label>Expire dans</Label>
              <Select value={duration} onValueChange={setDuration}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="1h">1 heure</SelectItem>
                  <SelectItem value="24h">24 heures</SelectItem>
                  <SelectItem value="7d">7 jours</SelectItem>
                  <SelectItem value="30d">30 jours</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {/* Nombre d'accès max */}
            <div className="space-y-2">
              <Label>Nombre d'accès max</Label>
              <Select
                value={maxAccess?.toString() ?? 'unlimited'}
                onValueChange={(v) => setMaxAccess(v === 'unlimited' ? null : parseInt(v))}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="1">1 accès</SelectItem>
                  <SelectItem value="5">5 accès</SelectItem>
                  <SelectItem value="10">10 accès</SelectItem>
                  <SelectItem value="unlimited">Illimité</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <Button onClick={handleShare} className="w-full">
              Générer le lien
            </Button>
          </div>
        ) : (
          <div className="space-y-4">
            <h4 className="font-medium">Lien de partage</h4>
            <div className="flex gap-2">
              <Input value={shareUrl} readOnly className="text-xs" />
              <Button
                variant="outline"
                size="icon"
                onClick={() => navigator.clipboard.writeText(shareUrl)}
              >
                <CopyIcon className="w-4 h-4" />
              </Button>
            </div>
            <p className="text-xs text-muted-foreground">
              Expire dans {durationLabels[duration]}
              {maxAccess && ` • ${maxAccess} accès max`}
            </p>
          </div>
        )}
      </PopoverContent>
    </Popover>
  );
}
```

### Composant ShareLinksManager

```tsx
// ShareLinksManager.tsx
export function ShareLinksManager({ document }: { document: Document }) {
  const { data: shareLinks, isLoading } = useShareLinks(document.id);
  const revokeLink = useRevokeShareLink();

  const handleRevoke = async (linkId: string) => {
    if (confirm('Êtes-vous sûr de vouloir révoquer ce lien ?')) {
      await revokeLink.mutateAsync({ documentId: document.id, linkId });
      toast.success('Lien révoqué');
    }
  };

  if (isLoading) return <Skeleton className="h-24" />;

  if (!shareLinks?.length) {
    return (
      <p className="text-sm text-muted-foreground">
        Aucun lien de partage actif
      </p>
    );
  }

  return (
    <div className="space-y-3">
      <h4 className="font-medium">Liens de partage actifs</h4>
      <div className="space-y-2">
        {shareLinks.map((link) => (
          <div
            key={link.id}
            className="flex items-center justify-between p-2 border rounded text-sm"
          >
            <div className="space-y-1">
              <code className="text-xs bg-muted px-1 rounded">
                ...{link.token.slice(-8)}
              </code>
              <div className="text-muted-foreground text-xs">
                Expire le {formatDate(link.expiresAt)}
                {link.maxAccessCount && (
                  <> • {link.accessCount}/{link.maxAccessCount} accès</>
                )}
              </div>
            </div>
            <Button
              variant="ghost"
              size="sm"
              onClick={() => handleRevoke(link.id)}
              className="text-destructive hover:text-destructive"
            >
              <TrashIcon className="w-4 h-4" />
            </Button>
          </div>
        ))}
      </div>
    </div>
  );
}
```

## Testing

### Tests de sécurité requis

1. **Token valide**
   - GET /share/{valid-token} → 302 redirect vers URL signée
   - accessCount incrémenté

2. **Token expiré**
   - GET /share/{expired-token} → 403 "Share link expired"

3. **Token invalide**
   - GET /share/{random-string} → 404 "Share link not found"

4. **Token révoqué**
   - GET /share/{revoked-token} → 403 "Share link has been revoked"

5. **Max accès atteint**
   - Créer lien avec maxAccessCount=1
   - Premier accès → 302 redirect
   - Deuxième accès → 403 "Share link max access count reached"

6. **Création de lien**
   - POST sans permission WRITE → 403
   - POST avec permission WRITE → 201 + lien créé
   - POST avec maxAccessCount=5 → lien créé avec limite

7. **Révocation de lien**
   - DELETE sans permission → 403
   - DELETE avec permission → 200 + revokedAt mis à jour
   - Accès après révocation → 403

8. **Liste des liens**
   - GET /share-links sans permission → 403
   - GET /share-links avec permission → 200 + liste (exclut révoqués et expirés)

9. **Access logs**
   - GET logs sans Super-Admin → 403
   - GET logs avec Super-Admin → 200 + liste

## Dependencies

- **Requires**: Story 2.3-2.5 (Document APIs), Story 2.9 (Document Details UI)
- **Blocks**: Aucun (dernière story de l'Epic 2)

## Dev Agent Record

### File List

| File | Action |
|------|--------|
| `prisma/schema.prisma` | Modified - Added ShareLink, AccessLog models and AccessAction enum |
| `packages/shared/src/types/share.types.ts` | Created - Share link types and enums |
| `packages/shared/src/types/access-log.types.ts` | Created - Access log types and enums |
| `packages/shared/src/types/index.ts` | Modified - Added exports |
| `packages/shared/src/validators/share.validators.ts` | Created - Zod schemas for share links |
| `packages/shared/src/validators/index.ts` | Modified - Added export |
| `apps/api/package.json` | Modified - Added @ong-chadia/shared dependency |
| `apps/api/src/modules/documents/sharing.service.ts` | Created - Share link management service |
| `apps/api/src/modules/documents/access-logs.service.ts` | Created - Access logging service |
| `apps/api/src/modules/documents/sharing.controller.ts` | Created - HTTP handlers for sharing |
| `apps/api/src/modules/documents/share.routes.ts` | Created - Public share route |
| `apps/api/src/modules/documents/documents.routes.ts` | Modified - Added sharing and access log routes |
| `apps/api/src/modules/documents/index.ts` | Modified - Added exports |
| `apps/api/src/app.ts` | Modified - Added share routes |
| `apps/web/src/services/sharing.service.ts` | Created - Frontend API service |
| `apps/web/src/hooks/useSharing.ts` | Created - TanStack Query hooks |
| `apps/web/src/components/documents/ShareButton.tsx` | Created - Share link creation dialog |
| `apps/web/src/components/documents/ShareLinksManager.tsx` | Created - Active links management |
| `apps/web/src/components/documents/AccessLogs.tsx` | Created - Access audit log display |
| `apps/web/src/components/documents/DocumentDrawer.tsx` | Modified - Integrated sharing components |
| `apps/web/src/components/documents/index.ts` | Modified - Added exports |

### Completion Notes

- Implemented ShareLink model with token, expiration, maxAccessCount, revokedAt, accessCount
- Implemented AccessLog model for comprehensive audit trail
- Token generation uses crypto.randomBytes(32) for security
- Share link validation checks: expiration, revocation, max access count
- Public route `/api/share/:token` allows download without authentication
- Staff and Super-Admin can create/revoke share links (WRITE permission required)
- Only Super-Admin can view access logs
- Frontend components integrated into DocumentDrawer with role-based visibility
- All 192 existing tests pass

### Agent Model Used

Claude Opus 4.5

## Change Log

| Date       | Version | Description                                                                                    | Author            |
|------------|---------|------------------------------------------------------------------------------------------------|-------------------|
| 2026-01-23 | 1.0     | Création initiale de la story                                                                  | SM Agent (Bob)    |
| 2026-01-24 | 1.1     | Ajout AC #7 (max accès), AC #8 (révocation), AC #11 (liste liens), AC #13 (UI gestion liens)   | PO Agent (Sarah)  |
| 2026-01-24 | 1.2     | Implementation complete (Tasks 1-9) | Dev Agent (James) |
