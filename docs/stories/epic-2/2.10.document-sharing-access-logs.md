# Story 2.10: Document Sharing & Access Logs

## Status

Draft

## Story

**As a** Staff ou Super-Admin,
**I want** partager un document via lien sécurisé et voir qui y a accédé,
**so that** je puisse collaborer avec des partenaires externes et auditer les accès.

## Acceptance Criteria

1. Schéma Prisma `ShareLink` : id, documentId, token (unique), expiresAt, createdById, accessCount
2. Schéma Prisma `AccessLog` : id, documentId, userId (nullable pour liens), action, ipAddress, createdAt
3. Endpoint `POST /api/documents/:id/share` créant un lien de partage avec expiration
4. Endpoint `GET /api/share/:token` permettant téléchargement sans auth (lien public temporaire)
5. Bouton "Partager" dans l'UI générant et affichant le lien
6. Option de durée d'expiration (1h, 24h, 7 jours, 30 jours)
7. Logging automatique de tous les accès aux documents sensibles
8. Endpoint `GET /api/documents/:id/access-logs` listant les accès (Super-Admin)
9. UI affichant les logs d'accès dans les détails du document (si autorisé)
10. Tests de sécurité : lien expiré retourne 403, token invalide retourne 404

## Tasks / Subtasks

- [ ] **Task 1: Créer les schémas Prisma** (AC: 1, 2)
  - [ ] Ajouter modèle `ShareLink` dans `prisma/schema.prisma`
  - [ ] Ajouter modèle `AccessLog` dans `prisma/schema.prisma`
  - [ ] Créer et exécuter la migration

- [ ] **Task 2: Créer les types partagés** (AC: 1-4, 6)
  - [ ] Créer `packages/shared/src/types/share.types.ts`
  - [ ] Définir `CreateShareLinkDto`, `ShareLinkResponse`
  - [ ] Définir enum `ExpirationDuration` (1h, 24h, 7d, 30d)
  - [ ] Créer `packages/shared/src/types/access-log.types.ts`
  - [ ] Définir `AccessLogResponse`, enum `AccessAction`

- [ ] **Task 3: Créer le service sharing** (AC: 3, 4)
  - [ ] Créer `apps/api/src/modules/documents/sharing.service.ts`
  - [ ] Implémenter `createShareLink(documentId, expiresIn, userId)`
  - [ ] Générer token sécurisé avec `crypto.randomBytes`
  - [ ] Implémenter `getDocumentByShareToken(token)` - vérifie expiration
  - [ ] Implémenter `incrementAccessCount(shareLink)`

- [ ] **Task 4: Créer le service access-logs** (AC: 7, 8)
  - [ ] Créer `apps/api/src/modules/documents/access-logs.service.ts`
  - [ ] Implémenter `logAccess(documentId, userId, action, ipAddress)`
  - [ ] Implémenter `getAccessLogs(documentId, pagination)`
  - [ ] Actions : VIEW, DOWNLOAD, SHARE, EDIT, DELETE

- [ ] **Task 5: Créer le middleware de logging** (AC: 7)
  - [ ] Créer `apps/api/src/middleware/access-logger.middleware.ts`
  - [ ] Logger automatiquement les accès aux endpoints documents
  - [ ] Extraire IP depuis `req.ip` ou `X-Forwarded-For`

- [ ] **Task 6: Créer les routes sharing** (AC: 3, 4)
  - [ ] `POST /api/documents/:id/share` → `createShareLink` (Staff/Super-Admin)
  - [ ] `GET /api/share/:token` → `downloadByShareToken` (public, pas d'auth)
  - [ ] Vérifier permission ADMIN ou WRITE sur le document pour créer un lien

- [ ] **Task 7: Créer la route access-logs** (AC: 8)
  - [ ] `GET /api/documents/:id/access-logs` → `getAccessLogs` (Super-Admin only)
  - [ ] Pagination supportée

- [ ] **Task 8: Créer le composant ShareButton UI** (AC: 5, 6)
  - [ ] Créer `apps/web/src/components/documents/ShareButton.tsx`
  - [ ] Popover avec options de durée
  - [ ] Affiche le lien généré avec bouton copier

- [ ] **Task 9: Créer la section AccessLogs UI** (AC: 9)
  - [ ] Créer `apps/web/src/components/documents/AccessLogs.tsx`
  - [ ] Tableau avec : Date, Utilisateur, Action, IP
  - [ ] Visible uniquement pour Super-Admin
  - [ ] Intégrer dans DocumentDrawer

- [ ] **Task 10: Écrire les tests de sécurité** (AC: 10)
  - [ ] Test lien expiré → 403 Forbidden
  - [ ] Test token invalide → 404 Not Found
  - [ ] Test token valide → 200 + téléchargement
  - [ ] Test création lien sans permission → 403

## Dev Notes

### Structure des fichiers à créer/modifier

```
prisma/
  schema.prisma              # Ajouter ShareLink, AccessLog

packages/shared/src/
  types/share.types.ts       # Nouveau
  types/access-log.types.ts  # Nouveau

apps/api/src/
  modules/documents/
    sharing.service.ts       # Nouveau
    access-logs.service.ts   # Nouveau
    documents.routes.ts      # Ajouter routes
  middleware/
    access-logger.middleware.ts  # Nouveau
  routes/
    share.routes.ts          # Nouveau (route publique)

apps/web/src/
  components/documents/
    ShareButton.tsx          # Nouveau
    AccessLogs.tsx           # Nouveau
```

### Schémas Prisma

```prisma
model ShareLink {
  id          String   @id @default(cuid())
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  token       String   @unique
  expiresAt   DateTime
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  accessCount Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("share_links")
}

model AccessLog {
  id         String       @id @default(cuid())
  documentId String
  document   Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String?      // null pour accès via share link
  user       User?        @relation(fields: [userId], references: [id])
  action     AccessAction
  ipAddress  String?
  metadata   Json?        // Infos supplémentaires (share token utilisé, etc.)
  createdAt  DateTime     @default(now())

  @@index([documentId, createdAt])
  @@map("access_logs")
}

enum AccessAction {
  VIEW
  DOWNLOAD
  SHARE
  EDIT
  DELETE
  SHARE_DOWNLOAD  // Téléchargement via lien partagé
}
```

### Génération de token sécurisé

```typescript
import crypto from 'crypto';

function generateShareToken(): string {
  return crypto.randomBytes(32).toString('hex');
  // Exemple: "a1b2c3d4e5f6..."  (64 caractères)
}
```

### Durées d'expiration

```typescript
export enum ExpirationDuration {
  ONE_HOUR = '1h',
  ONE_DAY = '24h',
  ONE_WEEK = '7d',
  ONE_MONTH = '30d',
}

const EXPIRATION_MS: Record<ExpirationDuration, number> = {
  '1h': 60 * 60 * 1000,
  '24h': 24 * 60 * 60 * 1000,
  '7d': 7 * 24 * 60 * 60 * 1000,
  '30d': 30 * 24 * 60 * 60 * 1000,
};

function calculateExpiresAt(duration: ExpirationDuration): Date {
  return new Date(Date.now() + EXPIRATION_MS[duration]);
}
```

### Service Sharing

```typescript
// sharing.service.ts
async function createShareLink(
  documentId: string,
  expiresIn: ExpirationDuration,
  userId: string
): Promise<ShareLink> {
  const token = generateShareToken();
  const expiresAt = calculateExpiresAt(expiresIn);

  const shareLink = await prisma.shareLink.create({
    data: {
      documentId,
      token,
      expiresAt,
      createdById: userId,
    },
  });

  // Logger la création du lien
  await accessLogsService.logAccess(documentId, userId, 'SHARE', null);

  return shareLink;
}

async function getDocumentByShareToken(token: string): Promise<Document | null> {
  const shareLink = await prisma.shareLink.findUnique({
    where: { token },
    include: { document: true },
  });

  if (!shareLink) return null;

  // Vérifier expiration
  if (new Date() > shareLink.expiresAt) {
    throw new ForbiddenError('Share link expired');
  }

  // Incrémenter le compteur
  await prisma.shareLink.update({
    where: { id: shareLink.id },
    data: { accessCount: { increment: 1 } },
  });

  return shareLink.document;
}
```

### Route publique pour téléchargement

```typescript
// share.routes.ts (pas de middleware authenticate)
router.get('/share/:token', async (req, res) => {
  const { token } = req.params;

  try {
    const document = await sharingService.getDocumentByShareToken(token);

    if (!document) {
      return res.status(404).json({ error: 'Share link not found' });
    }

    // Logger l'accès
    await accessLogsService.logAccess(
      document.id,
      null, // pas d'userId
      'SHARE_DOWNLOAD',
      req.ip,
      { shareToken: token }
    );

    // Retourner l'URL signée
    const signedUrl = await storageService.getSignedUrl(document.storagePath, 300);
    res.redirect(signedUrl);

  } catch (error) {
    if (error instanceof ForbiddenError) {
      return res.status(403).json({ error: error.message });
    }
    throw error;
  }
});
```

### Composant ShareButton

```tsx
// ShareButton.tsx
export function ShareButton({ document }: { document: Document }) {
  const [duration, setDuration] = useState<ExpirationDuration>('24h');
  const [shareUrl, setShareUrl] = useState<string | null>(null);
  const createShare = useCreateShareLink();

  const handleShare = async () => {
    const result = await createShare.mutateAsync({
      documentId: document.id,
      expiresIn: duration,
    });
    setShareUrl(`${window.location.origin}/share/${result.token}`);
  };

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button variant="outline">
          <ShareIcon className="w-4 h-4 mr-2" />
          Partager
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80">
        {!shareUrl ? (
          <div className="space-y-4">
            <h4 className="font-medium">Créer un lien de partage</h4>
            <Select value={duration} onValueChange={setDuration}>
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="1h">1 heure</SelectItem>
                <SelectItem value="24h">24 heures</SelectItem>
                <SelectItem value="7d">7 jours</SelectItem>
                <SelectItem value="30d">30 jours</SelectItem>
              </SelectContent>
            </Select>
            <Button onClick={handleShare} className="w-full">
              Générer le lien
            </Button>
          </div>
        ) : (
          <div className="space-y-4">
            <h4 className="font-medium">Lien de partage</h4>
            <div className="flex gap-2">
              <Input value={shareUrl} readOnly className="text-xs" />
              <Button
                variant="outline"
                size="icon"
                onClick={() => navigator.clipboard.writeText(shareUrl)}
              >
                <CopyIcon className="w-4 h-4" />
              </Button>
            </div>
            <p className="text-xs text-muted-foreground">
              Ce lien expire dans {durationLabels[duration]}
            </p>
          </div>
        )}
      </PopoverContent>
    </Popover>
  );
}
```

## Testing

### Tests de sécurité requis

1. **Token valide**
   - GET /share/{valid-token} → 302 redirect vers URL signée
   - accessCount incrémenté

2. **Token expiré**
   - GET /share/{expired-token} → 403 "Share link expired"

3. **Token invalide**
   - GET /share/{random-string} → 404 "Share link not found"

4. **Création de lien**
   - POST sans permission WRITE → 403
   - POST avec permission WRITE → 201 + lien créé

5. **Access logs**
   - GET logs sans Super-Admin → 403
   - GET logs avec Super-Admin → 200 + liste

## Dependencies

- **Requires**: Story 2.3-2.5 (Document APIs), Story 2.9 (Document Details UI)
- **Blocks**: Aucun (dernière story de l'Epic 2)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
