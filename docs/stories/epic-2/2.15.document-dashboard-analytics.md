# Story 2.15: Dashboard Documents & Analytics

## Status

Complete

## Story

**As a** Staff ou Super-Admin,
**I want** avoir un tableau de bord avec des statistiques sur les documents,
**so that** je puisse suivre l'utilisation de la GED et identifier les tendances.

> **Inspiré de** : SharePoint Analytics, Box Admin Console, Google Drive Activity Dashboard

## Acceptance Criteria

1. Widget "Aperçu stockage" : espace utilisé vs quota, jauge visuelle
2. Widget "Documents récents" : 5 derniers uploads avec preview miniature
3. Widget "Activité" : graphique d'uploads par jour (30 derniers jours)
4. Widget "Répartition par type" : camembert (PDF, Word, Excel, Images, Autres)
5. Widget "Top dossiers" : dossiers avec le plus de documents
6. Widget "Utilisateurs actifs" : top contributeurs (nombre d'uploads)
7. Filtres par période : 7j, 30j, 90j, 12 mois
8. Export des statistiques en PDF
9. Données temps réel (actualisation automatique toutes les 5 minutes)
10. Accès réservé aux rôles Staff et Super-Admin

## Tasks / Subtasks

- [x] **Task 1: Créer les endpoints API analytics**
  - [x] `GET /api/analytics/storage` - Usage stockage
  - [x] `GET /api/analytics/uploads` - Historique uploads par jour
  - [x] `GET /api/analytics/types` - Répartition par type MIME
  - [x] `GET /api/analytics/folders` - Top dossiers
  - [x] `GET /api/analytics/users` - Top contributeurs
  - [x] Paramètre `?period=7d|30d|90d|12m`

- [x] **Task 2: Créer les hooks React analytics**
  - [x] `useStorageAnalytics()` - Données stockage
  - [x] `useUploadAnalytics(period)` - Historique uploads
  - [x] `useTypeAnalytics()` - Répartition types
  - [x] `useFolderAnalytics()` - Top dossiers
  - [x] `useUserAnalytics()` - Top utilisateurs
  - [x] Refresh automatique avec `refetchInterval`

- [x] **Task 3: Créer le widget Storage Overview**
  - [x] Composant `StorageWidget.tsx`
  - [x] Jauge circulaire (radial progress)
  - [x] Couleur selon usage (vert < 70%, orange 70-90%, rouge > 90%)
  - [x] Détail : X Mo utilisés sur Y Mo

- [x] **Task 4: Créer le widget Recent Documents**
  - [x] Composant `RecentUploadsWidget.tsx`
  - [x] Liste des 5 derniers avec miniature
  - [x] Nom, type, date, uploadé par
  - [x] Clic ouvre DocumentDrawer

- [x] **Task 5: Créer le widget Activity Chart**
  - [x] Composant `ActivityChartWidget.tsx`
  - [x] Graphique ligne avec recharts ou chart.js
  - [x] Axe X : dates, Axe Y : nombre d'uploads
  - [x] Tooltip au survol

- [x] **Task 6: Créer le widget Type Distribution**
  - [x] Composant `TypeDistributionWidget.tsx`
  - [x] Camembert (pie chart)
  - [x] Légende avec pourcentages
  - [x] Couleurs par type (PDF=rouge, Word=bleu, etc.)

- [x] **Task 7: Créer le widget Top Folders**
  - [x] Composant `TopFoldersWidget.tsx`
  - [x] Liste des 5 dossiers avec le plus de docs
  - [x] Barre de progression relative
  - [x] Clic navigue vers le dossier

- [x] **Task 8: Créer le widget Top Contributors**
  - [x] Composant `TopContributorsWidget.tsx`
  - [x] Avatar + nom + nombre d'uploads
  - [x] Top 5 utilisateurs
  - [x] Badge pour le #1

- [x] **Task 9: Créer la page Dashboard Documents**
  - [x] Page `/analytics` accessible via routing
  - [x] Grid responsive des widgets
  - [x] Filtre période en haut
  - [x] RoleGuard pour Staff/Super-Admin (via API middleware)

- [x] **Task 10: Implémenter l'export PDF**
  - [x] Bouton "Exporter en PDF"
  - [x] Utiliser jsPDF + html2canvas
  - [x] Inclure tous les graphiques (capture du dashboard)
  - [x] En-tête avec période et date de génération

## Dev Notes

### Endpoints API

```typescript
// GET /api/analytics/storage
{
  used: 2147483648,        // bytes
  quota: 10737418240,      // bytes (10 GB)
  percentage: 20,
  documentCount: 1248
}

// GET /api/analytics/uploads?period=30d
{
  data: [
    { date: '2026-01-01', count: 12 },
    { date: '2026-01-02', count: 8 },
    ...
  ],
  total: 245
}

// GET /api/analytics/types
{
  data: [
    { type: 'application/pdf', label: 'PDF', count: 342, percentage: 27 },
    { type: 'application/vnd.openxmlformats...', label: 'Word', count: 256, percentage: 20 },
    ...
  ]
}

// GET /api/analytics/folders?limit=5
{
  data: [
    { id, name, path: '/Projects/2026', documentCount: 156 },
    ...
  ]
}

// GET /api/analytics/users?limit=5
{
  data: [
    { id, firstName, lastName, email, uploadCount: 89 },
    ...
  ]
}
```

### Widget Storage avec jauge circulaire

```tsx
import { PieChart, Pie, Cell } from 'recharts';

export function StorageWidget() {
  const { data } = useStorageAnalytics();

  const percentage = data?.percentage || 0;
  const color = percentage > 90 ? '#ef4444' : percentage > 70 ? '#f59e0b' : '#10b981';

  return (
    <Card>
      <CardHeader>
        <CardTitle>Stockage</CardTitle>
      </CardHeader>
      <CardContent className="flex flex-col items-center">
        <div className="relative">
          <PieChart width={120} height={120}>
            <Pie
              data={[
                { value: percentage },
                { value: 100 - percentage },
              ]}
              innerRadius={40}
              outerRadius={55}
              startAngle={90}
              endAngle={-270}
              dataKey="value"
            >
              <Cell fill={color} />
              <Cell fill="#e5e7eb" />
            </Pie>
          </PieChart>
          <div className="absolute inset-0 flex items-center justify-center">
            <span className="text-2xl font-bold">{percentage}%</span>
          </div>
        </div>

        <p className="mt-4 text-sm text-muted-foreground">
          {formatBytes(data?.used)} / {formatBytes(data?.quota)}
        </p>
        <p className="text-xs text-muted-foreground">
          {data?.documentCount} documents
        </p>
      </CardContent>
    </Card>
  );
}
```

### Graphique Activity avec recharts

```tsx
import { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } from 'recharts';

export function ActivityChartWidget({ period }: { period: string }) {
  const { data } = useUploadAnalytics(period);

  return (
    <Card className="col-span-2">
      <CardHeader>
        <CardTitle>Activité d'upload</CardTitle>
        <CardDescription>{data?.total} documents uploadés</CardDescription>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={200}>
          <LineChart data={data?.data}>
            <XAxis
              dataKey="date"
              tickFormatter={(d) => format(new Date(d), 'dd/MM')}
              stroke="#94a3b8"
            />
            <YAxis stroke="#94a3b8" />
            <Tooltip
              labelFormatter={(d) => format(new Date(d), 'dd MMMM yyyy', { locale: fr })}
            />
            <Line
              type="monotone"
              dataKey="count"
              stroke="#0d9488"
              strokeWidth={2}
              dot={false}
            />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  );
}
```

### Sources d'inspiration

- [SharePoint - Usage reports](https://learn.microsoft.com/en-us/sharepoint/site-usage-reports)
- [Box - Admin Analytics](https://support.box.com/hc/en-us/articles/360043695614)
- [Google Workspace - Drive activity](https://support.google.com/a/answer/9010922)

## Testing

### Tests recommandés

1. **API Analytics**
   - Retourne les bonnes agrégations
   - Filtrage par période fonctionne
   - Permissions respectées (Staff/Admin only)

2. **Widgets**
   - Affichent les données correctement
   - Responsive sur mobile
   - Loading states

3. **Export PDF**
   - Génère un PDF valide
   - Inclut tous les graphiques

## Dependencies

- **Requires**: Story 2.3 (Upload), Story 2.10 (Access Logs)
- **Blocks**: None

## Dev Agent Record

### File List

| File | Action |
|------|--------|
| `apps/api/src/modules/analytics/analytics.service.ts` | Existing - All analytics functions |
| `apps/api/src/modules/analytics/analytics.controller.ts` | Existing - Controller endpoints |
| `apps/api/src/modules/analytics/analytics.routes.ts` | Existing - Routes with Staff/Admin guard |
| `apps/web/src/services/analytics.service.ts` | Existing - Frontend API service |
| `apps/web/src/hooks/useAnalytics.ts` | Existing - React Query hooks with 5min refresh |
| `apps/web/src/components/analytics/StorageWidget.tsx` | Existing - Storage gauge widget |
| `apps/web/src/components/analytics/ActivityChartWidget.tsx` | Existing - Line chart widget |
| `apps/web/src/components/analytics/TypeDistributionWidget.tsx` | Existing - Pie chart widget |
| `apps/web/src/components/analytics/TopFoldersWidget.tsx` | Existing - Top folders list |
| `apps/web/src/components/analytics/TopContributorsWidget.tsx` | Existing - Top users list |
| `apps/web/src/components/analytics/RecentUploadsWidget.tsx` | Existing - Recent uploads list |
| `apps/web/src/pages/AnalyticsDashboardPage.tsx` | Modified - Added PDF export functionality |
| `apps/web/package.json` | Modified - Added jspdf, html2canvas |

### Completion Notes

- Most of the story was already implemented in a previous session
- Task 10 (PDF export) was the main implementation work
- PDF export uses dynamic imports for jspdf/html2canvas to reduce initial bundle
- Export captures the widgets grid with html2canvas, then generates PDF with jsPDF
- Header includes: title, period filter selection, generation date/time
- Routes protected via isStaffOrAbove middleware in API
- Auto-refresh every 5 minutes via refetchInterval in useQuery

### Agent Model Used

Claude Opus 4.5

---

## PO Review

### Review Date: 2026-01-26

### Reviewer: Sarah (Product Owner)

### Review Summary

| Critère | Score | Commentaire |
|---------|-------|-------------|
| Complétude Template | ✅ 10/10 | Structure complète |
| Acceptance Criteria | ✅ 10/10 | 10 AC clairs |
| Tasks/Subtasks | ✅ 10/10 | 10 tâches avec widgets |
| Dev Notes | ✅ 10/10 | Recharts + API examples |
| Testing | ⚠️ 7/10 | Tests basiques |
| Sécurité | ✅ 10/10 | RoleGuard Staff/Admin |

### Verdict: **GO** ✅

### Implementation Readiness Score: 9.4/10

### Confidence Level: High

### Recommendations
1. Définir quota de stockage par défaut (suggestion: 10 GB par organisation)
2. Préciser fréquence de cache des analytics (suggestion: 5 min)
3. Ajouter loading skeletons pour chaque widget
4. Considérer lazy loading des widgets moins critiques

### Notes
- Dashboard inspiré de SharePoint/Box Analytics - patterns éprouvés
- Jauge stockage avec code couleur - feedback visuel immédiat
- Graphique activité aide à identifier les pics d'utilisation
- Top contributeurs encourage l'engagement
- Export PDF pour reporting direction

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | Dev Agent (James) |
| 2026-01-26 | 1.1 | PO Review - Approuvé | Sarah (PO) |
| 2026-01-27 | 1.2 | Implémentation complète - Export PDF ajouté | James (Dev) |
| 2026-01-27 | 1.3 | PO Implementation Review - APPROVED → Complete | Sarah (PO) |
