# Story 2.11: Enhanced Document Preview

## Status

Ready for Review

## Story

**As a** utilisateur,
**I want** avoir une prévisualisation enrichie des documents avec un viewer plein écran,
**so that** je puisse consulter rapidement le contenu sans télécharger.

## Acceptance Criteria

1. Bouton "Plein écran" dans le preview pour ouvrir un viewer modal
2. Viewer PDF avec navigation pages (précédent/suivant, numéro de page)
3. Viewer PDF avec zoom in/out et fit to width/height
4. Viewer images avec zoom et pan (drag pour déplacer)
5. Galerie d'images si plusieurs images dans le dossier (navigation flèches)
6. Viewer Office (Word, Excel) via intégration Microsoft Office Online ou Google Docs Viewer
7. Preview des fichiers texte (.txt, .md, .json) avec coloration syntaxique
8. Raccourcis clavier : Échap pour fermer, flèches pour naviguer, +/- pour zoom
9. Indicateur de chargement pendant le fetch du document
10. Bouton télécharger accessible dans le viewer plein écran

## Tasks / Subtasks

- [x] **Task 1: Créer le composant FullScreenViewer**
  - [x] Créer `apps/web/src/components/documents/viewers/FullScreenViewer.tsx`
  - [x] Modal plein écran avec fond sombre
  - [x] Boutons close, download, zoom dans la toolbar
  - [x] Support raccourcis clavier

- [x] **Task 2: Implémenter le viewer PDF avancé**
  - [x] Intégrer react-pdf ou pdf.js
  - [x] Contrôles de navigation (page prev/next, input page)
  - [x] Contrôles de zoom (slider ou boutons)
  - [x] Afficher nombre total de pages

- [x] **Task 3: Implémenter le viewer images**
  - [x] Zoom avec molette souris
  - [x] Pan avec drag (quand zoomé)
  - [x] Boutons zoom in/out/reset
  - [x] Fit to screen par défaut

- [x] **Task 4: Implémenter la galerie d'images**
  - [x] Détecter les images dans le même dossier (via siblingDocuments prop)
  - [x] Navigation flèches gauche/droite
  - [x] Compteur "3 / 12"

- [x] **Task 5: Implémenter le viewer Office**
  - [x] Option B : iframe vers Google Docs Viewer
  - [x] Fallback : message "Prévisualisation non disponible, téléchargez le fichier"

- [x] **Task 6: Implémenter le viewer texte**
  - [x] Affichage du contenu brut
  - [x] Numéros de ligne
  - [x] Bouton copier le contenu
  - [x] JSON formatting automatique

- [x] **Task 7: Intégrer dans DocumentDrawer**
  - [x] Bouton "Plein écran" dans DocumentPreview
  - [x] Ouvrir FullScreenViewer au clic

## Dev Notes

### Librairies recommandées

```bash
# Pour PDF
pnpm add react-pdf

# Pour coloration syntaxique (optionnel)
pnpm add prismjs @types/prismjs
```

### Structure des fichiers

```
apps/web/src/components/documents/
  viewers/
    FullScreenViewer.tsx      # Container principal
    PdfViewer.tsx             # PDF avec react-pdf
    ImageViewer.tsx           # Image avec zoom/pan
    ImageGallery.tsx          # Galerie multi-images
    TextViewer.tsx            # Texte avec syntaxe
    OfficeViewer.tsx          # Iframe Office/Google
```

### Composant FullScreenViewer

```tsx
interface FullScreenViewerProps {
  document: DocumentResponse;
  open: boolean;
  onClose: () => void;
  siblingDocuments?: DocumentResponse[]; // Pour galerie
}

export function FullScreenViewer({ document, open, onClose, siblingDocuments }: FullScreenViewerProps) {
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
      if (e.key === 'ArrowLeft') prevDocument();
      if (e.key === 'ArrowRight') nextDocument();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, []);

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-full h-screen p-0 bg-black/95">
        <div className="absolute top-4 right-4 flex gap-2">
          <Button variant="ghost" onClick={handleZoomIn}><ZoomIn /></Button>
          <Button variant="ghost" onClick={handleZoomOut}><ZoomOut /></Button>
          <Button variant="ghost" onClick={handleDownload}><Download /></Button>
          <Button variant="ghost" onClick={onClose}><X /></Button>
        </div>

        <div className="flex items-center justify-center h-full">
          {renderViewer()}
        </div>

        {/* Navigation galerie */}
        {siblingDocuments && siblingDocuments.length > 1 && (
          <>
            <Button className="absolute left-4 top-1/2" onClick={prevDocument}>
              <ChevronLeft />
            </Button>
            <Button className="absolute right-4 top-1/2" onClick={nextDocument}>
              <ChevronRight />
            </Button>
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

### PDF Viewer avec react-pdf

```tsx
import { Document, Page, pdfjs } from 'react-pdf';

pdfjs.GlobalWorkerOptions.workerSrc = `//cdnjs.cloudflare.com/ajax/libs/pdf.js/${pdfjs.version}/pdf.worker.min.js`;

export function PdfViewer({ url }: { url: string }) {
  const [numPages, setNumPages] = useState(0);
  const [pageNumber, setPageNumber] = useState(1);
  const [scale, setScale] = useState(1.0);

  return (
    <div className="flex flex-col items-center">
      <Document
        file={url}
        onLoadSuccess={({ numPages }) => setNumPages(numPages)}
      >
        <Page pageNumber={pageNumber} scale={scale} />
      </Document>

      <div className="flex items-center gap-4 mt-4 bg-white/10 rounded-lg px-4 py-2">
        <Button onClick={() => setPageNumber(p => Math.max(1, p - 1))} disabled={pageNumber <= 1}>
          <ChevronLeft />
        </Button>
        <span className="text-white">
          {pageNumber} / {numPages}
        </span>
        <Button onClick={() => setPageNumber(p => Math.min(numPages, p + 1))} disabled={pageNumber >= numPages}>
          <ChevronRight />
        </Button>

        <div className="h-6 w-px bg-white/20 mx-2" />

        <Button onClick={() => setScale(s => s - 0.25)} disabled={scale <= 0.5}>
          <ZoomOut />
        </Button>
        <span className="text-white w-16 text-center">{Math.round(scale * 100)}%</span>
        <Button onClick={() => setScale(s => s + 0.25)} disabled={scale >= 3}>
          <ZoomIn />
        </Button>
      </div>
    </div>
  );
}
```

### Image Viewer avec zoom

```tsx
export function ImageViewer({ url }: { url: string }) {
  const [scale, setScale] = useState(1);
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [isDragging, setIsDragging] = useState(false);
  const imageRef = useRef<HTMLImageElement>(null);

  const handleWheel = (e: WheelEvent) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    setScale(s => Math.min(5, Math.max(0.5, s + delta)));
  };

  return (
    <div
      className="overflow-hidden cursor-grab active:cursor-grabbing"
      onWheel={handleWheel}
      onMouseDown={() => setIsDragging(true)}
      onMouseUp={() => setIsDragging(false)}
      onMouseMove={(e) => {
        if (isDragging && scale > 1) {
          setPosition(p => ({
            x: p.x + e.movementX,
            y: p.y + e.movementY,
          }));
        }
      }}
    >
      <img
        ref={imageRef}
        src={url}
        alt="Preview"
        style={{
          transform: `translate(${position.x}px, ${position.y}px) scale(${scale})`,
          transition: isDragging ? 'none' : 'transform 0.2s',
        }}
        className="max-h-[80vh] max-w-[90vw] object-contain"
      />
    </div>
  );
}
```

## Testing

### Tests recommandés

1. **PDF Viewer**
   - Navigation pages fonctionne
   - Zoom in/out respecte les limites
   - Chargement affiche loader

2. **Image Viewer**
   - Zoom molette fonctionne
   - Pan quand zoomé > 1
   - Reset zoom

3. **Raccourcis clavier**
   - Échap ferme le viewer
   - Flèches naviguent (galerie)

## Dependencies

- **Requires**: Story 2.9 (Document Details)
- **Blocks**: None

## Dev Agent Record

### File List

| File | Action |
|------|--------|
| apps/web/src/components/documents/viewers/index.ts | Created |
| apps/web/src/components/documents/viewers/FullScreenViewer.tsx | Created |
| apps/web/src/components/documents/viewers/ImageViewer.tsx | Created |
| apps/web/src/components/documents/viewers/PdfViewer.tsx | Created |
| apps/web/src/components/documents/viewers/TextViewer.tsx | Created |
| apps/web/src/components/documents/viewers/OfficeViewer.tsx | Created |
| apps/web/src/components/documents/DocumentPreview.tsx | Modified |
| apps/web/src/components/documents/DocumentDrawer.tsx | Modified |
| apps/web/src/components/documents/index.ts | Modified |
| apps/web/src/components/documents/MoveDocumentModal.tsx | Modified (fix unused import) |
| apps/web/src/components/documents/ShareButton.tsx | Modified (fix button size) |
| apps/web/src/components/documents/VersionHistory.tsx | Modified (fix unused param) |

### Completion Notes

- Implemented full-screen document viewer with keyboard shortcuts (Esc to close, arrows to navigate, +/- for zoom)
- PDF viewer uses react-pdf with page navigation and zoom controls
- Image viewer supports zoom with mouse wheel, pan when zoomed, rotation
- Text viewer displays content with line numbers, copy button, and JSON auto-formatting
- Office viewer uses Google Docs Viewer iframe with download fallback
- Navigation between sibling documents supported (images in same folder)
- Fullscreen button appears on hover in DocumentPreview
- All viewers integrated into DocumentDrawer

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

---

## PO Review

### Review Date: 2026-01-26

### Reviewer: Sarah (Product Owner)

### Review Summary

| Critère | Score | Commentaire |
|---------|-------|-------------|
| Complétude Template | ✅ 10/10 | Toutes les sections présentes |
| Acceptance Criteria | ✅ 10/10 | 10 AC clairs et testables |
| Tasks/Subtasks | ✅ 10/10 | Tous marqués [x] - Implémentés |
| Dev Notes | ✅ 10/10 | Code exemples complets |
| Testing | ✅ 8/10 | Tests recommandés présents |
| File List | ✅ 10/10 | Complète avec 12 fichiers |
| Completion Notes | ✅ 10/10 | Bien documentées |

### Verdict: **GO** ✅

### Implementation Readiness Score: 9.7/10

### Confidence Level: High

### Notes
- Story entièrement implémentée avec succès
- Tous les viewers fonctionnels (PDF, Image, Text, Office)
- Raccourcis clavier implémentés
- Navigation entre documents sibling supportée

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 1.0 | Création initiale de la story | Dev Agent (James) |
| 2026-01-25 | 1.1 | Implémentation complète des viewers (PDF, Image, Text, Office, FullScreen) | Dev Agent (James) |
| 2026-01-26 | 1.2 | PO Review - Approuvé | Sarah (PO) |
