# Story 2.3: Document Upload & Storage API

## Status

Ready for Review

## Story

**As a** utilisateur avec permission WRITE,
**I want** uploader des documents dans un dossier,
**so that** je puisse centraliser mes fichiers dans la GED.

## Acceptance Criteria

1. Schéma Prisma `Document` : id, name, mimeType, size, storagePath, folderId, uploadedById, createdAt
2. Intégration Supabase Storage configurée
3. Endpoint `POST /api/documents/upload` acceptant multipart/form-data
4. Upload vers Supabase Storage avec path structuré (`/org/{folderId}/{uuid}_{filename}`)
5. Limite de taille : 50 MB par fichier
6. Types acceptés : PDF, Word (.doc, .docx), Excel (.xls, .xlsx), images (jpg, png, gif), txt
7. Validation du type MIME côté serveur (pas seulement extension)
8. Métadonnées stockées en DB, fichier dans Storage
9. Retourne le document créé avec URL signée temporaire
10. Gestion d'erreurs : quota dépassé, type non supporté, upload failed
11. Tests d'intégration avec mock Storage

## Tasks / Subtasks

- [x] **Task 1: Configurer Supabase Storage** (AC: 2)
  - [x] Ajouter `@supabase/supabase-js` aux dépendances API
  - [x] Créer `apps/api/src/config/supabase.config.ts`
  - [x] Configurer les variables d'environnement (SUPABASE_URL, SUPABASE_SERVICE_KEY)
  - [x] Créer le bucket `documents` sur Supabase (si non existant)
  - [x] Mettre à jour `.env.example`

- [x] **Task 2: Créer le schéma Prisma Document** (AC: 1)
  - [x] Ajouter le modèle `Document` dans `prisma/schema.prisma`
  - [x] Définir les champs requis et relations (Folder, User)
  - [x] Créer et exécuter la migration

- [x] **Task 3: Créer les types partagés** (AC: 1, 6)
  - [x] Créer `packages/shared/src/types/document.types.ts`
  - [x] Définir `DocumentResponse`, `UploadDocumentDto`
  - [x] Définir constantes : `ALLOWED_MIME_TYPES`, `MAX_FILE_SIZE`
  - [x] Créer validateurs Zod

- [x] **Task 4: Créer le service storage** (AC: 2, 4, 9)
  - [x] Créer `apps/api/src/modules/documents/storage.service.ts`
  - [x] Implémenter `uploadFile(file, folderId)` → retourne storagePath
  - [x] Implémenter `getSignedUrl(storagePath, expiresIn)` → URL temporaire
  - [x] Implémenter `deleteFile(storagePath)`
  - [x] Générer path structuré : `/org/{folderId}/{uuid}_{filename}`

- [x] **Task 5: Créer le service documents** (AC: 1, 3, 5-10)
  - [x] Créer `apps/api/src/modules/documents/documents.service.ts`
  - [x] Implémenter `uploadDocument(file, folderId, userId)`
  - [x] Valider le type MIME avec `file-type` ou magic bytes
  - [x] Valider la taille (50 MB max)
  - [x] Appeler storage.service pour l'upload
  - [x] Sauvegarder les métadonnées en DB
  - [x] Retourner le document avec URL signée

- [x] **Task 6: Créer le contrôleur et routes upload** (AC: 3)
  - [x] Installer `multer` pour multipart/form-data
  - [x] Créer `apps/api/src/modules/documents/documents.controller.ts`
  - [x] Créer `apps/api/src/modules/documents/documents.routes.ts`
  - [x] Route `POST /api/documents/upload` avec multer middleware
  - [x] Appliquer middleware `authenticate` + `canAccessFolder(WRITE)`

- [x] **Task 7: Implémenter la gestion d'erreurs** (AC: 10)
  - [x] Créer erreurs custom : `FileTooLargeError`, `UnsupportedFileTypeError`, `StorageQuotaExceededError`
  - [x] Handler d'erreur global pour ces cas
  - [x] Retourner messages clairs au client

- [x] **Task 8: Écrire les tests** (AC: 11)
  - [x] Créer mock pour Supabase Storage
  - [x] Tester upload valide
  - [x] Tester rejet fichier trop gros
  - [x] Tester rejet type non supporté
  - [x] Tester vérification permissions

## Dev Notes

### Structure des fichiers à créer/modifier

```
apps/api/
  src/
    config/
      supabase.config.ts     # Nouveau
    modules/documents/
      documents.service.ts   # Nouveau
      documents.controller.ts # Nouveau
      documents.routes.ts    # Nouveau
      storage.service.ts     # Nouveau
      index.ts               # Nouveau
    common/errors/
      file.errors.ts         # Nouveau

packages/shared/src/
  types/document.types.ts    # Nouveau
  constants/file.constants.ts # Nouveau
```

### Schéma Prisma suggéré

```prisma
model Document {
  id           String   @id @default(cuid())
  name         String
  mimeType     String
  size         Int      // en bytes
  storagePath  String   @unique
  folderId     String
  folder       Folder   @relation(fields: [folderId], references: [id])
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())

  @@map("documents")
}
```

### Types MIME acceptés

```typescript
export const ALLOWED_MIME_TYPES = [
  'application/pdf',
  'application/msword',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'application/vnd.ms-excel',
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  'image/jpeg',
  'image/png',
  'image/gif',
  'text/plain',
];

export const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50 MB
```

### Validation MIME côté serveur

```typescript
import { fileTypeFromBuffer } from 'file-type';

async function validateMimeType(buffer: Buffer, declaredMime: string): Promise<boolean> {
  const detected = await fileTypeFromBuffer(buffer);
  // Pour les fichiers texte, file-type retourne undefined
  if (!detected && declaredMime === 'text/plain') return true;
  return detected?.mime === declaredMime && ALLOWED_MIME_TYPES.includes(declaredMime);
}
```

### Configuration Multer

```typescript
import multer from 'multer';

const upload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: MAX_FILE_SIZE },
  fileFilter: (req, file, cb) => {
    if (ALLOWED_MIME_TYPES.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new UnsupportedFileTypeError(file.mimetype));
    }
  },
});
```

### Coding Standards

- **Jamais** exposer le storagePath directement au client
- Toujours retourner des URL signées avec expiration
- Vérifier permissions AVANT l'upload (pas après)

## Testing

### Mock Supabase Storage

```typescript
jest.mock('@supabase/supabase-js', () => ({
  createClient: () => ({
    storage: {
      from: () => ({
        upload: jest.fn().mockResolvedValue({ data: { path: 'mock-path' }, error: null }),
        createSignedUrl: jest.fn().mockResolvedValue({ data: { signedUrl: 'https://mock-url' }, error: null }),
        remove: jest.fn().mockResolvedValue({ data: null, error: null }),
      }),
    },
  }),
}));
```

### Cas de test

1. Upload PDF valide → 201 + document créé
2. Upload fichier > 50MB → 413 Payload Too Large
3. Upload .exe → 415 Unsupported Media Type
4. Upload sans permission WRITE → 403 Forbidden
5. Upload dans dossier inexistant → 404 Not Found

## Dependencies

- **Requires**: Story 2.1 (Folder Management), Story 2.2 (Folder Permissions)
- **Blocks**: Story 2.4 (Document Operations), Story 2.5 (Versioning)

## QA Results

**Gate Decision: PASS**

### Acceptance Criteria Validation

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | Schéma Prisma Document | ✅ PASS | Document model in prisma/schema.prisma with all required fields |
| 2 | Intégration Supabase Storage | ✅ PASS | supabase.config.ts with lazy initialization |
| 3 | Endpoint POST /api/documents/upload | ✅ PASS | documents.routes.ts with multer middleware |
| 4 | Path structuré org/{folderId}/{uuid}_{filename} | ✅ PASS | storage.service.ts generateStoragePath() |
| 5 | Limite 50 MB | ✅ PASS | MAX_FILE_SIZE = 50 * 1024 * 1024 |
| 6 | Types acceptés | ✅ PASS | ALLOWED_MIME_TYPES includes all required types |
| 7 | Validation MIME côté serveur | ✅ PASS | validateMimeType() using file-type package |
| 8 | Métadonnées en DB, fichier en Storage | ✅ PASS | uploadDocument() saves to both |
| 9 | URL signée temporaire | ✅ PASS | getSignedUrl() with expiration |
| 10 | Gestion d'erreurs | ✅ PASS | FileTooLargeError, UnsupportedFileTypeError, StorageError |
| 11 | Tests d'intégration | ✅ PASS | 185 tests passing, 11 document-specific tests |

### Test Results
- **Total Tests**: 185 passed
- **Test Suites**: 15 passed
- **Lint**: Pass (1 expected warning)

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes
- Implemented Supabase Storage integration with lazy initialization for test compatibility
- Created Document Prisma model with relations to Folder and User
- Implemented storage.service.ts for Supabase Storage operations (upload, getSignedUrl, delete)
- Implemented documents.service.ts with MIME type validation using file-type package
- Created documents.controller.ts and documents.routes.ts with multer for multipart/form-data
- Added custom errors: FileTooLargeError, UnsupportedFileTypeError, StorageError
- All 185 tests passing (11 new tests for documents module)
- Lint passes with only expected console warning

### File List
**New Files:**
- `apps/api/src/config/supabase.config.ts` - Supabase client with lazy initialization
- `apps/api/src/modules/documents/storage.service.ts` - Storage operations
- `apps/api/src/modules/documents/documents.service.ts` - Document business logic
- `apps/api/src/modules/documents/documents.controller.ts` - HTTP handlers
- `apps/api/src/modules/documents/documents.routes.ts` - Express routes
- `apps/api/src/modules/documents/index.ts` - Module exports
- `packages/shared/src/types/document.types.ts` - Document types
- `packages/shared/src/validators/document.validators.ts` - Zod schemas
- `apps/api/tests/unit/documents.service.test.ts` - Unit tests
- `apps/api/tests/integration/documents.api.test.ts` - Integration tests

**Modified Files:**
- `prisma/schema.prisma` - Added Document model
- `apps/api/src/common/errors.ts` - Added file-related errors
- `apps/api/src/app.ts` - Registered documents routes
- `apps/api/src/modules/folders/folders.routes.ts` - Added GET /:id/documents route
- `packages/shared/src/index.ts` - Exported document types
- `apps/api/.env.example` - Added SUPABASE_URL and SUPABASE_SERVICE_KEY

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-23 | 1.0 | Création initiale de la story | SM Agent (Bob) |
| 2026-01-24 | 1.1 | Implémentation complète - tous les tests passent | Dev Agent (James) |
