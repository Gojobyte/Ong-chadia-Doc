# Story 8.5: Advanced Document CRUD for Projects

## Status: Approved

## Story

**As a** chef de projet,
**I want** gérer complètement les documents de mon projet (créer, lire, modifier, supprimer),
**so that** j'aie un contrôle total sur la documentation du projet.

## Acceptance Criteria

1. Création de documents directement depuis la page projet (texte ou tableur)
2. Liste des documents avec filtres (type, date création, auteur, statut)
3. Modification du contenu via éditeurs (Story 8.1, 8.2)
4. Modification des métadonnées (nom, description, tags)
5. Suppression avec confirmation et corbeille (soft delete 30 jours)
6. Restauration depuis la corbeille
7. Duplication de documents en un clic
8. Déplacement entre dossiers du projet
9. Renommage de documents inline
10. Téléchargement en différents formats (original, PDF, DOCX, XLSX)
11. Historique complet des actions sur chaque document (audit log)
12. Tests couvrant toutes les opérations CRUD

## Tasks / Subtasks

- [ ] **Task 1: API Documents Projet** (AC: 1, 2, 3, 4)
  - [ ] Étendre `/api/projects/:projectId/documents` existant
  - [ ] `GET` avec filtres type, author, dateRange
  - [ ] `POST` création avec type (text/spreadsheet)
  - [ ] `PATCH /:id` pour métadonnées
  - [ ] Validation Zod des inputs

- [ ] **Task 2: Soft Delete et Corbeille** (AC: 5, 6)
  - [ ] Ajouter `deletedAt` au model Document si pas présent
  - [ ] `DELETE /api/documents/:id` → soft delete
  - [ ] `GET /api/documents/trash` → liste corbeille
  - [ ] `POST /api/documents/:id/restore` → restaurer
  - [ ] `DELETE /api/documents/:id/permanent` → suppression définitive
  - [ ] Job CRON pour vider corbeille > 30 jours

- [ ] **Task 3: Duplication Document** (AC: 7)
  - [ ] `POST /api/documents/:id/duplicate`
  - [ ] Copier contenu, métadonnées, tags
  - [ ] Nouveau nom: "Copie de {nom}"
  - [ ] Même dossier par défaut

- [ ] **Task 4: Déplacement entre Dossiers** (AC: 8)
  - [ ] `PATCH /api/documents/:id` avec `folderId`
  - [ ] Validation dossier appartient au même projet
  - [ ] UI: Drag & drop ou modal déplacement

- [ ] **Task 5: Renommage Inline** (AC: 9)
  - [ ] `PATCH /api/documents/:id` avec `name`
  - [ ] UI: Double-clic sur nom pour éditer
  - [ ] Validation nom non vide

- [ ] **Task 6: Export Multi-format** (AC: 10)
  - [ ] `GET /api/documents/:id/download?format=original`
  - [ ] `GET /api/documents/:id/download?format=pdf`
  - [ ] `GET /api/documents/:id/download?format=docx`
  - [ ] `GET /api/documents/:id/download?format=xlsx`
  - [ ] Conversion serveur pour PDF/DOCX/XLSX

- [ ] **Task 7: Audit Log** (AC: 11)
  - [ ] Créer model `DocumentActivity` (id, documentId, action, userId, metadata, createdAt)
  - [ ] Actions: CREATE, VIEW, EDIT, RENAME, MOVE, DELETE, RESTORE, DOWNLOAD
  - [ ] Logger automatiquement dans service
  - [ ] `GET /api/documents/:id/activity` pour historique
  - [ ] UI timeline des actions

- [ ] **Task 8: UI Document Actions Menu** (AC: 1-11)
  - [ ] Créer `DocumentActionsMenu.tsx` (dropdown)
  - [ ] Actions: Ouvrir, Renommer, Dupliquer, Déplacer, Télécharger, Supprimer
  - [ ] Intégrer dans DocumentRow et DocumentCard
  - [ ] Confirmation pour suppression

- [ ] **Task 9: UI Corbeille** (AC: 5, 6)
  - [ ] Page ou section corbeille projet
  - [ ] Liste documents supprimés avec date suppression
  - [ ] Actions: Restaurer, Supprimer définitivement
  - [ ] Vider la corbeille (Super-Admin)

- [ ] **Task 10: UI Historique Document** (AC: 11)
  - [ ] Tab ou section "Activité" dans DocumentDrawer
  - [ ] Timeline des actions avec avatar, action, date
  - [ ] Filtres par type d'action

- [ ] **Task 11: Tests** (AC: 12)
  - [ ] Tests API toutes opérations CRUD
  - [ ] Tests soft delete et restore
  - [ ] Tests permissions
  - [ ] Tests UI actions menu

## Dev Notes

### Architecture

```text
apps/api/src/modules/documents/
├── documents.controller.ts   # Existant, à étendre
├── documents.service.ts      # Existant, à étendre
├── documents.routes.ts       # Existant, à étendre
├── export.service.ts         # Nouveau: conversions format
├── activity.service.ts       # Nouveau: audit log
└── trash.controller.ts       # Nouveau: gestion corbeille

apps/web/src/components/documents/
├── DocumentActionsMenu.tsx   # Menu contextuel
├── MoveDocumentModal.tsx     # Existant, améliorer
├── TrashView.tsx             # Liste corbeille
├── ActivityTimeline.tsx      # Historique actions
└── RenameInput.tsx           # Input inline renommage
```

### Schéma Prisma - DocumentActivity

```prisma
enum DocumentAction {
  CREATE
  VIEW
  EDIT
  RENAME
  MOVE
  DELETE
  RESTORE
  DOWNLOAD
  SHARE
}

model DocumentActivity {
  id         String         @id @default(uuid())
  documentId String
  document   Document       @relation(fields: [documentId], references: [id])
  action     DocumentAction
  userId     String
  user       User           @relation(fields: [userId], references: [id])
  metadata   Json?          // { oldName, newName, folderId, format, etc. }
  createdAt  DateTime       @default(now())

  @@index([documentId, createdAt])
  @@index([userId])
}
```

### API Endpoints Summary

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /projects/:pid/documents | Liste filtrée |
| POST | /projects/:pid/documents | Créer document |
| GET | /documents/:id | Détails document |
| PATCH | /documents/:id | Modifier (content, metadata) |
| DELETE | /documents/:id | Soft delete |
| POST | /documents/:id/duplicate | Dupliquer |
| POST | /documents/:id/restore | Restaurer |
| DELETE | /documents/:id/permanent | Suppr définitive |
| GET | /documents/:id/download | Télécharger (format param) |
| GET | /documents/:id/activity | Historique actions |
| GET | /documents/trash | Liste corbeille |

### Patterns UI

**Renommage Inline:**
```tsx
const [editing, setEditing] = useState(false);
if (editing) {
  return <input value={name} onBlur={save} autoFocus />;
}
return <span onDoubleClick={() => setEditing(true)}>{name}</span>;
```

**Menu Actions:**
- 3 dots icon → Dropdown avec icônes
- Keyboard shortcuts (optionnel): Ctrl+D (duplicate), Del (delete)

## Testing

### Localisation

- `apps/api/tests/documents-crud.test.ts`
- `apps/web/src/components/documents/__tests__/DocumentActionsMenu.test.tsx`

### Framework

- Jest + Supertest (API)
- Vitest + React Testing Library (UI)

### Cas à couvrir

| Test | Description |
|------|-------------|
| POST /documents | Création avec type text |
| POST /documents | Création avec type spreadsheet |
| PATCH /documents | Renommage |
| PATCH /documents | Déplacement dossier |
| DELETE /documents | Soft delete |
| POST /restore | Restauration depuis corbeille |
| POST /duplicate | Duplication avec nouveau nom |
| GET /download | Export PDF |
| GET /activity | Historique complet |
| Permissions | Non-membre ne peut pas modifier |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
