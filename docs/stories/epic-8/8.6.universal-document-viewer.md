# Story 8.6: Universal Document Viewer

## Status: Approved

## Story

**As a** utilisateur,
**I want** prévisualiser tous types de documents sans les télécharger,
**so that** je puisse consulter rapidement le contenu sans changer d'application.

## Acceptance Criteria

1. Preview PDF intégré avec navigation pages et zoom
2. Preview documents Word (.docx) avec rendu fidèle
3. Preview tableurs Excel (.xlsx) avec navigation entre feuilles
4. Preview images (jpg, png, gif, webp, svg) avec zoom
5. Preview vidéos (mp4, webm) avec player contrôles complets
6. Preview audio (mp3, wav) avec player audio
7. Zoom et navigation dans tous les documents compatibles
8. Mode plein écran pour tous les viewers
9. Téléchargement depuis le viewer (bouton download)
10. Partage direct du lien de preview (si permissions)
11. Fallback message élégant pour formats non supportés
12. Tests couvrant tous les types de fichiers

## Tasks / Subtasks

- [ ] **Task 1: Architecture Viewer Unifié** (AC: 1-6, 11)
  - [ ] Créer `DocumentViewer.tsx` comme composant orchestrateur
  - [ ] Détection type MIME / extension
  - [ ] Routing vers viewer spécifique
  - [ ] Fallback component pour non-supportés

- [ ] **Task 2: PDF Viewer** (AC: 1, 7, 8)
  - [ ] Installer `react-pdf` ou `pdfjs-dist`
  - [ ] Créer `PdfViewer.tsx`
  - [ ] Navigation pages (prev/next, go to page)
  - [ ] Contrôles zoom (in/out, fit width, fit page)
  - [ ] Scrolling continu ou page par page
  - [ ] Mode plein écran

- [ ] **Task 3: DOCX Viewer** (AC: 2, 7, 8)
  - [ ] Évaluer options: mammoth.js, docx-preview
  - [ ] Créer `DocxViewer.tsx`
  - [ ] Conversion DOCX → HTML pour affichage
  - [ ] Styles préservés (bold, italic, tables)
  - [ ] Zoom via CSS transform

- [ ] **Task 4: XLSX Viewer** (AC: 3, 7, 8)
  - [ ] Utiliser SheetJS pour parser
  - [ ] Créer `XlsxViewer.tsx`
  - [ ] Afficher tableau HTML
  - [ ] Onglets pour multi-feuilles
  - [ ] Scroll horizontal/vertical
  - [ ] Zoom

- [ ] **Task 5: Image Viewer** (AC: 4, 7, 8)
  - [ ] Créer `ImageViewer.tsx`
  - [ ] Support formats: jpg, png, gif, webp, svg
  - [ ] Zoom par molette ou boutons
  - [ ] Pan (drag pour déplacer)
  - [ ] Rotation optionnelle
  - [ ] Mode plein écran

- [ ] **Task 6: Video Player** (AC: 5, 8)
  - [ ] Créer `VideoPlayer.tsx`
  - [ ] Utiliser `<video>` natif avec contrôles custom ou HTML5
  - [ ] Support formats: mp4, webm, ogg
  - [ ] Contrôles: play/pause, volume, progress, fullscreen
  - [ ] Poster image optionnel

- [ ] **Task 7: Audio Player** (AC: 6)
  - [ ] Créer `AudioPlayer.tsx`
  - [ ] Utiliser `<audio>` avec contrôles stylisés
  - [ ] Support formats: mp3, wav, ogg
  - [ ] Waveform visualization (nice-to-have)

- [ ] **Task 8: Contrôles Communs** (AC: 7, 8, 9, 10)
  - [ ] Créer `ViewerControls.tsx` (toolbar)
  - [ ] Bouton zoom in/out
  - [ ] Bouton fullscreen
  - [ ] Bouton download
  - [ ] Bouton share (copier lien)
  - [ ] Bouton fermer

- [ ] **Task 9: Partage Lien Preview** (AC: 10)
  - [ ] URL format: `/documents/:id/preview`
  - [ ] Vérification permissions avant affichage
  - [ ] Option lien public si document partagé
  - [ ] Copier lien dans clipboard

- [ ] **Task 10: Fallback Non Supporté** (AC: 11)
  - [ ] Créer `UnsupportedViewer.tsx`
  - [ ] Message clair avec icône fichier
  - [ ] Bouton téléchargement proéminent
  - [ ] Liste des formats supportés

- [ ] **Task 11: Integration et Tests** (AC: 12)
  - [ ] Intégrer dans DocumentDrawer existant
  - [ ] Tests chaque viewer avec fichiers sample
  - [ ] Tests fallback

## Dev Notes

### Architecture

```text
apps/web/src/components/viewers/
├── DocumentViewer.tsx        # Orchestrateur principal
├── PdfViewer.tsx
├── DocxViewer.tsx
├── XlsxViewer.tsx
├── ImageViewer.tsx
├── VideoPlayer.tsx
├── AudioPlayer.tsx
├── UnsupportedViewer.tsx
├── ViewerControls.tsx        # Toolbar commune
└── index.ts
```

### Mapping Type → Viewer

```ts
const viewerMap: Record<string, React.FC<ViewerProps>> = {
  'application/pdf': PdfViewer,
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': DocxViewer,
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': XlsxViewer,
  'image/jpeg': ImageViewer,
  'image/png': ImageViewer,
  'image/gif': ImageViewer,
  'image/webp': ImageViewer,
  'image/svg+xml': ImageViewer,
  'video/mp4': VideoPlayer,
  'video/webm': VideoPlayer,
  'audio/mpeg': AudioPlayer,
  'audio/wav': AudioPlayer,
};
```

### Librairies Recommandées

| Type | Lib | Install |
|------|-----|---------|
| PDF | react-pdf | `pnpm add react-pdf` |
| DOCX | mammoth | `pnpm add mammoth` |
| XLSX | xlsx | `pnpm add xlsx` (déjà installé) |
| Image | Native + custom | CSS transform |
| Video | HTML5 video | Natif |
| Audio | HTML5 audio | Natif |

### Exemple PDF Viewer

```tsx
import { Document, Page, pdfjs } from 'react-pdf';

pdfjs.GlobalWorkerOptions.workerSrc = `//unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.js`;

function PdfViewer({ url }: { url: string }) {
  const [numPages, setNumPages] = useState(0);
  const [page, setPage] = useState(1);
  const [scale, setScale] = useState(1);

  return (
    <div>
      <Document file={url} onLoadSuccess={({ numPages }) => setNumPages(numPages)}>
        <Page pageNumber={page} scale={scale} />
      </Document>
      <div className="controls">
        <button onClick={() => setPage(p => Math.max(1, p - 1))}>Prev</button>
        <span>{page} / {numPages}</span>
        <button onClick={() => setPage(p => Math.min(numPages, p + 1))}>Next</button>
      </div>
    </div>
  );
}
```

### Exemple DOCX Viewer

```tsx
import mammoth from 'mammoth';

function DocxViewer({ url }: { url: string }) {
  const [html, setHtml] = useState('');

  useEffect(() => {
    fetch(url)
      .then(res => res.arrayBuffer())
      .then(buffer => mammoth.convertToHtml({ arrayBuffer: buffer }))
      .then(result => setHtml(result.value));
  }, [url]);

  return <div dangerouslySetInnerHTML={{ __html: html }} />;
}
```

## Testing

### Localisation

- `apps/web/src/components/viewers/__tests__/`

### Framework

- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| PDF | Affiche page, navigation fonctionne |
| DOCX | Conversion HTML réussie |
| XLSX | Affiche tableau avec feuilles |
| Image | Zoom in/out fonctionne |
| Video | Play/pause fonctionne |
| Unsupported | Affiche fallback avec download |
| Fullscreen | Toggle fullscreen |
| Download | Téléchargement déclenché |

### Fichiers Test

Placer des fichiers sample dans `apps/web/public/test-files/`:
- sample.pdf
- sample.docx
- sample.xlsx
- sample.jpg
- sample.mp4
- sample.unknown

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
