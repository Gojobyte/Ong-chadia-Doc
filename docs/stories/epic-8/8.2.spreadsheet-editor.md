# Story 8.2: Spreadsheet Editor (Tableur)

## Status: Approved

## Story

**As a** chef de projet,
**I want** créer et modifier des tableurs directement dans l'application,
**so that** je puisse gérer mes budgets et suivis sans utiliser Excel externe.

## Acceptance Criteria

1. Éditeur tableur intégré basé sur Luckysheet (gratuit) ou Handsontable
2. Support des formules de base: SUM, AVERAGE, COUNT, MIN, MAX, IF, VLOOKUP
3. Formatage cellules: couleurs fond, couleurs texte, bordures, alignement
4. Colonnes et lignes redimensionnables par drag
5. Tri des données par colonne (asc/desc)
6. Filtrage des données avec critères multiples
7. Export au format .xlsx via SheetJS
8. Export au format .csv
9. Import de fichiers .xlsx et .csv avec mapping colonnes
10. Sauvegarde automatique toutes les 30 secondes
11. Support multi-feuilles (sheets/tabs)
12. Graphiques basiques: barres, lignes, camembert (nice-to-have)
13. Tests couvrant formules et import/export

## Tasks / Subtasks

- [ ] **Task 1: Installation et Configuration Luckysheet** (AC: 1)
  - [ ] Installer `luckysheet` via npm/pnpm
  - [ ] Créer wrapper React `SpreadsheetEditor.tsx`
  - [ ] Configurer options de base (langue, plugins)
  - [ ] Gérer lifecycle (mount/unmount/resize)

- [ ] **Task 2: Moteur de Formules** (AC: 2)
  - [ ] Vérifier formules natives Luckysheet
  - [ ] Si besoin, intégrer HyperFormula pour formules avancées
  - [ ] Documenter formules supportées
  - [ ] Tests unitaires des formules critiques

- [ ] **Task 3: Formatage Cellules** (AC: 3)
  - [ ] Barre d'outils formatage (police, taille, couleur)
  - [ ] Boutons alignement (gauche, centre, droite, vertical)
  - [ ] Sélecteur couleur fond de cellule
  - [ ] Sélecteur bordures (style, couleur)

- [ ] **Task 4: Manipulation Grille** (AC: 4, 5, 6)
  - [ ] Redimensionnement colonnes par drag handle
  - [ ] Redimensionnement lignes par drag handle
  - [ ] Menu contextuel tri (A-Z, Z-A)
  - [ ] Interface filtrage avec critères

- [ ] **Task 5: Export XLSX** (AC: 7)
  - [ ] Installer `xlsx` (SheetJS)
  - [ ] Créer `apps/web/src/lib/export-xlsx.ts`
  - [ ] Convertir données Luckysheet vers format SheetJS
  - [ ] Préserver formatage et formules si possible
  - [ ] Téléchargement automatique

- [ ] **Task 6: Export CSV** (AC: 8)
  - [ ] Fonction export CSV dans `export-xlsx.ts`
  - [ ] Gestion encodage UTF-8 BOM pour Excel
  - [ ] Option sélection feuille active ou toutes

- [ ] **Task 7: Import XLSX/CSV** (AC: 9)
  - [ ] Créer `apps/web/src/lib/import-xlsx.ts`
  - [ ] Parser fichier avec SheetJS
  - [ ] Preview des données avant import
  - [ ] Mapping colonnes optionnel
  - [ ] Charger dans Luckysheet

- [ ] **Task 8: Auto-save** (AC: 10)
  - [ ] Debounce 30 secondes sur modifications
  - [ ] Sérialiser état Luckysheet vers JSON
  - [ ] Sauvegarder via PATCH `/api/documents/:id`
  - [ ] Indicateur visuel statut sauvegarde

- [ ] **Task 9: Multi-feuilles** (AC: 11)
  - [ ] Activer plugin sheets Luckysheet
  - [ ] Onglets en bas de l'éditeur
  - [ ] Ajout/suppression/renommage feuilles
  - [ ] Navigation entre feuilles

- [ ] **Task 10: Graphiques (Nice-to-have)** (AC: 12)
  - [ ] Évaluer plugin charts Luckysheet
  - [ ] Alternative: intégration Chart.js ou Recharts
  - [ ] Types: barres, lignes, camembert
  - [ ] Sélection données source

- [ ] **Task 11: Tests** (AC: 13)
  - [ ] Tests unitaires formules SUM, IF, VLOOKUP
  - [ ] Tests import/export XLSX round-trip
  - [ ] Tests import CSV avec différents encodages

## Dev Notes

### Architecture

```text
apps/web/src/components/editor/
├── SpreadsheetEditor.tsx     # Wrapper Luckysheet
├── SpreadsheetToolbar.tsx    # Barre d'outils formatage
├── SheetTabs.tsx             # Onglets feuilles
├── ImportModal.tsx           # Modal import fichier
└── ChartModal.tsx            # Modal création graphique

apps/web/src/lib/
├── export-xlsx.ts            # Export vers Excel
└── import-xlsx.ts            # Import depuis Excel/CSV
```

### Librairies Recommandées (cf. doc Winston)

| Lib | Usage | Install |
|-----|-------|---------|
| luckysheet | Éditeur tableur | `pnpm add luckysheet` |
| hyperformula | Moteur formules | `pnpm add hyperformula` |
| xlsx | Import/Export Excel | `pnpm add xlsx` |

### Stockage Document Tableur

Le contenu du tableur est stocké en JSON dans le champ `content` du document:

```json
{
  "type": "spreadsheet",
  "sheets": [
    {
      "name": "Feuille 1",
      "data": [[...], [...], ...],
      "config": { "columnWidth": {...}, "rowHeight": {...} }
    }
  ],
  "activeSheet": 0
}
```

### Référence API Luckysheet

```ts
// Initialisation
luckysheet.create({
  container: 'luckysheet-container',
  data: [{ name: 'Sheet1', celldata: [] }],
  showinfobar: false,
});

// Récupérer données
const data = luckysheet.getAllSheets();

// Insérer formule
luckysheet.setCellValue(0, 0, { f: '=SUM(A1:A10)' });
```

## Testing

### Localisation

- `apps/web/src/components/editor/__tests__/SpreadsheetEditor.test.tsx`
- `apps/web/src/lib/__tests__/export-xlsx.test.ts`
- `apps/web/src/lib/__tests__/import-xlsx.test.ts`

### Framework

- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Render | Tableur s'affiche avec données |
| Formula SUM | =SUM(A1:A5) calcule correctement |
| Formula IF | =IF(A1>10,"oui","non") fonctionne |
| Export XLSX | Génère fichier Excel valide |
| Import XLSX | Charge fichier et affiche données |
| Multi-sheets | Navigation entre feuilles |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
