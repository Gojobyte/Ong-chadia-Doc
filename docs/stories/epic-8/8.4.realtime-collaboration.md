# Story 8.4: Real-time Collaboration

## Status: Approved

## Story

**As a** membre d'une équipe projet,
**I want** éditer un document en même temps que mes collègues,
**so that** nous puissions collaborer efficacement sans conflits de versions.

## Acceptance Criteria

1. Édition simultanée par plusieurs utilisateurs via Yjs + WebSocket
2. Curseurs colorés montrant la position de chaque collaborateur en temps réel
3. Indicateur de présence (avatars des utilisateurs connectés au document)
4. Synchronisation en temps réel des modifications (< 100ms latence perçue)
5. Gestion automatique des conflits via CRDT (Conflict-free Replicated Data Type)
6. Mode "suggestion" pour proposer des modifications sans les appliquer directement
7. Commentaires dans le document avec mentions @user
8. Notifications en temps réel des modifications importantes
9. Fallback gracieux si connexion perdue (sauvegarde locale + resync)
10. Tests de charge avec 5+ utilisateurs simultanés

## Tasks / Subtasks

- [ ] **Task 1: Setup Serveur WebSocket Yjs** (AC: 1, 4, 5)
  - [ ] Installer `y-websocket ws` côté API
  - [ ] Créer `apps/api/src/modules/collaboration/ws-server.ts`
  - [ ] Configurer y-websocket server sur port dédié (ex: 1234)
  - [ ] Intégrer authentification JWT pour connexion WS
  - [ ] Logging des connexions/déconnexions

- [ ] **Task 2: Client Yjs + TipTap Integration** (AC: 1, 4, 5)
  - [ ] Installer `yjs y-websocket @tiptap/extension-collaboration @tiptap/extension-collaboration-cursor`
  - [ ] Créer `CollaborativeEditor.tsx` wrappant TipTapEditor
  - [ ] Configurer Y.Doc et WebsocketProvider
  - [ ] Connecter au serveur WS avec room = documentId
  - [ ] Configurer Collaboration extension

- [ ] **Task 3: Curseurs Collaboratifs** (AC: 2)
  - [ ] Configurer `@tiptap/extension-collaboration-cursor`
  - [ ] Afficher curseur avec couleur unique par user
  - [ ] Afficher nom utilisateur à côté du curseur
  - [ ] Style CSS pour curseurs (animation, visibilité)

- [ ] **Task 4: Indicateur de Présence** (AC: 3)
  - [ ] Créer `PresenceIndicator.tsx`
  - [ ] Utiliser Yjs awareness pour tracker présence
  - [ ] Afficher avatars des utilisateurs connectés
  - [ ] Tooltip avec nom et dernière activité
  - [ ] Animation entrée/sortie

- [ ] **Task 5: Mode Suggestion (Nice-to-have)** (AC: 6)
  - [ ] Évaluer faisabilité avec TipTap
  - [ ] Track changes style avec accept/reject
  - [ ] Différencier visuellement suggestions
  - [ ] Actions approuver/rejeter

- [ ] **Task 6: Commentaires et Mentions** (AC: 7)
  - [ ] Créer extension TipTap pour commentaires
  - [ ] UI sidebar commentaires
  - [ ] Mentions @user avec autocomplete
  - [ ] Stockage commentaires dans document content
  - [ ] Notifications mentions

- [ ] **Task 7: Notifications Temps Réel** (AC: 8)
  - [ ] Événements sur modifications majeures
  - [ ] Toast notifications pour actions collaborateurs
  - [ ] Option mute notifications temporaire

- [ ] **Task 8: Fallback Offline** (AC: 9)
  - [ ] Intégrer y-indexeddb pour persistence locale
  - [ ] Détecter perte de connexion
  - [ ] Indicateur mode offline
  - [ ] Re-synchronisation automatique au retour
  - [ ] Gestion conflits post-reconnexion

- [ ] **Task 9: Tests de Charge** (AC: 10)
  - [ ] Script test avec 5 clients simulés
  - [ ] Mesure latence synchronisation
  - [ ] Test conflits simultanés
  - [ ] Test reconnexion après déconnexion

## Dev Notes

### Architecture

```text
apps/api/src/modules/collaboration/
├── ws-server.ts              # Serveur WebSocket Yjs
├── auth-middleware.ts        # Auth JWT pour WS
└── index.ts

apps/web/src/components/editor/
├── CollaborativeEditor.tsx   # Wrapper collaboration
├── PresenceIndicator.tsx     # Avatars connectés
├── CommentsPanel.tsx         # Sidebar commentaires
└── CursorStyles.css          # Styles curseurs

apps/web/src/hooks/
└── useCollaboration.ts       # Hook gestion connexion Yjs
```

### Stack Technique (cf. doc Winston)

| Lib | Rôle | Install |
|-----|------|---------|
| yjs | CRDT synchronisation | `pnpm add yjs` |
| y-websocket | Transport WebSocket | `pnpm add y-websocket` |
| y-indexeddb | Persistence offline | `pnpm add y-indexeddb` |
| @tiptap/extension-collaboration | Binding TipTap | `pnpm add @tiptap/extension-collaboration` |
| @tiptap/extension-collaboration-cursor | Curseurs | `pnpm add @tiptap/extension-collaboration-cursor` |

### Code Serveur WebSocket

```ts
// apps/api/src/modules/collaboration/ws-server.ts
import { WebSocketServer } from 'ws';
import { setupWSConnection } from 'y-websocket/bin/utils';

export function startCollaborationServer(port = 1234) {
  const wss = new WebSocketServer({ port });

  wss.on('connection', (ws, req) => {
    // Verify JWT from query param or header
    const token = new URL(req.url!, `http://localhost`).searchParams.get('token');
    if (!verifyToken(token)) {
      ws.close(1008, 'Unauthorized');
      return;
    }
    setupWSConnection(ws, req);
  });

  return wss;
}
```

### Code Client Collaboration

```tsx
// apps/web/src/components/editor/CollaborativeEditor.tsx
import * as Y from 'yjs';
import { WebsocketProvider } from 'y-websocket';
import Collaboration from '@tiptap/extension-collaboration';
import CollaborationCursor from '@tiptap/extension-collaboration-cursor';

const ydoc = new Y.Doc();
const provider = new WebsocketProvider(
  'ws://localhost:1234',
  documentId,
  ydoc,
  { params: { token: accessToken } }
);

const editor = useEditor({
  extensions: [
    StarterKit.configure({ history: false }),
    Collaboration.configure({ document: ydoc }),
    CollaborationCursor.configure({
      provider,
      user: { name: user.name, color: randomColor() },
    }),
  ],
});
```

### Référence POC

Voir `docs/research/poc-examples-epics-8-9-10.md` - POC 6

## Testing

### Localisation

- `apps/api/tests/collaboration.test.ts`
- `apps/web/src/components/editor/__tests__/CollaborativeEditor.test.tsx`

### Framework

- Jest + ws mock pour tests serveur
- Vitest + React Testing Library pour client

### Cas à couvrir

| Test | Description |
|------|-------------|
| WS Connection | Client se connecte avec token valide |
| WS Reject | Connexion refusée si token invalide |
| Sync | Modification propagée entre 2 clients |
| Cursor | Position curseur visible par autres |
| Presence | Avatars affichés pour connectés |
| Offline | Sauvegarde locale si déconnecté |
| Reconnect | Resync automatique après reconnexion |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
