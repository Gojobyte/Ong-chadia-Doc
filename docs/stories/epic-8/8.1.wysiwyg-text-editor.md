# Story 8.1: WYSIWYG Text Document Editor

## Status: Approved

## Story

**As a** membre d'un projet,
**I want** créer et modifier des documents texte directement dans l'application,
**so that** je puisse rédiger mes rapports, PV et TDR sans quitter la plateforme.

## Acceptance Criteria

1. Éditeur TipTap intégré avec extensions StarterKit + Placeholder
2. Formatage texte : gras, italique, souligné, barré, code inline
3. Titres H1-H6 avec styles distincts
4. Listes à puces et numérotées avec imbrication
5. Insertion d'images (upload ou URL) avec redimensionnement
6. Tableaux basiques (ajout/suppression lignes/colonnes)
7. Export au format .docx via librairie `docx`
8. Export au format .pdf via `@react-pdf/renderer` ou API serveur
9. Sauvegarde automatique toutes les 30 secondes (auto-save)
10. Historique des versions avec restauration (intégration versions.service)
11. Document lié au projet courant (projectId)
12. Permissions : seuls les membres du projet peuvent éditer
13. Tests unitaires composants + tests d'intégration export

## Tasks / Subtasks

- [ ] **Task 1: Installation dépendances TipTap** (AC: 1)
  - [ ] Installer `@tiptap/react @tiptap/starter-kit @tiptap/extension-placeholder`
  - [ ] Installer `@tiptap/extension-image @tiptap/extension-table`
  - [ ] Installer `docx file-saver` pour export Word
  - [ ] Vérifier compatibilité avec React 18

- [ ] **Task 2: Composant TipTapEditor de base** (AC: 1, 2, 3, 4)
  - [ ] Créer `apps/web/src/components/editor/TipTapEditor.tsx`
  - [ ] Configurer extensions StarterKit
  - [ ] Implémenter barre d'outils formatage (Bold, Italic, etc.)
  - [ ] Implémenter sélecteur de titres (H1-H6)
  - [ ] Implémenter listes (bullet, ordered)
  - [ ] Styles CSS/Tailwind pour l'éditeur

- [ ] **Task 3: Extension Images** (AC: 5)
  - [ ] Configurer `@tiptap/extension-image`
  - [ ] Implémenter upload image vers Supabase Storage
  - [ ] Insérer image via URL
  - [ ] Contrôles de redimensionnement (small, medium, large)
  - [ ] Gestion erreur upload

- [ ] **Task 4: Extension Tableaux** (AC: 6)
  - [ ] Configurer `@tiptap/extension-table`
  - [ ] Boutons ajout/suppression lignes et colonnes
  - [ ] Style tableaux cohérent avec design system

- [ ] **Task 5: Export DOCX** (AC: 7)
  - [ ] Créer `apps/web/src/lib/export-docx.ts`
  - [ ] Parser HTML TipTap vers structure docx
  - [ ] Gérer headings, paragraphs, lists, tables
  - [ ] Gérer images (base64 ou URL)
  - [ ] Téléchargement automatique via file-saver

- [ ] **Task 6: Export PDF** (AC: 8)
  - [ ] Créer `apps/web/src/lib/export-pdf.ts`
  - [ ] Option A: Client-side avec @react-pdf/renderer
  - [ ] Option B: API endpoint `/api/documents/:id/export-pdf` avec Puppeteer
  - [ ] Téléchargement du fichier généré

- [ ] **Task 7: Auto-save** (AC: 9)
  - [ ] Implémenter debounce 30 secondes sur onChange
  - [ ] Appel PATCH `/api/documents/:id` pour sauvegarder content
  - [ ] Indicateur visuel "Enregistrement..." / "Enregistré"
  - [ ] Gestion erreur avec retry

- [ ] **Task 8: Intégration Versions** (AC: 10)
  - [ ] À chaque save, créer version via versions.service existant
  - [ ] Bouton "Historique" ouvrant VersionHistory drawer
  - [ ] Restauration d'une version = nouveau save

- [ ] **Task 9: Liaison Projet et Permissions** (AC: 11, 12)
  - [ ] Ajouter `projectId` lors de création document
  - [ ] Vérifier appartenance projet avant édition (hook useDocument)
  - [ ] Afficher message si non autorisé

- [ ] **Task 10: Tests** (AC: 13)
  - [ ] Tests unitaires TipTapEditor (render, toolbar actions)
  - [ ] Tests export-docx avec différents contenus
  - [ ] Tests d'intégration auto-save

## Dev Notes

### Architecture

```text
apps/web/src/components/editor/
├── TipTapEditor.tsx          # Composant principal
├── EditorToolbar.tsx         # Barre d'outils
├── ImageUploadModal.tsx      # Modal upload image
├── TableControls.tsx         # Contrôles tableaux
└── index.ts

apps/web/src/lib/
├── export-docx.ts            # Conversion HTML→DOCX
└── export-pdf.ts             # Conversion HTML→PDF
```

### Librairies Recommandées (cf. doc Winston)

| Lib | Usage | Install |
|-----|-------|---------|
| @tiptap/react | Éditeur WYSIWYG | `pnpm add @tiptap/react @tiptap/starter-kit` |
| @tiptap/extension-placeholder | Placeholder | `pnpm add @tiptap/extension-placeholder` |
| @tiptap/extension-image | Images | `pnpm add @tiptap/extension-image` |
| @tiptap/extension-table | Tableaux | `pnpm add @tiptap/extension-table @tiptap/extension-table-row @tiptap/extension-table-cell @tiptap/extension-table-header` |
| docx | Export Word | `pnpm add docx` |
| file-saver | Téléchargement | `pnpm add file-saver` |

### Référence POC

Voir `docs/research/poc-examples-epics-8-9-10.md` - POC 1 et POC 2

### Exemple TipTap Basic

```tsx
import { useEditor, EditorContent } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';

const editor = useEditor({
  extensions: [StarterKit],
  content: '<p>Hello World!</p>',
  onUpdate: ({ editor }) => {
    onChange?.(editor.getHTML());
  },
});
```

## Testing

### Localisation

- `apps/web/src/components/editor/__tests__/TipTapEditor.test.tsx`
- `apps/web/src/lib/__tests__/export-docx.test.ts`

### Framework

- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Render | Éditeur s'affiche correctement |
| Bold | Clic sur Bold applique le formatage |
| Heading | Sélection H1 change le style |
| Image | Upload image insère dans le contenu |
| Export DOCX | Génère fichier avec bon contenu |
| Auto-save | Sauvegarde après 30s d'inactivité |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
