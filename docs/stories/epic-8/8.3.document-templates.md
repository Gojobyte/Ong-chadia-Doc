# Story 8.3: Document Templates System

## Status: Approved

## Story

**As a** utilisateur,
**I want** créer des documents à partir de templates pré-configurés,
**so that** je gagne du temps et respecte les standards de l'organisation.

## Acceptance Criteria

1. Bibliothèque de templates accessible depuis le bouton "Nouveau document"
2. Templates texte prédéfinis: Rapport d'activité, PV réunion, TDR, Note conceptuelle, Fiche de poste
3. Templates tableur prédéfinis: Budget prévisionnel, Suivi budgétaire, Chronogramme, Liste présence, Tableau indicateurs
4. Preview du template avant sélection (aperçu miniature + description)
5. Variables dynamiques remplacées automatiquement: `{{projet.nom}}`, `{{date}}`, `{{user.name}}`, etc.
6. Création de templates personnalisés (rôle Staff+ requis)
7. Catégorisation des templates par type (texte, tableur) et catégorie métier
8. Templates liés à un projet spécifique (optionnel)
9. Duplication d'un document existant comme nouveau template
10. Tests d'intégration pour les variables et la création depuis template

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma Template** (AC: 1-8)
  - [ ] Créer model `DocumentTemplate` dans schema.prisma
  - [ ] Champs: id, name, description, type (TEXT/SPREADSHEET), category, content (JSON), isGlobal, projectId?, createdById
  - [ ] Créer enum `TemplateCategory`: REPORT, MEETING, BUDGET, TRACKING, HR, OTHER
  - [ ] Migration Prisma

- [ ] **Task 2: API Templates CRUD** (AC: 1, 6, 7, 8)
  - [ ] Créer module `apps/api/src/modules/templates/`
  - [ ] `GET /api/templates` - Liste templates (globaux + projet)
  - [ ] `GET /api/templates/:id` - Détails template
  - [ ] `POST /api/templates` - Créer template (Staff+)
  - [ ] `PATCH /api/templates/:id` - Modifier template
  - [ ] `DELETE /api/templates/:id` - Supprimer template

- [ ] **Task 3: Templates Prédéfinis (Seeding)** (AC: 2, 3)
  - [ ] Créer fichier `prisma/seed-templates.ts`
  - [ ] Définir 5 templates texte avec contenu HTML TipTap
  - [ ] Définir 5 templates tableur avec structure JSON
  - [ ] Exécuter seed via `pnpm db:seed`

- [ ] **Task 4: UI Sélection Template** (AC: 1, 4, 7)
  - [ ] Créer `TemplatePickerModal.tsx`
  - [ ] Affichage grille avec miniatures
  - [ ] Filtres par type et catégorie
  - [ ] Preview au hover ou clic
  - [ ] Bouton "Utiliser ce template"

- [ ] **Task 5: Système Variables Dynamiques** (AC: 5)
  - [ ] Créer `apps/web/src/lib/template-variables.ts`
  - [ ] Parser et remplacer `{{variable}}` dans le contenu
  - [ ] Variables supportées:
    - `{{projet.nom}}` - Nom du projet
    - `{{projet.description}}` - Description projet
    - `{{date}}` - Date du jour (format locale)
    - `{{date.annee}}` - Année courante
    - `{{user.name}}` - Nom utilisateur connecté
    - `{{user.email}}` - Email utilisateur
    - `{{organisation.nom}}` - Nom de l'ONG
  - [ ] Gestion variables manquantes (placeholder visible)

- [ ] **Task 6: Création Document depuis Template** (AC: 1-5)
  - [ ] Modifier `NewDocumentModal` pour inclure sélection template
  - [ ] Charger contenu template
  - [ ] Appliquer remplacement variables
  - [ ] Créer document avec contenu pré-rempli

- [ ] **Task 7: Création Template Personnalisé** (AC: 6, 9)
  - [ ] Bouton "Enregistrer comme template" dans l'éditeur
  - [ ] Modal de création: nom, description, catégorie, global/projet
  - [ ] Vérification rôle Staff+
  - [ ] Sauvegarde via POST /api/templates

- [ ] **Task 8: Duplication Document vers Template** (AC: 9)
  - [ ] Option "Dupliquer comme template" dans menu document
  - [ ] Pré-remplir avec contenu du document
  - [ ] Permettre modification avant sauvegarde

- [ ] **Task 9: Tests** (AC: 10)
  - [ ] Tests API templates CRUD
  - [ ] Tests parsing variables
  - [ ] Tests UI sélection et création

## Dev Notes

### Architecture

```text
apps/api/src/modules/templates/
├── templates.controller.ts
├── templates.service.ts
├── templates.routes.ts
└── index.ts

apps/web/src/components/templates/
├── TemplatePickerModal.tsx   # Modal sélection
├── TemplateCard.tsx          # Carte aperçu template
├── CreateTemplateModal.tsx   # Modal création
└── index.ts

apps/web/src/lib/
└── template-variables.ts     # Parsing variables
```

### Schéma Prisma

```prisma
enum TemplateCategory {
  REPORT
  MEETING
  BUDGET
  TRACKING
  HR
  OTHER
}

model DocumentTemplate {
  id          String           @id @default(uuid())
  name        String
  description String?
  type        DocumentType     // TEXT, SPREADSHEET
  category    TemplateCategory @default(OTHER)
  content     Json             // Contenu TipTap ou Luckysheet
  isGlobal    Boolean          @default(true)
  projectId   String?
  project     Project?         @relation(fields: [projectId], references: [id])
  createdById String
  createdBy   User             @relation(fields: [createdById], references: [id])
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([type, category])
  @@index([projectId])
}
```

### Templates Prédéfinis

| Nom | Type | Catégorie | Description |
|-----|------|-----------|-------------|
| Rapport d'activité mensuel | TEXT | REPORT | Structure rapport mensuel standard |
| PV de réunion | TEXT | MEETING | Modèle procès-verbal |
| Termes de Référence (TDR) | TEXT | HR | Structure TDR consultant |
| Note conceptuelle | TEXT | OTHER | Structure note de projet |
| Fiche de poste | TEXT | HR | Modèle description de poste |
| Budget prévisionnel | SPREADSHEET | BUDGET | Tableau budget avec catégories |
| Suivi budgétaire | SPREADSHEET | BUDGET | Suivi prévu vs réel |
| Chronogramme | SPREADSHEET | TRACKING | Planning avec jalons |
| Liste de présence | SPREADSHEET | MEETING | Feuille émargement |
| Tableau indicateurs | SPREADSHEET | TRACKING | Suivi KPIs projet |

### Exemple Variable Parsing

```ts
const variables = {
  'projet.nom': project.name,
  'date': new Date().toLocaleDateString('fr-FR'),
  'user.name': currentUser.name,
};

function parseTemplate(content: string, vars: Record<string, string>): string {
  return content.replace(/\{\{(\w+(?:\.\w+)?)\}\}/g, (match, key) => {
    return vars[key] ?? match; // Garde le placeholder si non trouvé
  });
}
```

## Testing

### Localisation

- `apps/api/tests/templates.test.ts`
- `apps/web/src/lib/__tests__/template-variables.test.ts`
- `apps/web/src/components/templates/__tests__/TemplatePickerModal.test.tsx`

### Framework

- Jest/Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| GET /templates | Liste templates globaux |
| POST /templates | Création par Staff+ |
| POST /templates | Création par Contributor - 403 |
| Variable parsing | `{{projet.nom}}` remplacé |
| Variable inconnue | `{{unknown}}` reste tel quel |
| Picker | Affiche templates par catégorie |
| Create from template | Document créé avec contenu |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
