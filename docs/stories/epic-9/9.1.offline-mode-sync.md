# Story 9.1: Offline Mode & Synchronization

## Status: Approved

## Story

**As a** agent terrain,
**I want** utiliser l'application sans connexion internet,
**so that** je puisse continuer à travailler dans les zones sans réseau.

## Acceptance Criteria

1. Service Worker pour mise en cache des ressources statiques (JS, CSS, images)
2. IndexedDB via Dexie.js pour stockage local des données (documents, projets, formulaires)
3. Indicateur visuel permanent du mode offline/online (icône + badge)
4. File d'attente des modifications en attente de synchronisation
5. Synchronisation automatique au retour de connexion
6. Stratégie de résolution conflits: timestamp-based avec option merge manuel
7. Notification des éléments synchronisés avec succès/échec
8. Possibilité de forcer la synchronisation manuelle
9. Cache des documents récemment consultés (10 derniers) pour accès offline
10. Installation PWA sur mobile et desktop
11. Tests de scénarios offline/online complets

## Tasks / Subtasks

- [ ] **Task 1: Configuration PWA avec Vite** (AC: 1, 10)
  - [ ] Installer `vite-plugin-pwa`
  - [ ] Configurer dans `vite.config.ts`
  - [ ] Définir manifest.json (nom, icônes, thème)
  - [ ] Configurer Workbox pour precaching
  - [ ] Tester installation sur Chrome/Safari

- [ ] **Task 2: Service Worker Avancé** (AC: 1)
  - [ ] Stratégie CacheFirst pour assets statiques
  - [ ] Stratégie NetworkFirst pour API avec fallback cache
  - [ ] Stratégie StaleWhileRevalidate pour ressources semi-dynamiques
  - [ ] Gérer mise à jour Service Worker

- [ ] **Task 3: Setup Dexie.js** (AC: 2)
  - [ ] Installer `dexie dexie-react-hooks`
  - [ ] Créer `apps/web/src/lib/db.ts`
  - [ ] Définir schéma: documents, projects, forms, syncQueue
  - [ ] Configurer indexes pour recherche offline

- [ ] **Task 4: Indicateur Connectivité** (AC: 3)
  - [ ] Créer `useOnlineStatus.ts` hook
  - [ ] Créer `ConnectionIndicator.tsx`
  - [ ] Afficher dans TopNav: icône wifi/wifi-off
  - [ ] Badge couleur (vert=online, rouge=offline)
  - [ ] Toast notification changement état

- [ ] **Task 5: Queue de Synchronisation** (AC: 4, 5)
  - [ ] Créer table `syncQueue` dans Dexie
  - [ ] Structure: id, type (create/update/delete), entity, entityId, data, timestamp, status
  - [ ] Ajouter à la queue lors de modifications offline
  - [ ] Traitement FIFO au retour connexion
  - [ ] Retry avec backoff exponentiel si échec

- [ ] **Task 6: Sync Automatique** (AC: 5)
  - [ ] Écouter événement `online` du navigateur
  - [ ] Déclencher processus sync
  - [ ] Traiter queue dans l'ordre
  - [ ] Mettre à jour IndexedDB avec réponses serveur

- [ ] **Task 7: Gestion Conflits** (AC: 6)
  - [ ] Détecter conflits (version serveur > version locale modifiée)
  - [ ] Stratégie par défaut: last-write-wins basé sur timestamp
  - [ ] UI pour conflits critiques: modal merge
  - [ ] Afficher diff des modifications

- [ ] **Task 8: Notifications Sync** (AC: 7)
  - [ ] Toast succès: "5 éléments synchronisés"
  - [ ] Toast erreur: "2 éléments en échec - Réessayer"
  - [ ] Badge sur icône sync indiquant pending count
  - [ ] Historique sync accessible

- [ ] **Task 9: Sync Manuelle** (AC: 8)
  - [ ] Bouton "Synchroniser maintenant" dans menu
  - [ ] Progress indicator pendant sync
  - [ ] Résultat détaillé en fin de sync

- [ ] **Task 10: Cache Documents Récents** (AC: 9)
  - [ ] Stocker contenu des 10 derniers documents consultés
  - [ ] Mettre à jour LRU (Least Recently Used)
  - [ ] Supprimer anciens quand > 10
  - [ ] Marquer documents disponibles offline

- [ ] **Task 11: Tests Offline/Online** (AC: 11)
  - [ ] Simuler offline dans DevTools
  - [ ] Tester modifications offline
  - [ ] Tester sync au retour online
  - [ ] Tester conflits
  - [ ] Tester PWA installation

## Dev Notes

### Architecture

```text
apps/web/src/lib/
├── db.ts                     # Configuration Dexie
├── sync-queue.ts             # Gestion queue sync
├── sync-service.ts           # Logique synchronisation
├── conflict-resolver.ts      # Résolution conflits
└── pwa-utils.ts              # Utilitaires PWA

apps/web/src/hooks/
├── useOnlineStatus.ts        # Hook état connexion
├── useOfflineDocument.ts     # Hook document avec fallback
├── useSyncQueue.ts           # Hook queue sync
└── useServiceWorker.ts       # Hook SW updates

apps/web/src/components/offline/
├── ConnectionIndicator.tsx   # Indicateur online/offline
├── SyncStatusBadge.tsx       # Badge éléments pending
├── ConflictModal.tsx         # Modal résolution conflits
└── SyncHistoryPanel.tsx      # Historique sync
```

### Configuration Vite PWA

```ts
// apps/web/vite.config.ts
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'ONG Platform',
        short_name: 'ONG',
        description: 'Plateforme de gestion pour ONG',
        theme_color: '#3b82f6',
        background_color: '#ffffff',
        display: 'standalone',
        icons: [
          { src: 'logo-192.png', sizes: '192x192', type: 'image/png' },
          { src: 'logo-512.png', sizes: '512x512', type: 'image/png' },
        ],
      },
      workbox: {
        globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/api\./i,
            handler: 'NetworkFirst',
            options: {
              cacheName: 'api-cache',
              expiration: { maxEntries: 100, maxAgeSeconds: 86400 },
            },
          },
        ],
      },
    }),
  ],
});
```

### Schéma Dexie

```ts
// apps/web/src/lib/db.ts
import Dexie, { Table } from 'dexie';

interface OfflineDocument {
  id: string;
  projectId: string;
  name: string;
  type: 'text' | 'spreadsheet';
  content: any;
  updatedAt: Date;
  localUpdatedAt: Date;
  synced: boolean;
}

interface SyncQueueItem {
  id?: number;
  type: 'create' | 'update' | 'delete';
  entity: 'document' | 'project' | 'form';
  entityId: string;
  data: any;
  timestamp: Date;
  status: 'pending' | 'processing' | 'failed';
  retryCount: number;
  error?: string;
}

class AppDatabase extends Dexie {
  documents!: Table<OfflineDocument>;
  syncQueue!: Table<SyncQueueItem>;

  constructor() {
    super('ong-platform-db');
    this.version(1).stores({
      documents: 'id, projectId, synced, updatedAt',
      syncQueue: '++id, type, entity, status, timestamp',
    });
  }
}

export const db = new AppDatabase();
```

### Référence POC

Voir `docs/research/poc-examples-epics-8-9-10.md` - POC 4 et POC 5

## Testing

### Localisation

- `apps/web/src/lib/__tests__/sync-queue.test.ts`
- `apps/web/src/hooks/__tests__/useOnlineStatus.test.ts`

### Framework

- Vitest + fake-indexeddb pour IndexedDB
- Playwright pour tests E2E offline

### Cas à couvrir

| Test | Description |
|------|-------------|
| Dexie init | Base IndexedDB créée correctement |
| Add to queue | Modification offline ajoutée à queue |
| Sync on online | Queue traitée au retour connexion |
| Conflict detection | Conflit détecté si version différente |
| Conflict resolve | Résolution timestamp fonctionne |
| Indicator | UI reflète état connexion |
| PWA install | App installable |
| Cache docs | Documents récents accessibles offline |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
