# Story 9.2: Dynamic Field Collection Forms

## Status: Approved

## Story

**As a** agent terrain,
**I want** remplir des formulaires de collecte sur mon mobile,
**so that** je puisse saisir les données bénéficiaires directement sur le terrain.

## Acceptance Criteria

1. Interface de création de formulaires personnalisés (rôle Staff+ requis)
2. Types de champs supportés: texte court, texte long, nombre, date, heure, choix unique (radio), choix multiple (checkbox), photo, signature, GPS
3. Champs conditionnels: afficher un champ si une condition est remplie (ex: afficher "préciser" si "Autre" sélectionné)
4. Validation des champs: requis, format (email, téléphone), min/max pour nombres, regex custom
5. Sauvegarde brouillon automatique pendant la saisie
6. Fonctionnement complet en mode offline (IndexedDB)
7. Soumission avec horodatage et géolocalisation automatiques
8. Liste des formulaires à remplir par projet avec statut (nouveau, brouillon, soumis)
9. Export des réponses en CSV/Excel par formulaire
10. Statistiques agrégées des réponses (graphiques simples)
11. Tests couvrant création, remplissage, et export

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma Form** (AC: 1, 3, 4)
  - [ ] Créer model `Form` (id, projectId, name, description, fields JSON, status, createdById)
  - [ ] Créer model `FormSubmission` (id, formId, data JSON, userId, geoLocation, submittedAt, status)
  - [ ] Créer enum `FormFieldType`: TEXT, TEXTAREA, NUMBER, DATE, TIME, RADIO, CHECKBOX, PHOTO, SIGNATURE, GPS
  - [ ] Migration Prisma

- [ ] **Task 2: API Forms CRUD** (AC: 1)
  - [ ] `GET /api/forms` - Liste par projet
  - [ ] `GET /api/forms/:id` - Détails avec champs
  - [ ] `POST /api/forms` - Créer formulaire (Staff+)
  - [ ] `PATCH /api/forms/:id` - Modifier structure
  - [ ] `DELETE /api/forms/:id` - Supprimer

- [ ] **Task 3: API Submissions** (AC: 7, 9)
  - [ ] `POST /api/forms/:id/submissions` - Soumettre réponse
  - [ ] `GET /api/forms/:id/submissions` - Liste réponses
  - [ ] `GET /api/forms/:id/export` - Export CSV/Excel
  - [ ] Validation des données selon définition champs

- [ ] **Task 4: Form Builder UI** (AC: 1, 2, 3, 4)
  - [ ] Créer `FormBuilder.tsx` (page création/édition)
  - [ ] Drag & drop pour réorganiser champs
  - [ ] Panel propriétés pour chaque champ
  - [ ] Configuration conditions d'affichage
  - [ ] Configuration validations
  - [ ] Preview du formulaire

- [ ] **Task 5: Types de Champs** (AC: 2)
  - [ ] `TextField.tsx` - Input texte court
  - [ ] `TextAreaField.tsx` - Textarea multiligne
  - [ ] `NumberField.tsx` - Input number avec min/max
  - [ ] `DateField.tsx` - Date picker
  - [ ] `TimeField.tsx` - Time picker
  - [ ] `RadioField.tsx` - Choix unique
  - [ ] `CheckboxField.tsx` - Choix multiple
  - [ ] `PhotoField.tsx` - Capture photo (voir Story 9.4)
  - [ ] `SignatureField.tsx` - Signature tactile (voir Story 9.3)
  - [ ] `GpsField.tsx` - Capture coordonnées

- [ ] **Task 6: Conditions d'Affichage** (AC: 3)
  - [ ] UI définition condition dans builder
  - [ ] Logic: field X === value Y → show field Z
  - [ ] Évaluation conditions au runtime
  - [ ] Support AND/OR pour conditions multiples

- [ ] **Task 7: Validations** (AC: 4)
  - [ ] Validation "required"
  - [ ] Validation "min/max" pour nombres
  - [ ] Validation "minLength/maxLength" pour texte
  - [ ] Validation "pattern" regex
  - [ ] Messages d'erreur personnalisables
  - [ ] Highlight champs invalides

- [ ] **Task 8: Form Filler UI** (AC: 5, 6, 7, 8)
  - [ ] Créer `FormFiller.tsx` (page remplissage)
  - [ ] Rendu dynamique des champs selon définition
  - [ ] Auto-save brouillon toutes les 10 secondes
  - [ ] Bouton soumettre avec géoloc
  - [ ] Stockage offline avec Dexie si pas de connexion

- [ ] **Task 9: Liste Formulaires** (AC: 8)
  - [ ] Page liste formulaires par projet
  - [ ] Filtres: à remplir, brouillons, soumis
  - [ ] Badge nouveau formulaire
  - [ ] Actions: Remplir, Voir brouillon, Voir soumission

- [ ] **Task 10: Export Réponses** (AC: 9)
  - [ ] Endpoint export CSV
  - [ ] Endpoint export XLSX
  - [ ] Bouton export dans liste submissions
  - [ ] Colonnes = champs du formulaire

- [ ] **Task 11: Statistiques** (AC: 10)
  - [ ] API agrégation par champ
  - [ ] Graphiques pour radio/checkbox (pie chart)
  - [ ] Moyennes pour nombres (bar chart)
  - [ ] Timeline des soumissions

- [ ] **Task 12: Tests** (AC: 11)
  - [ ] Tests API forms CRUD
  - [ ] Tests validation champs
  - [ ] Tests conditions
  - [ ] Tests export
  - [ ] Tests offline submission

## Dev Notes

### Architecture

```text
apps/api/src/modules/forms/
├── forms.controller.ts
├── forms.service.ts
├── forms.routes.ts
├── submissions.controller.ts
├── submissions.service.ts
├── export.service.ts
└── validation.service.ts

apps/web/src/components/forms/
├── FormBuilder.tsx           # Création formulaire
├── FormFiller.tsx            # Remplissage formulaire
├── FormField.tsx             # Wrapper champ générique
├── fields/                   # Composants par type
│   ├── TextField.tsx
│   ├── NumberField.tsx
│   ├── RadioField.tsx
│   └── ...
├── ConditionEditor.tsx       # UI conditions
├── ValidationEditor.tsx      # UI validations
├── FormPreview.tsx           # Preview
└── FormStats.tsx             # Statistiques
```

### Schéma Prisma

```prisma
enum FormFieldType {
  TEXT
  TEXTAREA
  NUMBER
  DATE
  TIME
  RADIO
  CHECKBOX
  PHOTO
  SIGNATURE
  GPS
}

model Form {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  name        String
  description String?
  fields      Json     // Array de FormFieldDefinition
  status      String   @default("draft") // draft, published, archived
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  submissions FormSubmission[]

  @@index([projectId, status])
}

model FormSubmission {
  id          String   @id @default(uuid())
  formId      String
  form        Form     @relation(fields: [formId], references: [id])
  data        Json     // Réponses: { fieldId: value }
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  geoLocation Json?    // { lat, lng, accuracy }
  submittedAt DateTime @default(now())
  status      String   @default("submitted") // draft, submitted, validated

  @@index([formId, submittedAt])
  @@index([userId])
}
```

### Structure Field Definition

```ts
interface FormFieldDefinition {
  id: string;
  type: FormFieldType;
  label: string;
  placeholder?: string;
  required: boolean;
  options?: { value: string; label: string }[]; // Pour radio/checkbox
  validation?: {
    min?: number;
    max?: number;
    minLength?: number;
    maxLength?: number;
    pattern?: string;
    message?: string;
  };
  condition?: {
    fieldId: string;
    operator: 'equals' | 'notEquals' | 'contains';
    value: any;
  };
  order: number;
}
```

### Offline Storage

```ts
// Stocker formulaire et brouillons dans Dexie
interface OfflineForm {
  id: string;
  data: Form;
  cachedAt: Date;
}

interface OfflineDraft {
  id: string;
  formId: string;
  data: Record<string, any>;
  updatedAt: Date;
  synced: boolean;
}
```

## Testing

### Localisation

- `apps/api/tests/forms.test.ts`
- `apps/web/src/components/forms/__tests__/`

### Framework

- Jest/Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create form | Création avec champs multiples |
| Validation required | Soumission bloquée si requis vide |
| Validation min/max | Nombre hors limites rejeté |
| Condition | Champ affiché si condition vraie |
| Condition hide | Champ masqué si condition fausse |
| Submit | Soumission avec géoloc |
| Export CSV | Génère CSV valide |
| Offline draft | Brouillon sauvé localement |
| Offline submit | Queue de sync si offline |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
