# Story 9.3: Electronic Signature

## Status: Approved

## Story

**As a** coordinateur terrain,
**I want** faire signer des documents sur tablette/mobile,
**so that** je puisse valider des présences ou accords sans papier.

## Acceptance Criteria

1. Canvas de signature tactile responsive (doigt ou stylet)
2. Capture de la signature en image PNG avec fond transparent
3. Intégration de la signature dans les documents PDF
4. Horodatage automatique de la signature (date/heure précise)
5. Géolocalisation optionnelle au moment de la signature
6. Stockage sécurisé des signatures (hash + metadata)
7. Vérification de l'identité du signataire (nom, email confirmés)
8. Possibilité de refaire la signature avant validation finale
9. Historique des signatures par document avec audit trail
10. Export du document signé en PDF
11. Tests couvrant capture, validation, et intégration PDF

## Tasks / Subtasks

- [ ] **Task 1: Composant SignaturePad** (AC: 1, 2, 8)
  - [ ] Installer `react-signature-canvas`
  - [ ] Créer `SignaturePad.tsx`
  - [ ] Canvas responsive (mobile/tablet/desktop)
  - [ ] Options: couleur trait, épaisseur
  - [ ] Bouton "Effacer" pour recommencer
  - [ ] Bouton "Valider" quand satisfait
  - [ ] Export en PNG base64

- [ ] **Task 2: API Signatures** (AC: 4, 5, 6, 9)
  - [ ] Créer model `Signature` dans Prisma
  - [ ] `POST /api/signatures` - Créer signature
  - [ ] `GET /api/documents/:id/signatures` - Liste signatures document
  - [ ] Stocker: imageData, timestamp, geoLocation, signerId, documentId
  - [ ] Calculer hash SHA-256 de l'image pour intégrité

- [ ] **Task 3: Horodatage et Géolocalisation** (AC: 4, 5)
  - [ ] Capturer timestamp précis (ISO 8601)
  - [ ] Demander permission géolocalisation
  - [ ] Capturer lat/lng/accuracy si autorisé
  - [ ] Fallback gracieux si refusé

- [ ] **Task 4: Vérification Identité** (AC: 7)
  - [ ] Modal confirmation identité avant signature
  - [ ] Afficher nom et email de l'utilisateur connecté
  - [ ] Option: saisie nom si signature pour tiers
  - [ ] Checkbox "Je confirme mon identité"

- [ ] **Task 5: Intégration PDF** (AC: 3, 10)
  - [ ] Installer `pdf-lib`
  - [ ] Créer service `signature-pdf.service.ts`
  - [ ] Charger PDF source
  - [ ] Insérer image signature à position définie
  - [ ] Ajouter texte: nom, date, lieu
  - [ ] Générer PDF signé
  - [ ] Endpoint `GET /api/documents/:id/signed-pdf`

- [ ] **Task 6: Stockage Sécurisé** (AC: 6)
  - [ ] Uploader image signature vers Supabase Storage (bucket privé)
  - [ ] Stocker hash SHA-256 en base
  - [ ] Vérification intégrité à l'affichage
  - [ ] Politique rétention configurable

- [ ] **Task 7: UI Document Signing Flow** (AC: 1-10)
  - [ ] Créer `DocumentSigningModal.tsx`
  - [ ] Étape 1: Preview document
  - [ ] Étape 2: Confirmation identité
  - [ ] Étape 3: Signature tactile
  - [ ] Étape 4: Confirmation + horodatage affiché
  - [ ] Téléchargement PDF signé

- [ ] **Task 8: Historique Signatures** (AC: 9)
  - [ ] Tab "Signatures" dans DocumentDrawer
  - [ ] Liste chronologique des signatures
  - [ ] Détails: signataire, date, lieu, aperçu signature
  - [ ] Vérification intégrité (hash match)

- [ ] **Task 9: Intégration Formulaires** (AC: 1-4)
  - [ ] `SignatureField.tsx` pour FormFiller (Story 9.2)
  - [ ] Même composant SignaturePad réutilisé
  - [ ] Stockage signature dans soumission formulaire

- [ ] **Task 10: Tests** (AC: 11)
  - [ ] Tests composant SignaturePad
  - [ ] Tests API signature
  - [ ] Tests intégration PDF
  - [ ] Tests hash intégrité

## Dev Notes

### Architecture

```text
apps/api/src/modules/signatures/
├── signatures.controller.ts
├── signatures.service.ts
├── signatures.routes.ts
├── pdf-signing.service.ts    # Intégration PDF
└── index.ts

apps/web/src/components/signature/
├── SignaturePad.tsx          # Canvas tactile
├── SignatureModal.tsx        # Flow complet
├── SignaturePreview.tsx      # Aperçu signature
├── SignatureHistory.tsx      # Liste signatures
└── index.ts
```

### Schéma Prisma

```prisma
model Signature {
  id            String   @id @default(uuid())
  documentId    String
  document      Document @relation(fields: [documentId], references: [id])
  signerId      String
  signer        User     @relation(fields: [signerId], references: [id])
  signerName    String   // Nom affiché (peut être tiers)
  imageUrl      String   // URL Supabase Storage
  imageHash     String   // SHA-256 pour intégrité
  signedAt      DateTime @default(now())
  geoLocation   Json?    // { lat, lng, accuracy }
  metadata      Json?    // Infos supplémentaires
  createdAt     DateTime @default(now())

  @@index([documentId])
  @@index([signerId])
}
```

### Code SignaturePad

```tsx
// apps/web/src/components/signature/SignaturePad.tsx
import { useRef, useState } from 'react';
import SignatureCanvas from 'react-signature-canvas';

interface SignaturePadProps {
  onSave: (dataUrl: string) => void;
  onCancel: () => void;
}

export function SignaturePad({ onSave, onCancel }: SignaturePadProps) {
  const sigRef = useRef<SignatureCanvas>(null);
  const [isEmpty, setIsEmpty] = useState(true);

  const handleClear = () => {
    sigRef.current?.clear();
    setIsEmpty(true);
  };

  const handleSave = () => {
    if (sigRef.current && !sigRef.current.isEmpty()) {
      const dataUrl = sigRef.current.getTrimmedCanvas().toDataURL('image/png');
      onSave(dataUrl);
    }
  };

  return (
    <div className="flex flex-col gap-4">
      <div className="border-2 border-dashed rounded-lg bg-white">
        <SignatureCanvas
          ref={sigRef}
          penColor="black"
          canvasProps={{
            className: 'w-full h-48 touch-none',
          }}
          onBegin={() => setIsEmpty(false)}
        />
      </div>

      <div className="flex gap-2 justify-end">
        <Button variant="outline" onClick={onCancel}>Annuler</Button>
        <Button variant="outline" onClick={handleClear}>Effacer</Button>
        <Button onClick={handleSave} disabled={isEmpty}>Valider</Button>
      </div>
    </div>
  );
}
```

### Intégration PDF avec pdf-lib

```ts
// apps/api/src/modules/signatures/pdf-signing.service.ts
import { PDFDocument } from 'pdf-lib';

async function addSignatureToPdf(
  pdfBytes: Uint8Array,
  signatureImage: Uint8Array,
  signerName: string,
  signedAt: Date,
  position: { x: number; y: number; page: number }
) {
  const pdfDoc = await PDFDocument.load(pdfBytes);
  const pngImage = await pdfDoc.embedPng(signatureImage);

  const page = pdfDoc.getPages()[position.page];

  // Ajouter signature
  page.drawImage(pngImage, {
    x: position.x,
    y: position.y,
    width: 150,
    height: 50,
  });

  // Ajouter texte
  page.drawText(`Signé par ${signerName} le ${signedAt.toLocaleString('fr-FR')}`, {
    x: position.x,
    y: position.y - 15,
    size: 8,
  });

  return pdfDoc.save();
}
```

### Référence POC

Voir `docs/research/poc-examples-epics-8-9-10.md` - POC 3

## Testing

### Localisation

- `apps/api/tests/signatures.test.ts`
- `apps/web/src/components/signature/__tests__/SignaturePad.test.tsx`

### Framework

- Jest/Vitest + React Testing Library
- canvas mock pour tests

### Cas à couvrir

| Test | Description |
|------|-------------|
| Render pad | Canvas s'affiche correctement |
| Draw | Trait visible après dessin |
| Clear | Effacer remet canvas vide |
| Save | Export PNG valide |
| API create | Signature créée avec hash |
| PDF embed | Signature insérée dans PDF |
| Hash verify | Intégrité vérifiée au chargement |
| History | Liste signatures affichée |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
