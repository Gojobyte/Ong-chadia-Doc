# Story 7.1: Project Budget Creation

## Status: Approved

## Story

**As a** gestionnaire financier,
**I want** créer un budget de projet avec une structure flexible,
**so that** je puisse planifier les ressources financières selon le format requis.

## Acceptance Criteria

1. Interface de création de budget intuitive avec wizard ou formulaire guidé
2. Structure hiérarchique: Catégories > Lignes > Sous-lignes
3. Catégories standards ONG pré-définies: Personnel, Équipement, Activités, Frais généraux, etc.
4. Import de structure depuis template bailleur (Epic 7.2)
5. Périodes budgétaires configurables (mensuel, trimestriel, annuel, multi-années)
6. Support multi-devises avec taux de conversion vers devise principale
7. Calculs automatiques (totaux, sous-totaux, pourcentages)
8. Formules personnalisées entre cellules (ex: ligne A = 10% de ligne B)
9. Commentaires/justifications par ligne budgétaire
10. Validation format et cohérence avant sauvegarde

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma Budget** (AC: 1, 2, 5)
  - [ ] Créer model `Budget` (id, projectId, name, currency, startDate, endDate, status)
  - [ ] Créer model `BudgetCategory` (budgetId, name, order)
  - [ ] Créer model `BudgetLine` (categoryId, description, unitCost, quantity, total, formula)
  - [ ] Créer enum `BudgetPeriodType`: MONTHLY, QUARTERLY, ANNUAL
  - [ ] Migration Prisma

- [ ] **Task 2: API Budget CRUD** (AC: 1)
  - [ ] `POST /api/projects/:id/budgets` - Créer budget
  - [ ] `GET /api/projects/:id/budgets` - Liste budgets projet
  - [ ] `GET /api/budgets/:id` - Détails complets
  - [ ] `PATCH /api/budgets/:id` - Modifier
  - [ ] `DELETE /api/budgets/:id` - Supprimer (si brouillon)

- [ ] **Task 3: Catégories Standards** (AC: 3)
  - [ ] Seed catégories par défaut
  - [ ] Personnel (salaires, charges, per diem)
  - [ ] Équipement (achat, location)
  - [ ] Activités (formations, ateliers, missions)
  - [ ] Fonctionnement (bureau, communication)
  - [ ] Frais indirects (si applicable)

- [ ] **Task 4: Structure Hiérarchique** (AC: 2)
  - [ ] API gestion catégories
  - [ ] API gestion lignes avec parent optionnel
  - [ ] Calculs récursifs sous-totaux
  - [ ] Réordonnancement drag & drop

- [ ] **Task 5: Périodes Budgétaires** (AC: 5)
  - [ ] Ajouter structure periods sur BudgetLine
  - [ ] Ventilation automatique si pas détaillée
  - [ ] Agrégation par période
  - [ ] Affichage tableau croisé

- [ ] **Task 6: Multi-devises** (AC: 6)
  - [ ] Ajouter champ currency sur BudgetLine
  - [ ] Table `ExchangeRate` (from, to, rate, date)
  - [ ] Conversion automatique vers devise budget
  - [ ] Affichage montant original + converti

- [ ] **Task 7: Calculs Automatiques** (AC: 7, 8)
  - [ ] Calcul total = unitCost * quantity
  - [ ] Calcul sous-total catégorie
  - [ ] Calcul total budget
  - [ ] Support formules simples: `=SUM()`, `=10% * REF`
  - [ ] Validation formules circulaires

- [ ] **Task 8: Justifications** (AC: 9)
  - [ ] Ajouter champ `justification` sur BudgetLine
  - [ ] UI textarea pour chaque ligne
  - [ ] Export inclut justifications

- [ ] **Task 9: Validation** (AC: 10)
  - [ ] Vérifier totaux cohérents
  - [ ] Vérifier lignes requises présentes (selon template)
  - [ ] Vérifier devise renseignée
  - [ ] Retourner liste erreurs/warnings

- [ ] **Task 10: UI Budget Editor** (AC: 1, 2, 7)
  - [ ] Créer `BudgetEditorPage.tsx`
  - [ ] Vue tableau avec colonnes configurables
  - [ ] Lignes groupées par catégorie
  - [ ] Totaux et sous-totaux automatiques
  - [ ] Inline editing

- [ ] **Task 11: UI Création Guidée** (AC: 1)
  - [ ] Wizard étape par étape
  - [ ] Étape 1: Infos générales (nom, période, devise)
  - [ ] Étape 2: Sélection catégories
  - [ ] Étape 3: Saisie lignes
  - [ ] Étape 4: Révision et validation

- [ ] **Task 12: Tests** (AC: 1-10)
  - [ ] Tests API CRUD
  - [ ] Tests calculs automatiques
  - [ ] Tests formules
  - [ ] Tests validation

## Dev Notes

### Architecture

```text
apps/api/src/modules/budgets/
├── budgets.controller.ts
├── budgets.service.ts
├── budgets.routes.ts
├── categories.controller.ts
├── categories.service.ts
├── lines.controller.ts
├── lines.service.ts
├── calculations.service.ts
├── validation.service.ts
└── index.ts

apps/web/src/pages/budgets/
├── BudgetEditorPage.tsx
├── BudgetWizard.tsx
├── BudgetTable.tsx
├── BudgetLineRow.tsx
├── CategorySection.tsx
├── FormulaEditor.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum BudgetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  ACTIVE
  CLOSED
}

model Budget {
  id          String       @id @default(uuid())
  projectId   String
  project     Project      @relation(fields: [projectId], references: [id])
  name        String
  description String?
  currency    String       @default("EUR")
  startDate   DateTime
  endDate     DateTime
  status      BudgetStatus @default(DRAFT)

  totalPlanned Decimal?    @db.Decimal(15, 2)

  createdById String
  createdBy   User         @relation(fields: [createdById], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  categories  BudgetCategory[]
  versions    BudgetVersion[]

  @@index([projectId])
}

model BudgetCategory {
  id          String   @id @default(uuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id])
  name        String
  code        String?  // Ex: "A", "B", "C" ou "1", "2", "3"
  description String?
  order       Int      @default(0)

  lines       BudgetLine[]

  @@index([budgetId, order])
}

model BudgetLine {
  id            String         @id @default(uuid())
  categoryId    String
  category      BudgetCategory @relation(fields: [categoryId], references: [id])
  parentId      String?        // Pour sous-lignes
  parent        BudgetLine?    @relation("LineHierarchy", fields: [parentId], references: [id])
  children      BudgetLine[]   @relation("LineHierarchy")

  code          String?        // Ex: "A.1", "A.1.1"
  description   String
  unit          String?        // "mois", "jour", "forfait"
  unitCost      Decimal?       @db.Decimal(15, 2)
  quantity      Decimal?       @db.Decimal(10, 2)
  total         Decimal?       @db.Decimal(15, 2)

  currency      String?        // Si différent du budget
  exchangeRate  Decimal?       @db.Decimal(10, 6)

  formula       String?        // Formule si calculé
  justification String?

  // Ventilation par période (JSON)
  periods       Json?          // { "2025-01": 1000, "2025-02": 1000, ... }

  order         Int            @default(0)

  @@index([categoryId, order])
}

model ExchangeRate {
  id        String   @id @default(uuid())
  fromCur   String
  toCur     String
  rate      Decimal  @db.Decimal(10, 6)
  date      DateTime @default(now())

  @@unique([fromCur, toCur, date])
  @@index([fromCur, toCur])
}
```

### Catégories Standards ONG

| Code | Nom | Description |
|------|-----|-------------|
| A | Personnel | Salaires, charges sociales, per diem |
| B | Équipement | Achats, locations, amortissements |
| C | Activités | Formations, ateliers, missions terrain |
| D | Fonctionnement | Bureau, communication, transport |
| E | Sous-traitance | Consultants, prestataires |
| F | Imprévus | Provision pour imprévus (5-10%) |
| G | Frais indirects | Overhead (si applicable) |

### Calculs et Formules

```ts
interface BudgetCalculations {
  // Calcul ligne simple
  calculateLineTotal(line: BudgetLine): Decimal {
    if (line.formula) {
      return this.evaluateFormula(line.formula);
    }
    return (line.unitCost || 0) * (line.quantity || 1);
  }

  // Calcul sous-total catégorie
  calculateCategoryTotal(category: BudgetCategory): Decimal {
    return category.lines
      .filter(l => !l.parentId) // Exclure sous-lignes (déjà dans parent)
      .reduce((sum, line) => sum + line.total, 0);
  }

  // Évaluer formule
  evaluateFormula(formula: string, context: BudgetContext): Decimal {
    // Supporter: =A.1 * 0.1, =SUM(A.1:A.5), =A.1 + B.2
    // Utiliser parser de formules (math.js ou custom)
  }
}
```

## Testing

### Localisation

- `apps/api/tests/budgets.test.ts`
- `apps/web/src/pages/budgets/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create budget | Création avec catégories |
| Add line | Ajout ligne avec calcul total |
| Hierarchy | Sous-lignes calculées |
| Formula | Formule évaluée correctement |
| Multi-currency | Conversion devise |
| Periods | Ventilation par période |
| Validation | Erreurs détectées |
| Totals | Sous-totaux et total corrects |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
