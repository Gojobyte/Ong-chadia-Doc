# Story 7.3: Budget Breakdown & Allocation

## Status: Approved

## Story

**As a** coordinateur projet,
**I want** ventiler le budget par période, activité et source de financement,
**so that** j'aie une vision claire de l'allocation des ressources.

## Acceptance Criteria

1. Ventilation temporelle par période (mensuelle/trimestrielle)
2. Ventilation par work package / activité du projet
3. Ventilation par source de financement (multi-bailleurs, co-financement)
4. Graphiques de répartition (camembert, barres empilées)
5. Tableau croisé dynamique (période x catégorie, activité x catégorie)
6. Calcul automatique des quotes-parts par source
7. Alertes si déséquilibre détecté (période vide, activité non budgétée)
8. Comparaison entre scénarios budgétaires
9. Export ventilation détaillée en Excel
10. Drill-down depuis graphiques vers détail

## Tasks / Subtasks

- [ ] **Task 1: Schéma Ventilation Temporelle** (AC: 1)
  - [ ] Ajouter champ `periods` JSON sur BudgetLine
  - [ ] Structure: `{ "2025-Q1": 5000, "2025-Q2": 5000, ... }`
  - [ ] API pour mise à jour ventilation
  - [ ] Validation: somme periods = total ligne

- [ ] **Task 2: Ventilation par Activité** (AC: 2)
  - [ ] Créer model `BudgetActivity` (budgetId, activityId, lines[])
  - [ ] Lier BudgetLine à Activity (du projet)
  - [ ] Permettre allocation partielle (% d'une ligne à plusieurs activités)
  - [ ] Calcul total par activité

- [ ] **Task 3: Sources de Financement** (AC: 3, 6)
  - [ ] Créer model `FundingSource` (budgetId, name, amount, percentage)
  - [ ] Types: principal, co-financement, contrepartie
  - [ ] Allocation lignes par source (% ou montant)
  - [ ] Calcul automatique quotes-parts

- [ ] **Task 4: API Ventilation** (AC: 1, 2, 3)
  - [ ] `GET /api/budgets/:id/breakdown/periods` - Par période
  - [ ] `GET /api/budgets/:id/breakdown/activities` - Par activité
  - [ ] `GET /api/budgets/:id/breakdown/sources` - Par source
  - [ ] `GET /api/budgets/:id/breakdown/matrix` - Tableau croisé

- [ ] **Task 5: Détection Déséquilibres** (AC: 7)
  - [ ] Créer service `balance-checker.service.ts`
  - [ ] Vérifier: période sans allocation
  - [ ] Vérifier: activité sans budget
  - [ ] Vérifier: source sous/sur-financée
  - [ ] Retourner liste warnings

- [ ] **Task 6: Scénarios Budgétaires** (AC: 8)
  - [ ] Permettre création de scénarios (copies du budget)
  - [ ] Nommer scénarios: "Optimiste", "Réaliste", "Minimum"
  - [ ] Comparaison côte à côte
  - [ ] Diff montants entre scénarios

- [ ] **Task 7: Export Excel Ventilé** (AC: 9)
  - [ ] `GET /api/budgets/:id/export/breakdown`
  - [ ] Feuilles: Synthèse, Par période, Par activité, Par source
  - [ ] Tableau croisé inclus
  - [ ] Graphiques intégrés si possible

- [ ] **Task 8: UI Ventilation Temporelle** (AC: 1, 4)
  - [ ] Créer `BudgetPeriodsView.tsx`
  - [ ] Tableau avec colonnes = périodes
  - [ ] Inline editing des montants par période
  - [ ] Totaux par ligne et par période
  - [ ] Graphique évolution temporelle

- [ ] **Task 9: UI Ventilation Activités** (AC: 2, 4)
  - [ ] Créer `BudgetActivitiesView.tsx`
  - [ ] Lier lignes aux activités du projet
  - [ ] Allocation % par activité
  - [ ] Graphique répartition par activité

- [ ] **Task 10: UI Sources Financement** (AC: 3, 4)
  - [ ] Créer `FundingSourcesView.tsx`
  - [ ] Définir sources avec montants engagés
  - [ ] Allocation lignes par source
  - [ ] Graphique camembert par source

- [ ] **Task 11: UI Tableau Croisé** (AC: 5)
  - [ ] Créer `BudgetPivotTable.tsx`
  - [ ] Sélection dimensions (lignes x colonnes)
  - [ ] Options: Catégorie x Période, Activité x Catégorie
  - [ ] Totaux marginaux

- [ ] **Task 12: UI Graphiques** (AC: 4, 10)
  - [ ] Graphiques Recharts intégrés
  - [ ] Camembert répartition
  - [ ] Barres empilées par période
  - [ ] Clic sur segment → drill-down

- [ ] **Task 13: Tests** (AC: 1-10)
  - [ ] Tests ventilation temporelle
  - [ ] Tests allocation activités
  - [ ] Tests quotes-parts sources
  - [ ] Tests détection déséquilibres

## Dev Notes

### Architecture

```text
apps/api/src/modules/budgets/
├── breakdown/
│   ├── breakdown.controller.ts
│   ├── breakdown.service.ts
│   ├── periods.service.ts
│   ├── activities.service.ts
│   ├── sources.service.ts
│   ├── balance-checker.service.ts
│   └── index.ts
├── scenarios/
│   ├── scenarios.controller.ts
│   ├── scenarios.service.ts
│   └── index.ts
└── index.ts

apps/web/src/pages/budgets/
├── BudgetBreakdownPage.tsx
├── BudgetPeriodsView.tsx
├── BudgetActivitiesView.tsx
├── FundingSourcesView.tsx
├── BudgetPivotTable.tsx
├── BudgetCharts.tsx
├── ScenariosComparison.tsx
└── index.ts
```

### Schéma Prisma Étendu

```prisma
model BudgetLine {
  // ... champs existants

  // Ventilation temporelle
  periods         Json?     // { "2025-Q1": 5000, ... }

  // Ventilation activité
  activityAllocations BudgetActivityAllocation[]

  // Ventilation source
  sourceAllocations BudgetSourceAllocation[]
}

model BudgetActivityAllocation {
  id          String     @id @default(uuid())
  budgetLineId String
  budgetLine  BudgetLine @relation(fields: [budgetLineId], references: [id])
  activityId  String     // ID activité projet
  percentage  Decimal    @db.Decimal(5, 2)  // 0-100
  amount      Decimal?   @db.Decimal(15, 2) // Calculé

  @@unique([budgetLineId, activityId])
}

model FundingSource {
  id          String   @id @default(uuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id])
  name        String   // "AFD", "UE", "Fonds propres"
  type        String   // MAIN, CO_FUNDING, CONTRIBUTION
  amount      Decimal  @db.Decimal(15, 2)
  percentage  Decimal? @db.Decimal(5, 2)
  currency    String?

  allocations BudgetSourceAllocation[]

  @@index([budgetId])
}

model BudgetSourceAllocation {
  id          String        @id @default(uuid())
  budgetLineId String
  budgetLine  BudgetLine    @relation(fields: [budgetLineId], references: [id])
  sourceId    String
  source      FundingSource @relation(fields: [sourceId], references: [id])
  percentage  Decimal       @db.Decimal(5, 2)
  amount      Decimal?      @db.Decimal(15, 2)

  @@unique([budgetLineId, sourceId])
}

model BudgetScenario {
  id          String   @id @default(uuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id])
  name        String   // "Optimiste", "Réaliste", "Minimum"
  description String?
  data        Json     // Copie de la structure avec montants modifiés
  createdAt   DateTime @default(now())

  @@index([budgetId])
}
```

### API Response Breakdown

```ts
// GET /api/budgets/:id/breakdown/periods
interface PeriodsBreakdown {
  periods: string[];  // ["2025-Q1", "2025-Q2", ...]
  byCategory: {
    categoryId: string;
    categoryName: string;
    periods: { [period: string]: number };
    total: number;
  }[];
  totals: { [period: string]: number };
  grandTotal: number;
}

// GET /api/budgets/:id/breakdown/sources
interface SourcesBreakdown {
  sources: {
    id: string;
    name: string;
    type: string;
    committed: number;
    allocated: number;
    remaining: number;
    percentage: number;
  }[];
  total: number;
  unallocated: number;
}
```

### UI Tableau Croisé

```text
┌─────────────────────────────────────────────────────────────┐
│ Tableau croisé: [Catégorie ▼] x [Période ▼]                │
├────────────────┬──────────┬──────────┬──────────┬──────────┤
│                │ Q1 2025  │ Q2 2025  │ Q3 2025  │ TOTAL    │
├────────────────┼──────────┼──────────┼──────────┼──────────┤
│ Personnel      │  50,000  │  50,000  │  50,000  │ 150,000  │
│ Équipement     │  30,000  │   5,000  │   5,000  │  40,000  │
│ Activités      │  10,000  │  25,000  │  20,000  │  55,000  │
│ Fonctionnement │   5,000  │   5,000  │   5,000  │  15,000  │
├────────────────┼──────────┼──────────┼──────────┼──────────┤
│ TOTAL          │  95,000  │  85,000  │  80,000  │ 260,000  │
└────────────────┴──────────┴──────────┴──────────┴──────────┘
```

## Testing

### Localisation

- `apps/api/tests/budget-breakdown.test.ts`
- `apps/web/src/pages/budgets/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Period allocation | Ventilation temporelle correcte |
| Activity allocation | Allocation activité avec % |
| Source allocation | Quotes-parts calculées |
| Balance check | Warning période vide |
| Scenario create | Copie budget créée |
| Scenario compare | Diff calculé |
| Export | Excel avec toutes feuilles |
| Pivot table | Données croisées correctes |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
