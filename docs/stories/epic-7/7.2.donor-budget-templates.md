# Story 7.2: Donor Budget Templates

## Status: Approved

## Story

**As a** chargé de budget,
**I want** utiliser des templates budgétaires conformes aux formats bailleurs,
**so that** mes budgets respectent les exigences spécifiques de chaque financeur.

## Acceptance Criteria

1. Bibliothèque de templates budgétaires par bailleur
2. Templates pré-définis: UE, AFD, USAID, ECHO, Banque Mondiale
3. Structure pré-définie avec catégories et lignes obligatoires
4. Règles de calcul spécifiques (ex: frais indirects max 7%, plafonds)
5. Création de budget depuis template avec pré-remplissage structure
6. Personnalisation du template (ajout lignes, pas suppression obligatoires)
7. Validation automatique conformité aux règles bailleur
8. Export au format exact exigé par le bailleur (Excel spécifique)
9. Mise à jour des templates selon évolutions des exigences bailleurs
10. Tests de conformité automatisés

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma BudgetTemplate** (AC: 1, 2, 3)
  - [ ] Créer model `BudgetTemplate` (id, donor, name, structure, rules, exportFormat)
  - [ ] Relation avec BudgetCategory/Line templates
  - [ ] Champs: version, isActive
  - [ ] Migration Prisma

- [ ] **Task 2: API Templates CRUD** (AC: 1, 9)
  - [ ] `GET /api/budget-templates` - Liste par bailleur
  - [ ] `GET /api/budget-templates/:id` - Détails template
  - [ ] `POST /api/budget-templates` - Créer (Admin)
  - [ ] `PATCH /api/budget-templates/:id` - Modifier
  - [ ] Versioning automatique

- [ ] **Task 3: Templates Bailleurs Standards** (AC: 2, 3)
  - [ ] Créer seed `seed-budget-templates.ts`
  - [ ] Template UE (format standard annexe budget)
  - [ ] Template AFD (format convention)
  - [ ] Template USAID (SF-424)
  - [ ] Template ECHO (Single Form)

- [ ] **Task 4: Règles de Calcul** (AC: 4)
  - [ ] Créer structure `BudgetRule`
  - [ ] Types: MAX_PERCENT, MIN_AMOUNT, REQUIRED_LINE, FORMULA
  - [ ] Exemples:
    - `{ type: 'MAX_PERCENT', target: 'indirect_costs', value: 7 }`
    - `{ type: 'REQUIRED_LINE', category: 'personnel', code: 'coordinator' }`
  - [ ] Validation contre règles

- [ ] **Task 5: Création depuis Template** (AC: 5, 6)
  - [ ] `POST /api/projects/:id/budgets` avec templateId
  - [ ] Copier structure (catégories, lignes)
  - [ ] Marquer lignes obligatoires (non supprimables)
  - [ ] Permettre ajout lignes custom

- [ ] **Task 6: Validation Conformité** (AC: 7)
  - [ ] Service `compliance-validator.service.ts`
  - [ ] Vérifier toutes les règles du template
  - [ ] Retourner liste violations
  - [ ] Bloquer export si violations critiques

- [ ] **Task 7: Export Format Bailleur** (AC: 8)
  - [ ] Créer exports spécifiques par bailleur
  - [ ] UE: Format annexe Excel standard
  - [ ] AFD: Format tableau AFD
  - [ ] USAID: SF-424 Budget
  - [ ] Mapping colonnes personnalisé

- [ ] **Task 8: UI Sélection Template** (AC: 1, 5)
  - [ ] Modal sélection template à création budget
  - [ ] Filtrer par bailleur
  - [ ] Preview structure du template
  - [ ] Description des règles applicables

- [ ] **Task 9: UI Indicateurs Conformité** (AC: 7)
  - [ ] Panneau latéral avec règles et statut
  - [ ] Indicateur visuel: ✓ conforme, ⚠ warning, ✗ violation
  - [ ] Détail de chaque règle
  - [ ] Actions correctives suggérées

- [ ] **Task 10: Gestion Versions Templates** (AC: 9)
  - [ ] Historique des versions par template
  - [ ] Changelog des modifications
  - [ ] Migration budgets existants (optionnel)
  - [ ] Notification nouveaux templates

- [ ] **Task 11: Tests** (AC: 10)
  - [ ] Tests création depuis template
  - [ ] Tests validation règles
  - [ ] Tests export format bailleur
  - [ ] Tests conformité

## Dev Notes

### Architecture

```text
apps/api/src/modules/budgets/
├── templates/
│   ├── templates.controller.ts
│   ├── templates.service.ts
│   ├── templates.routes.ts
│   ├── rules-validator.service.ts
│   └── index.ts
├── export/
│   ├── export.service.ts
│   ├── exporters/
│   │   ├── eu-exporter.ts
│   │   ├── afd-exporter.ts
│   │   ├── usaid-exporter.ts
│   │   └── generic-exporter.ts
│   └── index.ts
└── index.ts

apps/web/src/pages/budgets/
├── TemplateSelectionModal.tsx
├── CompliancePanel.tsx
└── index.ts
```

### Schéma Prisma

```prisma
model BudgetTemplate {
  id          String   @id @default(uuid())
  donor       String   // UE, AFD, USAID, ECHO, etc.
  name        String
  description String?
  version     Int      @default(1)
  isActive    Boolean  @default(true)

  structure   Json     // Catégories et lignes template
  rules       Json     // Règles de validation
  exportConfig Json?   // Configuration export spécifique

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  budgets     Budget[]

  @@unique([donor, version])
  @@index([donor, isActive])
}
```

### Structure Template

```ts
interface BudgetTemplateStructure {
  categories: TemplateCategoryDef[];
  metadata: {
    currency: string;
    periodType: string;
  };
}

interface TemplateCategoryDef {
  code: string;
  name: string;
  required: boolean;
  lines: TemplateLineDef[];
}

interface TemplateLineDef {
  code: string;
  description: string;
  required: boolean;
  unit?: string;
  formula?: string;
}
```

### Règles Budget

```ts
interface BudgetRule {
  id: string;
  type: 'MAX_PERCENT' | 'MIN_PERCENT' | 'MAX_AMOUNT' | 'REQUIRED_LINE' | 'FORMULA' | 'CUSTOM';
  target: string;      // Catégorie, ligne, ou 'total'
  value?: number;
  formula?: string;
  message: string;
  severity: 'error' | 'warning';
}

// Exemples règles UE
const euRules: BudgetRule[] = [
  {
    id: 'eu-indirect-max',
    type: 'MAX_PERCENT',
    target: 'indirect_costs',
    value: 7,
    message: 'Les frais indirects ne peuvent dépasser 7% des coûts directs',
    severity: 'error'
  },
  {
    id: 'eu-contingency-max',
    type: 'MAX_PERCENT',
    target: 'contingency',
    value: 5,
    message: 'La provision pour imprévus ne peut dépasser 5%',
    severity: 'warning'
  },
  {
    id: 'eu-coordinator-required',
    type: 'REQUIRED_LINE',
    target: 'personnel.coordinator',
    message: 'Un poste de coordinateur est requis',
    severity: 'error'
  }
];
```

### Templates Standards

| Bailleur | Nom | Catégories | Règles Clés |
|----------|-----|------------|-------------|
| UE | Budget Annexe III | Ressources humaines, Voyages, Équipement, Autres | Indirect max 7%, Contingency max 5% |
| AFD | Budget Convention | Personnel, Fonctionnement, Investissement, Suivi-éval | Indirect max 10% |
| USAID | SF-424A | Personnel, Fringe, Travel, Equipment, Supplies | F&A selon NICRA |
| ECHO | Single Form Budget | Staff, Travel, Assets, Supplies, Other | Indirect max 7% |

### Export Spécifique Bailleur

```ts
// Exemple export UE
class EuBudgetExporter implements BudgetExporter {
  export(budget: Budget): ExcelJS.Workbook {
    const workbook = new ExcelJS.Workbook();

    // Feuille principale selon format UE
    const sheet = workbook.addWorksheet('Budget');

    // En-têtes selon template UE
    sheet.columns = [
      { header: 'Budget Heading', key: 'heading', width: 40 },
      { header: 'Unit', key: 'unit', width: 15 },
      { header: 'No. of units', key: 'quantity', width: 12 },
      { header: 'Unit cost (EUR)', key: 'unitCost', width: 15 },
      { header: 'Total (EUR)', key: 'total', width: 15 },
    ];

    // Ajouter données...

    return workbook;
  }
}
```

## Testing

### Localisation

- `apps/api/tests/budget-templates.test.ts`
- `apps/api/src/modules/budgets/templates/__tests__/`

### Framework

- Jest + Supertest

### Cas à couvrir

| Test | Description |
|------|-------------|
| List by donor | Filtrage par bailleur |
| Create from template | Structure copiée |
| Required lines | Lignes obligatoires non supprimables |
| Rule MAX_PERCENT | Violation si > max |
| Rule REQUIRED | Violation si manquant |
| Export UE | Format Excel conforme |
| Export AFD | Format Excel conforme |
| Version update | Nouvelle version créée |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
