# Story 7.6: Standard Financial Reports

## Status: Approved

## Story

**As a** comptable,
**I want** générer des rapports financiers standards,
**so that** je puisse répondre aux exigences de reporting des bailleurs.

## Acceptance Criteria

1. Rapport d'exécution budgétaire (prévu vs réel par catégorie)
2. Rapport de trésorerie prévisionnelle (cashflow forecast)
3. État des dépenses détaillé par catégorie et période
4. Tableau de suivi des décaissements (versements reçus vs consommés)
5. Format configurable par bailleur (colonnes, mise en page)
6. Période de reporting paramétrable (mois, trimestre, custom)
7. Inclusion des justificatifs (liens vers pièces comptables)
8. Espace pour signature électronique
9. Export PDF et Excel
10. Planification génération automatique

## Tasks / Subtasks

- [ ] **Task 1: Schéma Report Templates** (AC: 1-4)
  - [ ] Créer model `FinancialReportTemplate` (type, donor, structure, format)
  - [ ] Types: EXECUTION, CASHFLOW, EXPENSE_DETAIL, DISBURSEMENT
  - [ ] Structure configurable par bailleur

- [ ] **Task 2: API Reports Generation** (AC: 1-4, 6)
  - [ ] `POST /api/budgets/:id/reports/generate`
  - [ ] Body: { type, periodStart, periodEnd, format }
  - [ ] `GET /api/budgets/:id/reports` - Liste rapports générés
  - [ ] `GET /api/budgets/:id/reports/:id/download`

- [ ] **Task 3: Rapport Exécution Budgétaire** (AC: 1)
  - [ ] Créer `execution-report.service.ts`
  - [ ] Colonnes: Ligne, Prévu, Réel, Écart, % Exécution
  - [ ] Groupement par catégorie
  - [ ] Totaux et sous-totaux
  - [ ] Commentaires sur écarts significatifs

- [ ] **Task 4: Rapport Trésorerie** (AC: 2)
  - [ ] Créer `cashflow-report.service.ts`
  - [ ] Prévisions encaissements (versements bailleur)
  - [ ] Prévisions décaissements (dépenses planifiées)
  - [ ] Solde prévisionnel par période
  - [ ] Alertes si solde négatif prévu

- [ ] **Task 5: État des Dépenses** (AC: 3)
  - [ ] Créer `expense-report.service.ts`
  - [ ] Liste détaillée des dépenses
  - [ ] Colonnes: Date, Description, Montant, Catégorie, Justificatif
  - [ ] Filtres par période et catégorie
  - [ ] Totaux par catégorie

- [ ] **Task 6: Suivi Décaissements** (AC: 4)
  - [ ] Créer model `Disbursement` (budgetId, amount, date, reference)
  - [ ] Rapport: versements reçus vs budget vs consommé
  - [ ] Calcul solde disponible
  - [ ] Prévision prochains versements

- [ ] **Task 7: Formats par Bailleur** (AC: 5)
  - [ ] Templates par bailleur (UE, AFD, etc.)
  - [ ] Colonnes et ordre configurables
  - [ ] Logo et en-tête personnalisés
  - [ ] Devise et langue

- [ ] **Task 8: Liens Justificatifs** (AC: 7)
  - [ ] Lien vers pièce comptable dans expense
  - [ ] Inclusion optionnelle dans rapport
  - [ ] QR code ou référence pour accès

- [ ] **Task 9: Signature Électronique** (AC: 8)
  - [ ] Zone signature en bas de rapport
  - [ ] Intégrer SignaturePad (Epic 9.3)
  - [ ] Métadonnées: signataire, date, poste
  - [ ] Validation signature

- [ ] **Task 10: Export PDF/Excel** (AC: 9)
  - [ ] Génération PDF via Puppeteer
  - [ ] Génération Excel via SheetJS
  - [ ] Mise en page professionnelle
  - [ ] Logos et en-têtes

- [ ] **Task 11: Planification Automatique** (AC: 10)
  - [ ] Créer model `ReportSchedule` (budgetId, type, frequency, recipients)
  - [ ] Job: mensuel, trimestriel
  - [ ] Envoi automatique par email
  - [ ] Archivage dans historique

- [ ] **Task 12: UI Génération Rapports** (AC: 1-10)
  - [ ] Créer `FinancialReportsPage.tsx`
  - [ ] Sélection type de rapport
  - [ ] Sélection période
  - [ ] Preview avant export
  - [ ] Liste historique rapports

- [ ] **Task 13: Tests** (AC: 1-10)
  - [ ] Tests génération chaque type
  - [ ] Tests formats bailleur
  - [ ] Tests export PDF/Excel
  - [ ] Tests planification

## Dev Notes

### Architecture

```text
apps/api/src/modules/budgets/
├── reports/
│   ├── reports.controller.ts
│   ├── reports.service.ts
│   ├── generators/
│   │   ├── execution-report.ts
│   │   ├── cashflow-report.ts
│   │   ├── expense-report.ts
│   │   └── disbursement-report.ts
│   ├── formatters/
│   │   ├── pdf-formatter.ts
│   │   └── excel-formatter.ts
│   ├── scheduler.service.ts
│   └── index.ts
└── index.ts

apps/web/src/pages/budgets/
├── FinancialReportsPage.tsx
├── ReportPreview.tsx
├── ReportScheduleConfig.tsx
├── ReportHistory.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum FinancialReportType {
  EXECUTION
  CASHFLOW
  EXPENSE_DETAIL
  DISBURSEMENT
  CUSTOM
}

model FinancialReport {
  id          String              @id @default(uuid())
  budgetId    String
  budget      Budget              @relation(fields: [budgetId], references: [id])
  type        FinancialReportType
  periodStart DateTime
  periodEnd   DateTime
  data        Json                // Données du rapport
  pdfUrl      String?
  excelUrl    String?

  signedAt    DateTime?
  signedById  String?
  signatureData String?

  generatedById String
  generatedBy User                @relation(fields: [generatedById], references: [id])
  generatedAt DateTime            @default(now())

  @@index([budgetId, type])
}

model Disbursement {
  id          String   @id @default(uuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id])
  amount      Decimal  @db.Decimal(15, 2)
  date        DateTime
  reference   String?  // Numéro virement
  description String?
  sourceId    String?  // FundingSource si lié
  createdAt   DateTime @default(now())

  @@index([budgetId, date])
}

model ReportSchedule {
  id          String   @id @default(uuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id])
  type        FinancialReportType
  frequency   String   // MONTHLY, QUARTERLY
  dayOfPeriod Int?     // Jour du mois/trimestre
  recipients  String[] // Emails
  isActive    Boolean  @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  createdAt   DateTime @default(now())

  @@index([isActive, nextRunAt])
}
```

### Structure Rapport Exécution

```ts
interface ExecutionReportData {
  header: {
    projectName: string;
    budgetName: string;
    period: { start: Date; end: Date };
    currency: string;
    generatedAt: Date;
  };
  categories: {
    code: string;
    name: string;
    lines: {
      code: string;
      description: string;
      planned: number;
      actual: number;
      variance: number;
      executionRate: number;
      comment?: string;
    }[];
    subtotal: {
      planned: number;
      actual: number;
      variance: number;
      executionRate: number;
    };
  }[];
  totals: {
    planned: number;
    actual: number;
    variance: number;
    executionRate: number;
  };
  notes: string[];
  signature?: {
    name: string;
    title: string;
    date: Date;
    image?: string;
  };
}
```

### Template PDF

```text
┌─────────────────────────────────────────────────────────────┐
│ [LOGO]                   RAPPORT D'EXÉCUTION BUDGÉTAIRE     │
│                                                             │
│ Projet: Santé Sahel                                        │
│ Période: 01/01/2025 - 31/03/2025 (T1)                      │
│ Budget: Budget Principal v2                                 │
├─────────────────────────────────────────────────────────────┤
│ Cat. │ Libellé        │ Prévu    │ Réel     │ Écart  │ %   │
├──────┼────────────────┼──────────┼──────────┼────────┼─────┤
│ A    │ PERSONNEL      │          │          │        │     │
│ A.1  │ Coordinateur   │  15,000  │  15,000  │     0  │100% │
│ A.2  │ Technicien     │  12,000  │  11,500  │   500  │ 96% │
│      │ Sous-total A   │  27,000  │  26,500  │   500  │ 98% │
├──────┼────────────────┼──────────┼──────────┼────────┼─────┤
│ B    │ ÉQUIPEMENT     │          │          │        │     │
│ ...  │ ...            │ ...      │ ...      │ ...    │ ... │
├──────┼────────────────┼──────────┼──────────┼────────┼─────┤
│      │ TOTAL GÉNÉRAL  │ 125,000  │ 110,000  │ 15,000 │ 88% │
├─────────────────────────────────────────────────────────────┤
│ Notes:                                                      │
│ - Économie sur équipement due à négociation fournisseur    │
├─────────────────────────────────────────────────────────────┤
│ Certifié conforme,                                         │
│                                                             │
│ [Signature]                                                │
│ Jean Dupont, Directeur Financier                           │
│ Le 15/04/2025                                              │
└─────────────────────────────────────────────────────────────┘
```

## Testing

### Localisation

- `apps/api/tests/financial-reports.test.ts`
- `apps/api/src/modules/budgets/reports/__tests__/`

### Framework

- Jest + Supertest

### Cas à couvrir

| Test | Description |
|------|-------------|
| Execution report | Données correctes |
| Cashflow report | Prévisions calculées |
| Expense report | Liste complète |
| Disbursement | Versements trackés |
| PDF export | PDF généré valide |
| Excel export | Excel avec formules |
| Signature | Signature intégrée |
| Schedule | Job exécuté selon planning |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
