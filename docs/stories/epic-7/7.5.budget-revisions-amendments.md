# Story 7.5: Budget Revisions & Amendments

## Status: Approved

## Story

**As a** directeur de projet,
**I want** gérer les révisions budgétaires et avenants,
**so that** je puisse adapter le budget aux réalités du terrain tout en gardant l'historique.

## Acceptance Criteria

1. Création de révision depuis budget existant (copie de travail)
2. Comparaison visuelle version initiale vs révision
3. Justification obligatoire des modifications significatives
4. Workflow d'approbation interne avant soumission bailleur
5. Historique complet des versions avec timestamps
6. Calcul automatique de l'impact des modifications
7. Génération automatique de document d'avenant
8. Notification des parties prenantes à chaque étape
9. Gel de la version approuvée (non modifiable)
10. Audit trail complet de toutes les modifications

## Tasks / Subtasks

- [ ] **Task 1: Schéma Versioning Budget** (AC: 1, 5, 9)
  - [ ] Créer model `BudgetVersion` (budgetId, version, data, status, createdAt)
  - [ ] Ajouter champ currentVersion sur Budget
  - [ ] Status: DRAFT, PENDING_APPROVAL, APPROVED, SUPERSEDED
  - [ ] Contrainte: version approuvée non modifiable

- [ ] **Task 2: API Révisions** (AC: 1, 5)
  - [ ] `POST /api/budgets/:id/revisions` - Créer révision
  - [ ] `GET /api/budgets/:id/revisions` - Liste versions
  - [ ] `GET /api/budgets/:id/revisions/:version` - Détail version
  - [ ] `PATCH /api/budgets/:id/revisions/:version` - Modifier draft

- [ ] **Task 3: Comparaison Versions** (AC: 2, 6)
  - [ ] `GET /api/budgets/:id/revisions/compare?v1=1&v2=2`
  - [ ] Calculer diff par ligne: ajouté, modifié, supprimé
  - [ ] Calculer impact total
  - [ ] Générer rapport de changements

- [ ] **Task 4: Justifications** (AC: 3)
  - [ ] Ajouter champ `changeJustification` sur BudgetLine
  - [ ] Obligatoire si modification > 10% ou nouvelle ligne
  - [ ] Historique justifications par ligne
  - [ ] Export inclut justifications

- [ ] **Task 5: Workflow Approbation** (AC: 4, 8)
  - [ ] `POST /api/budgets/:id/revisions/:version/submit` - Soumettre
  - [ ] `POST /api/budgets/:id/revisions/:version/approve` - Approuver
  - [ ] `POST /api/budgets/:id/revisions/:version/reject` - Rejeter
  - [ ] Notifications à chaque changement statut
  - [ ] Commentaires sur approbation/rejet

- [ ] **Task 6: Génération Avenant** (AC: 7)
  - [ ] Template document avenant
  - [ ] Inclure: résumé changements, justifications, signatures
  - [ ] Export PDF
  - [ ] `GET /api/budgets/:id/revisions/:version/amendment`

- [ ] **Task 7: Gel Version** (AC: 9)
  - [ ] Version APPROVED devient readonly
  - [ ] Empêcher modification via API
  - [ ] UI indique clairement statut verrouillé
  - [ ] Seule action: créer nouvelle révision

- [ ] **Task 8: Audit Trail** (AC: 10)
  - [ ] Créer model `BudgetAuditLog` (budgetId, versionId, action, userId, details, createdAt)
  - [ ] Logger: CREATE, UPDATE, SUBMIT, APPROVE, REJECT
  - [ ] Détail des champs modifiés
  - [ ] `GET /api/budgets/:id/audit-log`

- [ ] **Task 9: UI Liste Versions** (AC: 5)
  - [ ] Créer `BudgetVersionsPage.tsx`
  - [ ] Timeline des versions
  - [ ] Badge statut par version
  - [ ] Accès rapide à chaque version

- [ ] **Task 10: UI Comparaison** (AC: 2, 6)
  - [ ] Créer `BudgetCompareView.tsx`
  - [ ] Vue côte à côte ou diff
  - [ ] Highlight des changements (vert=ajout, rouge=suppression, jaune=modif)
  - [ ] Résumé impact en haut

- [ ] **Task 11: UI Workflow** (AC: 4)
  - [ ] Panneau workflow avec étapes
  - [ ] Boutons actions selon rôle et statut
  - [ ] Modal approbation/rejet avec commentaire
  - [ ] Timeline approbations

- [ ] **Task 12: Tests** (AC: 1-10)
  - [ ] Tests création révision
  - [ ] Tests comparaison diff
  - [ ] Tests workflow complet
  - [ ] Tests gel version

## Dev Notes

### Architecture

```text
apps/api/src/modules/budgets/
├── revisions/
│   ├── revisions.controller.ts
│   ├── revisions.service.ts
│   ├── compare.service.ts
│   ├── workflow.service.ts
│   ├── amendment.service.ts
│   ├── audit.service.ts
│   └── index.ts
└── index.ts

apps/web/src/pages/budgets/
├── BudgetVersionsPage.tsx
├── BudgetCompareView.tsx
├── RevisionWorkflow.tsx
├── AmendmentPreview.tsx
├── AuditLogPanel.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum BudgetVersionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SUPERSEDED
}

model BudgetVersion {
  id          String              @id @default(uuid())
  budgetId    String
  budget      Budget              @relation(fields: [budgetId], references: [id])
  version     Int
  status      BudgetVersionStatus @default(DRAFT)

  data        Json                // Copie complète structure budget
  changelog   String?             // Résumé des changements

  submittedAt   DateTime?
  submittedById String?
  approvedAt    DateTime?
  approvedById  String?
  approvalComment String?

  createdById String
  createdBy   User                @relation(fields: [createdById], references: [id])
  createdAt   DateTime            @default(now())

  auditLogs   BudgetAuditLog[]

  @@unique([budgetId, version])
  @@index([budgetId, status])
}

model BudgetAuditLog {
  id          String         @id @default(uuid())
  budgetId    String
  budget      Budget         @relation(fields: [budgetId], references: [id])
  versionId   String?
  version     BudgetVersion? @relation(fields: [versionId], references: [id])

  action      String         // CREATE, UPDATE_LINE, SUBMIT, APPROVE, REJECT
  userId      String
  user        User           @relation(fields: [userId], references: [id])
  details     Json?          // { field, oldValue, newValue, lineId, ... }
  createdAt   DateTime       @default(now())

  @@index([budgetId, createdAt])
}
```

### Compare Diff Structure

```ts
interface BudgetDiff {
  summary: {
    linesAdded: number;
    linesModified: number;
    linesRemoved: number;
    totalImpact: number;
    percentChange: number;
  };
  changes: BudgetLineChange[];
}

interface BudgetLineChange {
  lineId: string;
  lineCode: string;
  description: string;
  changeType: 'added' | 'modified' | 'removed';
  before?: {
    unitCost: number;
    quantity: number;
    total: number;
  };
  after?: {
    unitCost: number;
    quantity: number;
    total: number;
  };
  impact: number;
  justification?: string;
}
```

### Template Avenant

```ts
interface AmendmentDocument {
  title: string;
  budgetName: string;
  projectName: string;
  versionFrom: number;
  versionTo: number;
  date: Date;

  summary: string;
  totalBefore: number;
  totalAfter: number;
  netChange: number;

  changes: {
    category: string;
    items: {
      description: string;
      before: number;
      after: number;
      change: number;
      justification: string;
    }[];
  }[];

  approvals: {
    role: string;
    name: string;
    date: Date;
    signature?: string;
  }[];
}
```

### Workflow States

```text
DRAFT ─────► PENDING_APPROVAL ─────► APPROVED
   ▲              │                      │
   │              │ reject               │ nouvelle révision
   │              ▼                      ▼
   └──────── DRAFT                 SUPERSEDED
            (commentaires)

Note: APPROVED ne peut être modifié, seulement superseded par nouvelle version
```

## Testing

### Localisation

- `apps/api/tests/budget-revisions.test.ts`
- `apps/web/src/pages/budgets/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create revision | Copie créée avec version+1 |
| Compare diff | Changements détectés |
| Impact calc | Impact total correct |
| Justification required | Obligatoire si > 10% |
| Submit | Passe à PENDING_APPROVAL |
| Approve | Passe à APPROVED |
| Reject | Retour à DRAFT |
| Freeze approved | Modification bloquée |
| Audit log | Actions loggées |
| Amendment PDF | Document généré |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
