# Story 7.4: Real-time Budget Tracking

## Status: Approved

## Story

**As a** responsable financier,
**I want** suivre la consommation budgÃ©taire en temps rÃ©el,
**so that** je puisse anticiper les dÃ©passements et ajuster si nÃ©cessaire.

## Acceptance Criteria

1. Dashboard suivi budget avec KPIs principaux (consommÃ©, engagÃ©, disponible)
2. Comparaison PrÃ©vu vs RÃ©el vs EngagÃ© par ligne et catÃ©gorie
3. Calcul automatique des Ã©carts (montant absolu et pourcentage)
4. Projection de consommation fin de projet (burn rate)
5. Alertes seuils configurables (80%, 90%, 100%, dÃ©passement)
6. Suivi granulaire par catÃ©gorie, par ligne, par pÃ©riode
7. Courbe de consommation dans le temps (historique)
8. IntÃ©gration avec saisie des dÃ©penses (lien avec expenses)
9. Rapports pÃ©riodiques automatiques (email digest)
10. Export suivi pour reporting bailleur

## Tasks / Subtasks

- [ ] **Task 1: Lien Budget-Expenses** (AC: 8)
  - [ ] Ajouter champ budgetLineId sur Expense (Epic 10.2)
  - [ ] Permettre allocation expense Ã  ligne budget
  - [ ] Calcul automatique consumed par ligne
  - [ ] Mise Ã  jour temps rÃ©el

- [ ] **Task 2: Calculs Suivi** (AC: 2, 3, 4)
  - [ ] CrÃ©er service `budget-tracking.service.ts`
  - [ ] Calcul: consumed = sum(expenses) pour la ligne
  - [ ] Calcul: committed = engagements non encore payÃ©s
  - [ ] Calcul: available = planned - consumed - committed
  - [ ] Calcul: variance = planned - consumed (%)
  - [ ] Calcul: burn rate = consumed / elapsed time
  - [ ] Projection: estimated at completion = burn rate * total duration

- [ ] **Task 3: API Tracking Data** (AC: 1, 2, 6)
  - [ ] `GET /api/budgets/:id/tracking` - Vue d'ensemble
  - [ ] `GET /api/budgets/:id/tracking/by-category` - Par catÃ©gorie
  - [ ] `GET /api/budgets/:id/tracking/by-period` - Par pÃ©riode
  - [ ] `GET /api/budgets/:id/tracking/history` - Ã‰volution temps

- [ ] **Task 4: SystÃ¨me Alertes** (AC: 5)
  - [ ] CrÃ©er model `BudgetAlert` (budgetId, lineId?, type, threshold, isTriggered)
  - [ ] Types: THRESHOLD_80, THRESHOLD_90, THRESHOLD_100, OVERSPENT
  - [ ] Check aprÃ¨s chaque expense
  - [ ] Notifications in-app et email
  - [ ] Configuration seuils custom

- [ ] **Task 5: Historique Consommation** (AC: 7)
  - [ ] CrÃ©er model `BudgetSnapshot` (budgetId, date, data)
  - [ ] Job quotidien pour snapshot
  - [ ] Stocker totaux par catÃ©gorie
  - [ ] API pour rÃ©cupÃ©rer historique

- [ ] **Task 6: Rapports PÃ©riodiques** (AC: 9)
  - [ ] Job hebdomadaire/mensuel
  - [ ] GÃ©nÃ©rer digest: top variances, alertes, projections
  - [ ] Envoyer par email aux stakeholders
  - [ ] Configuration frÃ©quence par budget

- [ ] **Task 7: Export Reporting** (AC: 10)
  - [ ] `GET /api/budgets/:id/tracking/export`
  - [ ] Format Excel avec:
    - RÃ©sumÃ© exÃ©cution
    - DÃ©tail par catÃ©gorie
    - Ã‰carts et explications
    - Graphiques
  - [ ] Format conforme aux attentes bailleurs

- [ ] **Task 8: UI Dashboard Tracking** (AC: 1, 2, 3)
  - [ ] CrÃ©er `BudgetTrackingDashboard.tsx`
  - [ ] KPIs cards: PrÃ©vu, ConsommÃ©, Disponible, %
  - [ ] Progress bars par catÃ©gorie
  - [ ] Indicateurs couleur (vert/jaune/rouge)

- [ ] **Task 9: UI Tableau Comparatif** (AC: 2, 6)
  - [ ] CrÃ©er `BudgetComparisonTable.tsx`
  - [ ] Colonnes: Ligne, PrÃ©vu, RÃ©el, EngagÃ©, Ã‰cart, %
  - [ ] Groupement par catÃ©gorie
  - [ ] Filtres par pÃ©riode
  - [ ] Tri par Ã©cart

- [ ] **Task 10: UI Projections** (AC: 4)
  - [ ] CrÃ©er `BudgetProjectionsWidget.tsx`
  - [ ] Burn rate actuel vs prÃ©vu
  - [ ] Projection fin de projet
  - [ ] ScÃ©narios what-if

- [ ] **Task 11: UI Graphiques** (AC: 7)
  - [ ] Courbe consommation vs temps
  - [ ] PrÃ©vu vs RÃ©el cumulÃ©
  - [ ] Barres Ã©carts par catÃ©gorie
  - [ ] Trend line projection

- [ ] **Task 12: Tests** (AC: 1-10)
  - [ ] Tests calculs tracking
  - [ ] Tests alertes
  - [ ] Tests projections
  - [ ] Tests export

## Dev Notes

### Architecture

```text
apps/api/src/modules/budgets/
â”œâ”€â”€ tracking/
â”‚   â”œâ”€â”€ tracking.controller.ts
â”‚   â”œâ”€â”€ tracking.service.ts
â”‚   â”œâ”€â”€ calculations.service.ts
â”‚   â”œâ”€â”€ alerts.service.ts
â”‚   â”œâ”€â”€ projections.service.ts
â”‚   â”œâ”€â”€ snapshots.service.ts
â”‚   â”œâ”€â”€ reports.service.ts
â”‚   â””â”€â”€ index.ts
â””â”€â”€ index.ts

apps/web/src/pages/budgets/
â”œâ”€â”€ BudgetTrackingDashboard.tsx
â”œâ”€â”€ BudgetComparisonTable.tsx
â”œâ”€â”€ BudgetProjectionsWidget.tsx
â”œâ”€â”€ BudgetTrendChart.tsx
â”œâ”€â”€ AlertsPanel.tsx
â””â”€â”€ index.ts
```

### SchÃ©ma Prisma Ã‰tendu

```prisma
model BudgetLine {
  // ... champs existants

  // Tracking calculÃ© (peut Ãªtre stockÃ© pour perf)
  consumed    Decimal?  @db.Decimal(15, 2)
  committed   Decimal?  @db.Decimal(15, 2)
  available   Decimal?  @db.Decimal(15, 2)

  expenses    Expense[]
}

model BudgetAlert {
  id          String   @id @default(uuid())
  budgetId    String
  budget      Budget   @relation(fields: [budgetId], references: [id])
  lineId      String?  // null = budget global
  type        String   // THRESHOLD_80, THRESHOLD_90, THRESHOLD_100, OVERSPENT
  threshold   Int?     // Pourcentage custom
  isActive    Boolean  @default(true)
  isTriggered Boolean  @default(false)
  triggeredAt DateTime?
  notifiedAt  DateTime?

  @@index([budgetId, isActive])
}

model BudgetSnapshot {
  id        String   @id @default(uuid())
  budgetId  String
  budget    Budget   @relation(fields: [budgetId], references: [id])
  date      DateTime @default(now())
  data      Json     // { totalPlanned, totalConsumed, byCategory: [...] }

  @@index([budgetId, date])
}
```

### Calculs Tracking

```ts
interface BudgetTrackingData {
  planned: number;
  consumed: number;
  committed: number;
  available: number;
  varianceAmount: number;
  variancePercent: number;
  burnRate: {
    actual: number;      // EUR/mois consommÃ©
    planned: number;     // EUR/mois prÃ©vu
    ratio: number;       // actual/planned
  };
  projection: {
    estimatedAtCompletion: number;
    varianceAtCompletion: number;
    status: 'on_track' | 'at_risk' | 'over_budget';
  };
}

function calculateTracking(budget: Budget, expenses: Expense[]): BudgetTrackingData {
  const consumed = sumExpenses(expenses);
  const elapsedMonths = monthsBetween(budget.startDate, new Date());
  const totalMonths = monthsBetween(budget.startDate, budget.endDate);

  const burnRate = consumed / elapsedMonths;
  const plannedBurnRate = budget.totalPlanned / totalMonths;

  const estimatedAtCompletion = burnRate * totalMonths;

  return {
    planned: budget.totalPlanned,
    consumed,
    committed: sumCommitments(budget),
    available: budget.totalPlanned - consumed - committed,
    varianceAmount: budget.totalPlanned - consumed,
    variancePercent: ((budget.totalPlanned - consumed) / budget.totalPlanned) * 100,
    burnRate: {
      actual: burnRate,
      planned: plannedBurnRate,
      ratio: burnRate / plannedBurnRate,
    },
    projection: {
      estimatedAtCompletion,
      varianceAtCompletion: budget.totalPlanned - estimatedAtCompletion,
      status: getProjectionStatus(estimatedAtCompletion, budget.totalPlanned),
    },
  };
}
```

### UI Dashboard Layout

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Suivi BudgÃ©taire - Projet SantÃ© Sahel                               â”‚
â”‚ PÃ©riode: Jan 2025 - DÃ©c 2026  |  Mois 6/24  |  [Exporter]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚   PrÃ©vu     â”‚ â”‚  ConsommÃ©   â”‚ â”‚   EngagÃ©    â”‚ â”‚ Disponible  â”‚    â”‚
â”‚ â”‚  500,000 â‚¬  â”‚ â”‚  180,000 â‚¬  â”‚ â”‚   45,000 â‚¬  â”‚ â”‚  275,000 â‚¬  â”‚    â”‚
â”‚ â”‚             â”‚ â”‚    36%      â”‚ â”‚     9%      â”‚ â”‚    55%      â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Par catÃ©gorie                              â”‚ Projection            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ Personnel    [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 75%   âš ï¸        â”‚ EAC: 520,000 â‚¬        â”‚
â”‚ Ã‰quipement   [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 55%   âœ“         â”‚ Variance: -20,000 â‚¬   â”‚
â”‚ ActivitÃ©s    [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 35%   âœ“         â”‚ Status: âš ï¸ Ã€ risque   â”‚
â”‚ Fonctionne.  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘] 90%   ğŸ”´        â”‚                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Ã‰volution consommation                                              â”‚
â”‚ [Graphique courbe: PrÃ©vu vs RÃ©el vs Projection]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing

### Localisation

- `apps/api/tests/budget-tracking.test.ts`
- `apps/api/src/modules/budgets/tracking/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas Ã  couvrir

| Test | Description |
|------|-------------|
| Calculate consumed | Somme expenses correct |
| Calculate variance | Ã‰cart calculÃ© |
| Calculate burn rate | Taux consommation |
| Projection | Estimation fin projet |
| Alert 80% | Alerte dÃ©clenchÃ©e |
| Alert overspent | Alerte dÃ©passement |
| Snapshot | Snapshot quotidien crÃ©Ã© |
| Export | Excel avec donnÃ©es tracking |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | CrÃ©ation initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
