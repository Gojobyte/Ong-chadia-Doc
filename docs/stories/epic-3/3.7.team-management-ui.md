# Story 3.7: Team Management UI

## Status: Complete

## Story

**As a** Staff ou Super-Admin,
**I want** gÃ©rer l'Ã©quipe d'un projet via une interface graphique intuitive,
**so that** je puisse ajouter, modifier les rÃ´les ou retirer des membres facilement, comme dans les outils professionnels de gestion de projet.

## Acceptance Criteria

1. Panneau/Modal "GÃ©rer l'Ã©quipe" accessible depuis la page projet (bouton ou section Ã©quipe)
2. Liste des membres actuels affichant: Avatar, Nom complet, Email, RÃ´le projet (badge), Date d'assignation
3. Bouton "Ajouter membre" ouvrant un sÃ©lecteur/recherche d'utilisateurs
4. SÃ©lecteur d'utilisateurs filtrable par nom/email, excluant les membres dÃ©jÃ  assignÃ©s
5. Choix du rÃ´le projet lors de l'ajout: PROJECT_MANAGER, MEMBER, VOLUNTEER (dropdown)
6. Action "Modifier rÃ´le" sur chaque membre (dropdown inline ou modal)
7. Action "Retirer" sur chaque membre avec modal de confirmation
8. Validation UI: impossible de retirer/changer rÃ´le du dernier PROJECT_MANAGER (bouton disabled + tooltip)
9. Mise Ã  jour en temps rÃ©el de la liste aprÃ¨s chaque modification (optimistic update)
10. Indicateur du nombre total de membres dans le header du panneau
11. Feedback visuel: loading states, success toasts, error messages
12. Responsive: modal fullscreen sur mobile

## Tasks / Subtasks

- [x] **Task 1: Service membres frontend** (AC: 2-7)
  - [x] DÃ©jÃ  dans `projects.service.ts`:
    - `getMembers(projectId)`
    - `addMember(projectId, data)`
    - `updateMemberRole(projectId, memberId, data)`
    - `removeMember(projectId, memberId)`
  - [x] Filtrage users non assignÃ©s cÃ´tÃ© client

- [x] **Task 2: Hook useProjectMembers** (AC: 2, 9, 11)
  - [x] DÃ©jÃ  dans `apps/web/src/hooks/useProjects.ts`
  - [x] Query: `useProjectMembers`
  - [x] Mutations: `useAddProjectMember`, `useUpdateProjectMemberRole`, `useRemoveProjectMember`
  - [x] Invalidation cache aprÃ¨s mutations
  - [x] Toast notifications

- [x] **Task 3: Composant TeamManagementModal** (AC: 1, 10, 12)
  - [x] CrÃ©Ã© `apps/web/src/components/projects/TeamManagementModal.tsx`
  - [x] Modal responsive (fullscreen mobile)
  - [x] Header avec titre + count membres
  - [x] Props: projectId, isOpen, onClose

- [x] **Task 4 & 5: Composant MemberItem** (AC: 2, 6, 7, 8)
  - [x] CrÃ©Ã© `apps/web/src/components/projects/MemberItem.tsx`
  - [x] Layout: avatar | nom+email | role dropdown | remove btn
  - [x] Dropdown rÃ´le inline avec badges colorÃ©s
  - [x] Bouton retirer avec modal confirmation
  - [x] Protection dernier PM (boutons disabled + tooltip)

- [x] **Task 6: Composant AddMemberDialog** (AC: 3, 4, 5)
  - [x] CrÃ©Ã© `apps/web/src/components/projects/AddMemberDialog.tsx`
  - [x] Search input avec debounce (useDebounce)
  - [x] Liste utilisateurs disponibles (non assignÃ©s)
  - [x] SÃ©lection utilisateur avec indicateur visuel
  - [x] Dropdown choix rÃ´le (PROJECT_MANAGER, MEMBER, VOLUNTEER)
  - [x] Bouton "Ajouter" avec loading state

- [x] **Task 7 & 8: Recherche utilisateurs** (AC: 4)
  - [x] RÃ©utilise hook `useUsers` existant
  - [x] Filtrage cÃ´tÃ© client avec debounce
  - [x] Exclut membres dÃ©jÃ  assignÃ©s

- [x] **Task 9: Validation dernier PM** (AC: 8)
  - [x] Fonction `isLastProjectManager(memberId)` dans TeamManagementModal
  - [x] Disable bouton remove si dernier PM
  - [x] Disable options changement rÃ´le PMâ†’autre si dernier

- [x] **Task 10: IntÃ©gration page projet** (AC: 1)
  - [x] Bouton "GÃ©rer" dans ProjectTeam (dÃ©jÃ  prÃ©sent)
  - [x] State `teamModalOpen` dans ProjectDetailPage
  - [x] TeamManagementModal intÃ©grÃ© avec onClose

- [ ] **Task 11: Tests** (Deferred)
  - [ ] Tests Ã  ajouter ultÃ©rieurement

## Dev Notes

### Architecture

```text
apps/web/src/components/projects/
â”œâ”€â”€ TeamManagementModal.tsx     # NEW
â”œâ”€â”€ MembersList.tsx             # NEW
â”œâ”€â”€ MemberItem.tsx              # NEW
â”œâ”€â”€ AddMemberDialog.tsx         # NEW
â”œâ”€â”€ UserSearchCombobox.tsx      # NEW
â”œâ”€â”€ ProjectTeam.tsx             # MODIFY (add button)
â””â”€â”€ index.ts
```

### UI Layout - Modal

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GÃ©rer l'Ã©quipe (5 membres)        [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [+ Ajouter un membre]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ‘¤ Alice Martin                     â”‚ â”‚
â”‚ â”‚    alice@ong.org                    â”‚ â”‚
â”‚ â”‚    [PROJECT_MANAGER â–¼]    [ğŸ—‘ï¸]     â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ ğŸ‘¤ Bob Dupont                       â”‚ â”‚
â”‚ â”‚    bob@ong.org                      â”‚ â”‚
â”‚ â”‚    [MEMBER â–¼]             [ğŸ—‘ï¸]     â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ ğŸ‘¤ Claire Volunteer                 â”‚ â”‚
â”‚ â”‚    claire@email.com                 â”‚ â”‚
â”‚ â”‚    [VOLUNTEER â–¼]          [ğŸ—‘ï¸]     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Add Member Dialog

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ajouter un membre                  [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rechercher un utilisateur               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ” Tapez un nom ou email...        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ‘¤ David Nouveau (Staff)            â”‚ â”‚
â”‚ â”‚ ğŸ‘¤ Emma Benevole (Contributor)      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ RÃ´le dans le projet                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ MEMBER                          â–¼   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚              [Annuler]  [Ajouter]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Role Badge Colors

```typescript
const roleColors: Record<ProjectRole, string> = {
  PROJECT_MANAGER: 'bg-amber-100 text-amber-800',
  MEMBER: 'bg-blue-100 text-blue-800',
  VOLUNTEER: 'bg-green-100 text-green-800',
};

const roleLabels: Record<ProjectRole, string> = {
  PROJECT_MANAGER: 'Chef de projet',
  MEMBER: 'Membre',
  VOLUNTEER: 'BÃ©nÃ©vole',
};
```

### Optimistic Update Pattern

```typescript
const removeMember = useMutation({
  mutationFn: (memberId: string) =>
    projectsService.removeProjectMember(projectId, memberId),
  onMutate: async (memberId) => {
    await queryClient.cancelQueries(['project-members', projectId]);
    const previous = queryClient.getQueryData(['project-members', projectId]);

    queryClient.setQueryData(['project-members', projectId], (old: Member[]) =>
      old.filter(m => m.id !== memberId)
    );

    return { previous };
  },
  onError: (err, memberId, context) => {
    queryClient.setQueryData(['project-members', projectId], context?.previous);
    toast.error('Erreur lors de la suppression');
  },
  onSuccess: () => {
    toast.success('Membre retirÃ© du projet');
  },
});
```

### Last PM Protection

```typescript
const isLastProjectManager = (members: Member[], memberId: string): boolean => {
  const member = members.find(m => m.id === memberId);
  if (member?.role !== 'PROJECT_MANAGER') return false;

  const pmCount = members.filter(m => m.role === 'PROJECT_MANAGER').length;
  return pmCount === 1;
};
```

## Testing

### Localisation

- `apps/web/tests/TeamManagementModal.test.tsx`

### Cas de test

| Test | Description |
|------|-------------|
| Render modal | Affiche liste membres |
| Add member | Recherche, sÃ©lection, rÃ´le, ajout |
| Change role | Dropdown, changement, update |
| Remove member | Click, confirmation, suppression |
| Last PM protection | Bouton disabled, tooltip affichÃ© |
| Search users | Debounce, rÃ©sultats filtrÃ©s |
| Optimistic update | UI mise Ã  jour immÃ©diatement |
| Error handling | Rollback + toast erreur |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | CrÃ©ation initiale | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript: `pnpm tsc --noEmit` - Pass

### Completion Notes List
- TeamManagementModal avec header affichant nombre de membres
- MemberItem avec dropdown rÃ´le inline et confirmation suppression
- AddMemberDialog avec recherche debounce et sÃ©lection utilisateur
- Protection dernier PROJECT_MANAGER (boutons disabled + tooltip)
- IntÃ©gration complÃ¨te dans ProjectDetailPage
- Hooks membres dÃ©jÃ  prÃ©sents dans useProjects.ts
- Toast notifications via mutations
- Responsive: modal fullscreen sur mobile

### File List
- `apps/web/src/components/projects/TeamManagementModal.tsx` - NEW
- `apps/web/src/components/projects/MemberItem.tsx` - NEW
- `apps/web/src/components/projects/AddMemberDialog.tsx` - NEW
- `apps/web/src/components/projects/index.ts` - Updated (exports)
- `apps/web/src/pages/ProjectDetailPage.tsx` - Updated (modal integration)

---

## QA Results

### PO Review - 2025-01-28

**Reviewer:** Sarah (PO)

**Acceptance Criteria Verification:**

| AC | Description | Status | Notes |
|----|-------------|--------|-------|
| 1 | Modal "GÃ©rer l'Ã©quipe" accessible | âœ… PASS | Bouton dans ProjectTeam ouvre TeamManagementModal |
| 2 | Liste membres avec avatar, nom, email, rÃ´le | âœ… PASS | MemberItem affiche toutes infos |
| 3 | Bouton "Ajouter membre" | âœ… PASS | Ouvre AddMemberDialog |
| 4 | SÃ©lecteur utilisateurs filtrable | âœ… PASS | Recherche debounce, exclut membres assignÃ©s |
| 5 | Choix rÃ´le lors ajout | âœ… PASS | Dropdown avec 3 options |
| 6 | Action "Modifier rÃ´le" inline | âœ… PASS | Dropdown inline dans MemberItem |
| 7 | Action "Retirer" avec confirmation | âœ… PASS | Modal confirmation avant suppression |
| 8 | Protection dernier PM | âœ… PASS | Boutons disabled + tooltip explicatif |
| 9 | Mise Ã  jour temps rÃ©el | âœ… PASS | Invalidation cache via React Query |
| 10 | Indicateur nombre membres | âœ… PASS | Header modal affiche count |
| 11 | Feedback visuel | âœ… PASS | Loading states, toasts success/error |
| 12 | Responsive mobile | âœ… PASS | Modal fullscreen sur mobile |

**Score:** 12/12 AC satisfaits

**Note:** Tests unitaires (Task 11) diffÃ©rÃ©s - Ã  ajouter dans une story technique.

**Decision:** âœ… **APPROVED** - Story marquÃ©e Complete
