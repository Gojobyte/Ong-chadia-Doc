# Story 3.3: Project-Document Linking API

## Status: Complete

## Story

**As a** membre d'un projet,
**I want** lier des documents de la GED au projet,
**so that** tous les documents pertinents (rapports, contrats, budgets) soient accessibles directement depuis la fiche projet, facilitant la collaboration et l'audit.

## Acceptance Criteria

1. Schéma Prisma `ProjectDocument` avec: id (UUID), projectId (FK), documentId (FK), linkedById (FK), linkedAt
2. `GET /api/projects/:id/documents` - Liste des documents liés avec métadonnées document
3. `POST /api/projects/:id/documents` - Lier un document existant au projet
4. `POST /api/projects/:id/documents/folder/:folderId` - Lier tous les documents d'un dossier
5. `DELETE /api/projects/:id/documents/:docId` - Délier un document du projet
6. Validation: L'utilisateur doit avoir accès READ au document pour le lier
7. Les membres du projet obtiennent automatiquement accès READ aux documents liés
8. Un document peut être lié à plusieurs projets simultanément
9. Compteur `documentsCount` retourné sur GET /api/projects/:id
10. Tests d'intégration complets

## Tasks / Subtasks

- [x] **Task 1: Schéma Prisma ProjectDocument** (AC: 1, 8)
  - [x] Créer model `ProjectDocument`
  - [x] Relations: Project, Document, User (linkedBy)
  - [x] Contrainte unique `@@unique([projectId, documentId])`
  - [x] Index sur projectId et documentId
  - [x] Exécuter migration

- [x] **Task 2: Types partagés** (AC: 1-5)
  - [x] Créer types dans `packages/shared/src/types/project.types.ts`
  - [x] Interfaces: `ProjectDocument`, `LinkDocumentDto`, `LinkFolderDto`
  - [x] Exporter depuis index

- [x] **Task 3: Service ProjectDocuments** (AC: 2-8)
  - [x] Créer `apps/api/src/modules/projects/project-documents.service.ts`
  - [x] `getLinkedDocuments(projectId)` - Liste avec include Document
  - [x] `linkDocument(projectId, documentId, userId)` - Lier un doc
  - [x] `linkFolder(projectId, folderId, userId)` - Lier tous docs d'un dossier
  - [x] `unlinkDocument(projectId, documentId)` - Délier

- [x] **Task 4: Vérification accès document** (AC: 6)
  - [x] Avant liaison, vérifier `canAccessFolder(userId, folderId, READ)`
  - [x] Utiliser le service permissions existant de la GED
  - [x] Retourner 403 si pas d'accès

- [x] **Task 5: Accès automatique membres projet** (AC: 7)
  - [x] Option A: Vérification dynamique (si membre projet → accès READ docs liés)
  - [x] Créer fonction helper `canAccessDocumentViaProject()`

- [x] **Task 6: Liaison dossier complet** (AC: 4)
  - [x] Récupérer tous documents du dossier (récursif optionnel)
  - [x] Filtrer ceux où user a accès READ
  - [x] Créer liens en batch (skipDuplicates)
  - [x] Retourner nombre de documents liés

- [x] **Task 7: Controller & Routes** (AC: 2-5)
  - [x] Créer `project-documents.controller.ts`
  - [x] Routes dans `projects.routes.ts`:
    - GET `/:id/documents`
    - POST `/:id/documents`
    - POST `/:id/documents/folder/:folderId`
    - DELETE `/:id/documents/:docId`
  - [x] Middleware: membre du projet ou Staff+

- [x] **Task 8: Mise à jour GET /projects/:id** (AC: 9)
  - [x] `_count: { documents: true }` déjà dans le service projects
  - [x] Retourner `_count.documents` dans la réponse

- [x] **Task 9: Tests d'intégration** (AC: 10)
  - [x] Tests de routes avec validation UUID
  - [x] Tests d'authentification 401
  - [x] Tests de pagination
  - [x] Tests option recursive
  - [x] 18 tests passent

## Dev Notes

### Architecture

```text
apps/api/src/modules/projects/
├── projects.controller.ts
├── projects.service.ts
├── projects.routes.ts
├── members.controller.ts
├── members.service.ts
├── project-documents.controller.ts   # NEW
├── project-documents.service.ts      # NEW
└── index.ts
```

### Prisma Schema

```prisma
model ProjectDocument {
  id         String   @id @default(uuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id])
  documentId String
  document   Document @relation(fields: [documentId], references: [id])
  linkedById String
  linkedBy   User     @relation(fields: [linkedById], references: [id])
  linkedAt   DateTime @default(now())

  @@unique([projectId, documentId])
  @@index([projectId])
  @@index([documentId])
}
```

### Logique d'accès document via projet

```typescript
// Dans permissions.service.ts ou helper
async canAccessDocument(userId: string, documentId: string): Promise<boolean> {
  // 1. Accès direct (permission GED existante)
  const directAccess = await this.checkDirectAccess(userId, documentId);
  if (directAccess) return true;

  // 2. Accès via projet (nouveau)
  const projectAccess = await this.checkProjectAccess(userId, documentId);
  return projectAccess;
}

async checkProjectAccess(userId: string, documentId: string): Promise<boolean> {
  // Document lié à un projet dont l'user est membre?
  const link = await prisma.projectDocument.findFirst({
    where: {
      documentId,
      project: {
        members: { some: { userId } }
      }
    }
  });
  return !!link;
}
```

### Response Format

```typescript
// GET /api/projects/:id/documents
{
  data: [
    {
      id: "link-uuid",
      documentId: "doc-uuid",
      document: {
        id, name, mimeType, size, createdAt
      },
      linkedBy: { id, name },
      linkedAt: "2025-01-27T..."
    }
  ],
  pagination: { page, limit, total, totalPages }
}
```

## Testing

### Localisation
- `apps/api/tests/project-documents.test.ts`

### Cas de test

| Scénario | Expected |
|----------|----------|
| Lier doc avec accès READ | 201 |
| Lier doc sans accès | 403 |
| Lier doc déjà lié | 409 ou 200 (idempotent) |
| Lier dossier (5 docs, 3 accessibles) | 201, linkedCount: 3 |
| Délier doc | 204 |
| Membre projet accède doc lié | 200 (via checkProjectAccess) |
| Non-membre accède doc lié | 403 |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale | Sarah (PO) |
| 2025-01-27 | 1.1 | Implémentation complète - Dev Agent | Claude Opus 4.5 |
| 2025-01-27 | 1.2 | PO Review - Approved → Complete | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Tests: `pnpm test -- tests/integration/project-documents.api.test.ts --forceExit`
- 18/18 tests passing

### Completion Notes List
- Schéma Prisma mis à jour avec linkedById et linkedAt
- Service avec validation d'accès via canAccessFolder()
- Fonction canAccessDocumentViaProject() pour accès via projet
- Option recursive pour linkFolder()
- Middleware canManageDocuments() vérifie membership projet

### File List
- `prisma/schema.prisma` - ProjectDocument model (updated)
- `packages/shared/src/types/project.types.ts` - Types ProjectDocument, LinkDocumentDto, etc.
- `apps/api/src/modules/projects/project-documents.service.ts` - NEW
- `apps/api/src/modules/projects/project-documents.controller.ts` - NEW
- `apps/api/src/modules/projects/projects.routes.ts` - Routes documents ajoutées
- `apps/api/src/modules/projects/index.ts` - Exports ajoutés
- `apps/api/tests/integration/project-documents.api.test.ts` - NEW

---

## QA Results

### PO Review - 2025-01-27

**Reviewer:** Sarah (PO)

**Acceptance Criteria Verification:**

| AC | Description | Status | Notes |
|----|-------------|--------|-------|
| 1 | Schéma Prisma ProjectDocument | ✅ PASS | id, projectId, documentId, linkedById, linkedAt, createdAt |
| 2 | GET /api/projects/:id/documents | ✅ PASS | Pagination, include document + linkedBy |
| 3 | POST /api/projects/:id/documents | ✅ PASS | Validation UUID, conflit 409 |
| 4 | POST /api/projects/:id/documents/folder/:folderId | ✅ PASS | Option recursive, batch create |
| 5 | DELETE /api/projects/:id/documents/:docId | ✅ PASS | 204 No Content |
| 6 | Validation accès READ | ✅ PASS | canAccessFolder() avant liaison |
| 7 | Membres projet accès automatique | ✅ PASS | canAccessDocumentViaProject() implémenté |
| 8 | Document multi-projets | ✅ PASS | Pas de restriction |
| 9 | documentsCount sur GET /projects/:id | ✅ PASS | _count.documents retourné |
| 10 | Tests d'intégration | ✅ PASS | 18/18 tests passing |

**Score:** 10/10 AC satisfaits

**Decision:** ✅ **APPROVED** - Story marquée Complete
