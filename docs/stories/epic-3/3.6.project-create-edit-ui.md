# Story 3.6: Project Create/Edit UI

## Status: Complete

## Story

**As a** Staff ou Super-Admin,
**I want** créer et modifier des projets via un formulaire intuitif,
**so that** je puisse ajouter de nouveaux projets et mettre à jour les informations des projets existants de manière efficace.

## Acceptance Criteria

1. Page `/projects/new` avec formulaire de création
2. Champs: Nom* (requis), Description (textarea), Statut (select), Date début (datepicker), Date fin (datepicker), Budget (number input)
3. Validation frontend: nom requis (min 3 chars), dates cohérentes (fin >= début si les deux définies), budget >= 0
4. Mode édition sur `/projects/:id/edit` pré-remplissant les valeurs existantes
5. Boutons "Enregistrer" et "Annuler" avec états (loading, disabled)
6. Redirection vers page de détail après création/modification réussie
7. Messages d'erreur inline pour chaque champ en erreur
8. Toast de confirmation après succès ("Projet créé" / "Projet mis à jour")
9. Formulaire responsive adapté mobile
10. Protection route: accès Staff+ uniquement, redirect si non autorisé
11. Confirmation avant quitter si formulaire modifié (unsaved changes)

## Tasks / Subtasks

- [x] **Task 1: Service mutations** (AC: 1, 4)
  - [x] `createProject` et `updateProject` déjà dans projects.service.ts
  - [x] Types depuis shared

- [x] **Task 2: Hook useProjectMutations** (AC: 5, 6, 8)
  - [x] `useCreateProject` et `useUpdateProject` dans useProjects.ts
  - [x] Invalidation cache après succès
  - [x] Toast notifications

- [x] **Task 3: Schéma validation Zod** (AC: 3)
  - [x] Créer `apps/web/src/lib/validations/project.ts`
  - [x] Schema avec name min 3, description, status enum
  - [x] startDate/endDate avec refine >= startDate
  - [x] budget min 0

- [x] **Task 4: Composant ProjectForm** (AC: 2, 3, 5, 7, 9)
  - [x] Créer `apps/web/src/components/projects/ProjectForm.tsx`
  - [x] React Hook Form + Zod resolver
  - [x] Champs avec labels et erreurs inline
  - [x] Mode create vs edit (prop initialData)
  - [x] Boutons Submit/Cancel avec états loading

- [x] **Task 5: Input Composants** (AC: 2)
  - [x] Input existant utilisé (nom)
  - [x] Créé Textarea component
  - [x] Select Radix existant (statut)
  - [x] Native date inputs (dates)
  - [x] Number input (budget)

- [x] **Task 6: Page ProjectCreatePage** (AC: 1, 6, 10)
  - [x] Créer `apps/web/src/pages/ProjectCreatePage.tsx`
  - [x] Titre "Nouveau projet"
  - [x] ProjectForm mode create
  - [x] Redirect vers détail après succès
  - [x] Route protégée par RoleGuard Staff+

- [x] **Task 7: Page ProjectEditPage** (AC: 4, 6, 10)
  - [x] Créer `apps/web/src/pages/ProjectEditPage.tsx`
  - [x] Fetch projet existant avec useProject
  - [x] Titre "Modifier le projet"
  - [x] ProjectForm mode edit avec initialData
  - [x] Guard in-component: Staff+ ou PROJECT_MANAGER

- [x] **Task 8: Routes** (AC: 1, 4)
  - [x] `/projects/new` → ProjectCreatePage (RoleGuard Staff+)
  - [x] `/projects/:id/edit` → ProjectEditPage
  - [x] Lazy loading avec Suspense

- [x] **Task 9: Unsaved Changes Warning** (AC: 11)
  - [x] beforeunload event dans ProjectForm
  - [x] Détection form dirty state via isDirty

- [ ] **Task 10: Tests** (Deferred)
  - [ ] Tests vitest à ajouter ultérieurement

## Dev Notes

### Architecture

```text
apps/web/src/
├── pages/
│   ├── ProjectsPage.tsx
│   ├── ProjectDetailPage.tsx
│   ├── ProjectCreatePage.tsx      # NEW
│   └── ProjectEditPage.tsx        # NEW
├── components/projects/
│   ├── ProjectForm.tsx            # NEW
│   └── ...
├── hooks/
│   ├── useProjects.ts
│   ├── useProject.ts
│   └── useProjectMutations.ts     # NEW
└── lib/validations/
    └── project.ts                 # NEW
```

### Form Structure

```tsx
<ProjectForm
  mode="create" | "edit"
  initialData?: ProjectFormData
  onSuccess={(project) => navigate(`/projects/${project.id}`)}
  onCancel={() => navigate(-1)}
/>
```

### Zod Schema

```typescript
import { z } from 'zod';
import { ProjectStatus } from '@shared/types';

export const projectFormSchema = z.object({
  name: z.string()
    .min(3, 'Le nom doit contenir au moins 3 caractères')
    .max(100, 'Le nom ne peut pas dépasser 100 caractères'),
  description: z.string().optional(),
  status: z.nativeEnum(ProjectStatus),
  startDate: z.date().optional().nullable(),
  endDate: z.date().optional().nullable(),
  budget: z.number().min(0, 'Le budget ne peut pas être négatif').optional().nullable(),
}).refine(
  (data) => {
    if (data.startDate && data.endDate) {
      return data.endDate >= data.startDate;
    }
    return true;
  },
  {
    message: 'La date de fin doit être après la date de début',
    path: ['endDate'],
  }
);

export type ProjectFormData = z.infer<typeof projectFormSchema>;
```

### DatePicker Component

Si non existant, utiliser:
- `@radix-ui/react-popover` + `react-day-picker`
- Ou composant shadcn/ui date-picker

### Toast Messages

```typescript
// Après création
toast.success('Projet créé avec succès');

// Après modification
toast.success('Projet mis à jour');

// Erreur API
toast.error('Erreur lors de la sauvegarde');
```

### Unsaved Changes Hook

```typescript
import { useBlocker } from 'react-router-dom';

const useUnsavedChanges = (isDirty: boolean) => {
  useBlocker(
    ({ currentLocation, nextLocation }) =>
      isDirty && currentLocation.pathname !== nextLocation.pathname
  );

  // Aussi gérer beforeunload pour fermeture onglet
  useEffect(() => {
    const handler = (e: BeforeUnloadEvent) => {
      if (isDirty) {
        e.preventDefault();
        e.returnValue = '';
      }
    };
    window.addEventListener('beforeunload', handler);
    return () => window.removeEventListener('beforeunload', handler);
  }, [isDirty]);
};
```

## Testing

### Localisation
- `apps/web/tests/ProjectForm.test.tsx`
- `apps/web/tests/ProjectCreatePage.test.tsx`

### Cas de test

| Test | Description |
|------|-------------|
| Render form create | Formulaire vide, bouton "Créer" |
| Render form edit | Formulaire pré-rempli, bouton "Enregistrer" |
| Validation nom vide | Message erreur inline |
| Validation dates | Erreur si fin < début |
| Submit success | API call, toast, redirect |
| Submit error | Toast erreur, reste sur form |
| Cancel | Navigation retour |
| Access denied | Redirect si Contributor |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale | Sarah (PO) |
| 2025-01-28 | 1.1 | Implémentation complète - Dev Agent | Claude Opus 4.5 |
| 2025-01-28 | 1.2 | PO Review - Approved → Complete | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- TypeScript: `pnpm tsc --noEmit` - Pass

### Completion Notes List
- Schéma Zod avec validation dates cohérentes et budget >= 0
- ProjectForm avec react-hook-form + zodResolver
- Mode create/edit avec initialData optionnel
- Champs: Input, Textarea, Select Radix, native date, number input
- beforeunload pour unsaved changes warning
- ProjectCreatePage avec RoleGuard Staff+
- ProjectEditPage avec vérification permission in-component
- Breadcrumb navigation sur les deux pages
- États: loading, error, permission denied

### File List
- `apps/web/src/lib/validations/project.ts` - NEW
- `apps/web/src/components/ui/textarea.tsx` - NEW
- `apps/web/src/components/projects/ProjectForm.tsx` - NEW
- `apps/web/src/pages/ProjectCreatePage.tsx` - NEW
- `apps/web/src/pages/ProjectEditPage.tsx` - NEW
- `apps/web/src/components/projects/index.ts` - Updated
- `apps/web/src/App.tsx` - Routes ajoutées

---

## QA Results

### PO Review - 2025-01-27

**Reviewer:** Sarah (PO)

**Acceptance Criteria Verification:**

| AC | Description | Status | Notes |
|----|-------------|--------|-------|
| 1 | Page /projects/new | ✅ PASS | Route protégée RoleGuard Staff+ |
| 2 | Champs formulaire complets | ✅ PASS | Nom, Description, Statut, Dates, Budget |
| 3 | Validation frontend | ✅ PASS | Zod schema avec refine dates |
| 4 | Mode édition /projects/:id/edit | ✅ PASS | Pré-remplissage initialData |
| 5 | Boutons avec états loading | ✅ PASS | Loader2 icon pendant submit |
| 6 | Redirect après succès | ✅ PASS | navigate vers /projects/:id |
| 7 | Messages erreur inline | ✅ PASS | Sous chaque champ |
| 8 | Toast confirmation | ✅ PASS | Via useCreateProject/useUpdateProject |
| 9 | Formulaire responsive | ✅ PASS | Grid 1/2 cols pour dates |
| 10 | Protection route Staff+ | ✅ PASS | RoleGuard + vérif in-component |
| 11 | Unsaved changes warning | ✅ PASS | beforeunload event |

**Score:** 11/11 AC satisfaits

**Note:** Tests unitaires (Task 10) différés - à ajouter dans une story technique.

**Decision:** ✅ **APPROVED** - Story marquée Complete
