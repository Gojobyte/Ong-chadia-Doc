# Story 3.1: Project Model & CRUD API

## Status: Complete

## Story

**As a** Staff ou Super-Admin,
**I want** créer et gérer des fiches projet via API REST,
**so that** l'ONG puisse centraliser toutes les informations projets dans un système unique et structuré.

## Acceptance Criteria

1. Schéma Prisma `Project` avec champs: id (UUID), name, description (nullable), status (enum), startDate (nullable), endDate (nullable), budget (Decimal, nullable), createdById (FK User), createdAt, updatedAt, deletedAt (soft delete)
2. Enum `ProjectStatus`: DRAFT, PREPARATION, IN_PROGRESS, COMPLETED, CANCELLED
3. `GET /api/projects` - Liste paginée des projets accessibles à l'utilisateur avec filtres
4. `GET /api/projects/:id` - Détails complets d'un projet avec compteurs (membres, documents)
5. `POST /api/projects` - Création projet (Staff+ requis), retourne le projet créé
6. `PATCH /api/projects/:id` - Modification partielle (Staff+ ou PROJECT_MANAGER du projet)
7. `DELETE /api/projects/:id` - Soft delete (Super-Admin uniquement), définit deletedAt
8. Filtrage par statut: `?status=IN_PROGRESS` ou `?status=DRAFT,PREPARATION`
9. Pagination: `?page=1&limit=20` et tri: `?sort=startDate&order=desc`
10. Tests d'intégration couvrant tous les endpoints et cas d'erreur

## Tasks / Subtasks

- [x] **Task 1: Schéma Prisma Project** (AC: 1, 2)
  - [x] Créer model `Project` dans `prisma/schema.prisma`
  - [x] Créer enum `ProjectStatus` (DRAFT, PREPARATION, IN_PROGRESS, COMPLETED, CANCELLED)
  - [x] Ajouter relation `createdBy` vers User
  - [x] Ajouter index sur `status`, `createdById`, `deletedAt`
  - [x] Exécuter `pnpm db:push` pour synchroniser la base

- [x] **Task 2: Types partagés** (AC: 1-9)
  - [x] Créer `packages/shared/src/types/project.types.ts`
  - [x] Définir interfaces: `Project`, `CreateProjectDto`, `UpdateProjectDto`, `ProjectFilters`
  - [x] Définir enum `ProjectStatus` côté TypeScript
  - [x] Exporter depuis `packages/shared/src/index.ts`

- [x] **Task 3: Module Projects API** (AC: 3-9)
  - [x] Créer structure `apps/api/src/modules/projects/`
  - [x] Implémenter `projects.service.ts` avec méthodes CRUD
  - [x] Implémenter `projects.controller.ts` avec validation
  - [x] Implémenter `projects.routes.ts` avec middleware auth
  - [x] Ajouter routes dans `app.ts`

- [x] **Task 4: Endpoint GET /api/projects** (AC: 3, 8, 9)
  - [x] Implémenter listing paginé avec `skip/take`
  - [x] Ajouter filtre `status` (simple ou multiple via virgule)
  - [x] Ajouter tri dynamique (`sort`, `order`)
  - [x] Filtrer projets soft-deleted (`deletedAt IS NULL`)
  - [x] Retourner format: `{ data: Project[], pagination: {...} }`

- [x] **Task 5: Endpoint GET /api/projects/:id** (AC: 4)
  - [x] Récupérer projet par ID avec `_count` (members, documents)
  - [x] Vérifier projet non soft-deleted
  - [x] Retourner 404 si non trouvé

- [x] **Task 6: Endpoint POST /api/projects** (AC: 5)
  - [x] Valider payload avec Zod
  - [x] Vérifier rôle Staff+ via middleware
  - [x] Créer projet avec `createdById` = user connecté
  - [x] Statut par défaut: DRAFT
  - [x] Retourner 201 avec projet créé

- [x] **Task 7: Endpoint PATCH /api/projects/:id** (AC: 6)
  - [x] Valider payload partiel avec Zod
  - [x] Vérifier permission (Staff+ ou PROJECT_MANAGER du projet)
  - [x] Valider cohérence dates (endDate >= startDate)
  - [x] Retourner projet mis à jour

- [x] **Task 8: Endpoint DELETE /api/projects/:id** (AC: 7)
  - [x] Vérifier rôle Super-Admin via middleware
  - [x] Soft delete: `update({ deletedAt: new Date() })`
  - [x] Retourner 204 No Content

- [x] **Task 9: Tests d'intégration** (AC: 10)
  - [x] Créer `apps/api/tests/integration/projects.api.test.ts`
  - [x] Tester CRUD complet (create, read, update, delete)
  - [x] Tester pagination et filtres
  - [x] Tester permissions (Staff+, Super-Admin only)
  - [x] Tester cas d'erreur (404, 403, 400)

## Dev Notes

### Architecture

```text
apps/api/src/modules/projects/
├── projects.controller.ts   # Validation, formatting
├── projects.service.ts      # Business logic, Prisma queries
├── projects.routes.ts       # Express routes + middleware
└── index.ts                 # Module exports
```

### Patterns à suivre (cf. Epic 2)

- **Response format**: `{ data, pagination }` pour les listes
- **Permission check**: Middleware `requireRole('STAFF', 'SUPER_ADMIN')`
- **Soft delete**: Champ `deletedAt`, filtré par défaut
- **Validation**: Zod schemas dans controller

### Référence API similaire

Pattern inspiré de modules existants:
- `apps/api/src/modules/documents/` pour CRUD
- `apps/api/src/modules/folders/` pour pagination

### Prisma Schema

```prisma
enum ProjectStatus {
  DRAFT
  PREPARATION
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(DRAFT)
  startDate   DateTime?
  endDate     DateTime?
  budget      Decimal?      @db.Decimal(15, 2)
  createdById String
  createdBy   User          @relation(fields: [createdById], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  members     ProjectMember[]
  documents   ProjectDocument[]

  @@index([status])
  @@index([createdById])
  @@index([deletedAt])
}
```

## Testing

### Localisation
- `apps/api/tests/projects.test.ts`

### Framework
- Jest + Supertest

### Cas à couvrir

| Test | Description |
|------|-------------|
| POST /projects | Création avec Staff - succès |
| POST /projects | Création avec Contributor - 403 |
| GET /projects | Liste paginée avec filtres |
| GET /projects/:id | Détails projet existant |
| GET /projects/:id | Projet inexistant - 404 |
| PATCH /projects/:id | Modification par Staff |
| DELETE /projects/:id | Soft delete par Super-Admin |
| DELETE /projects/:id | Tentative par Staff - 403 |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Prisma db push successful: Database synced with schema
- API build successful: TypeScript compilation passed
- API endpoint verified: GET /api/projects returns 401 (auth required) as expected

### Completion Notes List
- All Tasks 1-9 completed (Schema, Types, API Module, CRUD endpoints, Integration Tests)
- Database schema includes Project, ProjectMember, ProjectDocument models
- Added ProjectStatus and ProjectRole enums
- Validation with Zod for all inputs
- Permission middleware: isStaffOrAbove, isSuperAdmin, canUpdateProject (custom)
- 33 integration tests covering authentication, validation, query params, routes, permissions

### File List
**Created:**
- `prisma/schema.prisma` (modified - added Project models)
- `packages/shared/src/types/project.types.ts`
- `packages/shared/src/validators/project.validators.ts`
- `apps/api/src/modules/projects/projects.service.ts`
- `apps/api/src/modules/projects/projects.controller.ts`
- `apps/api/src/modules/projects/projects.routes.ts`
- `apps/api/src/modules/projects/index.ts`
- `apps/api/tests/integration/projects.api.test.ts`

**Modified:**
- `packages/shared/src/types/index.ts` (added project exports)
- `packages/shared/src/validators/index.ts` (added project validators export)
- `apps/api/src/app.ts` (added projects routes)
- `apps/api/src/modules/tags/tags.controller.ts` (fixed TypeScript types)
- `apps/api/src/modules/favorites/favorites.controller.ts` (fixed TypeScript types)
- `apps/api/src/modules/analytics/analytics.service.ts` (fixed TypeScript types)

---

## QA Results
<!-- Populated by QA agent -->
