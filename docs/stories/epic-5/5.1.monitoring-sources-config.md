# Story 5.1: Monitoring Sources Configuration

## Status: Approved

## Story

**As a** responsable fundraising,
**I want** configurer les sources d'appels d'offres à surveiller,
**so that** le système agrège automatiquement les opportunités pertinentes.

## Acceptance Criteria

1. Interface CRUD de gestion des sources de veille
2. Types de sources supportés: URL RSS, API REST, scraping page web
3. Configuration fréquence de vérification (horaire, quotidienne, hebdomadaire)
4. Test de connexion/validation avant sauvegarde
5. Activation/désactivation par source sans suppression
6. Sources prédéfinies en seed: DevEx, ReliefWeb, ECHO, AFD, Portail UE
7. Logs d'exécution des collectes avec statut et erreurs
8. Alertes automatiques si source en erreur répétée
9. Import/export configuration sources (JSON)
10. Tests d'intégration API et UI

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma MonitoringSource** (AC: 1-6)
  - [ ] Créer model `MonitoringSource` (id, name, type, config, frequency, isActive, lastRunAt, errorCount)
  - [ ] Créer enum `SourceType`: RSS, API, SCRAPING
  - [ ] Créer enum `SourceFrequency`: HOURLY, DAILY, WEEKLY
  - [ ] Migration Prisma

- [ ] **Task 2: API Sources CRUD** (AC: 1, 5)
  - [ ] `GET /api/monitoring/sources` - Liste sources
  - [ ] `GET /api/monitoring/sources/:id` - Détails source
  - [ ] `POST /api/monitoring/sources` - Créer source
  - [ ] `PATCH /api/monitoring/sources/:id` - Modifier/activer/désactiver
  - [ ] `DELETE /api/monitoring/sources/:id` - Supprimer source

- [ ] **Task 3: Test de Connexion** (AC: 4)
  - [ ] Endpoint `POST /api/monitoring/sources/test`
  - [ ] Tester connexion RSS (fetch + parse)
  - [ ] Tester connexion API (auth + call)
  - [ ] Tester scraping (load page + selectors)
  - [ ] Retourner statut et sample data

- [ ] **Task 4: Configuration par Type** (AC: 2, 3)
  - [ ] Config RSS: url, itemSelector
  - [ ] Config API: url, authType, headers, params
  - [ ] Config Scraping: url, selectors (titre, date, lien)
  - [ ] Validation schema par type

- [ ] **Task 5: Sources Prédéfinies (Seed)** (AC: 6)
  - [ ] Créer fichier `prisma/seed-sources.ts`
  - [ ] DevEx RSS feed
  - [ ] ReliefWeb API
  - [ ] ECHO funding opportunities
  - [ ] AFD appels à projets
  - [ ] EU Funding & Tenders

- [ ] **Task 6: Système de Logs** (AC: 7)
  - [ ] Créer model `SourceRunLog` (sourceId, startedAt, completedAt, status, itemsFound, error)
  - [ ] Logger chaque exécution
  - [ ] API `GET /api/monitoring/sources/:id/logs`
  - [ ] Retention 30 jours

- [ ] **Task 7: Alertes Erreurs** (AC: 8)
  - [ ] Incrémenter errorCount si échec
  - [ ] Trigger alerte si errorCount >= 3
  - [ ] Reset errorCount si succès
  - [ ] Notification email admin

- [ ] **Task 8: Import/Export Config** (AC: 9)
  - [ ] `GET /api/monitoring/sources/export` - Export JSON
  - [ ] `POST /api/monitoring/sources/import` - Import JSON
  - [ ] Validation et merge avec existant

- [ ] **Task 9: UI Gestion Sources** (AC: 1-9)
  - [ ] Créer page `MonitoringSourcesPage.tsx`
  - [ ] Liste sources avec statuts (actif, erreur, dernière exécution)
  - [ ] Modal création/édition source
  - [ ] Formulaire dynamique selon type
  - [ ] Bouton test connexion avec feedback

- [ ] **Task 10: Tests** (AC: 10)
  - [ ] Tests API CRUD
  - [ ] Tests test de connexion (mocks)
  - [ ] Tests UI

## Dev Notes

### Architecture

```text
apps/api/src/modules/monitoring/
├── sources/
│   ├── sources.controller.ts
│   ├── sources.service.ts
│   ├── sources.routes.ts
│   ├── source-tester.service.ts  # Test connexion
│   └── index.ts
├── collectors/                    # Pour Story 5.2
└── index.ts

apps/web/src/pages/monitoring/
├── MonitoringSourcesPage.tsx
├── SourceForm.tsx
├── SourceLogs.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum SourceType {
  RSS
  API
  SCRAPING
}

enum SourceFrequency {
  HOURLY
  DAILY
  WEEKLY
}

model MonitoringSource {
  id          String          @id @default(uuid())
  name        String
  type        SourceType
  config      Json            // URL, auth, selectors selon type
  frequency   SourceFrequency @default(DAILY)
  isActive    Boolean         @default(true)
  lastRunAt   DateTime?
  nextRunAt   DateTime?
  errorCount  Int             @default(0)
  createdById String
  createdBy   User            @relation(fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  logs        SourceRunLog[]
  opportunities Opportunity[]

  @@index([isActive, nextRunAt])
}

model SourceRunLog {
  id          String           @id @default(uuid())
  sourceId    String
  source      MonitoringSource @relation(fields: [sourceId], references: [id])
  startedAt   DateTime         @default(now())
  completedAt DateTime?
  status      String           // SUCCESS, FAILED, PARTIAL
  itemsFound  Int              @default(0)
  itemsNew    Int              @default(0)
  error       String?
  metadata    Json?

  @@index([sourceId, startedAt])
}
```

### Config Examples par Type

```ts
// RSS
{
  url: "https://devex.com/rss/funding",
  itemSelector: "item",  // XPath ou CSS
  mappings: {
    title: "title",
    link: "link",
    date: "pubDate",
    description: "description"
  }
}

// API
{
  url: "https://api.reliefweb.int/v1/jobs",
  method: "GET",
  auth: { type: "none" | "apiKey" | "oauth", ... },
  params: { "filter[type]": "funding" },
  mappings: { ... }
}

// Scraping
{
  url: "https://example.com/grants",
  listSelector: ".grant-item",
  mappings: {
    title: ".grant-title",
    link: "a@href",
    deadline: ".deadline",
  }
}
```

## Testing

### Localisation

- `apps/api/tests/monitoring-sources.test.ts`
- `apps/web/src/pages/monitoring/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create RSS | Création source RSS valide |
| Create API | Création source API avec auth |
| Test connection | Test connexion RSS succès |
| Test connection fail | Test connexion échoue gracieusement |
| Toggle active | Activation/désactivation |
| Logs list | Historique exécutions affiché |
| Export/Import | Round-trip configuration |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
