# Story 5.4: Opportunity Detail & Actions

## Status: Approved

## Story

**As a** responsable projets,
**I want** consulter le dÃ©tail d'un appel d'offres et effectuer des actions,
**so that** je puisse Ã©valuer l'opportunitÃ© et initier une candidature.

## Acceptance Criteria

1. Page dÃ©tail avec toutes les informations normalisÃ©es
2. Lien vers source originale (ouvre dans nouvel onglet)
3. Actions rapides: Marquer comme lu, Archiver, Lancer candidature
4. Notes internes sur l'opportunitÃ© (commentaires Ã©quipe)
5. Liste des piÃ¨ces jointes tÃ©lÃ©chargÃ©es depuis la source
6. Historique des consultations (qui a vu, quand)
7. Partage interne vers collÃ¨gues (notification + email)
8. Ã‰valuation rapide: Go / No-Go / Ã€ Ã©tudier
9. Lien direct vers crÃ©ation de proposition (liaison Epic 6)
10. Tests E2E du flow complet

## Tasks / Subtasks

- [ ] **Task 1: API DÃ©tail OpportunitÃ©** (AC: 1, 2)
  - [ ] `GET /api/opportunities/:id` - DÃ©tails complets
  - [ ] Inclure: source, notes, attachments, views
  - [ ] Marquer comme VU si premier accÃ¨s
  - [ ] Logger consultation

- [ ] **Task 2: Actions sur OpportunitÃ©** (AC: 3)
  - [ ] `PATCH /api/opportunities/:id/status` - Changer statut
  - [ ] Statuts: NEW â†’ VIEWED â†’ APPLIED / ARCHIVED / REJECTED
  - [ ] `POST /api/opportunities/:id/archive` - Archiver
  - [ ] Validation transitions autorisÃ©es

- [ ] **Task 3: SystÃ¨me de Notes** (AC: 4)
  - [ ] CrÃ©er model `OpportunityNote` (opportunityId, userId, content, createdAt)
  - [ ] `GET /api/opportunities/:id/notes`
  - [ ] `POST /api/opportunities/:id/notes`
  - [ ] `DELETE /api/opportunities/:id/notes/:noteId`
  - [ ] Mentions @user dans notes

- [ ] **Task 4: Gestion PiÃ¨ces Jointes** (AC: 5)
  - [ ] TÃ©lÃ©charger PJ depuis source lors du parsing (si URLs)
  - [ ] Stocker dans Supabase Storage
  - [ ] `GET /api/opportunities/:id/attachments`
  - [ ] Preview/download depuis UI

- [ ] **Task 5: Historique Consultations** (AC: 6)
  - [ ] CrÃ©er model `OpportunityView` (opportunityId, userId, viewedAt)
  - [ ] Logger chaque consultation
  - [ ] `GET /api/opportunities/:id/views`
  - [ ] Limiter Ã  100 derniÃ¨res vues

- [ ] **Task 6: Partage Interne** (AC: 7)
  - [ ] `POST /api/opportunities/:id/share`
  - [ ] Body: { userIds: [], message?: string }
  - [ ] CrÃ©er notification in-app
  - [ ] Envoyer email avec lien direct
  - [ ] Logger partages

- [ ] **Task 7: SystÃ¨me d'Ã‰valuation** (AC: 8)
  - [ ] Ajouter champ `evaluation` sur Opportunity (GO, NO_GO, TO_STUDY, null)
  - [ ] `PATCH /api/opportunities/:id/evaluate`
  - [ ] Commentaire obligatoire si NO_GO
  - [ ] Afficher Ã©valuation dans liste

- [ ] **Task 8: Liaison CrÃ©ation Proposition** (AC: 9)
  - [ ] Bouton "CrÃ©er une proposition"
  - [ ] Rediriger vers `/proposals/new?opportunityId=xxx`
  - [ ] PrÃ©-remplir infos de l'opportunitÃ© dans proposal

- [ ] **Task 9: UI Page DÃ©tail** (AC: 1-9)
  - [ ] CrÃ©er `OpportunityDetailPage.tsx`
  - [ ] Header: Titre, Bailleur, Deadline (countdown)
  - [ ] Badges: Statut, Ã‰valuation
  - [ ] Section: Description complÃ¨te
  - [ ] Section: Informations (montant, secteurs, rÃ©gions, Ã©ligibilitÃ©)
  - [ ] Section: PiÃ¨ces jointes
  - [ ] Section: Notes Ã©quipe
  - [ ] Section: Historique
  - [ ] Sidebar: Actions rapides

- [ ] **Task 10: UI Actions** (AC: 3, 7, 8)
  - [ ] Boutons actions dans sidebar
  - [ ] Modal partage (sÃ©lection users)
  - [ ] Dropdown Ã©valuation avec commentaire
  - [ ] Confirmation archivage

- [ ] **Task 11: Tests E2E** (AC: 10)
  - [ ] Flow: Liste â†’ DÃ©tail â†’ Note â†’ Ã‰valuation â†’ Partage
  - [ ] Flow: DÃ©tail â†’ CrÃ©er Proposition
  - [ ] Tests permissions

## Dev Notes

### Architecture

```text
apps/api/src/modules/opportunities/
â”œâ”€â”€ opportunities.controller.ts  # Ã‰tendre
â”œâ”€â”€ opportunities.service.ts     # Ã‰tendre
â”œâ”€â”€ notes.controller.ts
â”œâ”€â”€ notes.service.ts
â”œâ”€â”€ sharing.service.ts
â”œâ”€â”€ views.service.ts
â””â”€â”€ index.ts

apps/web/src/pages/opportunities/
â”œâ”€â”€ OpportunityDetailPage.tsx
â”œâ”€â”€ OpportunityHeader.tsx
â”œâ”€â”€ OpportunityInfo.tsx
â”œâ”€â”€ OpportunityNotes.tsx
â”œâ”€â”€ OpportunityAttachments.tsx
â”œâ”€â”€ OpportunityHistory.tsx
â”œâ”€â”€ OpportunityActions.tsx
â”œâ”€â”€ ShareModal.tsx
â”œâ”€â”€ EvaluationDropdown.tsx
â””â”€â”€ index.ts
```

### SchÃ©mas Prisma Additionnels

```prisma
enum OpportunityEvaluation {
  GO
  NO_GO
  TO_STUDY
}

model OpportunityNote {
  id            String      @id @default(uuid())
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  content       String      @db.Text
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([opportunityId, createdAt])
}

model OpportunityView {
  id            String      @id @default(uuid())
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  viewedAt      DateTime    @default(now())

  @@index([opportunityId, viewedAt])
}

model OpportunityShare {
  id            String      @id @default(uuid())
  opportunityId String
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])
  sharedById    String
  sharedBy      User        @relation("SharedBy", fields: [sharedById], references: [id])
  sharedToId    String
  sharedTo      User        @relation("SharedTo", fields: [sharedToId], references: [id])
  message       String?
  createdAt     DateTime    @default(now())

  @@index([opportunityId])
  @@index([sharedToId])
}

// Ajouter Ã  Opportunity
model Opportunity {
  // ... champs existants
  evaluation         OpportunityEvaluation?
  evaluationComment  String?
  evaluatedAt        DateTime?
  evaluatedById      String?
}
```

### UI Layout

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Retour                                    [Actions â–¼]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [GO] Appel Ã  projets - SantÃ© Afrique de l'Ouest             â”‚
â”‚ Bailleur: AFD  |  Deadline: 15 Mars 2025 (J-45)             â”‚
â”‚ Montant: 500,000 - 2,000,000 EUR                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Description                                    â”‚ Actions    â”‚
â”‚ Lorem ipsum dolor sit amet...                  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                â”‚ [Voir source]
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚ [Partager] â”‚
â”‚ Secteurs: SantÃ©, Nutrition                    â”‚ [Archiver] â”‚
â”‚ RÃ©gions: SÃ©nÃ©gal, Mali, Niger                 â”‚            â”‚
â”‚ Ã‰ligibilitÃ©: ONG internationales              â”‚ Ã‰valuation â”‚
â”‚                                                â”‚ [GO â–¼]     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚            â”‚
â”‚ PiÃ¨ces jointes                                â”‚ [Candidater]â”‚
â”‚ ğŸ“ TDR_complet.pdf                            â”‚            â”‚
â”‚ ğŸ“ Formulaire_budget.xlsx                     â”‚            â”‚
â”‚                                                â”‚            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚            â”‚
â”‚ Notes Ã©quipe (3)                              â”‚            â”‚
â”‚ [Marie] TrÃ¨s pertinent pour notre...          â”‚            â”‚
â”‚ [Jean] Budget OK pour notre capacitÃ©          â”‚            â”‚
â”‚ + Ajouter une note                            â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing

### Localisation

- `apps/api/tests/opportunity-detail.test.ts`
- `apps/web/src/pages/opportunities/__tests__/OpportunityDetailPage.test.tsx`
- `e2e/opportunities.spec.ts`

### Framework

- Jest + Supertest (API)
- Vitest + RTL (UI)
- Playwright (E2E)

### Cas Ã  couvrir

| Test | Description |
|------|-------------|
| Get detail | RÃ©cupÃ¨re toutes les infos |
| Mark viewed | Status passe Ã  VIEWED |
| Add note | Note ajoutÃ©e et visible |
| Share | Notification crÃ©Ã©e |
| Evaluate GO | Ã‰valuation sauvegardÃ©e |
| Evaluate NO_GO | Commentaire requis |
| Archive | Status passe Ã  ARCHIVED |
| E2E flow | Parcours complet utilisateur |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | CrÃ©ation initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
