# Story 5.5: Alerts & Notifications

## Status: Approved

## Story

**As a** utilisateur,
**I want** recevoir des alertes pour les nouveaux appels d'offres correspondant à mes critères,
**so that** je ne rate aucune opportunité pertinente.

## Acceptance Criteria

1. Interface de configuration d'alertes par utilisateur
2. Critères d'alerte: secteurs, bailleurs, zones géographiques, mots-clés
3. Fréquence configurable: temps réel, digest quotidien, digest hebdomadaire
4. Canaux de notification: in-app (bell icon), email
5. Preview du nombre d'appels correspondants avant activation
6. Désabonnement facile en un clic
7. Historique des alertes envoyées avec statut
8. Template email personnalisable (Admin)
9. Limite anti-spam: max 10 alertes temps réel par jour
10. Tests notifications et digests

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma Alerts** (AC: 1, 2, 3, 4)
  - [ ] Créer model `OpportunityAlert` (userId, name, criteria, frequency, channels, isActive)
  - [ ] Créer model `AlertHistory` (alertId, opportunityId, sentAt, channel, status)
  - [ ] Créer enum `AlertFrequency`: REALTIME, DAILY, WEEKLY
  - [ ] Migration Prisma

- [ ] **Task 2: API Alerts CRUD** (AC: 1, 6)
  - [ ] `GET /api/alerts` - Liste alertes user
  - [ ] `POST /api/alerts` - Créer alerte
  - [ ] `PATCH /api/alerts/:id` - Modifier alerte
  - [ ] `DELETE /api/alerts/:id` - Supprimer alerte
  - [ ] `PATCH /api/alerts/:id/toggle` - Activer/désactiver

- [ ] **Task 3: Preview Matching** (AC: 5)
  - [ ] `POST /api/alerts/preview`
  - [ ] Body: criteria (même format que filtre)
  - [ ] Retourner: count total, sample 5 opportunités
  - [ ] Ne pas créer d'alerte, juste preview

- [ ] **Task 4: Real-time Alert Trigger** (AC: 3, 4, 9)
  - [ ] Hook après insertion nouvelle opportunité
  - [ ] Matcher contre toutes alertes REALTIME actives
  - [ ] Vérifier limite quotidienne (max 10)
  - [ ] Créer notification in-app
  - [ ] Envoyer email si canal activé

- [ ] **Task 5: Digest Jobs** (AC: 3)
  - [ ] Job quotidien (8h matin): agrège opportunités J-1
  - [ ] Job hebdomadaire (lundi 8h): agrège opportunités semaine
  - [ ] Matcher contre alertes correspondantes
  - [ ] Grouper par alerte et envoyer digest

- [ ] **Task 6: Notification In-App** (AC: 4)
  - [ ] Créer/étendre model `Notification`
  - [ ] Type: OPPORTUNITY_ALERT
  - [ ] Afficher dans bell icon (header)
  - [ ] Badge count non-lues
  - [ ] Clic → page détail opportunité

- [ ] **Task 7: Email Notifications** (AC: 4, 8)
  - [ ] Template email alerte unique
  - [ ] Template email digest (liste opportunités)
  - [ ] Variables: {{user.name}}, {{opportunity.title}}, {{alert.name}}
  - [ ] Lien direct vers opportunité
  - [ ] Lien désabonnement

- [ ] **Task 8: Historique Alertes** (AC: 7)
  - [ ] Logger chaque envoi dans AlertHistory
  - [ ] Statuts: SENT, DELIVERED, CLICKED, FAILED
  - [ ] `GET /api/alerts/:id/history`
  - [ ] UI timeline historique

- [ ] **Task 9: Anti-spam** (AC: 9)
  - [ ] Compteur alertes temps réel par jour par user
  - [ ] Si > 10, passer en mode digest pour la journée
  - [ ] Notifier user du changement
  - [ ] Reset compteur à minuit

- [ ] **Task 10: UI Configuration Alertes** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Créer page `AlertsSettingsPage.tsx`
  - [ ] Liste alertes configurées
  - [ ] Modal création/édition alerte
  - [ ] Preview matching en live
  - [ ] Toggle activation

- [ ] **Task 11: Tests** (AC: 10)
  - [ ] Tests API CRUD alertes
  - [ ] Tests matching criteria
  - [ ] Tests trigger temps réel
  - [ ] Tests digest jobs
  - [ ] Tests anti-spam

## Dev Notes

### Architecture

```text
apps/api/src/modules/alerts/
├── alerts.controller.ts
├── alerts.service.ts
├── alerts.routes.ts
├── matcher.service.ts       # Matching opportunité ↔ criteria
├── trigger.service.ts       # Déclenchement alertes
├── digest.job.ts            # Job digest quotidien/hebdo
└── index.ts

apps/api/src/modules/notifications/
├── notifications.controller.ts
├── notifications.service.ts
├── email.service.ts
└── index.ts

apps/web/src/pages/settings/
├── AlertsSettingsPage.tsx
├── AlertForm.tsx
├── AlertPreview.tsx
├── AlertHistory.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum AlertFrequency {
  REALTIME
  DAILY
  WEEKLY
}

enum AlertChannel {
  IN_APP
  EMAIL
}

model OpportunityAlert {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id])
  name        String
  criteria    Json            // Mêmes champs que OpportunityFilters
  frequency   AlertFrequency  @default(DAILY)
  channels    AlertChannel[]  @default([IN_APP])
  isActive    Boolean         @default(true)
  lastTriggeredAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  history     AlertHistory[]

  @@index([userId, isActive])
  @@index([frequency, isActive])
}

model AlertHistory {
  id            String           @id @default(uuid())
  alertId       String
  alert         OpportunityAlert @relation(fields: [alertId], references: [id])
  opportunityId String?
  opportunity   Opportunity?     @relation(fields: [opportunityId], references: [id])
  channel       AlertChannel
  status        String           // SENT, DELIVERED, CLICKED, FAILED
  sentAt        DateTime         @default(now())
  metadata      Json?

  @@index([alertId, sentAt])
}

model UserAlertLimit {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  date          DateTime @db.Date
  realtimeCount Int      @default(0)

  @@unique([userId, date])
}
```

### Criteria Matching

```ts
interface AlertCriteria {
  sectors?: string[];
  regions?: string[];
  donors?: string[];
  keywords?: string[];
  amountMin?: number;
  amountMax?: number;
}

function matchesAlert(opportunity: Opportunity, criteria: AlertCriteria): boolean {
  // Secteurs: au moins un match
  if (criteria.sectors?.length) {
    if (!criteria.sectors.some(s => opportunity.sectors.includes(s))) {
      return false;
    }
  }

  // Régions: au moins un match
  if (criteria.regions?.length) {
    if (!criteria.regions.some(r => opportunity.regions.includes(r))) {
      return false;
    }
  }

  // Keywords: au moins un dans titre ou description
  if (criteria.keywords?.length) {
    const text = (opportunity.title + ' ' + opportunity.description).toLowerCase();
    if (!criteria.keywords.some(k => text.includes(k.toLowerCase()))) {
      return false;
    }
  }

  // Montant dans range
  if (criteria.amountMin && opportunity.amount < criteria.amountMin) {
    return false;
  }
  if (criteria.amountMax && opportunity.amount > criteria.amountMax) {
    return false;
  }

  return true;
}
```

### Digest Job

```ts
// apps/api/src/modules/alerts/digest.job.ts
import { CronJob } from 'cron';

// Daily digest: 8h tous les jours
new CronJob('0 8 * * *', async () => {
  const dailyAlerts = await getActiveAlerts('DAILY');
  const yesterdayOpportunities = await getOpportunitiesSince(yesterday());

  for (const alert of dailyAlerts) {
    const matches = yesterdayOpportunities.filter(o =>
      matchesAlert(o, alert.criteria)
    );

    if (matches.length > 0) {
      await sendDigestNotification(alert, matches);
    }
  }
}).start();
```

## Testing

### Localisation

- `apps/api/tests/alerts.test.ts`
- `apps/api/src/modules/alerts/__tests__/matcher.test.ts`
- `apps/web/src/pages/settings/__tests__/AlertsSettingsPage.test.tsx`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create alert | Création avec critères valides |
| Preview match | Compteur correspond aux filtres |
| Match sectors | Opportunité matche secteur |
| Match keywords | Keyword trouvé dans description |
| No match | Opportunité ne matche pas |
| Trigger realtime | Notification créée immédiatement |
| Anti-spam | Blocage après 10 alertes |
| Digest daily | Opportunités agrégées correctement |
| Unsubscribe | Alerte désactivée |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
