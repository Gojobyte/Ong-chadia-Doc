# Story 5.3: Opportunities List & Filters

## Status: Approved

## Story

**As a** chargé de projets,
**I want** consulter la liste des appels d'offres avec des filtres avancés,
**so that** je trouve rapidement les opportunités pertinentes pour mon organisation.

## Acceptance Criteria

1. Liste paginée des appels d'offres avec tri par défaut (deadline proche)
2. Filtres: bailleur, secteur, zone géographique, montant (min/max), date limite
3. Recherche full-text dans titre et description
4. Tri par: date limite, date de publication, montant, pertinence
5. Vue carte des opportunités par pays/région (optionnel)
6. Badge "Nouveau" pour appels non consultés (status = NEW)
7. Sauvegarde des filtres favoris par utilisateur
8. Export liste filtrée en CSV/Excel
9. Compteurs par statut dans sidebar (Nouveaux, Vus, Candidatés)
10. Interface responsive mobile-first

## Tasks / Subtasks

- [ ] **Task 1: API Liste Opportunités** (AC: 1, 2, 3, 4)
  - [ ] `GET /api/opportunities` avec query params
  - [ ] Pagination: `page`, `limit`
  - [ ] Filtres: `donor`, `sectors[]`, `regions[]`, `amountMin`, `amountMax`, `deadlineBefore`, `deadlineAfter`
  - [ ] Recherche: `search` (full-text PostgreSQL)
  - [ ] Tri: `sort` (deadline, publishedAt, amount), `order` (asc, desc)

- [ ] **Task 2: Full-text Search** (AC: 3)
  - [ ] Configurer extension `pg_trgm` pour recherche floue
  - [ ] Créer index GIN sur title + description
  - [ ] Implémenter recherche avec ranking
  - [ ] Highlight des termes trouvés (optionnel)

- [ ] **Task 3: API Compteurs** (AC: 9)
  - [ ] `GET /api/opportunities/counts`
  - [ ] Compteur par statut: NEW, VIEWED, APPLIED, ARCHIVED
  - [ ] Compteur total
  - [ ] Cache avec invalidation

- [ ] **Task 4: Filtres Favoris** (AC: 7)
  - [ ] Créer model `SavedFilter` (userId, name, filters JSON)
  - [ ] `GET /api/opportunities/filters` - Liste filtres user
  - [ ] `POST /api/opportunities/filters` - Sauvegarder filtre
  - [ ] `DELETE /api/opportunities/filters/:id`

- [ ] **Task 5: Export CSV/Excel** (AC: 8)
  - [ ] `GET /api/opportunities/export?format=csv|xlsx`
  - [ ] Appliquer mêmes filtres que liste
  - [ ] Limiter à 1000 résultats max
  - [ ] Colonnes: Titre, Bailleur, Deadline, Montant, Secteurs, Lien

- [ ] **Task 6: UI Liste Opportunités** (AC: 1, 6, 10)
  - [ ] Créer `OpportunitiesPage.tsx`
  - [ ] Liste avec cards (titre, bailleur, deadline, montant)
  - [ ] Badge "Nouveau" si status = NEW
  - [ ] Countdown deadline (J-X)
  - [ ] Infinite scroll ou pagination

- [ ] **Task 7: UI Filtres Panel** (AC: 2)
  - [ ] Créer `FiltersPanel.tsx` (sidebar ou drawer mobile)
  - [ ] Select multiple: secteurs (avec recherche)
  - [ ] Select multiple: régions (groupées par continent)
  - [ ] Select: bailleur (autocomplete)
  - [ ] Range slider: montant min/max
  - [ ] Date pickers: deadline range
  - [ ] Bouton reset filtres

- [ ] **Task 8: UI Recherche** (AC: 3)
  - [ ] Input recherche avec debounce
  - [ ] Suggestions récentes (historique user)
  - [ ] Clear button

- [ ] **Task 9: UI Tri** (AC: 4)
  - [ ] Dropdown sélection tri
  - [ ] Options: Date limite (↑↓), Publication (↑↓), Montant (↑↓)
  - [ ] Indicateur tri actif

- [ ] **Task 10: Vue Carte (Nice-to-have)** (AC: 5)
  - [ ] Créer `OpportunitiesMap.tsx`
  - [ ] Markers par pays avec count
  - [ ] Cluster si beaucoup
  - [ ] Clic pays → filtre région
  - [ ] Toggle liste/carte

- [ ] **Task 11: Tests** (AC: 10)
  - [ ] Tests API filtres combinés
  - [ ] Tests full-text search
  - [ ] Tests UI filtres
  - [ ] Tests responsive

## Dev Notes

### Architecture

```text
apps/api/src/modules/opportunities/
├── opportunities.controller.ts
├── opportunities.service.ts
├── opportunities.routes.ts
├── filters.controller.ts
├── filters.service.ts
├── export.service.ts
└── index.ts

apps/web/src/pages/opportunities/
├── OpportunitiesPage.tsx
├── OpportunityCard.tsx
├── FiltersPanel.tsx
├── SearchBar.tsx
├── SortDropdown.tsx
├── OpportunitiesMap.tsx (optionnel)
└── index.ts
```

### API Query Params

```ts
// GET /api/opportunities?page=1&limit=20&search=health&sectors=Santé,Education&regions=Afrique&amountMin=10000&deadlineBefore=2025-06-01&sort=deadline&order=asc

interface OpportunityFilters {
  search?: string;
  donor?: string;
  sectors?: string[];
  regions?: string[];
  amountMin?: number;
  amountMax?: number;
  deadlineBefore?: Date;
  deadlineAfter?: Date;
  status?: OpportunityStatus[];
}

interface OpportunitySort {
  field: 'deadline' | 'publishedAt' | 'amount' | 'relevance';
  order: 'asc' | 'desc';
}
```

### Full-text Search PostgreSQL

```sql
-- Créer extension
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Index pour recherche
CREATE INDEX opportunities_search_idx ON "Opportunity"
USING GIN ((title || ' ' || COALESCE(description, '')) gin_trgm_ops);

-- Requête avec ranking
SELECT *,
  similarity(title || ' ' || description, 'health africa') as rank
FROM "Opportunity"
WHERE title || ' ' || description ILIKE '%health%'
ORDER BY rank DESC;
```

### Filtres Favoris Schema

```prisma
model SavedFilter {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  name      String
  filters   Json     // OpportunityFilters serialisé
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}
```

### UI Responsive

```tsx
// Mobile: Filtres dans Drawer
// Desktop: Filtres en sidebar
function OpportunitiesPage() {
  const isMobile = useMediaQuery('(max-width: 768px)');

  return (
    <div className="flex">
      {!isMobile && <FiltersPanel />}
      <div className="flex-1">
        <SearchBar />
        <SortDropdown />
        {isMobile && <FilterDrawerTrigger />}
        <OpportunityList />
      </div>
    </div>
  );
}
```

## Testing

### Localisation

- `apps/api/tests/opportunities.test.ts`
- `apps/web/src/pages/opportunities/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| List paginated | Pagination fonctionne |
| Filter sector | Filtre par secteur |
| Filter combined | Plusieurs filtres combinés |
| Search full-text | Recherche titre + description |
| Sort deadline | Tri par date limite |
| Export CSV | Génère CSV avec filtres |
| Save filter | Sauvegarde filtre favori |
| Badge new | Badge affiché si NEW |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
