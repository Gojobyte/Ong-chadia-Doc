# Story 6.4: Content Library & Reuse

## Status: Approved

## Story

**As a** rédacteur,
**I want** réutiliser des blocs de texte de propositions précédentes,
**so that** je capitalise sur le travail passé et gagne du temps.

## Acceptance Criteria

1. Bibliothèque centralisée de blocs de texte réutilisables
2. Catégorisation: présentation ONG, méthodologie, CV types, références projets, indicateurs
3. Recherche full-text dans les contenus des blocs
4. Insertion rapide dans proposition en cours d'édition
5. Extraction de blocs depuis propositions existantes
6. Tags et mots-clés sur les blocs pour classification
7. Statistiques d'utilisation par bloc (popularité)
8. Suggestions automatiques basées sur la section en cours
9. Versioning des blocs avec historique
10. Import en masse de contenus existants (Word, texte)

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma ContentBlock** (AC: 1, 2, 6, 7)
  - [ ] Créer model `ContentBlock` (id, title, content, category, tags, usageCount, version)
  - [ ] Créer enum `ContentCategory`: ORG_PRESENTATION, METHODOLOGY, CV, REFERENCES, INDICATORS, OTHER
  - [ ] Migration Prisma

- [ ] **Task 2: API Content Blocks CRUD** (AC: 1, 3)
  - [ ] `GET /api/content-blocks` - Liste avec filtres et recherche
  - [ ] `GET /api/content-blocks/:id` - Détails bloc
  - [ ] `POST /api/content-blocks` - Créer bloc
  - [ ] `PATCH /api/content-blocks/:id` - Modifier
  - [ ] `DELETE /api/content-blocks/:id` - Supprimer

- [ ] **Task 3: Recherche Full-text** (AC: 3)
  - [ ] Index GIN sur title + content
  - [ ] Query param `search`
  - [ ] Ranking par pertinence
  - [ ] Highlight des termes trouvés

- [ ] **Task 4: Catégories et Tags** (AC: 2, 6)
  - [ ] Filtrer par category
  - [ ] Filtrer par tags (array)
  - [ ] Auto-suggest tags existants
  - [ ] Compteur blocs par catégorie

- [ ] **Task 5: Extraction depuis Proposal** (AC: 5)
  - [ ] `POST /api/content-blocks/extract`
  - [ ] Body: { proposalId, sectionId, title, category, tags }
  - [ ] Copier contenu de la section
  - [ ] Lier à la proposition source (metadata)

- [ ] **Task 6: Insertion dans Proposal** (AC: 4)
  - [ ] Bouton "Insérer" dans UI bloc
  - [ ] Insérer contenu à position curseur dans éditeur
  - [ ] Incrémenter usageCount
  - [ ] Logger utilisation

- [ ] **Task 7: Statistiques Utilisation** (AC: 7)
  - [ ] Compteur usageCount sur bloc
  - [ ] Tracker dans `BlockUsage` (blockId, proposalId, userId, usedAt)
  - [ ] Trier par popularité
  - [ ] Dashboard stats (nice-to-have)

- [ ] **Task 8: Suggestions Automatiques** (AC: 8)
  - [ ] `GET /api/content-blocks/suggestions?sectionTitle=xxx&category=xxx`
  - [ ] Matcher par mots-clés du titre de section
  - [ ] Retourner top 5 blocs pertinents
  - [ ] Panel suggestions dans UI éditeur

- [ ] **Task 9: Versioning Blocs** (AC: 9)
  - [ ] Créer model `ContentBlockVersion`
  - [ ] Nouvelle version à chaque modification majeure
  - [ ] Historique des versions
  - [ ] Restauration possible

- [ ] **Task 10: Import en Masse** (AC: 10)
  - [ ] `POST /api/content-blocks/import`
  - [ ] Upload fichier Word ou texte
  - [ ] Parser et découper en blocs (par heading ou séparateur)
  - [ ] Preview avant confirmation
  - [ ] Attribution catégorie/tags en masse

- [ ] **Task 11: UI Content Library** (AC: 1, 2, 3)
  - [ ] Créer `ContentLibraryPage.tsx`
  - [ ] Liste blocs avec cards
  - [ ] Sidebar filtres (catégorie, tags)
  - [ ] Input recherche
  - [ ] Preview contenu

- [ ] **Task 12: UI Insertion Panel** (AC: 4, 8)
  - [ ] Panel latéral dans ProposalEditor
  - [ ] Tab "Suggestions" avec blocs recommandés
  - [ ] Tab "Recherche" pour chercher manuellement
  - [ ] Bouton "Insérer" sur chaque bloc
  - [ ] Preview au hover

- [ ] **Task 13: Tests** (AC: 1-10)
  - [ ] Tests API CRUD
  - [ ] Tests recherche full-text
  - [ ] Tests extraction
  - [ ] Tests suggestions

## Dev Notes

### Architecture

```text
apps/api/src/modules/content-library/
├── blocks.controller.ts
├── blocks.service.ts
├── blocks.routes.ts
├── search.service.ts
├── suggestions.service.ts
├── import.service.ts
└── index.ts

apps/web/src/pages/content-library/
├── ContentLibraryPage.tsx
├── ContentBlockCard.tsx
├── ContentBlockEditor.tsx
├── ImportModal.tsx
└── index.ts

apps/web/src/components/proposals/
├── ContentInsertionPanel.tsx
├── SuggestionsList.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum ContentCategory {
  ORG_PRESENTATION
  METHODOLOGY
  CV
  REFERENCES
  INDICATORS
  BUDGET_NOTES
  RISK_ANALYSIS
  OTHER
}

model ContentBlock {
  id          String          @id @default(uuid())
  title       String
  content     String          @db.Text
  category    ContentCategory
  tags        String[]

  usageCount  Int             @default(0)
  version     Int             @default(1)

  sourceProposalId String?
  sourceProposal   Proposal?   @relation(fields: [sourceProposalId], references: [id])
  sourceSectionId  String?

  createdById String
  createdBy   User            @relation(fields: [createdById], references: [id])
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  versions    ContentBlockVersion[]
  usages      BlockUsage[]

  @@index([category])
  @@index([tags])
}

model ContentBlockVersion {
  id        String       @id @default(uuid())
  blockId   String
  block     ContentBlock @relation(fields: [blockId], references: [id])
  version   Int
  content   String       @db.Text
  createdById String
  createdBy User         @relation(fields: [createdById], references: [id])
  createdAt DateTime     @default(now())

  @@unique([blockId, version])
}

model BlockUsage {
  id          String       @id @default(uuid())
  blockId     String
  block       ContentBlock @relation(fields: [blockId], references: [id])
  proposalId  String
  proposal    Proposal     @relation(fields: [proposalId], references: [id])
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  usedAt      DateTime     @default(now())

  @@index([blockId])
  @@index([proposalId])
}
```

### Catégories et Exemples

| Catégorie | Description | Exemples |
|-----------|-------------|----------|
| ORG_PRESENTATION | Présentation de l'ONG | Mission, historique, valeurs |
| METHODOLOGY | Méthodologies standards | Approche participative, suivi-évaluation |
| CV | CV types de l'équipe | Coordinateur, Expert technique |
| REFERENCES | Références projets | Projets similaires réalisés |
| INDICATORS | Indicateurs types | Indicateurs santé, éducation |
| BUDGET_NOTES | Notes budgétaires | Justifications coûts unitaires |
| RISK_ANALYSIS | Analyses de risque | Matrice risques types |

### Suggestions Algorithm

```ts
async function getSuggestions(sectionTitle: string, category?: ContentCategory): Promise<ContentBlock[]> {
  // Extraire mots-clés du titre
  const keywords = extractKeywords(sectionTitle);

  // Chercher blocs matching
  const blocks = await prisma.contentBlock.findMany({
    where: {
      OR: [
        { title: { search: keywords.join(' & ') } },
        { content: { search: keywords.join(' & ') } },
        { tags: { hasSome: keywords } },
      ],
      category: category || undefined,
    },
    orderBy: [
      { usageCount: 'desc' },
      { updatedAt: 'desc' },
    ],
    take: 5,
  });

  return blocks;
}

function extractKeywords(text: string): string[] {
  // Supprimer mots vides, normaliser
  const stopWords = ['de', 'la', 'le', 'du', 'des', 'et', 'ou', 'a', 'à'];
  return text
    .toLowerCase()
    .split(/\s+/)
    .filter(w => w.length > 2 && !stopWords.includes(w));
}
```

## Testing

### Localisation

- `apps/api/tests/content-blocks.test.ts`
- `apps/web/src/pages/content-library/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create block | Création avec catégorie et tags |
| Search fulltext | Recherche dans contenu |
| Filter category | Filtre par catégorie |
| Filter tags | Filtre par tags multiples |
| Extract from proposal | Bloc extrait correctement |
| Insert in proposal | Contenu inséré et compteur incrémenté |
| Suggestions | Blocs pertinents retournés |
| Import Word | Blocs créés depuis document |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
