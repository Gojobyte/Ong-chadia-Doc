# Story 6.6: Proposal Tracking & Pipeline

## Status: Approved

## Story

**As a** directeur,
**I want** suivre l'état des propositions soumises,
**so that** j'aie une visibilité sur le pipeline de financement.

## Acceptance Criteria

1. Dashboard propositions avec vue Kanban par statut
2. Timeline des étapes clés par proposition
3. Montants en jeu agrégés par statut (pipeline financier)
4. Taux de succès historique (propositions acceptées / soumises)
5. Alertes dates importantes (deadline soumission, réponse attendue)
6. Notes de suivi post-soumission
7. Liaison automatique avec projet créé si proposition acceptée
8. Analyse des raisons de rejet (catégorisation)
9. Rapports statistiques (par bailleur, secteur, période)
10. Export du pipeline au format Excel

## Tasks / Subtasks

- [ ] **Task 1: Statuts Avancés Proposal** (AC: 1)
  - [ ] Étendre enum: SUBMITTED, UNDER_REVIEW, ACCEPTED, REJECTED, WITHDRAWN
  - [ ] Ajouter champs: submittedAt, expectedResponseDate, actualResponseDate
  - [ ] `PATCH /api/proposals/:id/status` avec metadata

- [ ] **Task 2: Dashboard Pipeline** (AC: 1, 3)
  - [ ] `GET /api/proposals/pipeline` - Stats agrégées
  - [ ] Compteur et montants par statut
  - [ ] Total pipeline (soumis + en évaluation)
  - [ ] Graphique funnel

- [ ] **Task 3: Vue Kanban** (AC: 1)
  - [ ] Créer `ProposalKanbanPage.tsx`
  - [ ] Colonnes: Brouillon, Soumis, En évaluation, Accepté, Rejeté
  - [ ] Drag & drop pour changer statut
  - [ ] Filtres par période, bailleur

- [ ] **Task 4: Timeline Proposition** (AC: 2)
  - [ ] Créer model `ProposalEvent` (proposalId, type, date, description, userId)
  - [ ] Events: CREATED, SUBMITTED, RESPONSE_RECEIVED, ACCEPTED, REJECTED
  - [ ] `GET /api/proposals/:id/timeline`
  - [ ] UI timeline verticale

- [ ] **Task 5: Calcul Taux de Succès** (AC: 4)
  - [ ] `GET /api/proposals/stats/success-rate`
  - [ ] Filtres: période, bailleur, secteur
  - [ ] Calcul: (ACCEPTED / (ACCEPTED + REJECTED)) * 100
  - [ ] Évolution dans le temps

- [ ] **Task 6: Alertes et Rappels** (AC: 5)
  - [ ] Alerte J-7 avant deadline soumission
  - [ ] Alerte si réponse attendue dépassée
  - [ ] Job quotidien pour check dates
  - [ ] Notifications in-app + email

- [ ] **Task 7: Notes de Suivi** (AC: 6)
  - [ ] Ajouter section "Suivi post-soumission" sur proposal
  - [ ] Champs: contacts bailleur, échanges, questions
  - [ ] Historique des interactions
  - [ ] Rappels de follow-up

- [ ] **Task 8: Liaison Projet** (AC: 7)
  - [ ] Ajouter champ projectId sur Proposal
  - [ ] Workflow: ACCEPTED → Créer projet ou lier existant
  - [ ] Pré-remplir projet depuis données proposal
  - [ ] Lien bidirectionnel affichable

- [ ] **Task 9: Analyse Rejets** (AC: 8)
  - [ ] Ajouter champ rejectionReason enum
  - [ ] Catégories: BUDGET, METHODOLOGY, ELIGIBILITY, CAPACITY, COMPETITION, OTHER
  - [ ] Commentaire libre obligatoire
  - [ ] Stats rejets par catégorie

- [ ] **Task 10: Rapports Statistiques** (AC: 9)
  - [ ] Page `ProposalReportsPage.tsx`
  - [ ] Graphiques par bailleur, secteur, année
  - [ ] Tendances temporelles
  - [ ] Comparaison périodes

- [ ] **Task 11: Export Pipeline** (AC: 10)
  - [ ] `GET /api/proposals/export`
  - [ ] Colonnes: Titre, Bailleur, Montant, Statut, Soumis le, Réponse
  - [ ] Format Excel avec onglets par statut
  - [ ] Filtres appliqués

- [ ] **Task 12: Tests** (AC: 1-10)
  - [ ] Tests API pipeline stats
  - [ ] Tests calcul taux succès
  - [ ] Tests alertes
  - [ ] Tests UI kanban

## Dev Notes

### Architecture

```text
apps/api/src/modules/proposals/
├── tracking/
│   ├── tracking.controller.ts
│   ├── tracking.service.ts
│   ├── pipeline.service.ts
│   ├── alerts.service.ts
│   ├── stats.service.ts
│   └── index.ts
└── index.ts

apps/web/src/pages/proposals/
├── ProposalKanbanPage.tsx
├── ProposalPipelineDashboard.tsx
├── ProposalTimeline.tsx
├── ProposalReportsPage.tsx
├── RejectionAnalysis.tsx
└── index.ts
```

### Schéma Prisma Étendu

```prisma
enum ProposalStatus {
  DRAFT
  IN_PROGRESS
  IN_REVIEW
  FINALIZED
  SUBMITTED
  UNDER_EVALUATION  // Chez le bailleur
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum RejectionReason {
  BUDGET_ISSUES
  METHODOLOGY_WEAK
  ELIGIBILITY_CRITERIA
  CAPACITY_CONCERNS
  HIGH_COMPETITION
  OUT_OF_SCOPE
  INCOMPLETE
  OTHER
}

model Proposal {
  // ... champs existants

  // Tracking
  submittedAt          DateTime?
  expectedResponseDate DateTime?
  actualResponseDate   DateTime?

  // Résultat
  rejectionReason      RejectionReason?
  rejectionComment     String?

  // Liaison projet
  projectId            String?
  project              Project?  @relation(fields: [projectId], references: [id])

  // Montant demandé
  requestedAmount      Decimal?  @db.Decimal(15, 2)
  awardedAmount        Decimal?  @db.Decimal(15, 2)

  timeline             ProposalEvent[]
  followUps            ProposalFollowUp[]
}

model ProposalEvent {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id])
  type        String   // CREATED, SUBMITTED, STATUS_CHANGE, NOTE_ADDED, etc.
  description String?
  metadata    Json?
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())

  @@index([proposalId, createdAt])
}

model ProposalFollowUp {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id])
  type        String   // CALL, EMAIL, MEETING, NOTE
  content     String
  contactName String?
  dueDate     DateTime?
  isCompleted Boolean  @default(false)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())

  @@index([proposalId])
}
```

### Pipeline Stats Response

```ts
interface PipelineStats {
  byStatus: {
    status: ProposalStatus;
    count: number;
    totalAmount: number;
  }[];
  successRate: {
    accepted: number;
    rejected: number;
    rate: number;  // %
  };
  timeline: {
    avgDaysToResponse: number;
    avgDaysInReview: number;
  };
  byDonor: {
    donor: string;
    submitted: number;
    accepted: number;
    rejected: number;
    totalRequested: number;
    totalAwarded: number;
  }[];
}
```

### UI Kanban Layout

```text
┌───────────────────────────────────────────────────────────────────────┐
│ Pipeline Propositions                    [Filtres ▼] [Export]        │
│ Total pipeline: 2,500,000 EUR           Taux succès: 45%            │
├──────────┬──────────┬──────────┬──────────┬──────────┬──────────────┤
│ Brouillon│ Soumis   │En évalua.│ Accepté  │ Rejeté   │              │
│ (5)      │ (3)      │ (4)      │ (2)      │ (6)      │              │
├──────────┼──────────┼──────────┼──────────┼──────────┼──────────────┤
│ ┌──────┐ │ ┌──────┐ │ ┌──────┐ │ ┌──────┐ │ ┌──────┐ │              │
│ │Proj A│ │ │Proj D│ │ │Proj G│ │ │Proj K│ │ │Proj M│ │              │
│ │250k€ │ │ │180k€ │ │ │500k€ │ │ │300k€ │ │ │150k€ │ │              │
│ │AFD   │ │ │UE    │ │ │USAID │ │ │AFD   │ │ │ECHO  │ │              │
│ │J-15  │ │ │Soumis│ │ │Réponse│ │ │✓ Créer│ │ │Budget│ │              │
│ └──────┘ │ └──────┘ │ │ J-5   │ │ │projet │ │ └──────┘ │              │
│          │          │ └──────┘ │ └──────┘ │          │              │
│ ┌──────┐ │          │          │          │          │              │
│ │Proj B│ │          │          │          │          │              │
│ │...   │ │          │          │          │          │              │
│ └──────┘ │          │          │          │          │              │
└──────────┴──────────┴──────────┴──────────┴──────────┴──────────────┘
```

## Testing

### Localisation

- `apps/api/tests/proposal-tracking.test.ts`
- `apps/web/src/pages/proposals/__tests__/ProposalKanbanPage.test.tsx`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Pipeline stats | Compteurs corrects par statut |
| Success rate | Calcul taux succès |
| Status change | Transition SUBMITTED → UNDER_EVALUATION |
| Timeline event | Event créé au changement statut |
| Rejection reason | Raison enregistrée |
| Alert deadline | Alerte créée J-7 |
| Link to project | Liaison proposal → project |
| Export | Excel généré avec données |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
