# Story 6.1: Proposal Templates Library

## Status: Approved

## Story

**As a** rédacteur de propositions,
**I want** accéder à une bibliothèque de templates de propositions,
**so that** je puisse démarrer rapidement avec une structure adaptée au bailleur.

## Acceptance Criteria

1. Bibliothèque centralisée accessible depuis menu principal
2. Catégorisation par bailleur (UE, AFD, USAID, ECHO, Fondations)
3. Catégorisation par type (Note conceptuelle, Proposition complète, Budget, Annexes)
4. Preview du template avant utilisation (miniature + description)
5. Métadonnées affichées: auteur, date création, nombre d'utilisations, note moyenne
6. Recherche et filtres par bailleur, type, mots-clés
7. Indicateur "Approuvé" pour templates vérifiés par Admin
8. Versioning: voir historique des versions du template
9. Import de templates depuis fichiers Word/PDF existants
10. Tests d'intégration API et UI

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma ProposalTemplate** (AC: 1-8)
  - [ ] Créer model `ProposalTemplate` (id, name, description, donor, type, structure, isApproved, usageCount, version)
  - [ ] Créer enum `TemplateType`: CONCEPT_NOTE, FULL_PROPOSAL, BUDGET, ANNEX
  - [ ] Créer relation vers User (createdBy)
  - [ ] Migration Prisma

- [ ] **Task 2: API Templates CRUD** (AC: 1, 6)
  - [ ] `GET /api/proposal-templates` - Liste avec filtres
  - [ ] `GET /api/proposal-templates/:id` - Détails template
  - [ ] `POST /api/proposal-templates` - Créer (Staff+)
  - [ ] `PATCH /api/proposal-templates/:id` - Modifier
  - [ ] `DELETE /api/proposal-templates/:id` - Supprimer (Admin)

- [ ] **Task 3: Filtres et Recherche** (AC: 2, 3, 6)
  - [ ] Filtre par donor
  - [ ] Filtre par type
  - [ ] Recherche full-text dans name + description
  - [ ] Tri par: popularité, date, nom

- [ ] **Task 4: Versioning Templates** (AC: 8)
  - [ ] Créer model `TemplateVersion` (templateId, version, structure, createdAt, createdBy)
  - [ ] Incrémenter version à chaque modification majeure
  - [ ] `GET /api/proposal-templates/:id/versions`
  - [ ] Possibilité de restaurer une version

- [ ] **Task 5: Compteur Utilisation** (AC: 5)
  - [ ] Incrémenter usageCount à chaque utilisation
  - [ ] Tracker dans `TemplateUsage` (templateId, userId, proposalId, usedAt)
  - [ ] Afficher dans UI

- [ ] **Task 6: Import Word/PDF** (AC: 9)
  - [ ] Endpoint `POST /api/proposal-templates/import`
  - [ ] Parser DOCX avec mammoth
  - [ ] Extraire structure (headings → sections)
  - [ ] Créer template depuis structure extraite
  - [ ] Preview avant confirmation

- [ ] **Task 7: Seed Templates Standards** (AC: 2, 7)
  - [ ] Créer fichier `prisma/seed-proposal-templates.ts`
  - [ ] Template Note Conceptuelle générique
  - [ ] Template Proposition UE
  - [ ] Template Proposition AFD
  - [ ] Marquer comme approuvés

- [ ] **Task 8: UI Bibliothèque Templates** (AC: 1, 4, 5)
  - [ ] Créer `TemplatesLibraryPage.tsx`
  - [ ] Grille de cards avec preview
  - [ ] Badge "Approuvé" si isApproved
  - [ ] Stats: utilisations, auteur, date
  - [ ] Bouton "Utiliser ce template"

- [ ] **Task 9: UI Filtres** (AC: 2, 3, 6)
  - [ ] Sidebar/tabs par bailleur
  - [ ] Dropdown type de document
  - [ ] Input recherche
  - [ ] Compteurs par catégorie

- [ ] **Task 10: Tests** (AC: 10)
  - [ ] Tests API CRUD
  - [ ] Tests filtres
  - [ ] Tests import DOCX
  - [ ] Tests UI

## Dev Notes

### Architecture

```text
apps/api/src/modules/proposals/
├── templates/
│   ├── templates.controller.ts
│   ├── templates.service.ts
│   ├── templates.routes.ts
│   ├── import.service.ts
│   └── index.ts
└── index.ts

apps/web/src/pages/proposals/
├── TemplatesLibraryPage.tsx
├── TemplateCard.tsx
├── TemplatePreview.tsx
├── ImportTemplateModal.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum ProposalTemplateType {
  CONCEPT_NOTE
  FULL_PROPOSAL
  BUDGET
  ANNEX
}

model ProposalTemplate {
  id          String               @id @default(uuid())
  name        String
  description String?
  donor       String?              // UE, AFD, USAID, etc. ou null si générique
  type        ProposalTemplateType
  structure   Json                 // Définition des sections
  thumbnail   String?              // URL preview image

  isApproved  Boolean              @default(false)
  approvedById String?
  approvedAt  DateTime?

  usageCount  Int                  @default(0)
  version     Int                  @default(1)

  createdById String
  createdBy   User                 @relation(fields: [createdById], references: [id])
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  versions    TemplateVersion[]
  usages      TemplateUsage[]
  proposals   Proposal[]

  @@index([donor, type])
  @@index([isApproved])
}

model TemplateVersion {
  id         String           @id @default(uuid())
  templateId String
  template   ProposalTemplate @relation(fields: [templateId], references: [id])
  version    Int
  structure  Json
  changelog  String?
  createdById String
  createdBy  User             @relation(fields: [createdById], references: [id])
  createdAt  DateTime         @default(now())

  @@unique([templateId, version])
  @@index([templateId])
}

model TemplateUsage {
  id         String           @id @default(uuid())
  templateId String
  template   ProposalTemplate @relation(fields: [templateId], references: [id])
  userId     String
  user       User             @relation(fields: [userId], references: [id])
  proposalId String?
  usedAt     DateTime         @default(now())

  @@index([templateId])
}
```

### Structure Template

```ts
interface TemplateStructure {
  sections: TemplateSection[];
  metadata: {
    requiredFields: string[];
    maxPages?: number;
    language: string;
  };
}

interface TemplateSection {
  id: string;
  title: string;
  order: number;
  required: boolean;
  description?: string;     // Instructions pour le rédacteur
  placeholder?: string;     // Texte exemple
  constraints?: {
    minWords?: number;
    maxWords?: number;
    maxCharacters?: number;
  };
  subsections?: TemplateSection[];
}
```

### Import DOCX

```ts
import mammoth from 'mammoth';

async function importFromDocx(file: Buffer): Promise<TemplateStructure> {
  const result = await mammoth.convertToHtml({ buffer: file });
  const html = result.value;

  // Parser HTML pour extraire structure
  const $ = cheerio.load(html);
  const sections: TemplateSection[] = [];

  $('h1, h2, h3').each((i, el) => {
    sections.push({
      id: generateId(),
      title: $(el).text(),
      order: i,
      required: false,
    });
  });

  return { sections, metadata: { requiredFields: [], language: 'fr' } };
}
```

## Testing

### Localisation

- `apps/api/tests/proposal-templates.test.ts`
- `apps/web/src/pages/proposals/__tests__/`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| List templates | Liste avec pagination |
| Filter by donor | Filtre par bailleur |
| Filter by type | Filtre par type document |
| Search | Recherche dans nom |
| Get details | Détails avec structure |
| Create template | Création par Staff |
| Import DOCX | Import et extraction structure |
| Version history | Liste versions affichée |
| Usage count | Compteur incrémenté |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
