# Story 6.5: Proposal Export & Submission

## Status: Approved

## Story

**As a** responsable soumission,
**I want** exporter la proposition dans les formats requis,
**so that** je puisse soumettre au bailleur selon ses exigences.

## Acceptance Criteria

1. Export PDF avec mise en page professionnelle (marges, police, en-têtes)
2. Export Word (.docx) éditable pour modifications finales
3. Export selon template spécifique bailleur si défini
4. Génération automatique de la table des matières
5. Numérotation des pages et en-têtes/pieds de page personnalisables
6. Inclusion automatique des annexes définies dans le template
7. Checklist de soumission interactive avant export final
8. Historique des versions exportées avec timestamps
9. Partage lien sécurisé pour relecture externe (token temporaire)
10. Archivage automatique de la version soumise

## Tasks / Subtasks

- [ ] **Task 1: Export PDF** (AC: 1, 4, 5)
  - [ ] Endpoint `GET /api/proposals/:id/export/pdf`
  - [ ] Utiliser Puppeteer ou @react-pdf/renderer
  - [ ] Générer HTML avec styles puis PDF
  - [ ] En-têtes: titre, numéro page
  - [ ] Table des matières générée automatiquement

- [ ] **Task 2: Export Word** (AC: 2)
  - [ ] Endpoint `GET /api/proposals/:id/export/docx`
  - [ ] Utiliser librairie `docx`
  - [ ] Convertir structure vers DOCX
  - [ ] Préserver formatage (titres, listes, tableaux)
  - [ ] Inclure styles appropriés

- [ ] **Task 3: Templates Bailleur Spécifiques** (AC: 3)
  - [ ] Ajouter champ `exportTemplate` sur ProposalTemplate
  - [ ] Templates spécifiques: UE (format spécial), AFD, etc.
  - [ ] Appliquer formatage spécifique si défini
  - [ ] Fallback vers template générique

- [ ] **Task 4: Table des Matières** (AC: 4)
  - [ ] Générer TOC depuis structure sections
  - [ ] Numérotation hiérarchique (1, 1.1, 1.1.1)
  - [ ] Liens cliquables dans PDF
  - [ ] Option inclure/exclure certaines sections

- [ ] **Task 5: En-têtes et Pieds de Page** (AC: 5)
  - [ ] Configuration: logo, titre, pagination
  - [ ] Variables: `{{titre}}`, `{{page}}`, `{{totalPages}}`
  - [ ] Différencier première page si besoin
  - [ ] Preview avant export

- [ ] **Task 6: Gestion Annexes** (AC: 6)
  - [ ] Lister annexes requises depuis template
  - [ ] Upload des annexes sur la proposal
  - [ ] Fusion PDF: document principal + annexes
  - [ ] Numérotation continue

- [ ] **Task 7: Checklist Soumission** (AC: 7)
  - [ ] Créer model ou structure pour checklist
  - [ ] Items: sections complètes, annexes présentes, budget validé, etc.
  - [ ] UI checklist interactive
  - [ ] Bloquer export si items critiques non cochés
  - [ ] Commentaires par item

- [ ] **Task 8: Historique Exports** (AC: 8)
  - [ ] Créer model `ProposalExport` (proposalId, format, version, exportedAt, exportedBy, fileUrl)
  - [ ] Stocker chaque export
  - [ ] Numérotation version automatique
  - [ ] Accès historique downloads

- [ ] **Task 9: Partage Externe** (AC: 9)
  - [ ] Endpoint `POST /api/proposals/:id/share-link`
  - [ ] Générer token unique avec expiration (7 jours)
  - [ ] Page publique `/shared/proposals/:token`
  - [ ] Read-only, pas de download optionnel
  - [ ] Logging des accès
  - [ ] Révocation possible

- [ ] **Task 10: Archivage Version Soumise** (AC: 10)
  - [ ] Marquer export comme "submitted" version
  - [ ] Gel de la version (non modifiable)
  - [ ] Dupliquer pour modifications ultérieures
  - [ ] Mettre à jour status proposal → SUBMITTED

- [ ] **Task 11: UI Export** (AC: 1-10)
  - [ ] Créer `ExportModal.tsx`
  - [ ] Options: format (PDF/DOCX), inclure annexes, preview
  - [ ] Checklist interactive
  - [ ] Progress indicator pendant génération
  - [ ] Download automatique

- [ ] **Task 12: Tests** (AC: 1-10)
  - [ ] Tests génération PDF
  - [ ] Tests génération DOCX
  - [ ] Tests checklist validation
  - [ ] Tests partage externe

## Dev Notes

### Architecture

```text
apps/api/src/modules/proposals/
├── export/
│   ├── export.controller.ts
│   ├── export.service.ts
│   ├── pdf-generator.service.ts
│   ├── docx-generator.service.ts
│   ├── toc-generator.service.ts
│   └── index.ts
├── sharing/
│   ├── sharing.controller.ts
│   ├── sharing.service.ts
│   └── index.ts
└── index.ts

apps/web/src/components/proposals/
├── ExportModal.tsx
├── SubmissionChecklist.tsx
├── ExportHistory.tsx
├── ShareLinkModal.tsx
└── index.ts
```

### Schéma Prisma

```prisma
model ProposalExport {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id])
  format      String   // pdf, docx
  version     Int
  fileUrl     String
  fileSize    Int?
  isSubmitted Boolean  @default(false)
  exportedById String
  exportedBy  User     @relation(fields: [exportedById], references: [id])
  exportedAt  DateTime @default(now())

  @@index([proposalId, version])
}

model ProposalShareLink {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id])
  token       String   @unique
  expiresAt   DateTime
  allowDownload Boolean @default(false)
  accessCount Int      @default(0)
  lastAccessAt DateTime?
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  revokedAt   DateTime?

  @@index([token])
}
```

### Checklist Structure

```ts
interface SubmissionChecklist {
  items: ChecklistItem[];
}

interface ChecklistItem {
  id: string;
  label: string;
  type: 'auto' | 'manual';
  required: boolean;
  checked: boolean;
  autoCheck?: () => boolean;  // Pour items auto-vérifiables
  comment?: string;
}

const defaultChecklist: ChecklistItem[] = [
  { id: '1', label: 'Toutes les sections obligatoires sont complètes', type: 'auto', required: true },
  { id: '2', label: 'Le budget est équilibré et validé', type: 'auto', required: true },
  { id: '3', label: 'Les annexes requises sont jointes', type: 'auto', required: true },
  { id: '4', label: 'Relecture orthographique effectuée', type: 'manual', required: false },
  { id: '5', label: 'Validation par le directeur', type: 'manual', required: true },
  { id: '6', label: 'Conformité format bailleur vérifiée', type: 'manual', required: true },
];
```

### PDF Generation avec Puppeteer

```ts
import puppeteer from 'puppeteer';

async function generatePdf(proposal: Proposal, options: PdfOptions): Promise<Buffer> {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();

  // Générer HTML complet
  const html = renderProposalToHtml(proposal, options);

  await page.setContent(html, { waitUntil: 'networkidle0' });

  const pdf = await page.pdf({
    format: 'A4',
    printBackground: true,
    margin: { top: '2cm', right: '2cm', bottom: '2cm', left: '2cm' },
    displayHeaderFooter: true,
    headerTemplate: `<div style="font-size:10px;text-align:center;width:100%">${proposal.title}</div>`,
    footerTemplate: `<div style="font-size:10px;text-align:center;width:100%">Page <span class="pageNumber"></span>/<span class="totalPages"></span></div>`,
  });

  await browser.close();
  return pdf;
}
```

### UI Export Modal

```text
┌─────────────────────────────────────────────────────────────┐
│ Exporter la proposition                              [X]    │
├─────────────────────────────────────────────────────────────┤
│ Format d'export:                                            │
│ ○ PDF (recommandé pour soumission)                          │
│ ● Word (.docx) (pour modifications finales)                 │
│                                                             │
│ Options:                                                    │
│ ☑ Inclure table des matières                               │
│ ☑ Inclure les annexes (3 fichiers)                         │
│ ☐ Inclure numéros de page                                  │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│ Checklist de soumission:                                    │
│ ✓ Toutes les sections obligatoires sont complètes          │
│ ✓ Le budget est équilibré                                  │
│ ✓ Les annexes requises sont jointes                        │
│ ☐ Relecture orthographique effectuée                       │
│ ☐ Validation par le directeur                              │
│                                                             │
│ ⚠️ 2 items requis non cochés                               │
├─────────────────────────────────────────────────────────────┤
│                                    [Annuler] [Exporter]     │
└─────────────────────────────────────────────────────────────┘
```

## Testing

### Localisation

- `apps/api/tests/proposal-export.test.ts`
- `apps/web/src/components/proposals/__tests__/ExportModal.test.tsx`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Export PDF | PDF généré avec contenu |
| Export DOCX | DOCX généré valide |
| TOC generated | Table des matières présente |
| With annexes | Annexes fusionnées |
| Checklist block | Export bloqué si requis non coché |
| Version tracking | Export loggé dans historique |
| Share link | Token généré et fonctionne |
| Share expired | Token expiré refusé |
| Mark submitted | Status mis à jour |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
