# Story 6.2: Template Creation & Management

## Status: Approved

## Story

**As a** Admin ou responsable qualité,
**I want** créer et gérer des templates de propositions,
**so that** l'équipe dispose de modèles à jour et conformes aux exigences bailleurs.

## Acceptance Criteria

1. Éditeur visuel de template avec définition de sections
2. Définition de sections obligatoires et optionnelles
3. Variables dynamiques supportées: `{{projet.nom}}`, `{{bailleur.nom}}`, `{{organisation.nom}}`, etc.
4. Instructions/guidelines par section (texte d'aide pour rédacteurs)
5. Contraintes par section: nombre de mots min/max, caractères max
6. Pièces jointes types associées au template (annexes standards)
7. Workflow d'approbation: Brouillon → En révision → Approuvé
8. Duplication de templates existants
9. Archivage de templates obsolètes (soft delete)
10. Historique complet des modifications

## Tasks / Subtasks

- [ ] **Task 1: API Template Management** (AC: 1, 2, 8, 9)
  - [ ] `POST /api/proposal-templates` - Créer template
  - [ ] `PATCH /api/proposal-templates/:id` - Modifier structure
  - [ ] `POST /api/proposal-templates/:id/duplicate` - Dupliquer
  - [ ] `POST /api/proposal-templates/:id/archive` - Archiver
  - [ ] Validation structure JSON

- [ ] **Task 2: Sections Management** (AC: 2, 4, 5)
  - [ ] Structure section: id, title, required, order, instructions, constraints
  - [ ] Validation contraintes (min < max, valeurs positives)
  - [ ] Support subsections (arborescence)
  - [ ] Réordonnancement drag & drop

- [ ] **Task 3: Variables Dynamiques** (AC: 3)
  - [ ] Définir liste variables supportées
  - [ ] Parser et valider variables dans placeholder
  - [ ] Documenter variables dans UI
  - [ ] Preview avec valeurs exemple

- [ ] **Task 4: Workflow Approbation** (AC: 7)
  - [ ] Ajouter champ `status`: DRAFT, PENDING_REVIEW, APPROVED, ARCHIVED
  - [ ] `POST /api/proposal-templates/:id/submit-review` - Soumettre
  - [ ] `POST /api/proposal-templates/:id/approve` - Approuver (Admin)
  - [ ] `POST /api/proposal-templates/:id/reject` - Rejeter avec commentaire
  - [ ] Notifications aux parties prenantes

- [ ] **Task 5: Pièces Jointes Types** (AC: 6)
  - [ ] Ajouter champ `attachments` sur template
  - [ ] Structure: { name, description, required, fileUrl? }
  - [ ] Upload fichiers modèles (ex: formulaire budget vide)
  - [ ] Afficher dans preview et lors de création proposal

- [ ] **Task 6: Historique Modifications** (AC: 10)
  - [ ] Logger chaque modification dans TemplateVersion
  - [ ] Changelog obligatoire pour modifications majeures
  - [ ] Diff entre versions (nice-to-have)
  - [ ] Restauration version précédente

- [ ] **Task 7: UI Template Builder** (AC: 1, 2, 4, 5)
  - [ ] Créer `TemplateBuilderPage.tsx`
  - [ ] Panel gauche: liste sections (drag & drop)
  - [ ] Panel droit: propriétés section sélectionnée
  - [ ] Boutons: Ajouter section, Sous-section, Supprimer
  - [ ] Preview en temps réel

- [ ] **Task 8: UI Section Editor** (AC: 2, 4, 5)
  - [ ] Input: Titre section
  - [ ] Checkbox: Obligatoire
  - [ ] Textarea: Instructions pour rédacteur
  - [ ] Inputs: Min words, Max words, Max chars
  - [ ] Textarea: Placeholder/exemple

- [ ] **Task 9: UI Variables Helper** (AC: 3)
  - [ ] Panel/modal liste des variables disponibles
  - [ ] Clic pour insérer dans champ actif
  - [ ] Description de chaque variable
  - [ ] Catégories: Projet, Organisation, Date, Bailleur

- [ ] **Task 10: UI Workflow Status** (AC: 7)
  - [ ] Badge statut sur template card
  - [ ] Boutons actions selon statut et rôle
  - [ ] Timeline historique approbation
  - [ ] Modal commentaire pour rejet

- [ ] **Task 11: Tests** (AC: 1-10)
  - [ ] Tests API CRUD
  - [ ] Tests workflow approbation
  - [ ] Tests validation structure
  - [ ] Tests UI builder

## Dev Notes

### Architecture

```text
apps/api/src/modules/proposals/templates/
├── templates.controller.ts     # Étendre
├── templates.service.ts        # Étendre
├── workflow.service.ts         # Gestion approbation
├── variables.service.ts        # Parsing variables
└── index.ts

apps/web/src/pages/proposals/
├── TemplateBuilderPage.tsx
├── SectionsList.tsx
├── SectionEditor.tsx
├── VariablesHelper.tsx
├── WorkflowActions.tsx
└── index.ts
```

### Schéma Section Complet

```ts
interface TemplateSection {
  id: string;
  title: string;
  order: number;
  required: boolean;

  // Instructions pour rédacteur
  instructions?: string;
  placeholder?: string;

  // Contraintes
  constraints?: {
    minWords?: number;
    maxWords?: number;
    maxCharacters?: number;
  };

  // Sous-sections
  subsections?: TemplateSection[];

  // Type de contenu
  contentType?: 'text' | 'table' | 'list' | 'mixed';
}
```

### Variables Supportées

| Variable | Description | Exemple |
|----------|-------------|---------|
| `{{projet.nom}}` | Nom du projet | "Amélioration santé..." |
| `{{projet.description}}` | Description projet | "Ce projet vise à..." |
| `{{organisation.nom}}` | Nom de l'ONG | "ONG Solidarité" |
| `{{organisation.adresse}}` | Adresse siège | "123 rue..." |
| `{{bailleur.nom}}` | Nom du bailleur | "AFD" |
| `{{date.jour}}` | Date du jour | "27 janvier 2025" |
| `{{date.annee}}` | Année courante | "2025" |
| `{{budget.total}}` | Budget total | "500,000 EUR" |
| `{{duree.mois}}` | Durée en mois | "24" |

### Workflow States

```text
DRAFT ─────► PENDING_REVIEW ─────► APPROVED
   ▲              │                    │
   │              │ reject             │ archive
   │              ▼                    ▼
   └──────── DRAFT (avec commentaires) ARCHIVED
```

### UI Template Builder Layout

```text
┌─────────────────────────────────────────────────────────────┐
│ Template: Note Conceptuelle UE          [Preview] [Sauver]  │
├───────────────────────┬─────────────────────────────────────┤
│ Sections              │ Propriétés: "1.2 Contexte"          │
│ ──────────────────   │ ───────────────────────────────────  │
│ ▼ 1. Résumé          │ Titre: [Contexte                   ] │
│   ├─ 1.1 Objectif    │ ☑ Section obligatoire               │
│   └─ 1.2 Contexte ◄──│                                     │
│ ▼ 2. Description     │ Instructions pour rédacteur:        │
│   ├─ 2.1 Activités   │ [Décrire le contexte local et      ]│
│   └─ 2.2 Résultats   │ [les besoins identifiés...         ]│
│ ▼ 3. Budget          │                                     │
│                      │ Contraintes:                        │
│ [+ Section]          │ Min: [100] Max: [500] mots          │
│ [+ Sous-section]     │                                     │
│                      │ Placeholder/Exemple:                │
│                      │ [{{projet.description}}             ]│
└───────────────────────┴─────────────────────────────────────┘
```

## Testing

### Localisation

- `apps/api/tests/template-builder.test.ts`
- `apps/web/src/pages/proposals/__tests__/TemplateBuilderPage.test.tsx`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create with sections | Création template avec structure |
| Add section | Ajout section fonctionne |
| Reorder sections | Drag & drop réordonne |
| Set required | Section marquée obligatoire |
| Set constraints | Contraintes enregistrées |
| Workflow submit | Passage à PENDING_REVIEW |
| Workflow approve | Admin peut approuver |
| Workflow reject | Rejet avec commentaire |
| Duplicate | Copie créée correctement |
| Variables parsed | Variables détectées dans placeholder |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
