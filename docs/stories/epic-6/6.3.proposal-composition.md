# Story 6.3: Proposal Composition

## Status: Approved

## Story

**As a** chargÃ© de projets,
**I want** composer une proposition Ã  partir d'un template,
**so that** je puisse rÃ©diger efficacement en respectant le format requis.

## Acceptance Criteria

1. CrÃ©ation de proposition depuis template sÃ©lectionnÃ© ou depuis zÃ©ro
2. Liaison optionnelle avec un appel d'offres (Epic 5)
3. Remplissage guidÃ© section par section avec instructions
4. Indicateur de complÃ©tion par section (%, rempli/non rempli)
5. Validation des contraintes (longueur, champs requis) en temps rÃ©el
6. Auto-save toutes les 30 secondes
7. Statuts: Brouillon, En cours, En rÃ©vision, FinalisÃ©
8. Collaboration multi-utilisateurs sur la mÃªme proposition
9. Commentaires et suggestions par section
10. Preview format final en temps rÃ©el

## Tasks / Subtasks

- [ ] **Task 1: SchÃ©ma Prisma Proposal** (AC: 1, 2, 7)
  - [ ] CrÃ©er model `Proposal` (id, templateId, opportunityId, title, status, content, createdById)
  - [ ] CrÃ©er enum `ProposalStatus`: DRAFT, IN_PROGRESS, IN_REVIEW, FINALIZED, SUBMITTED
  - [ ] Relation vers Opportunity (optionnel)
  - [ ] Migration Prisma

- [ ] **Task 2: API Proposals CRUD** (AC: 1, 6)
  - [ ] `GET /api/proposals` - Liste mes propositions
  - [ ] `POST /api/proposals` - CrÃ©er proposition
  - [ ] `GET /api/proposals/:id` - DÃ©tails avec contenu
  - [ ] `PATCH /api/proposals/:id` - Sauvegarder contenu
  - [ ] `DELETE /api/proposals/:id` - Supprimer brouillon

- [ ] **Task 3: CrÃ©ation depuis Template** (AC: 1)
  - [ ] `POST /api/proposals` avec templateId
  - [ ] Copier structure du template vers proposal
  - [ ] PrÃ©-remplir variables si opportunitÃ© liÃ©e
  - [ ] Initialiser toutes sections vides

- [ ] **Task 4: Liaison OpportunitÃ©** (AC: 2)
  - [ ] Champ opportunityId optionnel
  - [ ] PrÃ©-remplir: titre, bailleur, deadline
  - [ ] Remplacement variables: `{{bailleur.nom}}`, etc.
  - [ ] Afficher infos opportunitÃ© dans sidebar

- [ ] **Task 5: Contenu par Section** (AC: 3, 4)
  - [ ] Structure content: `{ sectionId: { content, wordCount, isComplete } }`
  - [ ] Calculer wordCount Ã  chaque modification
  - [ ] Marquer isComplete si contraintes respectÃ©es
  - [ ] Calculer % complÃ©tion global

- [ ] **Task 6: Validation Temps RÃ©el** (AC: 5)
  - [ ] VÃ©rifier minWords, maxWords, maxCharacters
  - [ ] VÃ©rifier sections required remplies
  - [ ] Afficher warnings/errors inline
  - [ ] Bloquer finalisation si erreurs

- [ ] **Task 7: Auto-save** (AC: 6)
  - [ ] Debounce 30 secondes sur modifications
  - [ ] PATCH silencieux
  - [ ] Indicateur "SauvegardÃ©" / "Sauvegarde..."
  - [ ] Gestion conflits si modif concurrente

- [ ] **Task 8: Workflow Statuts** (AC: 7)
  - [ ] Transitions autorisÃ©es: DRAFT â†’ IN_PROGRESS â†’ IN_REVIEW â†’ FINALIZED
  - [ ] `PATCH /api/proposals/:id/status`
  - [ ] Validation avant FINALIZED (toutes sections complÃ¨tes)
  - [ ] Historique changements statut

- [ ] **Task 9: Collaboration** (AC: 8)
  - [ ] Utiliser Yjs pour Ã©dition temps rÃ©el (cf Epic 8.4)
  - [ ] Ou: verrouillage par section (un Ã©diteur Ã  la fois)
  - [ ] Indicateur qui Ã©dite quoi
  - [ ] Gestion droits par collaborateur

- [ ] **Task 10: Commentaires par Section** (AC: 9)
  - [ ] CrÃ©er model `ProposalComment` (proposalId, sectionId, userId, content, resolved)
  - [ ] Sidebar commentaires par section
  - [ ] Mentions @user
  - [ ] RÃ©solution de commentaires

- [ ] **Task 11: UI Composition** (AC: 3, 4, 10)
  - [ ] CrÃ©er `ProposalEditorPage.tsx`
  - [ ] Sidebar: table des matiÃ¨res avec % complÃ©tion
  - [ ] Zone Ã©dition: section active avec Ã©diteur TipTap
  - [ ] Preview panel: rendu final en temps rÃ©el
  - [ ] Instructions au-dessus de chaque section

- [ ] **Task 12: Tests** (AC: 1-10)
  - [ ] Tests API CRUD
  - [ ] Tests crÃ©ation depuis template
  - [ ] Tests validation contraintes
  - [ ] Tests auto-save
  - [ ] Tests workflow

## Dev Notes

### Architecture

```text
apps/api/src/modules/proposals/
â”œâ”€â”€ proposals.controller.ts
â”œâ”€â”€ proposals.service.ts
â”œâ”€â”€ proposals.routes.ts
â”œâ”€â”€ comments.controller.ts
â”œâ”€â”€ comments.service.ts
â”œâ”€â”€ validation.service.ts
â””â”€â”€ index.ts

apps/web/src/pages/proposals/
â”œâ”€â”€ ProposalEditorPage.tsx
â”œâ”€â”€ SectionNavigation.tsx
â”œâ”€â”€ SectionEditor.tsx
â”œâ”€â”€ SectionComments.tsx
â”œâ”€â”€ ProposalPreview.tsx
â”œâ”€â”€ ValidationPanel.tsx
â””â”€â”€ index.ts
```

### SchÃ©ma Prisma

```prisma
enum ProposalStatus {
  DRAFT
  IN_PROGRESS
  IN_REVIEW
  FINALIZED
  SUBMITTED
}

model Proposal {
  id            String          @id @default(uuid())
  templateId    String?
  template      ProposalTemplate? @relation(fields: [templateId], references: [id])
  opportunityId String?
  opportunity   Opportunity?    @relation(fields: [opportunityId], references: [id])

  title         String
  status        ProposalStatus  @default(DRAFT)
  content       Json            // { sectionId: { content, wordCount, isComplete } }
  metadata      Json?           // DonnÃ©es additionnelles (budget, Ã©quipe, etc.)

  completionPercent Int         @default(0)

  createdById   String
  createdBy     User            @relation(fields: [createdById], references: [id])
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  collaborators ProposalCollaborator[]
  comments      ProposalComment[]
  exports       ProposalExport[]

  @@index([status])
  @@index([createdById])
  @@index([opportunityId])
}

model ProposalCollaborator {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  role        String   // EDITOR, REVIEWER, VIEWER
  addedAt     DateTime @default(now())

  @@unique([proposalId, userId])
}

model ProposalComment {
  id          String   @id @default(uuid())
  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id])
  sectionId   String
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  content     String
  isResolved  Boolean  @default(false)
  resolvedById String?
  resolvedAt  DateTime?
  createdAt   DateTime @default(now())

  @@index([proposalId, sectionId])
}
```

### Content Structure

```ts
interface ProposalContent {
  [sectionId: string]: {
    content: string;        // HTML ou JSON TipTap
    wordCount: number;
    characterCount: number;
    isComplete: boolean;
    lastEditedBy?: string;
    lastEditedAt?: Date;
  };
}

function calculateCompletion(proposal: Proposal, template: ProposalTemplate): number {
  const requiredSections = template.structure.sections.filter(s => s.required);
  const completedSections = requiredSections.filter(s =>
    proposal.content[s.id]?.isComplete
  );
  return Math.round((completedSections.length / requiredSections.length) * 100);
}
```

### UI Layout

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Proposition: Projet SantÃ© Sahel    [Preview] [Commentaires] [Sauver]â”‚
â”‚ Statut: En cours  |  ComplÃ©tion: 65%  |  Deadline: J-15            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Navigation      â”‚ Section: 2.1 Description des activitÃ©s            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ âœ“ 1. RÃ©sumÃ©    â”‚ â„¹ï¸ DÃ©crivez les activitÃ©s prÃ©vues avec un niveau  â”‚
â”‚   âœ“ 1.1 (100%) â”‚    de dÃ©tail suffisant. Max 1000 mots.            â”‚
â”‚   âœ“ 1.2 (100%) â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ âš  2. Descriptionâ”‚ [                                                ]â”‚
â”‚   âœ“ 2.1 (80%)  â”‚ [   Ã‰diteur TipTap avec toolbar                  ]â”‚
â”‚   â—‹ 2.2 (0%)   â”‚ [                                                ]â”‚
â”‚ â—‹ 3. Budget    â”‚ [                                                ]â”‚
â”‚   â—‹ 3.1 (0%)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                â”‚ ğŸ“Š 823/1000 mots  |  Section complÃ¨te: âœ“          â”‚
â”‚ [+ Collabo]    â”‚                                                   â”‚
â”‚ ğŸ‘¤ Marie (edit)â”‚ ğŸ’¬ Commentaires (2)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing

### Localisation

- `apps/api/tests/proposals.test.ts`
- `apps/web/src/pages/proposals/__tests__/ProposalEditorPage.test.tsx`

### Framework

- Jest + Supertest
- Vitest + React Testing Library

### Cas Ã  couvrir

| Test | Description |
|------|-------------|
| Create from template | Structure copiÃ©e correctement |
| Create with opportunity | Variables prÃ©-remplies |
| Save content | Contenu sauvegardÃ© |
| Auto-save | Sauvegarde aprÃ¨s 30s |
| Validation min words | Warning si < minimum |
| Validation max words | Error si > maximum |
| Completion calc | Pourcentage correct |
| Status transition | IN_PROGRESS â†’ IN_REVIEW |
| Add comment | Commentaire ajoutÃ© |
| Resolve comment | Commentaire rÃ©solu |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | CrÃ©ation initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
