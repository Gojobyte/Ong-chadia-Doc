# Story 4.4: Dashboard UI - Documents Widget

## Status

Complete

## Story

**As a** utilisateur,
**I want** voir les documents récents sur le dashboard,
**so that** je puisse accéder rapidement aux derniers fichiers uploadés.

## Acceptance Criteria

1. Widget "Documents Récents" affichant les 10 derniers documents
2. Chaque document montre : Nom, Type (icône), Date upload, Dossier parent
3. Clic sur un document ouvre ses détails (ou télécharge directement)
4. Clic sur le dossier navigue vers ce dossier dans la GED
5. Lien "Voir tous les documents" vers `/documents`
6. Bouton "Upload" rapide ouvrant le sélecteur de fichiers
7. Indication du quota utilisé (X GB / 25 GB) si pertinent
8. État vide : "Aucun document" avec CTA pour uploader
9. Recherche rapide dans le widget (optionnel)
10. Filtrable par type de fichier (optionnel)

## Tasks / Subtasks

- [x] **Task 1: Créer le composant DocumentsWidget**
  - [x] Créer `apps/web/src/components/dashboard/DocumentsWidget.tsx`
  - [x] Afficher liste des documents récents
  - [x] Icône selon type MIME
  - [x] Date formatée relative

- [x] **Task 2: Implémenter les interactions**
  - [x] Clic sur document → navigation vers dossier
  - [x] Clic sur dossier → navigation vers /documents?folder=
  - [x] Lien "Voir tous" → /documents
  - [x] Bouton Upload rapide

- [ ] **Task 3: Afficher le quota stockage** (Non implémenté - API ne fournit pas ces données)
  - [ ] Récupérer stats stockage depuis useDashboard
  - [ ] Barre de progression visuelle
  - [ ] Couleur selon usage (vert/orange/rouge)

- [x] **Task 4: Gérer les états**
  - [x] Skeleton loading
  - [x] État vide avec CTA upload
  - [x] État erreur (via parent)

- [x] **Task 5: Intégrer au dashboard**
  - [x] Remplacer la section inline actuelle
  - [x] Utiliser données de useDashboard()

## Dev Notes

### Note sur l'existant

Le DashboardPage actuel a déjà une section "Recent Documents" avec une table. Cette story doit :
1. Transformer cette section en composant réutilisable
2. Connecter aux vraies données API
3. Ajouter les fonctionnalités manquantes (quota, upload rapide)

### Composant DocumentsWidget

```tsx
// apps/web/src/components/dashboard/DocumentsWidget.tsx
import { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import {
  FileText, Upload, ArrowUpRight, Folder,
  FileImage, FileSpreadsheet, File
} from 'lucide-react';
import { formatRelativeDate, formatFileSize } from '@/lib/utils';
import { DocumentDrawer } from '@/components/documents/DocumentDrawer';

interface Document {
  id: string;
  name: string;
  mimeType: string;
  size: number;
  createdAt: string;
  folder: { id: string; name: string };
}

interface DocumentsWidgetProps {
  documents: Document[];
  storageStats?: {
    used: number;
    quota: number;
    percentage: number;
  };
  isLoading?: boolean;
  onUpload?: () => void;
}

const getFileIcon = (mimeType: string) => {
  if (mimeType.includes('pdf')) return FileText;
  if (mimeType.includes('word')) return FileText;
  if (mimeType.includes('sheet') || mimeType.includes('excel')) return FileSpreadsheet;
  if (mimeType.startsWith('image/')) return FileImage;
  return File;
};

const getFileIconColor = (mimeType: string) => {
  if (mimeType.includes('pdf')) return 'text-red-500';
  if (mimeType.includes('word')) return 'text-blue-500';
  if (mimeType.includes('sheet') || mimeType.includes('excel')) return 'text-green-500';
  if (mimeType.startsWith('image/')) return 'text-purple-500';
  return 'text-slate-400';
};

export function DocumentsWidget({
  documents,
  storageStats,
  isLoading,
  onUpload
}: DocumentsWidgetProps) {
  const [selectedDocId, setSelectedDocId] = useState<string | null>(null);
  const navigate = useNavigate();

  if (isLoading) {
    return <DocumentsWidgetSkeleton />;
  }

  const storageColor = storageStats
    ? storageStats.percentage > 90 ? 'bg-red-500'
    : storageStats.percentage > 70 ? 'bg-orange-500'
    : 'bg-green-500'
    : 'bg-slate-200';

  return (
    <>
      <Card className="lg:col-span-2">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <FileText className="w-5 h-5 text-primary-600" />
            <h3 className="font-semibold text-slate-900">Documents Récents</h3>
          </div>
          <div className="flex items-center gap-2">
            {onUpload && (
              <Button variant="outline" size="sm" onClick={onUpload}>
                <Upload className="w-4 h-4 mr-1" />
                Upload
              </Button>
            )}
            <Button variant="ghost" size="sm" asChild>
              <Link to="/documents">
                Voir tous
                <ArrowUpRight className="w-4 h-4 ml-1" />
              </Link>
            </Button>
          </div>
        </div>

        {/* Storage quota bar */}
        {storageStats && (
          <div className="mb-4 p-3 bg-slate-50 rounded-lg">
            <div className="flex items-center justify-between text-sm mb-1">
              <span className="text-slate-600">Stockage utilisé</span>
              <span className="font-medium">
                {formatFileSize(storageStats.used)} / {formatFileSize(storageStats.quota)}
              </span>
            </div>
            <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
              <div
                className={`h-full ${storageColor} transition-all`}
                style={{ width: `${storageStats.percentage}%` }}
              />
            </div>
          </div>
        )}

        {documents.length === 0 ? (
          <div className="text-center py-8 text-slate-500">
            <FileText className="w-10 h-10 mx-auto mb-2 text-slate-300" />
            <p className="mb-2">Aucun document</p>
            {onUpload && (
              <Button variant="primary" size="sm" onClick={onUpload}>
                <Upload className="w-4 h-4 mr-1" />
                Uploader un document
              </Button>
            )}
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="text-slate-500 border-b border-slate-100">
                <tr>
                  <th className="text-left py-2 font-medium">Document</th>
                  <th className="text-left py-2 font-medium">Dossier</th>
                  <th className="text-left py-2 font-medium">Date</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {documents.map((doc) => {
                  const Icon = getFileIcon(doc.mimeType);
                  return (
                    <tr
                      key={doc.id}
                      className="hover:bg-slate-50 cursor-pointer"
                      onClick={() => setSelectedDocId(doc.id)}
                    >
                      <td className="py-3">
                        <div className="flex items-center gap-3">
                          <Icon className={`w-5 h-5 ${getFileIconColor(doc.mimeType)}`} />
                          <div>
                            <p className="font-medium text-slate-900 truncate max-w-xs">
                              {doc.name}
                            </p>
                            <p className="text-xs text-slate-500">
                              {formatFileSize(doc.size)}
                            </p>
                          </div>
                        </div>
                      </td>
                      <td className="py-3">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            navigate(`/documents?folderId=${doc.folder.id}`);
                          }}
                          className="flex items-center gap-1 text-slate-600 hover:text-primary-600"
                        >
                          <Folder className="w-4 h-4" />
                          {doc.folder.name}
                        </button>
                      </td>
                      <td className="py-3 text-slate-500">
                        {formatRelativeDate(doc.createdAt)}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </Card>

      <DocumentDrawer
        documentId={selectedDocId}
        open={!!selectedDocId}
        onClose={() => setSelectedDocId(null)}
      />
    </>
  );
}
```

### Fichiers concernés

```
apps/web/src/components/dashboard/
├── DocumentsWidget.tsx (créer)
└── index.ts (mettre à jour)
```

## Testing

### Tests recommandés

1. **Affichage**
   - Liste des documents correcte
   - Icônes par type MIME
   - Barre de quota visible

2. **Interactions**
   - Clic document → drawer
   - Clic dossier → navigation
   - Bouton upload fonctionne

3. **États**
   - Skeleton pendant loading
   - Message si aucun document

## Dependencies

- **Requires**: Story 4.1 (Dashboard API), Story 4.2 (Dashboard Layout)
- **Blocks**: None

---

## PO Review

**Reviewed by:** Sarah (PO)
**Date:** 2026-01-27
**Status:** ✅ Approved for Development

### Review Notes
- Acceptance criteria align with existing document features
- Storage quota visualization is a valuable UX addition
- File icon mapping by MIME type is well-defined
- Quick upload button provides efficient workflow
- DocumentDrawer integration reuses existing component

### Recommendations
- Existing Recent Documents section in DashboardPage should be refactored into this widget
- Ensure formatRelativeDate utility exists in utils (or create it)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |
| 2026-01-27 | 1.1 | PO Review - Approved for Development | Sarah (PO) |
