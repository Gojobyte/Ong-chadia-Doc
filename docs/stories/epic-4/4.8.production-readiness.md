# Story 4.8: Production Readiness

## Status

Complete

## Story

**As a** développeur,
**I want** préparer l'application pour la production,
**so that** le déploiement soit sécurisé et monitoré.

## Acceptance Criteria

1. Variables d'environnement production configurées (DB, Storage, JWT secrets)
2. CORS configuré correctement (domaines autorisés)
3. Rate limiting sur les endpoints API sensibles (login, register)
4. Helmet.js configuré pour headers de sécurité
5. Logs structurés (JSON) pour debugging production
6. Health check endpoint `GET /api/health`
7. Build production optimisé (minification, tree-shaking)
8. Documentation déploiement dans README
9. Seed de données initiales (Super-Admin, dossiers par défaut)
10. Backup manuel de la base de données documenté

## Tasks / Subtasks

- [x] **Task 1: Configurer les variables d'environnement**
  - [x] Créer `.env.production.example`
  - [x] Documenter toutes les variables requises
  - [x] Vérifier que les secrets ne sont pas commités

- [x] **Task 2: Sécuriser CORS**
  - [x] Configurer CORS avec liste blanche de domaines (via CORS_ORIGIN env var)
  - [x] Différencier config dev/prod
  - [x] Tester depuis domaine différent

- [x] **Task 3: Implémenter Rate Limiting**
  - [x] Installer `express-rate-limit`
  - [x] Limiter `/api/auth/login` (5 req/min par IP)
  - [x] Limiter `/api/auth/register` (3 req/min par IP)
  - [x] Headers RateLimit-* dans les réponses (standardHeaders: true)

- [x] **Task 4: Configurer Helmet.js**
  - [x] Installer helmet
  - [x] Activer dans app.ts
  - [x] Configurer CSP pour production

- [x] **Task 5: Implémenter les logs structurés**
  - [x] Installer pino et pino-pretty
  - [x] Format JSON en production
  - [x] Niveaux : error, warn, info, debug
  - [ ] Rotation des logs (à configurer via système externe)

- [x] **Task 6: Créer endpoint Health Check**
  - [x] `GET /api/health` retourne { status: 'ok', timestamp }
  - [x] Vérifier connexion DB
  - [x] Vérifier connexion Supabase Storage
  - [x] Endpoints additionnels: /api/health/live, /api/health/ready

- [x] **Task 7: Optimiser le build**
  - [x] Vérifier configuration Vite pour production (lazy loading)
  - [x] Activer minification et tree-shaking
  - [x] Analyser taille du bundle
  - [x] Lazy loading des routes (existant dans App.tsx)

- [x] **Task 8: Créer script de seed**
  - [x] Seed Super-Admin par défaut
  - [x] Seed dossiers racine par défaut (Projets, Templates, Archives)
  - [x] Seed tags par défaut
  - [x] Script idempotent (ne crée pas de doublons)

- [x] **Task 9: Documenter le déploiement**
  - [x] README avec instructions de déploiement
  - [x] Prérequis (Node, PostgreSQL, Supabase)
  - [x] Commandes de build et démarrage
  - [x] Procédure de backup DB

## Dev Notes

### Variables d'environnement production

```env
# .env.production.example

# Database
DATABASE_URL=postgresql://user:password@host:5432/ong_chadia_prod

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_KEY=eyJ...
SUPABASE_BUCKET=documents

# JWT
JWT_SECRET=<générer avec openssl rand -base64 64>
JWT_EXPIRES_IN=7d

# Server
PORT=3001
NODE_ENV=production
CORS_ORIGIN=https://app.ong-chadia.org

# Logging
LOG_LEVEL=info
```

### Rate Limiting

```typescript
// apps/api/src/middleware/rateLimit.ts
import rateLimit from 'express-rate-limit';

export const loginLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 minute
  max: 5,
  message: { error: 'Trop de tentatives de connexion. Réessayez dans 1 minute.' },
  standardHeaders: true,
  legacyHeaders: false,
});

export const registerLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 3,
  message: { error: 'Trop de demandes d\'inscription. Réessayez dans 1 minute.' },
});

// Dans auth.routes.ts
router.post('/login', loginLimiter, authController.login);
router.post('/register', registerLimiter, authController.register);
```

### Health Check

```typescript
// apps/api/src/routes/health.routes.ts
import { Router } from 'express';
import { prisma } from '../config/database';
import { supabase } from '../config/supabase.config';

const router = Router();

router.get('/health', async (req, res) => {
  try {
    // Check DB
    await prisma.$queryRaw`SELECT 1`;

    // Check Supabase
    const { error } = await supabase.storage.from('documents').list('', { limit: 1 });
    if (error) throw error;

    res.json({
      status: 'ok',
      timestamp: new Date().toISOString(),
      services: {
        database: 'ok',
        storage: 'ok',
      },
    });
  } catch (error) {
    res.status(503).json({
      status: 'error',
      timestamp: new Date().toISOString(),
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
});

export default router;
```

### Script de seed

```typescript
// prisma/seed.ts
import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcrypt';

const prisma = new PrismaClient();

async function main() {
  // Create Super Admin if not exists
  const adminEmail = 'admin@ong-chadia.org';
  const existingAdmin = await prisma.user.findUnique({
    where: { email: adminEmail },
  });

  if (!existingAdmin) {
    const hashedPassword = await bcrypt.hash('ChangeMe123!', 10);
    await prisma.user.create({
      data: {
        email: adminEmail,
        password: hashedPassword,
        firstName: 'Super',
        lastName: 'Admin',
        role: 'SUPER_ADMIN',
        isActive: true,
      },
    });
    console.log('✅ Super Admin created');
  }

  // Create default root folders if not exist
  const defaultFolders = ['Projets', 'Templates', 'Archives'];
  for (const name of defaultFolders) {
    const existing = await prisma.folder.findFirst({
      where: { name, parentId: null },
    });
    if (!existing) {
      await prisma.folder.create({
        data: { name, parentId: null },
      });
      console.log(`✅ Folder "${name}" created`);
    }
  }
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

### Fichiers concernés

```
apps/api/
├── src/
│   ├── middleware/rateLimit.ts (créer)
│   ├── routes/health.routes.ts (créer)
│   └── app.ts (modifier - helmet, cors, health)
├── .env.production.example (créer)
└── package.json (ajouter scripts)

prisma/
└── seed.ts (créer)

README.md (mettre à jour)
```

## Testing

### Tests recommandés

1. **Rate Limiting**
   - 6ème requête login bloquée
   - Headers X-RateLimit corrects

2. **Health Check**
   - Retourne 200 si tout OK
   - Retourne 503 si DB down

3. **Security Headers**
   - Helmet headers présents
   - CORS bloque domaines non autorisés

4. **Build**
   - Build production réussit
   - Application démarre en mode production

## Dependencies

- **Requires**: Toutes les stories précédentes
- **Blocks**: Déploiement production

---

## PO Review

**Reviewed by:** Sarah (PO)
**Date:** 2026-01-27
**Status:** ✅ Approved for Development

### Review Notes
- Critical story for production deployment
- Security measures well-defined (helmet, rate limiting, CORS)
- Health check includes DB and storage verification
- Seed script is idempotent - good practice
- Documentation requirements clear

### Recommendations
- **CRITICAL**: Ensure JWT_SECRET is never committed to git
- Rate limits may need adjustment based on actual usage
- Consider adding Prometheus/Grafana metrics endpoint
- Backup documentation should include restore procedure

### Security Checklist
- [ ] .env.production added to .gitignore
- [ ] Secrets rotated before go-live
- [ ] CORS whitelist verified
- [ ] Rate limiting tested

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |
| 2026-01-27 | 1.1 | PO Review - Approved for Development | Sarah (PO) |
