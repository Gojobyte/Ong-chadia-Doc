# Story 4.5: Dashboard UI - Alerts & Deadlines Widget

## Status

Complete

## Story

**As a** utilisateur,
**I want** voir les alertes et échéances importantes,
**so that** je ne manque pas les deadlines critiques.

## Acceptance Criteria

1. Widget "Échéances" listant les projets avec deadline proche
2. Seuils : Rouge (< 7 jours), Orange (< 14 jours), Jaune (< 30 jours)
3. Format : Nom projet, Date fin, Jours restants
4. Tri par urgence (plus proche en premier)
5. Maximum 5 éléments affichés, lien "Voir plus" si plus
6. Widget "Alertes" pour notifications système (optionnel MVP)
7. Possibilité de marquer une alerte comme "vue"
8. Animation subtile pour nouvelles alertes
9. État vide : "Aucune échéance proche" (message positif)
10. Clic sur échéance navigue vers le projet

## Tasks / Subtasks

- [x] **Task 1: Créer le composant DeadlinesWidget**
  - [x] Créer `apps/web/src/components/dashboard/DeadlinesWidget.tsx`
  - [x] Afficher liste des échéances triées par urgence
  - [x] Badge couleur selon urgence (rouge/orange/jaune)
  - [x] Afficher jours restants

- [x] **Task 2: Implémenter les indicateurs visuels**
  - [x] Code couleur pour urgence (< 3j, < 7j, normal)
  - [x] Icône d'alerte pour deadlines critiques
  - [x] Compteur de jours restants

- [x] **Task 3: Gérer les interactions**
  - [x] Clic sur deadline → navigation vers projet
  - [x] Lien "Voir plus" si > 5 échéances

- [x] **Task 4: Gérer les états**
  - [x] Skeleton loading
  - [x] État vide avec message positif ("Aucune échéance proche")
  - [x] État erreur (via parent)

- [x] **Task 5: Intégrer au dashboard**
  - [x] Ajouter DeadlinesWidget dans DashboardPage
  - [x] Utiliser upcomingDeadlines de useDashboard()

## Dev Notes

### Composant DeadlinesWidget

```tsx
// apps/web/src/components/dashboard/DeadlinesWidget.tsx
import { Link } from 'react-router-dom';
import { Card } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { AlertTriangle, Calendar, CheckCircle2, ArrowUpRight } from 'lucide-react';
import { format, differenceInDays, parseISO } from 'date-fns';
import { fr } from 'date-fns/locale';
import { cn } from '@/lib/utils';

interface Deadline {
  id: string;
  name: string;
  endDate: string;
  daysRemaining: number;
}

interface DeadlinesWidgetProps {
  deadlines: Deadline[];
  isLoading?: boolean;
}

const getUrgencyConfig = (days: number) => {
  if (days < 0) return { color: 'bg-red-100 text-red-700 border-red-200', icon: 'text-red-500', label: 'En retard' };
  if (days < 7) return { color: 'bg-red-50 text-red-700 border-red-200', icon: 'text-red-500', label: 'Critique' };
  if (days < 14) return { color: 'bg-orange-50 text-orange-700 border-orange-200', icon: 'text-orange-500', label: 'Urgent' };
  if (days < 30) return { color: 'bg-yellow-50 text-yellow-700 border-yellow-200', icon: 'text-yellow-500', label: 'Proche' };
  return { color: 'bg-slate-50 text-slate-700 border-slate-200', icon: 'text-slate-400', label: '' };
};

export function DeadlinesWidget({ deadlines, isLoading }: DeadlinesWidgetProps) {
  if (isLoading) {
    return <DeadlinesWidgetSkeleton />;
  }

  // Sort by urgency (least days first)
  const sortedDeadlines = [...deadlines].sort((a, b) => a.daysRemaining - b.daysRemaining);
  const displayedDeadlines = sortedDeadlines.slice(0, 5);
  const hasMore = deadlines.length > 5;

  return (
    <Card>
      <div className="flex items-center gap-2 mb-4">
        <AlertTriangle className="w-5 h-5 text-orange-500" />
        <h3 className="font-semibold text-slate-900">Échéances à venir</h3>
        {deadlines.length > 0 && (
          <Badge variant="warning">{deadlines.length}</Badge>
        )}
      </div>

      {deadlines.length === 0 ? (
        <div className="text-center py-6">
          <CheckCircle2 className="w-10 h-10 mx-auto mb-2 text-green-400" />
          <p className="text-slate-600 font-medium">Aucune échéance proche</p>
          <p className="text-sm text-slate-500">Tous vos projets sont dans les temps</p>
        </div>
      ) : (
        <div className="space-y-3">
          {displayedDeadlines.map((deadline) => {
            const urgency = getUrgencyConfig(deadline.daysRemaining);
            return (
              <Link
                key={deadline.id}
                to={`/projects/${deadline.id}`}
                className={cn(
                  'flex items-center justify-between p-3 rounded-lg border transition-colors hover:shadow-sm',
                  urgency.color
                )}
              >
                <div className="flex-1 min-w-0">
                  <p className="font-medium truncate">{deadline.name}</p>
                  <div className="flex items-center gap-2 mt-1 text-sm opacity-80">
                    <Calendar className="w-4 h-4" />
                    <span>{format(parseISO(deadline.endDate), 'dd MMM yyyy', { locale: fr })}</span>
                  </div>
                </div>
                <div className="text-right ml-4">
                  <p className="font-bold">
                    {deadline.daysRemaining < 0
                      ? `${Math.abs(deadline.daysRemaining)}j de retard`
                      : deadline.daysRemaining === 0
                        ? "Aujourd'hui"
                        : `${deadline.daysRemaining}j`}
                  </p>
                  {urgency.label && (
                    <p className="text-xs opacity-80">{urgency.label}</p>
                  )}
                </div>
              </Link>
            );
          })}

          {hasMore && (
            <Link
              to="/projects?filter=upcoming"
              className="flex items-center justify-center gap-1 py-2 text-sm text-primary-600 hover:text-primary-700"
            >
              Voir toutes les échéances ({deadlines.length})
              <ArrowUpRight className="w-4 h-4" />
            </Link>
          )}
        </div>
      )}
    </Card>
  );
}

function DeadlinesWidgetSkeleton() {
  return (
    <Card>
      <div className="flex items-center gap-2 mb-4">
        <div className="w-5 h-5 bg-slate-200 rounded animate-pulse" />
        <div className="h-5 w-32 bg-slate-200 rounded animate-pulse" />
      </div>
      <div className="space-y-3">
        {[1, 2, 3].map((i) => (
          <div key={i} className="p-3 rounded-lg bg-slate-50 animate-pulse">
            <div className="h-4 w-3/4 bg-slate-200 rounded mb-2" />
            <div className="h-3 w-1/2 bg-slate-200 rounded" />
          </div>
        ))}
      </div>
    </Card>
  );
}
```

### Fichiers concernés

```
apps/web/src/components/dashboard/
├── DeadlinesWidget.tsx (créer)
└── index.ts (mettre à jour)
```

## Testing

### Tests recommandés

1. **Affichage**
   - Échéances triées par urgence
   - Couleurs correctes selon seuils
   - Jours restants calculés correctement

2. **Interactions**
   - Clic deadline → page projet
   - Lien "Voir plus" affiché si > 5

3. **États**
   - Skeleton pendant loading
   - Message positif si aucune échéance

## Dependencies

- **Requires**: Story 4.1 (Dashboard API), Story 4.2 (Dashboard Layout)
- **Blocks**: None

---

## PO Review

**Reviewed by:** Sarah (PO)
**Date:** 2026-01-27
**Status:** ✅ Approved for Development

### Review Notes
- Urgency thresholds are well-defined (7/14/30 days, overdue)
- Color coding is intuitive (red/orange/yellow)
- Positive empty state message is good UX
- Link to /projects?filter=upcoming enables full list view
- Skeleton loading ensures consistent experience

### Recommendations
- Consider adding notification bell icon in header for critical deadlines
- Animation for new alerts could be subtle pulse effect

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |
| 2026-01-27 | 1.1 | PO Review - Approved for Development | Sarah (PO) |
