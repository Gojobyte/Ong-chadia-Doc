# Story 4.1: Dashboard API - Aggregated Data

## Status

Complete

## Story

**As a** utilisateur authentifié,
**I want** récupérer les données agrégées pour mon dashboard via API,
**so that** l'interface puisse afficher une vue d'ensemble personnalisée.

## Acceptance Criteria

1. Endpoint `GET /api/dashboard` retournant les données agrégées
2. Données retournées :
   - `projects`: { total, byStatus: { draft, preparation, inProgress, completed } }
   - `myProjects`: liste des 5 derniers projets où l'utilisateur est assigné
   - `recentDocuments`: 10 derniers documents uploadés accessibles à l'utilisateur
   - `upcomingDeadlines`: projets avec endDate dans les 30 prochains jours
   - `stats`: { totalDocuments, totalProjects, totalUsers (si admin) }
3. Données filtrées selon permissions de l'utilisateur
4. Cache côté serveur (5 min) pour performance
5. Endpoint `GET /api/dashboard/activity` pour activité récente (uploads, créations)
6. Pagination sur l'activité récente
7. Performance : réponse < 500ms
8. Tests d'intégration validant les permissions

## Tasks / Subtasks

- [x] **Task 1: Créer le module dashboard API**
  - [x] Créer `apps/api/src/modules/dashboard/dashboard.service.ts`
  - [x] Créer `apps/api/src/modules/dashboard/dashboard.controller.ts`
  - [x] Créer `apps/api/src/modules/dashboard/dashboard.routes.ts`
  - [x] Enregistrer les routes dans app.ts

- [x] **Task 2: Implémenter GET /api/dashboard**
  - [x] Agrégation des projets par statut
  - [x] Requête des 5 derniers projets de l'utilisateur
  - [x] Requête des 10 derniers documents accessibles
  - [x] Requête des échéances dans les 30 jours
  - [x] Stats globales (totalDocuments, totalProjects, totalUsers si admin)
  - [x] Filtrage selon permissions utilisateur

- [x] **Task 3: Implémenter GET /api/dashboard/activity**
  - [x] Agrégation activité récente (uploads, créations projets)
  - [x] Pagination (page, limit)
  - [x] Filtrage selon permissions

- [x] **Task 4: Implémenter le cache**
  - [x] Cache en mémoire (5 minutes)
  - [x] Invalidation du cache lors de modifications
  - [x] Cache par userId pour données personnalisées

- [x] **Task 5: Optimiser les performances**
  - [x] Utiliser des requêtes agrégées (groupBy, count)
  - [x] Limiter les includes aux champs nécessaires
  - [x] Requêtes parallèles avec Promise.all

## Dev Notes

### Structure des endpoints

```typescript
// GET /api/dashboard
interface DashboardResponse {
  projects: {
    total: number;
    byStatus: {
      draft: number;
      preparation: number;
      inProgress: number;
      completed: number;
    };
  };
  myProjects: Array<{
    id: string;
    name: string;
    status: string;
    endDate: string | null;
  }>;
  recentDocuments: Array<{
    id: string;
    name: string;
    mimeType: string;
    createdAt: string;
    folder: { id: string; name: string };
  }>;
  upcomingDeadlines: Array<{
    id: string;
    name: string;
    endDate: string;
    daysRemaining: number;
  }>;
  stats: {
    totalDocuments: number;
    totalProjects: number;
    totalUsers?: number; // Only for admin
  };
}

// GET /api/dashboard/activity?page=1&limit=20
interface ActivityResponse {
  data: Array<{
    id: string;
    type: 'document_upload' | 'project_created' | 'document_shared';
    user: { id: string; firstName: string; lastName: string };
    target: { id: string; name: string; type: string };
    createdAt: string;
  }>;
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

### Fichiers concernés

```
apps/api/src/modules/dashboard/
├── dashboard.service.ts
├── dashboard.controller.ts
└── dashboard.routes.ts
```

### Cache simple en mémoire

```typescript
const cache = new Map<string, { data: any; expiry: number }>();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

function getCached<T>(key: string): T | null {
  const entry = cache.get(key);
  if (!entry || entry.expiry < Date.now()) {
    cache.delete(key);
    return null;
  }
  return entry.data as T;
}

function setCache(key: string, data: any) {
  cache.set(key, { data, expiry: Date.now() + CACHE_TTL });
}
```

## Testing

### Tests recommandés

1. **API Dashboard**
   - Retourne les bonnes données agrégées
   - Filtre selon permissions utilisateur
   - Cache fonctionne (2ème appel plus rapide)

2. **API Activity**
   - Pagination fonctionne
   - Résultats ordonnés par date desc

3. **Performance**
   - Réponse < 500ms avec 1000 documents

## Dependencies

- **Requires**: Story 1.x (Auth), Story 2.x (Documents), Story 3.x (Projects)
- **Blocks**: Story 4.2, 4.3, 4.4, 4.5

---

## PO Review

**Reviewed by:** Sarah (PO)
**Date:** 2026-01-27
**Status:** ✅ Approved for Development

### Review Notes
- Acceptance criteria are clear and measurable (8 criteria)
- API contract well-defined with TypeScript interfaces
- Cache strategy appropriate (5 min TTL, per-user keys)
- Performance requirement explicit (< 500ms)
- Dependencies correctly identified (requires Auth, Documents, Projects)
- This story is a **blocker** for 4.2-4.5 - should be prioritized

### Recommendations
- Consider using Redis for cache in production instead of in-memory
- Add monitoring for cache hit rate

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |
| 2026-01-27 | 1.1 | PO Review - Approved for Development | Sarah (PO) |
