# Story 4.6: Global Search

## Status

Complete

## Story

**As a** utilisateur,
**I want** rechercher globalement dans l'application,
**so that** je puisse trouver rapidement documents ou projets.

## Acceptance Criteria

1. Barre de recherche dans le header/navbar, accessible partout
2. Endpoint `GET /api/search?q=terme` recherchant dans documents ET projets
3. Résultats groupés par type (Documents, Projets)
4. Affichage en dropdown sous la barre de recherche
5. Navigation clavier (flèches, Enter pour sélectionner)
6. Raccourci clavier pour focus (Ctrl+K ou Cmd+K)
7. Recherche en temps réel avec debounce (300ms)
8. Maximum 5 résultats par catégorie dans le dropdown
9. Lien "Voir tous les résultats" ouvrant page de résultats complète
10. Résultats respectant les permissions utilisateur

## Tasks / Subtasks

**Note:** La majeure partie de cette story est déjà implémentée dans Story 2.16. Cette story doit :
1. Étendre la recherche pour inclure les projets
2. Vérifier l'intégration dans la navbar globale

- [x] **Task 1: Étendre l'API de recherche pour les projets**
  - [x] Utiliser GET /api/projects?search= existant
  - [x] Rechercher dans projets (name, description)
  - [x] Retourner résultats groupés par type (via Promise.all)

- [x] **Task 2: Mettre à jour GlobalSearch pour les projets**
  - [x] Ajouter section "Projets" dans les résultats
  - [x] Icône FolderKanban pour projets vs FileText pour documents
  - [x] Navigation vers /projects/{id}

- [x] **Task 3: Vérifier l'intégration TopNav**
  - [x] GlobalSearch présent dans TopNav (existant)
  - [x] Accessible depuis toutes les pages
  - [x] Style cohérent

- [x] **Task 4: Navigation clavier**
  - [x] Flèches haut/bas pour naviguer entre résultats
  - [x] Enter pour sélectionner
  - [x] Escape pour fermer

## Dev Notes

### Ce qui existe déjà (Story 2.16)

- `GlobalSearch.tsx` avec Cmd+K shortcut
- Recherche documents avec debounce 300ms
- Dropdown avec résultats instantanés
- Historique de recherche en localStorage
- Highlight des termes

### Modifications nécessaires

```typescript
// Étendre le service de recherche
// apps/web/src/services/search.service.ts

interface UnifiedSearchResult {
  documents: Array<{
    id: string;
    name: string;
    mimeType: string;
    folderName: string;
  }>;
  projects: Array<{
    id: string;
    name: string;
    status: string;
  }>;
  totals: {
    documents: number;
    projects: number;
  };
}

export async function unifiedSearch(query: string): Promise<UnifiedSearchResult> {
  const [docsResponse, projectsResponse] = await Promise.all([
    api.get('/documents/search', { params: { q: query, limit: 5 } }),
    api.get('/projects/search', { params: { q: query, limit: 5 } }),
  ]);

  return {
    documents: docsResponse.data.data,
    projects: projectsResponse.data.data,
    totals: {
      documents: docsResponse.data.pagination.total,
      projects: projectsResponse.data.pagination.total,
    },
  };
}
```

### Mise à jour GlobalSearch

```tsx
// Ajouter section projets dans GlobalSearch.tsx

{results?.projects?.length > 0 && (
  <div className="p-2 border-t border-slate-100">
    <p className="px-2 py-1 text-xs font-medium text-slate-500 uppercase">
      Projets ({results.totals.projects})
    </p>
    {results.projects.map((project) => (
      <button
        key={project.id}
        onClick={() => {
          addRecentSearch(query);
          setOpen(false);
          navigate(`/projects/${project.id}`);
        }}
        className="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-100 text-left"
      >
        <FolderKanban className="w-5 h-5 text-amber-500" />
        <div className="flex-1 min-w-0">
          <p className="text-sm font-medium text-slate-900 truncate">
            <Highlight text={project.name} query={query} />
          </p>
          <p className="text-xs text-slate-500">
            {project.status}
          </p>
        </div>
      </button>
    ))}
  </div>
)}
```

### Fichiers concernés

```
apps/api/src/modules/projects/
├── projects.service.ts (ajouter searchProjects)
├── projects.controller.ts (ajouter endpoint search)
└── projects.routes.ts (ajouter route)

apps/web/src/components/search/
├── GlobalSearch.tsx (modifier)
└── index.ts
```

## Testing

### Tests recommandés

1. **Recherche unifiée**
   - Retourne documents ET projets
   - Résultats groupés correctement
   - Permissions respectées

2. **UI**
   - Cmd+K ouvre la recherche
   - Sections documents et projets visibles
   - Navigation clavier fonctionne

3. **Navigation**
   - Clic projet → /projects/{id}
   - Clic document → drawer ou /documents/{id}

## Dependencies

- **Requires**: Story 2.16 (Advanced Search - déjà fait), Story 3.x (Projects)
- **Blocks**: None

### Note sur le chevauchement

Cette story chevauche significativement avec Story 2.16 (Advanced Search). Les principales différences :
- 2.16 : Focus sur documents avec filtres avancés ✅ FAIT
- 4.6 : Étend la recherche aux projets

**Recommandation** : Implémenter uniquement l'extension pour les projets.

---

## PO Review

**Reviewed by:** Sarah (PO)
**Date:** 2026-01-27
**Status:** ✅ Approved for Development

### Review Notes
- Story correctly identifies overlap with Story 2.16 (already complete)
- Scope appropriately limited to PROJECT search extension
- unifiedSearch service pattern is clean
- Uses Promise.all for parallel API calls - good performance
- Note section clarifies exactly what needs to be done

### Recommendations
- **DO NOT** reimplement document search - only add project search
- Reuse existing GlobalSearch.tsx and extend it
- Minimal story - can be combined with 4.7 if desired

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |
| 2026-01-27 | 1.1 | PO Review - Approved for Development | Sarah (PO) |
