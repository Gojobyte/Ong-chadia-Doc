# Story 10.1: Advanced Project Dashboard

## Status: Approved

## Story

**As a** chef de projet,
**I want** avoir un tableau de bord synthétique de mon projet,
**so that** je puisse suivre l'avancement et identifier rapidement les problèmes.

## Acceptance Criteria

1. Dashboard personnalisable par projet avec widgets déplaçables
2. Widget avancement global (% completion avec progress bar)
3. Widget budget (consommé vs restant, graphique donut)
4. Widget timeline (jalons atteints, prochaines échéances, Gantt simplifié)
5. Widget équipe (membres actifs, dernières contributions)
6. Widget documents (récents, à réviser, statistiques)
7. Widget alertes (dépassements budget, retards, documents en attente)
8. Période configurable (semaine, mois, trimestre, année, custom)
9. Export du dashboard complet en PDF
10. Rafraîchissement automatique des données (polling 60s)
11. Tests couvrant widgets et agrégations

## Tasks / Subtasks

- [ ] **Task 1: API Dashboard Aggregations** (AC: 2-7)
  - [ ] `GET /api/projects/:id/dashboard` - Données agrégées
  - [ ] Calculer avancement global depuis indicateurs
  - [ ] Calculer consommation budget
  - [ ] Agréger activités récentes
  - [ ] Détecter alertes (règles configurables)

- [ ] **Task 2: Layout Dashboard Customizable** (AC: 1)
  - [ ] Installer `react-grid-layout`
  - [ ] Créer `ProjectDashboard.tsx`
  - [ ] Grille de widgets draggable
  - [ ] Sauvegarder layout préférences utilisateur
  - [ ] Responsive: 1/2/3 colonnes selon écran

- [ ] **Task 3: Widget Avancement** (AC: 2)
  - [ ] Créer `ProgressWidget.tsx`
  - [ ] Progress bar avec pourcentage
  - [ ] Couleur selon état (vert/jaune/rouge)
  - [ ] Détail par catégorie d'indicateurs
  - [ ] Tendance vs période précédente

- [ ] **Task 4: Widget Budget** (AC: 3)
  - [ ] Créer `BudgetWidget.tsx`
  - [ ] Graphique donut: consommé/restant/engagé
  - [ ] Chiffres clés: total, dépensé, restant
  - [ ] Barre de progression avec seuils
  - [ ] Alerte si > 80% ou 100%

- [ ] **Task 5: Widget Timeline** (AC: 4)
  - [ ] Créer `TimelineWidget.tsx`
  - [ ] Liste jalons avec statut (atteint/à venir/retard)
  - [ ] Mini Gantt chart (nice-to-have)
  - [ ] Prochaines échéances triées par date
  - [ ] Countdown jours restants

- [ ] **Task 6: Widget Équipe** (AC: 5)
  - [ ] Créer `TeamWidget.tsx`
  - [ ] Avatars membres avec statut activité
  - [ ] Dernières contributions (commits, documents)
  - [ ] Charge de travail si tracking activé

- [ ] **Task 7: Widget Documents** (AC: 6)
  - [ ] Créer `DocumentsWidget.tsx`
  - [ ] Documents récemment modifiés (5 derniers)
  - [ ] Documents en attente de révision
  - [ ] Stats: total, par type, cette semaine

- [ ] **Task 8: Widget Alertes** (AC: 7)
  - [ ] Créer `AlertsWidget.tsx`
  - [ ] Types: BUDGET_HIGH, DEADLINE_APPROACHING, DEADLINE_PASSED, DOCUMENT_PENDING
  - [ ] Icône et couleur par gravité
  - [ ] Actions rapides depuis l'alerte
  - [ ] Dismiss avec raison

- [ ] **Task 9: Filtre Période** (AC: 8)
  - [ ] Créer `PeriodSelector.tsx`
  - [ ] Options: Cette semaine, Ce mois, Ce trimestre, Cette année, Custom
  - [ ] Date picker pour range custom
  - [ ] Appliquer à tous les widgets

- [ ] **Task 10: Export PDF Dashboard** (AC: 9)
  - [ ] Créer endpoint `GET /api/projects/:id/dashboard/export-pdf`
  - [ ] Utiliser Puppeteer côté serveur
  - [ ] Rendre dashboard en HTML puis PDF
  - [ ] Inclure date génération et période

- [ ] **Task 11: Auto-refresh** (AC: 10)
  - [ ] Polling API toutes les 60 secondes
  - [ ] Indicateur dernière mise à jour
  - [ ] Option pause/resume auto-refresh
  - [ ] useQuery refetchInterval

- [ ] **Task 12: Tests** (AC: 11)
  - [ ] Tests API agrégations
  - [ ] Tests widgets render
  - [ ] Tests calculs budget et avancement

## Dev Notes

### Architecture

```text
apps/api/src/modules/dashboard/
├── dashboard.controller.ts
├── dashboard.service.ts
├── dashboard.routes.ts
├── aggregations/
│   ├── progress.aggregation.ts
│   ├── budget.aggregation.ts
│   ├── alerts.aggregation.ts
│   └── activity.aggregation.ts
└── export.service.ts

apps/web/src/components/dashboard/
├── ProjectDashboard.tsx      # Layout principal
├── widgets/
│   ├── ProgressWidget.tsx
│   ├── BudgetWidget.tsx
│   ├── TimelineWidget.tsx
│   ├── TeamWidget.tsx
│   ├── DocumentsWidget.tsx
│   └── AlertsWidget.tsx
├── PeriodSelector.tsx
├── WidgetContainer.tsx       # Wrapper commun
└── index.ts
```

### API Response Structure

```ts
// GET /api/projects/:id/dashboard?period=month
interface DashboardData {
  period: { start: Date; end: Date };
  progress: {
    overall: number; // 0-100
    trend: 'up' | 'down' | 'stable';
    byCategory: { name: string; value: number }[];
  };
  budget: {
    total: number;
    spent: number;
    committed: number;
    remaining: number;
    percentUsed: number;
    byCategory: { name: string; spent: number; budgeted: number }[];
  };
  timeline: {
    milestones: { id: string; name: string; date: Date; status: 'completed' | 'upcoming' | 'overdue' }[];
    upcomingDeadlines: { id: string; name: string; date: Date; daysLeft: number }[];
  };
  team: {
    members: { id: string; name: string; avatar: string; lastActive: Date }[];
    recentActivity: { userId: string; action: string; date: Date }[];
  };
  documents: {
    total: number;
    thisWeek: number;
    byType: { type: string; count: number }[];
    recent: { id: string; name: string; updatedAt: Date }[];
    pendingReview: { id: string; name: string; dueDate: Date }[];
  };
  alerts: {
    id: string;
    type: AlertType;
    severity: 'info' | 'warning' | 'critical';
    message: string;
    entityId?: string;
    createdAt: Date;
  }[];
}
```

### Layout avec react-grid-layout

```tsx
import GridLayout from 'react-grid-layout';

const defaultLayout = [
  { i: 'progress', x: 0, y: 0, w: 4, h: 2 },
  { i: 'budget', x: 4, y: 0, w: 4, h: 2 },
  { i: 'alerts', x: 8, y: 0, w: 4, h: 2 },
  { i: 'timeline', x: 0, y: 2, w: 6, h: 3 },
  { i: 'team', x: 6, y: 2, w: 6, h: 3 },
  { i: 'documents', x: 0, y: 5, w: 12, h: 2 },
];

function ProjectDashboard({ projectId }: { projectId: string }) {
  const [layout, setLayout] = useState(defaultLayout);

  return (
    <GridLayout
      layout={layout}
      cols={12}
      rowHeight={100}
      onLayoutChange={setLayout}
      draggableHandle=".widget-handle"
    >
      <div key="progress"><ProgressWidget /></div>
      <div key="budget"><BudgetWidget /></div>
      {/* ... */}
    </GridLayout>
  );
}
```

### Librairies Recommandées

| Lib | Usage | Install |
|-----|-------|---------|
| react-grid-layout | Layout draggable | `pnpm add react-grid-layout` |
| recharts | Graphiques | `pnpm add recharts` |
| date-fns | Manipulation dates | Déjà installé |

## Testing

### Localisation

- `apps/api/tests/dashboard.test.ts`
- `apps/web/src/components/dashboard/__tests__/`

### Framework

- Jest/Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| API aggregation | Données calculées correctement |
| Progress widget | Affiche % et tendance |
| Budget widget | Graphique donut correct |
| Alerts widget | Alertes triées par gravité |
| Period change | Données filtrées par période |
| Export PDF | PDF généré avec contenu |
| Auto-refresh | Données mises à jour |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
