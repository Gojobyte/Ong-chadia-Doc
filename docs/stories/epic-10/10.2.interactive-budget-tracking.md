# Story 10.2: Interactive Budget Tracking

## Status: Approved

## Story

**As a** gestionnaire financier,
**I want** suivre le budget du projet en temps réel,
**so that** je puisse contrôler les dépenses et éviter les dépassements.

## Acceptance Criteria

1. Saisie des lignes budgétaires prévisionnelles avec catégories
2. Saisie des dépenses réelles avec justificatifs (upload)
3. Comparaison prévu vs réel par catégorie avec écarts
4. Calcul automatique des écarts (montant et %)
5. Alertes configurables (seuils 80%, 100%, custom)
6. Graphiques de suivi (barres comparatives, courbes d'évolution)
7. Ventilation par période (mensuel, trimestriel)
8. Support multi-devises avec taux de conversion
9. Export Excel du suivi budgétaire complet
10. Historique des modifications budgétaires (audit trail)
11. Tests couvrant calculs, alertes, et exports

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma Budget** (AC: 1, 2, 10)
  - [ ] Créer model `BudgetLine` (id, projectId, category, description, planned, currency)
  - [ ] Créer model `Expense` (id, budgetLineId, amount, date, description, receiptUrl, createdById)
  - [ ] Créer model `BudgetHistory` pour audit trail
  - [ ] Migration Prisma

- [ ] **Task 2: API Budget Lines CRUD** (AC: 1)
  - [ ] `GET /api/projects/:id/budget` - Structure budget complète
  - [ ] `POST /api/projects/:id/budget/lines` - Ajouter ligne
  - [ ] `PATCH /api/budget/lines/:id` - Modifier ligne
  - [ ] `DELETE /api/budget/lines/:id` - Supprimer ligne
  - [ ] Validation montants positifs

- [ ] **Task 3: API Expenses CRUD** (AC: 2)
  - [ ] `POST /api/budget/lines/:id/expenses` - Ajouter dépense
  - [ ] `PATCH /api/expenses/:id` - Modifier dépense
  - [ ] `DELETE /api/expenses/:id` - Supprimer dépense
  - [ ] Upload justificatif vers Supabase Storage

- [ ] **Task 4: Calculs Automatiques** (AC: 3, 4)
  - [ ] Service `budget-calculations.service.ts`
  - [ ] Somme dépenses par ligne
  - [ ] Écart = prévu - réel
  - [ ] Pourcentage = réel / prévu * 100
  - [ ] Agrégation par catégorie

- [ ] **Task 5: Système Alertes** (AC: 5)
  - [ ] Créer model `BudgetAlert` ou utiliser Alert générique
  - [ ] Trigger alerte si > seuil configuré
  - [ ] Seuils par défaut: 80% (warning), 100% (critical)
  - [ ] Seuils custom par ligne ou projet
  - [ ] Notifications email optionnel

- [ ] **Task 6: UI Tableau Budget** (AC: 1, 2, 3, 4)
  - [ ] Créer `BudgetTable.tsx`
  - [ ] Colonnes: Catégorie, Ligne, Prévu, Réel, Écart, %
  - [ ] Lignes groupées par catégorie
  - [ ] Totaux par catégorie et général
  - [ ] Coloration conditionnelle (rouge si > 100%)
  - [ ] Inline editing pour modifications rapides

- [ ] **Task 7: UI Saisie Dépenses** (AC: 2)
  - [ ] Créer `ExpenseForm.tsx`
  - [ ] Champs: montant, date, description, justificatif
  - [ ] Upload fichier (PDF, image)
  - [ ] Sélection devise si multi-devises
  - [ ] Modal ou drawer

- [ ] **Task 8: Graphiques** (AC: 6)
  - [ ] Créer `BudgetCharts.tsx`
  - [ ] Bar chart: prévu vs réel par catégorie
  - [ ] Line chart: évolution dépenses dans le temps
  - [ ] Pie chart: répartition par catégorie
  - [ ] Utiliser Recharts

- [ ] **Task 9: Ventilation Période** (AC: 7)
  - [ ] Filtre période dans UI
  - [ ] API support `?period=monthly|quarterly`
  - [ ] Agrégation par mois/trimestre
  - [ ] Graphique évolution temporelle

- [ ] **Task 10: Multi-devises** (AC: 8)
  - [ ] Ajouter champ `currency` aux lignes et dépenses
  - [ ] Table `ExchangeRate` ou API externe
  - [ ] Conversion vers devise projet pour totaux
  - [ ] Affichage montant original + converti

- [ ] **Task 11: Export Excel** (AC: 9)
  - [ ] Endpoint `GET /api/projects/:id/budget/export`
  - [ ] Générer XLSX avec SheetJS
  - [ ] Feuilles: Résumé, Détail par catégorie, Dépenses
  - [ ] Formatage: couleurs, bordures, formules

- [ ] **Task 12: Historique Modifications** (AC: 10)
  - [ ] Logger chaque modification dans BudgetHistory
  - [ ] Champs: userId, action, previousValue, newValue, timestamp
  - [ ] UI timeline historique
  - [ ] Filtres par période et type action

- [ ] **Task 13: Tests** (AC: 11)
  - [ ] Tests calculs écarts et pourcentages
  - [ ] Tests alertes déclenchées correctement
  - [ ] Tests export Excel

## Dev Notes

### Architecture

```text
apps/api/src/modules/budget/
├── budget.controller.ts
├── budget.service.ts
├── budget.routes.ts
├── expenses.controller.ts
├── expenses.service.ts
├── calculations.service.ts
├── alerts.service.ts
├── export.service.ts
└── index.ts

apps/web/src/components/budget/
├── BudgetTable.tsx           # Tableau principal
├── BudgetLineRow.tsx         # Ligne éditable
├── ExpenseForm.tsx           # Form saisie dépense
├── ExpenseList.tsx           # Liste dépenses ligne
├── BudgetCharts.tsx          # Graphiques
├── BudgetAlerts.tsx          # Alertes
├── BudgetHistory.tsx         # Historique
└── index.ts
```

### Schéma Prisma

```prisma
model BudgetLine {
  id          String    @id @default(uuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id])
  category    String
  description String
  planned     Decimal   @db.Decimal(15, 2)
  currency    String    @default("EUR")
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  expenses    Expense[]

  @@index([projectId, category])
}

model Expense {
  id            String     @id @default(uuid())
  budgetLineId  String
  budgetLine    BudgetLine @relation(fields: [budgetLineId], references: [id])
  amount        Decimal    @db.Decimal(15, 2)
  currency      String     @default("EUR")
  date          DateTime
  description   String
  receiptUrl    String?
  createdById   String
  createdBy     User       @relation(fields: [createdById], references: [id])
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([budgetLineId, date])
}

model BudgetHistory {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  action        String   // CREATE_LINE, UPDATE_LINE, DELETE_LINE, ADD_EXPENSE, etc.
  entityType    String   // BudgetLine, Expense
  entityId      String
  previousValue Json?
  newValue      Json?
  createdAt     DateTime @default(now())

  @@index([projectId, createdAt])
}
```

### Calculs Budget

```ts
interface BudgetSummary {
  totalPlanned: number;
  totalSpent: number;
  totalRemaining: number;
  percentUsed: number;
  byCategory: {
    category: string;
    planned: number;
    spent: number;
    remaining: number;
    percent: number;
    lines: BudgetLineWithExpenses[];
  }[];
}

function calculateBudgetSummary(lines: BudgetLineWithExpenses[]): BudgetSummary {
  const byCategory = groupBy(lines, 'category');

  return {
    totalPlanned: sum(lines, 'planned'),
    totalSpent: sum(lines, l => sum(l.expenses, 'amount')),
    // ...
  };
}
```

### Alertes Configuration

```ts
interface AlertConfig {
  warningThreshold: number; // Default 80
  criticalThreshold: number; // Default 100
  notifyEmail: boolean;
  notifyInApp: boolean;
}

// Vérifier après chaque expense
function checkBudgetAlerts(lineId: string) {
  const line = await getBudgetLineWithExpenses(lineId);
  const spent = sum(line.expenses, 'amount');
  const percent = (spent / line.planned) * 100;

  if (percent >= config.criticalThreshold) {
    createAlert('BUDGET_CRITICAL', line);
  } else if (percent >= config.warningThreshold) {
    createAlert('BUDGET_WARNING', line);
  }
}
```

## Testing

### Localisation

- `apps/api/tests/budget.test.ts`
- `apps/web/src/components/budget/__tests__/`

### Framework

- Jest/Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Create line | Ligne créée avec montant valide |
| Add expense | Dépense ajoutée à la ligne |
| Calculate spent | Total dépenses correct |
| Calculate percent | Pourcentage correct |
| Alert 80% | Warning déclenché à 80% |
| Alert 100% | Critical déclenché à 100% |
| Export Excel | Fichier généré avec données |
| History | Modification loggée |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
