# Story 10.4: Donor Portal (Read-Only)

## Status: Approved

## Story

**As a** bailleur de fonds,
**I want** accéder à un portail dédié pour suivre mes projets financés,
**so that** je puisse consulter l'avancement sans solliciter l'équipe projet.

## Acceptance Criteria

1. Espace dédié bailleur avec authentification séparée (rôle DONOR)
2. Vue liste des projets financés par ce bailleur
3. Dashboard synthétique par projet (lecture seule, voir Story 10.1)
4. Accès aux rapports générés (téléchargement PDF)
5. Accès aux documents partagés spécifiquement avec ce bailleur
6. Visualisation du suivi budgétaire (consommation fonds attribués)
7. Timeline des jalons et activités clés
8. Galerie photos des réalisations terrain
9. Notifications email des nouveaux rapports disponibles
10. Export des données pour reporting interne bailleur
11. Tests couvrant accès, permissions, et données affichées

## Tasks / Subtasks

- [ ] **Task 1: Rôle et Auth Donor** (AC: 1)
  - [ ] Ajouter rôle `DONOR` dans enum UserRole
  - [ ] Middleware vérification rôle donor
  - [ ] Pages dédiées `/donor/*` avec layout spécifique
  - [ ] Redirection automatique après login donor

- [ ] **Task 2: Modèle Donor-Project Relation** (AC: 2)
  - [ ] Créer model `DonorProject` (donorId, projectId, fundingAmount, startDate)
  - [ ] Ou utiliser ProjectMember avec rôle DONOR
  - [ ] Migration Prisma

- [ ] **Task 3: API Donor Endpoints** (AC: 2-8)
  - [ ] `GET /api/donor/projects` - Projets financés
  - [ ] `GET /api/donor/projects/:id` - Détails projet (filtré)
  - [ ] `GET /api/donor/projects/:id/dashboard` - Dashboard read-only
  - [ ] `GET /api/donor/projects/:id/reports` - Rapports disponibles
  - [ ] `GET /api/donor/projects/:id/documents` - Documents partagés
  - [ ] `GET /api/donor/projects/:id/photos` - Galerie photos
  - [ ] Filtrer données sensibles non destinées aux bailleurs

- [ ] **Task 4: Donor Portal Layout** (AC: 1)
  - [ ] Créer `DonorLayout.tsx` avec branding neutre
  - [ ] Sidebar simplifiée (Projets, Rapports, Paramètres)
  - [ ] Header avec nom bailleur et déconnexion
  - [ ] Footer avec mentions légales

- [ ] **Task 5: Liste Projets Financés** (AC: 2)
  - [ ] Créer `DonorProjectsList.tsx`
  - [ ] Cards projets avec: nom, statut, % avancement, montant financé
  - [ ] Filtres: statut, période
  - [ ] Clic vers détail projet

- [ ] **Task 6: Dashboard Projet (Read-Only)** (AC: 3)
  - [ ] Réutiliser composants de Story 10.1
  - [ ] Masquer widgets non pertinents (équipe interne)
  - [ ] Widgets affichés: avancement, budget, timeline, alertes
  - [ ] Désactiver édition et actions

- [ ] **Task 7: Section Rapports** (AC: 4)
  - [ ] Créer `DonorReportsView.tsx`
  - [ ] Liste rapports finalisés et envoyés
  - [ ] Téléchargement PDF
  - [ ] Filtres par période et type

- [ ] **Task 8: Section Documents Partagés** (AC: 5)
  - [ ] Créer `DonorDocumentsView.tsx`
  - [ ] Ajouter champ `sharedWithDonors` sur Document
  - [ ] Liste documents marqués comme partagés
  - [ ] Preview et téléchargement

- [ ] **Task 9: Suivi Budget Bailleur** (AC: 6)
  - [ ] Créer `DonorBudgetView.tsx`
  - [ ] Afficher uniquement fonds de ce bailleur
  - [ ] Graphique consommation
  - [ ] Détail par catégorie si pertinent

- [ ] **Task 10: Timeline Activités** (AC: 7)
  - [ ] Créer `DonorTimelineView.tsx`
  - [ ] Jalons clés avec dates
  - [ ] Activités majeures réalisées
  - [ ] Prochaines étapes

- [ ] **Task 11: Galerie Photos** (AC: 8)
  - [ ] Créer `DonorPhotoGallery.tsx`
  - [ ] Photos marquées comme visibles bailleurs
  - [ ] Lightbox pour agrandissement
  - [ ] Légendes et dates

- [ ] **Task 12: Notifications Email** (AC: 9)
  - [ ] Trigger email quand rapport envoyé au bailleur
  - [ ] Template email avec lien direct
  - [ ] Préférences notifications dans profil donor

- [ ] **Task 13: Export Données** (AC: 10)
  - [ ] Endpoint `GET /api/donor/projects/:id/export`
  - [ ] Export Excel avec résumé projet
  - [ ] Données: budget, indicateurs, timeline
  - [ ] Format adapté reporting interne bailleur

- [ ] **Task 14: Tests** (AC: 11)
  - [ ] Tests accès donor vs autres rôles
  - [ ] Tests données filtrées (pas d'info sensible)
  - [ ] Tests export

## Dev Notes

### Architecture

```text
apps/api/src/modules/donor/
├── donor.controller.ts
├── donor.service.ts
├── donor.routes.ts
├── donor.middleware.ts       # Vérification rôle
└── index.ts

apps/web/src/pages/donor/
├── DonorLayout.tsx
├── DonorDashboard.tsx        # Landing page
├── DonorProjectsList.tsx
├── DonorProjectDetail.tsx
├── DonorReports.tsx
├── DonorDocuments.tsx
├── DonorPhotos.tsx
└── DonorSettings.tsx

apps/web/src/components/donor/
├── DonorProjectCard.tsx
├── DonorBudgetWidget.tsx
├── DonorTimelineWidget.tsx
└── index.ts
```

### Schéma Prisma

```prisma
// Option 1: Table dédiée
model DonorProject {
  id            String   @id @default(uuid())
  donorId       String
  donor         User     @relation("DonorProjects", fields: [donorId], references: [id])
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id])
  fundingAmount Decimal? @db.Decimal(15, 2)
  fundingStart  DateTime?
  fundingEnd    DateTime?
  createdAt     DateTime @default(now())

  @@unique([donorId, projectId])
  @@index([donorId])
  @@index([projectId])
}

// Ajouter au model Document
model Document {
  // ... champs existants
  sharedWithDonors Boolean @default(false)
}

// Ajouter au model Photo
model Photo {
  // ... champs existants
  visibleToDonors Boolean @default(false)
}
```

### Filtrage Données Sensibles

```ts
// Liste des champs à masquer pour les donors
const donorProjectFilter = {
  select: {
    id: true,
    name: true,
    description: true,
    status: true,
    startDate: true,
    endDate: true,
    // Exclure: budget total si confidentiel, membres internes
  },
};

// Middleware vérification
function requireDonorAccess(projectId: string) {
  return async (req, res, next) => {
    const isDonor = await donorService.hasDonorAccess(req.user.id, projectId);
    if (!isDonor) {
      return res.status(403).json({ error: 'Access denied' });
    }
    next();
  };
}
```

### Routes Donor

```ts
// apps/api/src/modules/donor/donor.routes.ts
router.use(requireRole('DONOR'));

router.get('/projects', donorController.listProjects);
router.get('/projects/:id', requireDonorAccess, donorController.getProject);
router.get('/projects/:id/dashboard', requireDonorAccess, donorController.getDashboard);
router.get('/projects/:id/reports', requireDonorAccess, donorController.getReports);
router.get('/projects/:id/documents', requireDonorAccess, donorController.getDocuments);
router.get('/projects/:id/photos', requireDonorAccess, donorController.getPhotos);
router.get('/projects/:id/export', requireDonorAccess, donorController.exportData);
```

### UI Considérations

- **Branding neutre**: Logo ONG, pas de couleurs corporate bailleur
- **Simplicité**: Interface épurée, focus sur l'information
- **Mobile-friendly**: Bailleurs peuvent consulter sur mobile
- **Multilangue**: Considérer français/anglais selon bailleurs

## Testing

### Localisation

- `apps/api/tests/donor.test.ts`
- `apps/web/src/pages/donor/__tests__/`

### Framework

- Jest/Vitest + React Testing Library

### Cas à couvrir

| Test | Description |
|------|-------------|
| Auth donor | Connexion avec rôle DONOR |
| Access own projects | Voir uniquement projets financés |
| Access denied | Refus accès projet non financé |
| Dashboard readonly | Pas d'actions d'édition |
| Reports list | Rapports finalisés affichés |
| Documents filtered | Seuls documents partagés |
| Photos filtered | Seules photos visibles |
| Export | Excel généré avec bonnes données |
| Notification | Email envoyé pour nouveau rapport |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
