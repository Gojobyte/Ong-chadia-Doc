# Story 10.3: Automated Report Generation

## Status: Approved

## Story

**As a** chef de projet,
**I want** générer automatiquement des rapports à partir des données du projet,
**so that** je gagne du temps sur le reporting bailleur.

## Acceptance Criteria

1. Templates de rapports configurables (structure, sections, style)
2. Génération automatique de rapport mensuel
3. Génération automatique de rapport trimestriel
4. Insertion automatique des données projet (budget, activités, indicateurs)
5. Insertion automatique des photos récentes avec légendes
6. Sections éditables manuellement avant finalisation
7. Export PDF et Word (.docx)
8. Planification de génération automatique (CRON jobs)
9. Envoi automatique par email aux destinataires configurés
10. Historique des rapports générés avec versions
11. Tests couvrant génération, templates, et exports

## Tasks / Subtasks

- [ ] **Task 1: Schéma Prisma Reports** (AC: 1, 10)
  - [ ] Créer model `ReportTemplate` (id, name, type, structure JSON, style)
  - [ ] Créer model `Report` (id, projectId, templateId, period, content, status, generatedAt)
  - [ ] Créer enum `ReportType`: MONTHLY, QUARTERLY, ANNUAL, CUSTOM
  - [ ] Créer enum `ReportStatus`: DRAFT, PENDING_REVIEW, FINALIZED, SENT
  - [ ] Migration Prisma

- [ ] **Task 2: API Report Templates** (AC: 1)
  - [ ] `GET /api/report-templates` - Liste templates
  - [ ] `GET /api/report-templates/:id` - Détails template
  - [ ] `POST /api/report-templates` - Créer template (Admin)
  - [ ] `PATCH /api/report-templates/:id` - Modifier
  - [ ] Templates prédéfinis (seed)

- [ ] **Task 3: Template Structure** (AC: 1, 4, 5)
  - [ ] Définir format JSON pour structure rapport
  - [ ] Sections: cover, executive_summary, activities, budget, indicators, photos, annexes
  - [ ] Blocs: text, data_table, chart, image_gallery, signature
  - [ ] Variables: `{{project.name}}`, `{{period.start}}`, etc.

- [ ] **Task 4: Data Aggregation Service** (AC: 4)
  - [ ] Créer `report-data.service.ts`
  - [ ] Agréger activités de la période
  - [ ] Agréger budget (prévu, réel, écarts)
  - [ ] Agréger indicateurs avec progression
  - [ ] Récupérer photos récentes

- [ ] **Task 5: Report Generation Engine** (AC: 2, 3, 4, 5)
  - [ ] Créer `report-generator.service.ts`
  - [ ] Parser template et remplacer variables
  - [ ] Insérer données dans sections
  - [ ] Insérer photos avec légendes
  - [ ] Générer contenu HTML intermédiaire

- [ ] **Task 6: UI Template Editor** (AC: 1)
  - [ ] Créer `ReportTemplateEditor.tsx`
  - [ ] Builder visuel de sections
  - [ ] Configuration des données à inclure
  - [ ] Preview avec données sample
  - [ ] Sauvegarde template

- [ ] **Task 7: UI Report Generator** (AC: 2, 3, 6)
  - [ ] Créer `ReportGenerator.tsx`
  - [ ] Sélection template et période
  - [ ] Preview rapport généré
  - [ ] Édition sections avant finalisation
  - [ ] Boutons export PDF/Word

- [ ] **Task 8: Export PDF** (AC: 7)
  - [ ] Utiliser Puppeteer côté serveur
  - [ ] Endpoint `POST /api/reports/:id/export-pdf`
  - [ ] Rendu HTML → PDF avec styles
  - [ ] Headers/footers avec numéros de page
  - [ ] Table des matières (nice-to-have)

- [ ] **Task 9: Export Word** (AC: 7)
  - [ ] Utiliser librairie `docx`
  - [ ] Endpoint `POST /api/reports/:id/export-docx`
  - [ ] Conversion structure rapport → DOCX
  - [ ] Préserver styles et images

- [ ] **Task 10: Scheduled Generation (CRON)** (AC: 8)
  - [ ] Créer job scheduled avec BullMQ ou node-cron
  - [ ] Configuration: projet, template, récurrence
  - [ ] Générer rapport automatiquement selon planning
  - [ ] Envoyer notification une fois généré
  - [ ] UI configuration schedule

- [ ] **Task 11: Email Dispatch** (AC: 9)
  - [ ] Créer `email-dispatch.service.ts`
  - [ ] Template email avec résumé
  - [ ] Attacher PDF en pièce jointe
  - [ ] Liste destinataires configurable
  - [ ] Log envois

- [ ] **Task 12: Report History** (AC: 10)
  - [ ] Liste rapports générés par projet
  - [ ] Filtres: période, type, statut
  - [ ] Accès aux versions précédentes
  - [ ] Téléchargement historique

- [ ] **Task 13: Tests** (AC: 11)
  - [ ] Tests agrégation données
  - [ ] Tests génération contenu
  - [ ] Tests export PDF
  - [ ] Tests scheduled jobs

## Dev Notes

### Architecture

```text
apps/api/src/modules/reports/
├── reports.controller.ts
├── reports.service.ts
├── reports.routes.ts
├── templates.controller.ts
├── templates.service.ts
├── generator.service.ts      # Moteur génération
├── data-aggregation.service.ts
├── export-pdf.service.ts
├── export-docx.service.ts
├── scheduler.service.ts      # CRON jobs
├── email-dispatch.service.ts
└── index.ts

apps/web/src/components/reports/
├── ReportTemplateEditor.tsx
├── ReportGenerator.tsx
├── ReportPreview.tsx
├── ReportHistory.tsx
├── ScheduleConfig.tsx
└── index.ts
```

### Schéma Prisma

```prisma
enum ReportType {
  MONTHLY
  QUARTERLY
  ANNUAL
  CUSTOM
}

enum ReportStatus {
  DRAFT
  PENDING_REVIEW
  FINALIZED
  SENT
}

model ReportTemplate {
  id          String   @id @default(uuid())
  name        String
  type        ReportType
  description String?
  structure   Json     // Définition sections
  styles      Json?    // CSS custom
  isDefault   Boolean  @default(false)
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reports     Report[]

  @@index([type])
}

model Report {
  id           String       @id @default(uuid())
  projectId    String
  project      Project      @relation(fields: [projectId], references: [id])
  templateId   String
  template     ReportTemplate @relation(fields: [templateId], references: [id])
  type         ReportType
  periodStart  DateTime
  periodEnd    DateTime
  content      Json         // Contenu généré
  status       ReportStatus @default(DRAFT)
  pdfUrl       String?
  docxUrl      String?
  generatedAt  DateTime     @default(now())
  finalizedAt  DateTime?
  sentAt       DateTime?
  sentTo       String[]     // Liste emails

  generatedById String
  generatedBy  User         @relation(fields: [generatedById], references: [id])

  @@index([projectId, periodStart])
  @@index([status])
}

model ReportSchedule {
  id           String     @id @default(uuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id])
  templateId   String
  template     ReportTemplate @relation(fields: [templateId], references: [id])
  frequency    String     // monthly, quarterly
  dayOfMonth   Int?       // 1-28 pour monthly
  recipients   String[]   // Liste emails
  isActive     Boolean    @default(true)
  lastRunAt    DateTime?
  nextRunAt    DateTime?
  createdAt    DateTime   @default(now())

  @@index([isActive, nextRunAt])
}
```

### Template Structure JSON

```ts
interface ReportTemplateStructure {
  sections: ReportSection[];
  variables: string[]; // Variables disponibles
}

interface ReportSection {
  id: string;
  type: 'cover' | 'text' | 'data_table' | 'chart' | 'image_gallery' | 'signature';
  title?: string;
  config: {
    // Pour text
    content?: string; // Markdown avec variables
    // Pour data_table
    dataSource?: 'budget' | 'activities' | 'indicators';
    columns?: string[];
    // Pour chart
    chartType?: 'bar' | 'line' | 'pie';
    dataSource?: string;
    // Pour image_gallery
    maxImages?: number;
    layout?: 'grid' | 'list';
  };
  order: number;
}
```

### Génération Report Flow

```
1. Sélection template + période
       ↓
2. Agrégation données (budget, activités, photos)
       ↓
3. Parser template et remplacer variables
       ↓
4. Générer contenu HTML
       ↓
5. Preview / Édition manuelle
       ↓
6. Export PDF/DOCX
       ↓
7. Optionnel: Envoi email
```

### Scheduled Job avec BullMQ

```ts
// apps/api/src/jobs/report-scheduler.ts
import { Queue, Worker } from 'bullmq';

const reportQueue = new Queue('report-generation');

// Ajouter job récurrent
await reportQueue.add('generate-monthly', { projectId, templateId }, {
  repeat: { pattern: '0 9 1 * *' }, // 1er du mois à 9h
});

// Worker
const worker = new Worker('report-generation', async (job) => {
  const { projectId, templateId } = job.data;
  await reportService.generateAndSend(projectId, templateId);
});
```

## Testing

### Localisation

- `apps/api/tests/reports.test.ts`
- `apps/web/src/components/reports/__tests__/`

### Framework

- Jest/Vitest + React Testing Library
- Puppeteer mock pour PDF

### Cas à couvrir

| Test | Description |
|------|-------------|
| Aggregate budget | Données budget correctes |
| Aggregate activities | Activités de la période |
| Generate content | Variables remplacées |
| Export PDF | PDF généré valide |
| Export DOCX | DOCX généré valide |
| Schedule trigger | Job exécuté à l'heure |
| Email sent | Email avec pièce jointe |
| History | Rapport sauvé dans historique |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Création initiale de la story | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
<!-- Populated by dev agent -->

### Debug Log References
<!-- Populated by dev agent -->

### Completion Notes List
<!-- Populated by dev agent -->

### File List
<!-- Populated by dev agent -->

---

## QA Results
<!-- Populated by QA agent -->
