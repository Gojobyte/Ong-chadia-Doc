// prisma/schema.prisma
// ONG Chadia Platform - Database Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ENUM - User Roles
enum Role {
  SUPER_ADMIN
  STAFF
  CONTRIBUTOR
  GUEST
}

// ENUM - Folder Permissions
enum Permission {
  READ
  WRITE
  ADMIN
}

// USER MODEL
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         Role     @default(GUEST)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  refreshTokens RefreshToken[]
  folders       Folder[]

  @@map("users")
}

// REFRESH TOKEN MODEL
model RefreshToken {
  id        String    @id @default(uuid())
  tokenHash String    @map("token_hash")
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// FOLDER MODEL - GED Hierarchy
model Folder {
  id          String   @id @default(cuid())
  name        String
  parentId    String?  @map("parent_id")
  parent      Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Folder[] @relation("FolderHierarchy")
  createdById String   @map("created_by_id")
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  permissions FolderPermission[]

  @@unique([name, parentId])
  @@index([parentId])
  @@index([createdById])
  @@map("folders")
}

// FOLDER PERMISSION MODEL - Access Control
model FolderPermission {
  id         String     @id @default(cuid())
  folderId   String     @map("folder_id")
  folder     Folder     @relation(fields: [folderId], references: [id], onDelete: Cascade)
  role       Role
  permission Permission
  createdAt  DateTime   @default(now()) @map("created_at")

  @@unique([folderId, role])
  @@index([folderId])
  @@map("folder_permissions")
}
