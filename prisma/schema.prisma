// prisma/schema.prisma
// ONG Chadia Platform - Database Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ENUM - User Roles
enum Role {
  SUPER_ADMIN
  STAFF
  CONTRIBUTOR
  GUEST
}

// ENUM - Folder Permissions
enum Permission {
  READ
  WRITE
  ADMIN
}

// USER MODEL
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         Role     @default(GUEST)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  refreshTokens    RefreshToken[]
  folders          Folder[]
  documents        Document[]
  documentVersions DocumentVersion[]
  shareLinks       ShareLink[]
  accessLogs       AccessLog[]

  @@map("users")
}

// REFRESH TOKEN MODEL
model RefreshToken {
  id        String    @id @default(uuid())
  tokenHash String    @map("token_hash")
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// FOLDER MODEL - GED Hierarchy
model Folder {
  id          String   @id @default(cuid())
  name        String
  parentId    String?  @map("parent_id")
  parent      Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Folder[] @relation("FolderHierarchy")
  createdById String   @map("created_by_id")
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  permissions FolderPermission[]
  documents   Document[]

  @@unique([name, parentId])
  @@index([parentId])
  @@index([createdById])
  @@map("folders")
}

// FOLDER PERMISSION MODEL - Access Control
model FolderPermission {
  id         String     @id @default(cuid())
  folderId   String     @map("folder_id")
  folder     Folder     @relation(fields: [folderId], references: [id], onDelete: Cascade)
  role       Role
  permission Permission
  createdAt  DateTime   @default(now()) @map("created_at")

  @@unique([folderId, role])
  @@index([folderId])
  @@map("folder_permissions")
}

// DOCUMENT MODEL - GED Files
model Document {
  id               String            @id @default(cuid())
  name             String
  mimeType         String            @map("mime_type")
  size             Int               // in bytes
  storagePath      String            @unique @map("storage_path")
  folderId         String            @map("folder_id")
  folder           Folder            @relation(fields: [folderId], references: [id], onDelete: Restrict)
  uploadedById     String            @map("uploaded_by_id")
  uploadedBy       User              @relation(fields: [uploadedById], references: [id])
  currentVersionId String?           @unique @map("current_version_id")
  currentVersion   DocumentVersion?  @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  versions         DocumentVersion[] @relation("DocumentVersions")
  shareLinks       ShareLink[]
  accessLogs       AccessLog[]
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  @@index([folderId])
  @@index([uploadedById])
  @@map("documents")
}

// DOCUMENT VERSION MODEL - Version History
model DocumentVersion {
  id            String    @id @default(cuid())
  documentId    String    @map("document_id")
  document      Document  @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  versionNumber Int       @map("version_number")
  storagePath   String    @unique @map("storage_path")
  size          Int       // in bytes
  uploadedById  String    @map("uploaded_by_id")
  uploadedBy    User      @relation(fields: [uploadedById], references: [id])
  createdAt     DateTime  @default(now()) @map("created_at")

  currentFor Document? @relation("CurrentVersion")

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@map("document_versions")
}

// ENUM - Access Actions for logging
enum AccessAction {
  VIEW
  DOWNLOAD
  SHARE
  SHARE_REVOKE
  EDIT
  DELETE
  SHARE_DOWNLOAD
}

// SHARE LINK MODEL - Document sharing with expiration
model ShareLink {
  id             String    @id @default(cuid())
  documentId     String    @map("document_id")
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  token          String    @unique
  expiresAt      DateTime  @map("expires_at")
  maxAccessCount Int?      @map("max_access_count") // null = unlimited
  createdById    String    @map("created_by_id")
  createdBy      User      @relation(fields: [createdById], references: [id])
  accessCount    Int       @default(0) @map("access_count")
  revokedAt      DateTime? @map("revoked_at") // null = active, date = revoked
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([documentId])
  @@index([token])
  @@map("share_links")
}

// ACCESS LOG MODEL - Document access audit trail
model AccessLog {
  id         String       @id @default(cuid())
  documentId String       @map("document_id")
  document   Document     @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String?      @map("user_id") // null for share link access
  user       User?        @relation(fields: [userId], references: [id])
  action     AccessAction
  ipAddress  String?      @map("ip_address")
  metadata   Json?        // Additional info (share token used, etc.)
  createdAt  DateTime     @default(now()) @map("created_at")

  @@index([documentId, createdAt])
  @@index([userId])
  @@map("access_logs")
}
